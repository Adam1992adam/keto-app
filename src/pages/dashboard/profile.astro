---
import {
  supabase, getProfile, isSubscriptionActive, getWeightLogs,
  getUserJourney, getDailyTasks, getWaterIntake, getXPTransactions,
  calculateBMI, calculateCalorieTarget,
  formatWeight, formatHeight, weightLabel,
  kgToLbs, getPlan,
  type UnitSystem
} from '../../lib/supabase';

const accessToken = Astro.cookies.get('sb-access-token')?.value;
if (!accessToken) return Astro.redirect('/login');

const { data: { user } } = await supabase.auth.getUser(accessToken);
if (!user) return Astro.redirect('/login');

const profile = await getProfile(user.id);
if (!profile || !isSubscriptionActive(profile)) return Astro.redirect('/dashboard/upgrade');

const units: UnitSystem = (profile.preferred_units as UnitSystem) || 'imperial';
const wLabel = weightLabel(units);
const plan = getPlan(profile.subscription_tier);

const journey = await getUserJourney(user.id);
const currentDay = journey?.current_day || 1;
const dailyTasks = await getDailyTasks(user.id, currentDay);
await getWaterIntake(user.id, currentDay);
const incompleteTasks = dailyTasks?.filter(
  t => t.task_type !== 'reflection' && t.task_type !== 'weight' && !t.completed
) || [];

const weightLogs = await getWeightLogs(user.id, 30);
const { data: allTasks } = await supabase.from('daily_tasks').select('*').eq('user_id', user.id).order('day_number', { ascending: true });
const xpTransactions = await getXPTransactions(user.id, 30);

const completionData: {day:number;percentage:number}[] = [];
for (let day = 1; day <= Math.min(journey?.current_day || 1, 30); day++) {
  const dt = allTasks?.filter(t => t.day_number === day) || [];
  const dc = dt.filter(t => t.completed).length;
  completionData.push({ day, percentage: dt.length > 0 ? Math.round((dc / dt.length) * 100) : 0 });
}

const xpData: {day:number;xp:number}[] = [];
let cXP = 0;
for (let day = 1; day <= Math.min(journey?.current_day || 1, 30); day++) {
  cXP += xpTransactions?.filter(t => t.day_number === day).reduce((s,t) => s + (t.xp_amount||0), 0) || 0;
  xpData.push({ day, xp: cXP });
}

const totalDaysCompleted = journey?.current_day ? journey.current_day - 1 : 0;
const currentStreak  = journey?.streak_days    || 0;
const longestStreak  = journey?.longest_streak || 0;
const perfectDays    = journey?.perfect_days   || 0;
const totalXP        = journey?.total_xp       || 0;
const level          = journey?.level          || 1;

const currentWeight = profile.weight_kg || 0;
const startWeight   = weightLogs.length > 0 ? weightLogs[weightLogs.length - 1].weight_kg : currentWeight;
const weightChange  = startWeight - currentWeight;
const targetWeight  = profile.target_weight_kg || currentWeight - 5;
const weightToLose  = Math.max(0.001, currentWeight - targetWeight);
const progressPercent = Math.min(100, Math.max(0, ((startWeight - currentWeight) / (startWeight - targetWeight)) * 100));

const bmi = profile.weight_kg && profile.height_cm ? await calculateBMI(profile.weight_kg, profile.height_cm) : null;
const bmiCategory = !bmi ? { label:'Unknown', color:'#8a9ab0' }
  : bmi < 18.5 ? { label:'Underweight', color:'#3b82f6' }
  : bmi < 25   ? { label:'Normal',      color:'#10b981' }
  : bmi < 30   ? { label:'Overweight',  color:'#f59e0b' }
  : { label:'Obese', color:'#ef4444' };

const calorieTarget = await calculateCalorieTarget(profile);
const fatGrams     = Math.round((calorieTarget * 0.70) / 9);
const proteinGrams = Math.round((calorieTarget * 0.25) / 4);
const carbGrams    = Math.round((calorieTarget * 0.05) / 4);

const daysLeft = profile.subscription_end_date
  ? Math.max(0, Math.ceil((new Date(profile.subscription_end_date).getTime() - Date.now()) / 86400000)) : 0;

const totalTasksCompleted = allTasks?.filter(t => t.completed).length || 0;
const totalMealsCompleted = allTasks?.filter(t => t.completed && ['breakfast','lunch','dinner','snack'].includes(t.task_type)).length || 0;
const { data: waterData } = await supabase.from('water_intake').select('glasses_count').eq('user_id', user.id);
const totalWaterGlasses = waterData?.reduce((s,w) => s + w.glasses_count, 0) || 0;

const displayWeight       = formatWeight(currentWeight, units);
const displayTargetWeight = formatWeight(targetWeight, units);
const displayHeight       = profile.height_cm
  ? (units === 'imperial'
      ? (() => { const ti = profile.height_cm! / 2.54; return `${Math.floor(ti/12)}'${Math.round(ti%12)}"`; })()
      : `${profile.height_cm} cm`)
  : '‚Äî';

const weightInputVal = profile.weight_kg ? (units==='imperial' ? kgToLbs(profile.weight_kg) : profile.weight_kg) : '';
const targetInputVal = profile.target_weight_kg ? (units==='imperial' ? kgToLbs(profile.target_weight_kg) : profile.target_weight_kg) : '';
const heightFtVal = profile.height_cm && units==='imperial' ? Math.floor(profile.height_cm/2.54/12) : '';
const heightInVal = profile.height_cm && units==='imperial' ? Math.round((profile.height_cm/2.54)%12) : '';

// Keto Score
const streakScore  = Math.min(30, currentStreak) / 30 * 30;
const tasksScore   = totalTasksCompleted > 0 ? Math.min(20, (totalTasksCompleted / Math.max(1, currentDay * 4)) * 20) : 0;
const waterScore   = totalWaterGlasses > 0 ? Math.min(15, (totalWaterGlasses / Math.max(1, currentDay * 8)) * 15) : 0;
const weightScore  = weightChange > 0 ? Math.min(20, (weightChange / Math.max(1, weightToLose)) * 20) : 0;
const perfectScore = Math.min(15, perfectDays / 30 * 15);
const ketoScore    = Math.round(streakScore + tasksScore + waterScore + weightScore + perfectScore);

const milestones = [
  { day:1,  icon:'üöÄ', label:'Started the Journey',   done: currentDay >= 1  },
  { day:3,  icon:'üõ°Ô∏è', label:'Survived Keto Flu',    done: currentDay >= 3  },
  { day:7,  icon:'üî•', label:'One Week Strong',       done: currentDay >= 7  },
  { day:10, icon:'üëë', label:'Beat Keto Flu',         done: currentDay >= 10 },
  { day:15, icon:'üåü', label:'Halfway Hero',          done: currentDay >= 15 },
  { day:21, icon:'üíé', label:'Three Weeks In',        done: currentDay >= 21 },
  { day:30, icon:'üèÜ', label:'30-Day Champion',       done: currentDay >= 30 },
  ...(weightChange >= 1 ? [{ day:0, icon:'‚öñÔ∏è', label:`Lost ${weightChange.toFixed(1)} ${wLabel}`, done:true }] : []),
  ...(totalXP >= 500    ? [{ day:0, icon:'üèÖ', label:'500 XP Earned',    done:true }] : []),
];

const achievementsList = [
  { name:'First Step',       desc:'Complete your first day',    icon:'üéØ', done: perfectDays  >= 1  },
  { name:'Week Warrior',     desc:'7 perfect days',             icon:'üìÖ', done: perfectDays  >= 7  },
  { name:'Two Weeks Strong', desc:'14 perfect days',            icon:'üí™', done: perfectDays  >= 14 },
  { name:'On Fire',          desc:'7 day streak',               icon:'üî•', done: currentStreak>= 7  },
  { name:'Level Master',     desc:'Reach Level 5',              icon:'‚≠ê', done: level        >= 5  },
  { name:'XP Hunter',        desc:'Earn 500 XP',                icon:'üèÖ', done: totalXP      >= 500 },
  { name:'First Kilo',       desc:'Lose 1 kg',                  icon:'‚öñÔ∏è', done: weightChange >= 1  },
  { name:'Five Down',        desc:'Lose 5 kg',                  icon:'üèÜ', done: weightChange >= 5  },
  { name:'Halfway Hero',     desc:'Reach Day 15',               icon:'üåü', done: currentDay   >= 15 },
  { name:'Keto Champion',    desc:'Complete 30 days',           icon:'üëë', done: currentDay   >= 30 },
];

const chartDataJson      = JSON.stringify(weightLogs.slice().reverse().map(log => ({
  date: new Date(log.date).toLocaleDateString('en-US', { month:'short', day:'numeric' }),
  weight: units === 'imperial' ? kgToLbs(log.weight_kg) : log.weight_kg,
})));
const xpDataJson         = JSON.stringify(xpData);
const completionDataJson = JSON.stringify(completionData);
const weightChartLabel   = units === 'imperial' ? 'lbs' : 'kg';
const avatarLetter       = profile.full_name?.charAt(0)?.toUpperCase() || '?';
const userName           = profile.full_name?.split(' ')[0] || 'Friend';
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Profile ‚Äî Keto Journey</title>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,700;0,9..144,900;1,9..144,700&family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600;9..40,700&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script is:inline>(function(){ const t=localStorage.getItem('keto-theme')||'dark'; document.documentElement.setAttribute('data-theme',t); })();</script>
  <style>
    :root{--bg:#0c1117;--surface:#131b24;--card:#1a2535;--border:rgba(255,255,255,.07);--border2:rgba(255,255,255,.13);--text:#e8edf5;--muted:#4a5a6e;--soft:#8a9ab0;--green:#10b981;--green2:#34d399;--blue:#3b82f6;--purple:#8b5cf6;--gold:#f59e0b;--red:#ef4444;--cyan:#06b6d4;--radius:20px;--nav-h:64px;}
    [data-theme="light"]{--bg:#f0f4f8;--surface:#fff;--card:#fff;--border:rgba(0,0,0,.07);--border2:rgba(0,0,0,.13);--text:#0f172a;--muted:#94a3b8;--soft:#64748b;}
    *,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
    html{scroll-behavior:smooth;}
    body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;transition:background .3s,color .3s;}
    .bg-mesh{position:fixed;inset:0;pointer-events:none;z-index:0;overflow:hidden;}
    .orb{position:absolute;border-radius:50%;filter:blur(100px);animation:drift ease-in-out infinite;}
    [data-theme="light"] .orb{opacity:.2;}
    .o1{width:700px;height:700px;background:rgba(16,185,129,.06);top:-200px;left:-200px;animation-duration:22s;}
    .o2{width:500px;height:500px;background:rgba(139,92,246,.05);bottom:-100px;right:-100px;animation-duration:28s;animation-delay:-12s;}
    .o3{width:350px;height:350px;background:rgba(245,158,11,.04);top:45%;left:40%;animation-duration:19s;animation-delay:-7s;}
    @keyframes drift{0%,100%{transform:translate(0,0) scale(1);}33%{transform:translate(50px,-60px) scale(1.08);}66%{transform:translate(-40px,50px) scale(.94);}}
    nav{position:sticky;top:0;z-index:100;height:var(--nav-h);background:rgba(12,17,23,.85);border-bottom:1px solid var(--border);backdrop-filter:blur(20px);display:flex;align-items:center;transition:background .3s;}
    [data-theme="light"] nav{background:rgba(255,255,255,.9);}
    .nav-inner{max-width:1280px;margin:0 auto;padding:0 1.5rem;width:100%;display:flex;align-items:center;gap:1.25rem;}
    .nav-brand{display:flex;align-items:center;gap:.6rem;text-decoration:none;font-family:'Fraunces',serif;font-weight:700;font-size:1.1rem;color:var(--text);flex-shrink:0;}
    .nav-links{display:flex;align-items:center;gap:.25rem;flex:1;overflow-x:auto;}
    .nav-links::-webkit-scrollbar{display:none;}
    .nav-link{display:flex;align-items:center;gap:.4rem;padding:.45rem .9rem;border-radius:10px;font-size:.82rem;font-weight:600;color:var(--soft);text-decoration:none;white-space:nowrap;transition:all .2s;}
    .nav-link:hover,.nav-link.active{background:rgba(16,185,129,.1);color:var(--green);}
    .nav-right{display:flex;align-items:center;gap:.65rem;flex-shrink:0;}
    .icon-btn{width:36px;height:36px;border-radius:10px;background:var(--card);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:.95rem;transition:all .2s;}
    .icon-btn:hover{border-color:var(--green);}
    .nav-avatar{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--green),var(--blue));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:.9rem;text-decoration:none;flex-shrink:0;}
    .notif-wrap{position:relative;}
    .notif-badge{position:absolute;top:-4px;right:-4px;background:var(--red);color:#fff;width:17px;height:17px;border-radius:50%;font-size:.62rem;font-weight:800;display:flex;align-items:center;justify-content:center;animation:pulse 2s infinite;}
    @keyframes pulse{0%,100%{transform:scale(1);}50%{transform:scale(1.2);}}
    .notif-drop{position:absolute;top:calc(100% + .5rem);right:0;width:300px;background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden;box-shadow:0 20px 50px rgba(0,0,0,.4);display:none;z-index:200;}
    .notif-drop.open{display:block;animation:dropIn .25s ease;}
    @keyframes dropIn{from{opacity:0;transform:translateY(-8px);}to{opacity:1;transform:translateY(0);}}
    .page{position:relative;z-index:1;max-width:1280px;margin:0 auto;padding:2rem 1.5rem 5rem;}
    /* HERO */
    .profile-hero{background:var(--card);border:1px solid var(--border);border-radius:28px;margin-bottom:1.5rem;overflow:hidden;position:relative;animation:fadeUp .5s ease both;}
    @keyframes fadeUp{from{opacity:0;transform:translateY(14px);}to{opacity:1;transform:translateY(0);}}
    .hero-gradient{position:absolute;inset:0;background:linear-gradient(135deg,rgba(16,185,129,.1) 0%,rgba(59,130,246,.06) 55%,rgba(139,92,246,.07) 100%);pointer-events:none;}
    .hero-glow{position:absolute;top:-80px;right:-80px;width:400px;height:400px;border-radius:50%;background:radial-gradient(circle,rgba(16,185,129,.13),transparent 70%);pointer-events:none;animation:drift 20s ease-in-out infinite;}
    .hero-body{position:relative;z-index:1;display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:2rem;padding:2.5rem;}
    .hero-avatar{width:88px;height:88px;border-radius:22px;background:linear-gradient(135deg,var(--green),var(--blue));display:flex;align-items:center;justify-content:center;font-size:2.6rem;font-weight:900;color:#fff;box-shadow:0 12px 32px rgba(16,185,129,.3);border:2px solid rgba(255,255,255,.1);overflow:hidden;transition:transform .3s;cursor:pointer;flex-shrink:0;}
    .hero-avatar:hover{transform:scale(1.05);}
    .hero-greeting{font-size:.7rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.1em;margin-bottom:.3rem;}
    .hero-name{font-family:'Fraunces',serif;font-size:clamp(1.8rem,4vw,2.8rem);font-weight:900;line-height:1.12;margin-bottom:.4rem;}
    .hero-name .hl{font-style:italic;background:linear-gradient(135deg,var(--green),var(--green2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
    .hero-email{font-size:.82rem;color:var(--soft);margin-bottom:.75rem;}
    .hero-tags{display:flex;flex-wrap:wrap;gap:.4rem;margin-bottom:.875rem;}
    .htag{display:inline-flex;align-items:center;gap:.3rem;padding:.22rem .7rem;border-radius:99px;font-size:.7rem;font-weight:700;background:rgba(255,255,255,.05);border:1px solid var(--border);color:var(--soft);}
    .units-toggle{display:inline-flex;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:.2rem;}
    .units-btn{padding:.4rem .9rem;border-radius:9px;border:none;font-size:.75rem;font-weight:700;cursor:pointer;color:var(--soft);background:transparent;transition:all .2s;}
    .units-btn.active{background:var(--card);color:var(--green);box-shadow:0 2px 6px rgba(0,0,0,.15);}
    /* Score ring */
    .score-wrap{flex-shrink:0;text-align:center;}
    .score-ring{position:relative;width:108px;height:108px;}
    .score-ring svg{transform:rotate(-90deg);}
    .ring-bg{fill:none;stroke:rgba(255,255,255,.07);stroke-width:8;}
    .ring-fill{fill:none;stroke-width:8;stroke-linecap:round;transition:stroke-dashoffset 1.6s cubic-bezier(.4,0,.2,1);}
    .score-center{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;}
    .score-num{font-family:'Fraunces',serif;font-size:1.75rem;font-weight:900;line-height:1;}
    .score-lbl{font-size:.58rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--soft);margin-top:.1rem;}
    .score-tag{font-size:.7rem;font-weight:700;color:var(--soft);margin-top:.4rem;}
    /* Stats bar */
    .stats-bar{display:grid;grid-template-columns:repeat(5,1fr);border-top:1px solid var(--border);}
    .sbar{padding:1rem 1.25rem;text-align:center;border-right:1px solid var(--border);transition:background .2s;}
    .sbar:last-child{border-right:none;}
    .sbar:hover{background:rgba(255,255,255,.02);}
    .sbar-val{font-family:'Fraunces',serif;font-size:1.5rem;font-weight:900;line-height:1;margin-bottom:.15rem;}
    .sbar-lbl{font-size:.65rem;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.07em;}
    /* TABS */
    .tabs-bar{display:flex;gap:.25rem;background:var(--surface);border-radius:14px;padding:.3rem;margin-bottom:1.5rem;border:1px solid var(--border);overflow-x:auto;animation:fadeUp .5s .1s ease both;}
    .tabs-bar::-webkit-scrollbar{display:none;}
    .tab-btn{display:flex;align-items:center;gap:.4rem;padding:.6rem 1.1rem;border-radius:10px;border:none;font-size:.82rem;font-weight:700;cursor:pointer;color:var(--soft);background:transparent;white-space:nowrap;flex-shrink:0;transition:all .2s;}
    .tab-btn.active{background:var(--card);color:var(--green);box-shadow:0 2px 8px rgba(0,0,0,.15);}
    .tab-content{display:none;animation:fadeUp .3s ease;}
    .tab-content.active{display:block;}
    /* CARDS */
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:1.75rem;transition:border-color .2s;}
    .card:hover{border-color:var(--border2);}
    .card-title{font-family:'Fraunces',serif;font-size:1.2rem;font-weight:700;margin-bottom:1.25rem;background:linear-gradient(135deg,var(--green),var(--green2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
    .g2{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;}
    .g3{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;}
    .chart-wrap{position:relative;height:220px;margin-top:.75rem;}
    /* STAT CARDS */
    .stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:1rem;margin-bottom:1.25rem;animation:fadeUp .5s .15s ease both;}
    .scard{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:1.25rem;position:relative;overflow:hidden;transition:all .25s;}
    .scard:hover{transform:translateY(-3px);border-color:var(--border2);}
    .scard .gl{position:absolute;top:-20px;right:-20px;width:90px;height:90px;border-radius:50%;filter:blur(35px);opacity:.18;}
    .scard:hover .gl{opacity:.35;}
    .scard-icon{width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;margin-bottom:.875rem;position:relative;z-index:1;}
    .scard-lbl{font-size:.68rem;font-weight:700;color:var(--soft);text-transform:uppercase;letter-spacing:.08em;margin-bottom:.3rem;position:relative;z-index:1;}
    .scard-val{font-family:'Fraunces',serif;font-size:1.75rem;font-weight:900;line-height:1;position:relative;z-index:1;margin-bottom:.2rem;}
    .scard-sub{font-size:.72rem;color:var(--muted);position:relative;z-index:1;}
    .mini-bar{height:5px;background:var(--surface);border-radius:99px;overflow:hidden;margin-top:.625rem;position:relative;z-index:1;}
    .mini-fill{height:100%;border-radius:99px;transition:width .8s ease;}
    /* ACHIEVEMENTS */
    .ach-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:.75rem;}
    .ach{background:var(--surface);border:1.5px solid var(--border);border-radius:14px;padding:.875rem 1rem;display:flex;align-items:center;gap:.75rem;transition:all .2s;}
    .ach.on{background:rgba(16,185,129,.06);border-color:rgba(16,185,129,.3);}
    .ach:hover{transform:translateY(-2px);}
    .ach-ico{font-size:1.6rem;flex-shrink:0;}
    .ach-name{font-weight:700;font-size:.8rem;margin-bottom:.08rem;}
    .ach-desc{font-size:.7rem;color:var(--soft);}
    /* TIMELINE */
    .timeline{position:relative;padding-left:2rem;}
    .timeline::before{content:'';position:absolute;left:.65rem;top:.5rem;bottom:.5rem;width:2px;background:var(--border);}
    .tl-item{position:relative;margin-bottom:1rem;display:flex;align-items:center;gap:.875rem;}
    .tl-dot{position:absolute;left:-1.35rem;width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.7rem;border:2px solid var(--border);background:var(--surface);z-index:1;}
    .tl-dot.on{border-color:var(--green);background:rgba(16,185,129,.15);}
    .tl-body{padding:.65rem .875rem;background:var(--surface);border:1px solid var(--border);border-radius:11px;flex:1;transition:all .2s;}
    .tl-body.on{border-color:rgba(16,185,129,.25);background:rgba(16,185,129,.04);}
    .tl-label{font-weight:700;font-size:.82rem;}
    .tl-day{font-size:.7rem;color:var(--soft);}
    /* SETTINGS */
    .form-section{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:1.75rem;margin-bottom:1rem;}
    .fsec-title{font-size:.7rem;font-weight:800;text-transform:uppercase;letter-spacing:.1em;color:var(--muted);margin-bottom:1.25rem;padding-bottom:.625rem;border-bottom:1px solid var(--border);}
    .fgrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:.875rem;margin-bottom:1rem;}
    .fg{display:flex;flex-direction:column;gap:.35rem;}
    .fg label{font-size:.7rem;font-weight:700;color:var(--soft);text-transform:uppercase;letter-spacing:.06em;}
    .fi{padding:.72rem .9rem;border-radius:11px;border:1.5px solid var(--border);background:var(--surface);color:var(--text);font-size:.875rem;font-weight:600;outline:none;transition:all .2s;font-family:'DM Sans',sans-serif;width:100%;}
    .fi:focus{border-color:var(--green);box-shadow:0 0 0 3px rgba(16,185,129,.1);}
    select.fi option{background:var(--surface);color:var(--text);}
    .btn-save{display:inline-flex;align-items:center;gap:.5rem;padding:.7rem 1.5rem;border-radius:11px;border:none;background:linear-gradient(135deg,var(--green),var(--green2));color:#fff;font-weight:800;font-size:.82rem;cursor:pointer;transition:all .25s;}
    .btn-save:hover{transform:translateY(-2px);box-shadow:0 8px 22px rgba(16,185,129,.35);}
    .btn-ghost{display:inline-flex;align-items:center;gap:.4rem;padding:.68rem 1.1rem;border-radius:11px;border:1.5px solid var(--border);background:transparent;color:var(--soft);font-weight:700;font-size:.82rem;cursor:pointer;text-decoration:none;transition:all .2s;}
    .btn-ghost:hover{border-color:var(--border2);color:var(--text);}
    .qa{display:flex;align-items:center;gap:.7rem;width:100%;padding:.8rem 1rem;border-radius:11px;border:1px solid var(--border);background:var(--surface);color:var(--text);font-weight:600;font-size:.82rem;cursor:pointer;text-decoration:none;transition:all .2s;margin-bottom:.45rem;}
    .qa:hover{border-color:var(--border2);transform:translateX(3px);}
    .qa.danger{color:var(--red);}
    .qa.danger:hover{background:rgba(239,68,68,.06);border-color:rgba(239,68,68,.25);}
    /* MACRO RINGS */
    .macro-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:.875rem;}
    .mring{text-align:center;padding:1.1rem .75rem;border-radius:13px;background:var(--surface);border:1px solid var(--border);}
    .mring-val{font-family:'Fraunces',serif;font-size:1.5rem;font-weight:900;margin-bottom:.15rem;}
    .mring-lbl{font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--soft);}
    /* MODAL */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.65);backdrop-filter:blur(10px);z-index:300;display:none;align-items:center;justify-content:center;padding:1rem;}
    .modal.open{display:flex;}
    .modal-box{background:var(--card);border:1px solid var(--border);border-radius:24px;width:100%;max-width:420px;overflow:hidden;animation:fadeUp .3s ease;}
    .modal-head{padding:1.25rem 1.5rem;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
    .modal-title{font-family:'Fraunces',serif;font-size:1.1rem;font-weight:700;}
    .modal-close{width:28px;height:28px;border-radius:8px;background:var(--surface);border:1px solid var(--border);font-size:.95rem;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--soft);}
    /* TOAST */
    .toast{position:fixed;top:5rem;right:1.5rem;z-index:9999;background:linear-gradient(135deg,var(--green),var(--green2));color:#fff;padding:.875rem 1.5rem;border-radius:12px;font-weight:700;font-size:.875rem;box-shadow:0 10px 30px rgba(16,185,129,.4);transform:translateY(-16px);opacity:0;pointer-events:none;transition:all .35s cubic-bezier(.4,0,.2,1);}
    .toast.show{transform:translateY(0);opacity:1;}
    @media(max-width:900px){.hero-body{grid-template-columns:1fr;text-align:center;}.hero-tags{justify-content:center;}.score-wrap{margin:0 auto;}.stats-bar{grid-template-columns:repeat(3,1fr);}}
    @media(max-width:540px){.stats-bar{grid-template-columns:repeat(2,1fr);}.ach-grid{grid-template-columns:1fr;}}
  </style>
</head>
<body>
<div class="bg-mesh" aria-hidden="true">
  <div class="orb o1"></div><div class="orb o2"></div><div class="orb o3"></div>
</div>

<!-- NAV -->
<nav>
  <div class="nav-inner">
    <a href="/dashboard" class="nav-brand">ü•ë <span>Keto Journey</span></a>
    <div class="nav-links">
      <a href="/dashboard"               class="nav-link">üìä Dashboard</a>
      <a href="/dashboard/shopping-list" class="nav-link">üõí Shopping</a>
      <a href="/dashboard/recipes"       class="nav-link">üç≥ Recipes</a>
      <a href="/dashboard/profile"       class="nav-link active">üë§ Profile</a>
      <a href="/dashboard/notifications" class="nav-link">üîî Reminders</a>
    </div>
    <div class="nav-right">
      <button class="icon-btn" id="themeBtn">‚òÄÔ∏è</button>
      {incompleteTasks.length > 0 && (
        <div class="notif-wrap">
          <button class="icon-btn" id="notifBtn" style="position:relative;">üîî<span class="notif-badge">{incompleteTasks.length}</span></button>
          <div class="notif-drop" id="notifDrop">
            <div style="padding:.875rem 1.25rem;border-bottom:1px solid var(--border);font-weight:800;font-size:.85rem;color:var(--green);">üîî {incompleteTasks.length} Pending</div>
            <div style="max-height:250px;overflow-y:auto;">
              {incompleteTasks.map(t=>(
                <div style="display:flex;align-items:center;gap:.75rem;padding:.7rem 1.25rem;border-bottom:1px solid var(--border);">
                  <div style="width:32px;height:32px;border-radius:8px;background:linear-gradient(135deg,var(--green),var(--green2));display:flex;align-items:center;justify-content:center;font-size:.9rem;">{t.task_type==='breakfast'?'üç≥':t.task_type==='lunch'?'ü•ó':t.task_type==='dinner'?'üçΩÔ∏è':t.task_type==='snack'?'üçé':'üíß'}</div>
                  <div><div style="font-weight:700;font-size:.8rem;">{t.task_title}</div><div style="font-size:.7rem;color:var(--soft);">+{t.xp_earned} XP</div></div>
                </div>
              ))}
            </div>
            <div style="padding:.75rem 1.25rem;"><a href="/dashboard" style="display:block;text-align:center;padding:.55rem;border-radius:9px;background:linear-gradient(135deg,var(--green),var(--green2));color:#fff;font-weight:700;font-size:.78rem;text-decoration:none;">Go to Dashboard ‚Üí</a></div>
          </div>
        </div>
      )}
      <a href="/dashboard/profile" class="nav-avatar">{avatarLetter}</a>
    </div>
  </div>
</nav>

<div class="page">

  <!-- ‚ïê‚ïê HERO ‚ïê‚ïê -->
  <div class="profile-hero">
    <div class="hero-gradient"></div>
    <div class="hero-glow"></div>
    <div class="hero-body">
      <!-- Avatar -->
      <div class="hero-avatar" id="openAvatarBtn" title="Change avatar">
        {profile.avatar_url?.startsWith('emoji:') ? profile.avatar_url.replace('emoji:','')
        : profile.avatar_url ? <img src={profile.avatar_url} alt={profile.full_name} style="width:100%;height:100%;object-fit:cover;"/>
        : avatarLetter}
      </div>

      <!-- Info -->
      <div>
        <div class="hero-greeting">Your Keto Profile</div>
        <div class="hero-name"><span class="hl">{profile.full_name}</span></div>
        <div class="hero-email">{profile.email}</div>
        <div class="hero-tags">
          <span class="htag">{plan.emoji} {plan.name}</span>
          <span class="htag">üî• {currentStreak}d streak</span>
          <span class="htag">‚ö° Lv.{level}</span>
          <span class="htag" style={daysLeft<=7?'color:var(--red);border-color:rgba(239,68,68,.3);':''}>üìÖ {daysLeft}d left</span>
          <span class="htag">üèÜ {achievementsList.filter(a=>a.done).length}/{achievementsList.length} badges</span>
        </div>
        <div class="units-toggle">
          <button class={`units-btn${units==='imperial'?' active':''}`} onclick="setUnits('imperial')">üá∫üá∏ lbs/ft</button>
          <button class={`units-btn${units==='metric'?' active':''}`} onclick="setUnits('metric')">üåç kg/cm</button>
        </div>
      </div>

      <!-- Keto Score -->
      <div class="score-wrap">
        <div class="score-ring">
          <svg viewBox="0 0 100 100" width="108" height="108">
            <circle class="ring-bg" cx="50" cy="50" r="42"/>
            <circle class="ring-fill" cx="50" cy="50" r="42"
              stroke={ketoScore>=80?'#10b981':ketoScore>=60?'#f59e0b':'#3b82f6'}
              stroke-dasharray={`${2*Math.PI*42}`}
              stroke-dashoffset={`${2*Math.PI*42}`}
              id="scoreRing"
            />
          </svg>
          <div class="score-center">
            <div class="score-num" style={`color:${ketoScore>=80?'#10b981':ketoScore>=60?'#f59e0b':'#3b82f6'}`}>{ketoScore}</div>
            <div class="score-lbl">Keto Score</div>
          </div>
        </div>
        <div class="score-tag">{ketoScore>=80?'üî• Excellent!':ketoScore>=60?'üí™ Good':ketoScore>=40?'üìà Growing':'üöÄ Starting'}</div>
      </div>
    </div>

    <!-- Stats bar -->
    <div class="stats-bar">
      <div class="sbar"><div class="sbar-val" style="background:linear-gradient(135deg,var(--green),var(--green2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;">{currentDay}</div><div class="sbar-lbl">Current Day</div></div>
      <div class="sbar"><div class="sbar-val" style="background:linear-gradient(135deg,var(--red),var(--gold));-webkit-background-clip:text;-webkit-text-fill-color:transparent;">{currentStreak}</div><div class="sbar-lbl">Day Streak</div></div>
      <div class="sbar"><div class="sbar-val" style="background:linear-gradient(135deg,var(--gold),#fbbf24);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">{totalXP}</div><div class="sbar-lbl">Total XP</div></div>
      <div class="sbar"><div class="sbar-val" style="background:linear-gradient(135deg,var(--blue),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent;">{displayWeight}</div><div class="sbar-lbl">Weight</div></div>
      <div class="sbar"><div class="sbar-val" style="background:linear-gradient(135deg,var(--purple),#a78bfa);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">{perfectDays}</div><div class="sbar-lbl">Perfect Days</div></div>
    </div>
  </div>

  <!-- TABS -->
  <div class="tabs-bar">
    <button class="tab-btn active" data-tab="overview">üìä Overview</button>
    <button class="tab-btn" data-tab="achievements">üèÜ Achievements</button>
    <button class="tab-btn" data-tab="milestones">üó∫Ô∏è Milestones</button>
    <button class="tab-btn" data-tab="settings">‚öôÔ∏è Settings</button>
  </div>

  <!-- ‚ïê‚ïê OVERVIEW ‚ïê‚ïê -->
  <div id="tab-overview" class="tab-content active">
    <div class="stats-row">
      <div class="scard"><div class="gl" style="background:var(--green);"></div><div class="scard-icon" style="background:rgba(16,185,129,.1);">‚öñÔ∏è</div><div class="scard-lbl">Weight Lost</div><div class="scard-val" style="color:var(--green);">{weightChange>0?`-${weightChange.toFixed(1)}`:'0.0'} {wLabel}</div><div class="scard-sub">Goal: {displayTargetWeight}</div><div class="mini-bar"><div class="mini-fill" style={`width:${progressPercent}%;background:linear-gradient(90deg,var(--green),var(--green2));`}></div></div></div>
      <div class="scard"><div class="gl" style="background:var(--blue);"></div><div class="scard-icon" style="background:rgba(59,130,246,.1);">üìè</div><div class="scard-lbl">BMI</div><div class="scard-val" style={`color:${bmiCategory.color};`}>{bmi?bmi.toFixed(1):'‚Äî'}</div><div class="scard-sub">{bmiCategory.label} ¬∑ {displayHeight}</div></div>
      <div class="scard"><div class="gl" style="background:var(--gold);"></div><div class="scard-icon" style="background:rgba(245,158,11,.1);">üèÜ</div><div class="scard-lbl">Perfect Days</div><div class="scard-val" style="color:var(--gold);">{perfectDays}</div><div class="scard-sub">Longest: {longestStreak}d</div></div>
      <div class="scard"><div class="gl" style="background:var(--purple);"></div><div class="scard-icon" style="background:rgba(139,92,246,.1);">üíß</div><div class="scard-lbl">Water Logged</div><div class="scard-val" style="color:var(--purple);">{totalWaterGlasses}</div><div class="scard-sub">glasses total</div></div>
      <div class="scard"><div class="gl" style="background:var(--cyan);"></div><div class="scard-icon" style="background:rgba(6,182,212,.1);">üçΩÔ∏è</div><div class="scard-lbl">Meals Done</div><div class="scard-val" style="color:var(--cyan);">{totalMealsCompleted}</div><div class="scard-sub">{totalTasksCompleted} tasks total</div></div>
    </div>
    <div class="g2" style="margin-bottom:1rem;">
      <div class="card">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;flex-wrap:wrap;gap:.5rem;">
          <div class="card-title" style="margin:0;">üìà Weight Progress</div>
          <button id="openWM" class="btn-save" style="padding:.45rem .9rem;font-size:.75rem;">+ Log Weight</button>
        </div>
        {weightLogs.length>1?<div class="chart-wrap"><canvas id="weightChart"></canvas></div>:<div style="height:180px;display:flex;flex-direction:column;align-items:center;justify-content:center;border:1.5px dashed var(--border);border-radius:12px;gap:.5rem;"><span style="font-size:2.5rem;">‚öñÔ∏è</span><p style="font-size:.82rem;color:var(--soft);">Log weight to see progress</p></div>}
      </div>
      <div class="card">
        <div class="card-title">‚ö° XP Growth</div>
        {xpData.length>0?<div class="chart-wrap"><canvas id="xpChart"></canvas></div>:<div style="height:180px;display:flex;align-items:center;justify-content:center;border:1.5px dashed var(--border);border-radius:12px;color:var(--soft);font-size:.82rem;">Complete tasks to earn XP</div>}
      </div>
    </div>
    <div class="g2" style="margin-bottom:1rem;">
      <div class="card">
        <div class="card-title">üìä Daily Completion</div>
        {completionData.length>0?<div class="chart-wrap"><canvas id="completionChart"></canvas></div>:<div style="height:180px;display:flex;align-items:center;justify-content:center;border:1.5px dashed var(--border);border-radius:12px;color:var(--soft);font-size:.82rem;">Start your journey!</div>}
      </div>
      <div class="card">
        <div class="card-title">ü•ë Daily Nutrition Targets</div>
        <div class="macro-grid">
          {[{lbl:'Calories',val:`${calorieTarget}`,unit:'kcal',color:'#f093fb'},{lbl:'Protein',val:`${proteinGrams}`,unit:'g',color:'#4facfe'},{lbl:'Fat',val:`${fatGrams}`,unit:'g',color:'#10b981'},{lbl:'Carbs',val:`${carbGrams}`,unit:'g',color:'#f59e0b'}].map(m=>(
            <div class="mring"><div class="mring-val" style={`color:${m.color};`}>{m.val}<span style="font-size:.75rem;opacity:.65;">{m.unit}</span></div><div class="mring-lbl">{m.lbl}</div></div>
          ))}
        </div>
        <div style="margin-top:1rem;padding:.75rem;background:rgba(59,130,246,.06);border:1px solid rgba(59,130,246,.2);border-radius:11px;text-align:center;font-size:.75rem;font-weight:700;color:var(--blue);">70% Fat ¬∑ 25% Protein ¬∑ 5% Carbs</div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">üìä Activity Summary</div>
      <div class="g3">
        {[{icon:'üçΩÔ∏è',lbl:'Meals',val:totalMealsCompleted,color:'#8b5cf6'},{icon:'üíß',lbl:'Water Glasses',val:totalWaterGlasses,color:'#3b82f6'},{icon:'‚úÖ',lbl:'Tasks Done',val:totalTasksCompleted,color:'#10b981'},{icon:'‚ö°',lbl:'XP Earned',val:totalXP,color:'#f59e0b'},{icon:'üèÜ',lbl:'Perfect Days',val:perfectDays,color:'#f093fb'},{icon:'üî•',lbl:'Day Streak',val:currentStreak,color:'#ef4444'}].map(s=>(
          <div style="text-align:center;padding:1rem .875rem;background:var(--surface);border:1px solid var(--border);border-radius:13px;">
            <div style="font-size:1.6rem;margin-bottom:.35rem;">{s.icon}</div>
            <div style={`font-family:'Fraunces',serif;font-size:1.4rem;font-weight:900;color:${s.color};margin-bottom:.15rem;`}>{s.val}</div>
            <div style="font-size:.67rem;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.07em;">{s.lbl}</div>
          </div>
        ))}
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê ACHIEVEMENTS ‚ïê‚ïê -->
  <div id="tab-achievements" class="tab-content">
    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;flex-wrap:wrap;gap:.5rem;">
        <div class="card-title" style="margin:0;">üèÜ Your Achievements</div>
        <span style="font-size:.75rem;font-weight:700;color:var(--soft);">{achievementsList.filter(a=>a.done).length} / {achievementsList.length} earned</span>
      </div>
      <div class="mini-bar" style="height:7px;margin-bottom:1.5rem;"><div class="mini-fill" style={`width:${Math.round(achievementsList.filter(a=>a.done).length/achievementsList.length*100)}%;background:linear-gradient(90deg,var(--green),var(--green2));`}></div></div>
      <div style="font-size:.7rem;font-weight:800;text-transform:uppercase;letter-spacing:.1em;color:var(--green);margin-bottom:.75rem;">‚úÖ Earned ({achievementsList.filter(a=>a.done).length})</div>
      <div class="ach-grid" style="margin-bottom:1.5rem;">
        {achievementsList.filter(a=>a.done).length===0?<p style="color:var(--soft);font-size:.82rem;grid-column:1/-1;">Complete tasks to earn your first badge!</p>:achievementsList.filter(a=>a.done).map(a=>(
          <div class="ach on"><div class="ach-ico">{a.icon}</div><div><div class="ach-name">{a.name}</div><div class="ach-desc">{a.desc}</div></div><span style="margin-left:auto;color:var(--green);font-size:.85rem;">‚úì</span></div>
        ))}
      </div>
      <div style="font-size:.7rem;font-weight:800;text-transform:uppercase;letter-spacing:.1em;color:var(--muted);margin-bottom:.75rem;">üîí Locked ({achievementsList.filter(a=>!a.done).length})</div>
      <div class="ach-grid">
        {achievementsList.filter(a=>!a.done).map(a=>(
          <div class="ach" style="opacity:.5;"><div class="ach-ico" style="filter:grayscale(1);">{a.icon}</div><div><div class="ach-name" style="color:var(--soft);">{a.name}</div><div class="ach-desc">{a.desc}</div></div><span style="margin-left:auto;color:var(--muted);font-size:.82rem;">üîí</span></div>
        ))}
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê MILESTONES ‚ïê‚ïê -->
  <div id="tab-milestones" class="tab-content">
    <div class="g2">
      <div class="card">
        <div class="card-title">üó∫Ô∏è Journey Timeline</div>
        <div class="timeline">
          {[...milestones].sort((a,b)=>a.day-b.day).map(m=>(
            <div class="tl-item">
              <div class={`tl-dot${m.done?' on':''}`}>{m.done?'‚úì':'¬∑'}</div>
              <div class={`tl-body${m.done?' on':''}`}>
                <div class="tl-label">{m.icon} {m.label}</div>
                {m.day>0&&<div class="tl-day">Day {m.day}</div>}
              </div>
            </div>
          ))}
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:1rem;">
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;flex-wrap:wrap;gap:.5rem;">
            <div class="card-title" style="margin:0;">‚öñÔ∏è Weight Log</div>
            <button id="openWM2" class="btn-save" style="padding:.4rem .85rem;font-size:.72rem;">+ Add</button>
          </div>
          {weightLogs.length>0?(
            <div style="display:flex;flex-direction:column;gap:.4rem;max-height:280px;overflow-y:auto;">
              {weightLogs.slice(0,10).map(log=>(
                <div style="display:flex;align-items:center;justify-content:space-between;padding:.625rem .875rem;background:var(--surface);border:1px solid var(--border);border-radius:10px;">
                  <div><div style="font-weight:700;font-size:.82rem;">{formatWeight(log.weight_kg,units)}</div><div style="font-size:.7rem;color:var(--soft);">{new Date(log.date).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})}</div></div>
                  {log.notes&&<div style="font-size:.7rem;color:var(--muted);max-width:110px;text-align:right;">{log.notes}</div>}
                </div>
              ))}
            </div>
          ):<p style="color:var(--soft);font-size:.82rem;text-align:center;padding:1.5rem 0;">No entries yet</p>}
        </div>
        <div class="card">
          <div class="card-title">üìä Journey Stats</div>
          <div style="display:flex;flex-direction:column;gap:.5rem;">
            {[{lbl:'Days Completed',val:`${totalDaysCompleted}/30`},{lbl:'Start Weight',val:formatWeight(startWeight,units)},{lbl:'Current Weight',val:displayWeight},{lbl:'Target Weight',val:displayTargetWeight},{lbl:'Progress',val:`${progressPercent.toFixed(0)}%`}].map(s=>(
              <div style="display:flex;justify-content:space-between;align-items:center;padding:.55rem .875rem;background:var(--surface);border-radius:10px;">
                <span style="font-size:.8rem;color:var(--soft);">{s.lbl}</span>
                <span style="font-size:.85rem;font-weight:800;">{s.val}</span>
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê SETTINGS ‚ïê‚ïê -->
  <div id="tab-settings" class="tab-content">
    <div class="g2">
      <div>
        <div class="form-section">
          <div class="fsec-title">üë§ Personal Information</div>
          <form id="editForm">
            <div class="fgrid">
              <div class="fg"><label>Full Name</label><input type="text" name="full_name" value={profile.full_name} class="fi" required/></div>
              <div class="fg"><label>Age</label><input type="number" name="age" value={profile.age||''} class="fi"/></div>
            </div>
            <div class="fgrid">
              <div class="fg"><label>Gender</label><select name="gender" class="fi"><option value="">Select‚Ä¶</option><option value="male" selected={profile.gender==='male'}>Male</option><option value="female" selected={profile.gender==='female'}>Female</option><option value="other" selected={profile.gender==='other'}>Other</option></select></div>
              <div class="fg"><label>Goal</label><select name="goal" class="fi"><option value="">Select‚Ä¶</option><option value="lose_weight" selected={profile.goal==='lose_weight'}>Lose Weight</option><option value="maintain" selected={profile.goal==='maintain'}>Maintain</option><option value="gain_muscle" selected={profile.goal==='gain_muscle'}>Gain Muscle</option></select></div>
            </div>
            <div class="fgrid">
              <div class="fg"><label>Weight ({wLabel})</label><input type="number" name="weight_display" value={weightInputVal} step=".1" class="fi"/></div>
              <div class="fg"><label>Target ({wLabel})</label><input type="number" name="target_weight_display" value={targetInputVal} step=".1" class="fi"/></div>
            </div>
            {units==='imperial'?(
              <div class="fgrid">
                <div class="fg"><label>Height (ft)</label><input type="number" name="height_ft" value={heightFtVal} min="3" max="8" class="fi"/></div>
                <div class="fg"><label>Height (in)</label><input type="number" name="height_in" value={heightInVal} min="0" max="11" class="fi"/></div>
              </div>
            ):(
              <div class="fg" style="margin-bottom:1rem;"><label>Height (cm)</label><input type="number" name="height_cm" value={profile.height_cm||''} class="fi"/></div>
            )}
            <div class="fg" style="margin-bottom:1.25rem;"><label>Activity Level</label><select name="activity_level" class="fi"><option value="">Select‚Ä¶</option><option value="sedentary" selected={profile.activity_level==='sedentary'}>Sedentary</option><option value="light" selected={profile.activity_level==='light'}>Light (1‚Äì3√ó/wk)</option><option value="moderate" selected={profile.activity_level==='moderate'}>Moderate (3‚Äì5√ó/wk)</option><option value="active" selected={profile.activity_level==='active'}>Active (6‚Äì7√ó/wk)</option><option value="very_active" selected={profile.activity_level==='very_active'}>Very Active</option></select></div>
            <button type="submit" class="btn-save">üíæ Save Changes</button>
          </form>
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:1rem;">
        <div class="form-section">
          <div class="fsec-title">üì∑ Avatar</div>
          <div style="display:flex;align-items:center;gap:1.25rem;margin-bottom:1.25rem;">
            <div id="avaPreview" style="width:60px;height:60px;border-radius:15px;background:linear-gradient(135deg,var(--green),var(--blue));display:flex;align-items:center;justify-content:center;font-size:1.6rem;font-weight:900;color:#fff;overflow:hidden;flex-shrink:0;">
              {profile.avatar_url?.startsWith('emoji:')?profile.avatar_url.replace('emoji:',''):profile.avatar_url?<img src={profile.avatar_url} style="width:100%;height:100%;object-fit:cover;"/>:avatarLetter}
            </div>
            <div>
              <input type="file" id="avaUpload" accept="image/*" style="display:none;"/>
              <button onclick="document.getElementById('avaUpload').click()" class="btn-save" style="padding:.45rem .9rem;font-size:.75rem;margin-bottom:.4rem;display:block;">üìÅ Upload Image</button>
              <p style="font-size:.68rem;color:var(--muted);">JPG/PNG max 2MB</p>
            </div>
          </div>
          <div style="display:grid;grid-template-columns:repeat(8,1fr);gap:.3rem;margin-bottom:1rem;">
            {['üë§','üòä','üòé','ü§†','üë®','üë©','üßî','üë±','ü¶∏','üßô','ü§ñ','üëæ','üò∫','ü¶ä','üê∫','ü¶Å'].map(e=>(
              <button type="button" data-emoji={e} class="epick" style="font-size:1.3rem;padding:.3rem;border:1.5px solid var(--border);background:var(--surface);border-radius:7px;cursor:pointer;transition:all .15s;">{e}</button>
            ))}
          </div>
          <button id="saveAva" class="btn-save" style="width:100%;justify-content:center;">üíæ Save Avatar</button>
        </div>
        <div class="form-section">
          <div class="fsec-title">‚ö° Quick Actions</div>
          <a href="/dashboard" class="qa">üìä Dashboard</a>
          <a href="/dashboard/recipes" class="qa">üç≥ Recipes</a>
          <a href="/dashboard/shopping-list" class="qa">üõí Shopping List</a>
          <a href="/dashboard/upgrade" class="qa">‚¨ÜÔ∏è Upgrade Plan</a>
          <form action="/api/auth/logout" method="POST" style="margin:0;">
            <button type="submit" class="qa danger" style="width:100%;text-align:left;border-color:rgba(239,68,68,.15);">üö™ Logout</button>
          </form>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Weight Modal -->
<div id="weightModal" class="modal">
  <div class="modal-box">
    <div class="modal-head">
      <div class="modal-title">‚öñÔ∏è Log Weight</div>
      <button id="closeWM" class="modal-close">√ó</button>
    </div>
    <form id="weightForm" style="padding:1.25rem;display:flex;flex-direction:column;gap:.875rem;">
      <div class="fg"><label style="font-size:.7rem;font-weight:700;color:var(--soft);text-transform:uppercase;letter-spacing:.06em;">Weight ({wLabel})</label><input type="number" name="weight_display" step=".1" placeholder={units==='imperial'?'e.g. 165':'e.g. 75'} class="fi" style="font-size:1.05rem;font-weight:700;" required/></div>
      <div class="fg"><label style="font-size:.7rem;font-weight:700;color:var(--soft);text-transform:uppercase;letter-spacing:.06em;">Date</label><input type="date" name="date" value={new Date().toISOString().split('T')[0]} max={new Date().toISOString().split('T')[0]} class="fi" required/></div>
      <div class="fg"><label style="font-size:.7rem;font-weight:700;color:var(--soft);text-transform:uppercase;letter-spacing:.06em;">Notes (optional)</label><textarea name="notes" rows="2" placeholder="How are you feeling?" class="fi" style="resize:none;"></textarea></div>
      <div style="display:flex;gap:.625rem;">
        <button type="submit" class="btn-save" style="flex:1;justify-content:center;">‚úÖ Log Weight</button>
        <button type="button" id="cancelWM" class="btn-ghost">Cancel</button>
      </div>
    </form>
  </div>
</div>

<div class="toast" id="toast"></div>

<script is:inline define:vars={{ chartDataJson, xpDataJson, completionDataJson, weightChartLabel, currentUnits:units, ketoScore }}>
// THEME
const html = document.documentElement;
const themeBtn = document.getElementById('themeBtn');
function applyTheme(t){html.setAttribute('data-theme',t);localStorage.setItem('keto-theme',t);if(themeBtn)themeBtn.textContent=t==='dark'?'‚òÄÔ∏è':'üåô';}
applyTheme(localStorage.getItem('keto-theme')||'dark');
themeBtn?.addEventListener('click',()=>applyTheme(html.getAttribute('data-theme')==='dark'?'light':'dark'));

// NOTIF
const nb=document.getElementById('notifBtn'),nd=document.getElementById('notifDrop');
nb?.addEventListener('click',e=>{e.stopPropagation();nd?.classList.toggle('open');});
document.addEventListener('click',e=>{if(!nd?.contains(e.target)&&e.target!==nb)nd?.classList.remove('open');});

// TABS
function switchTab(n){document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));document.getElementById('tab-'+n)?.classList.add('active');document.querySelector(`[data-tab="${n}"]`)?.classList.add('active');}
document.querySelectorAll('.tab-btn').forEach(b=>b.addEventListener('click',()=>{const t=b.getAttribute('data-tab');if(t)switchTab(t);}));

// WEIGHT MODAL
const wm=document.getElementById('weightModal');
['openWM','openWM2'].forEach(id=>document.getElementById(id)?.addEventListener('click',()=>wm?.classList.add('open')));
['closeWM','cancelWM'].forEach(id=>document.getElementById(id)?.addEventListener('click',()=>wm?.classList.remove('open')));
wm?.addEventListener('click',e=>{if(e.target===wm)wm.classList.remove('open');});
document.getElementById('weightForm')?.addEventListener('submit',async function(e){
  e.preventDefault();
  const d=Object.fromEntries(new FormData(this).entries());
  const v=parseFloat(d.weight_display);
  d.weight_kg=currentUnits==='imperial'?(v/2.20462).toFixed(2):v;
  delete d.weight_display;
  const r=await fetch('/api/profile/add-weight',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)});
  if(r.ok){showToast('‚öñÔ∏è Weight logged!');wm?.classList.remove('open');setTimeout(()=>window.location.reload(),1000);}
  else showToast('‚ùå Failed');
});

// AVATAR in settings
let avaData=null;
const avaPrev=document.getElementById('avaPreview');
document.getElementById('avaUpload')?.addEventListener('change',function(e){
  const f=e.target.files?.[0];if(!f)return;
  if(f.size>2*1024*1024){showToast('‚ùå Max 2MB');return;}
  const r=new FileReader();
  r.onload=ev=>{avaData=ev.target.result;if(avaPrev)avaPrev.innerHTML=`<img src="${ev.target.result}" style="width:100%;height:100%;object-fit:cover;border-radius:15px;"/>`;};
  r.readAsDataURL(f);
});
document.querySelectorAll('.epick').forEach(b=>b.addEventListener('click',function(){
  const e=this.getAttribute('data-emoji');avaData='emoji:'+e;
  if(avaPrev)avaPrev.innerHTML=`<span style="font-size:1.6rem;">${e}</span>`;
  document.querySelectorAll('.epick').forEach(x=>x.style.borderColor='');
  this.style.borderColor='var(--green)';
}));
document.getElementById('saveAva')?.addEventListener('click',async function(){
  if(!avaData){showToast('‚ùå Select an avatar first');return;}
  const r=await fetch('/api/profile/update-avatar',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({avatar:avaData})});
  if(r.ok){showToast('‚úÖ Avatar saved!');setTimeout(()=>window.location.reload(),1000);}else showToast('‚ùå Failed');
});
// open avatar via hero click
document.getElementById('openAvatarBtn')?.addEventListener('click',()=>{switchTab('settings');setTimeout(()=>document.getElementById('saveAva')?.scrollIntoView({behavior:'smooth'}),200);});

// EDIT FORM
document.getElementById('editForm')?.addEventListener('submit',async function(e){
  e.preventDefault();
  const d=Object.fromEntries(new FormData(this).entries());
  const w=parseFloat(d.weight_display),t=parseFloat(d.target_weight_display);
  if(currentUnits==='imperial'){
    if(!isNaN(w))d.weight_kg=(w/2.20462).toFixed(2);
    if(!isNaN(t))d.target_weight_kg=(t/2.20462).toFixed(2);
    const ft=parseFloat(d.height_ft)||0,inch=parseFloat(d.height_in)||0;
    d.height_cm=Math.round((ft*12+inch)*2.54);
    delete d.height_ft;delete d.height_in;
  }else{if(!isNaN(w))d.weight_kg=w;if(!isNaN(t))d.target_weight_kg=t;}
  delete d.weight_display;delete d.target_weight_display;
  const r=await fetch('/api/profile/update',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)});
  if(r.ok){showToast('‚úÖ Profile saved!');setTimeout(()=>window.location.reload(),1000);}else showToast('‚ùå Failed');
});

// UNITS
async function setUnits(u){
  const r=await fetch('/api/profile/update-units',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({units:u})});
  if(r.ok)window.location.reload();else showToast('‚ùå Failed');
}
window.setUnits=setUnits;

// TOAST
function showToast(msg){const t=document.getElementById('toast');if(!t)return;t.textContent=msg;t.className='toast show';setTimeout(()=>t.classList.remove('show'),2800);}

// CHARTS
window.addEventListener('load',()=>{
  if(typeof Chart==='undefined')return;
  const dark=html.getAttribute('data-theme')==='dark';
  const tc=dark?'#e8edf5':'#0f172a',gc=dark?'rgba(255,255,255,.06)':'rgba(0,0,0,.05)';
  Chart.defaults.color=tc;
  const wd=JSON.parse(chartDataJson||'[]');
  const wc=document.getElementById('weightChart');
  if(wc&&wd.length>1){
    const ws=wd.map(x=>x.weight),mn=Math.min(...ws),mx=Math.max(...ws),rng=mx-mn;
    new Chart(wc,{type:'line',data:{labels:wd.map(x=>x.date),datasets:[{data:ws,borderColor:'#10b981',backgroundColor:'rgba(16,185,129,.08)',fill:true,tension:.4,borderWidth:2.5,pointRadius:4,pointBackgroundColor:'#10b981'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>`${ctx.parsed.y.toFixed(1)} ${weightChartLabel}`}}},scales:{y:{min:Math.floor(mn-rng*.2),max:Math.ceil(mx+rng*.2),grid:{color:gc},ticks:{callback:v=>v+' '+weightChartLabel}},x:{grid:{display:false}}}}});
  }
  const xd=JSON.parse(xpDataJson||'[]');
  const xc=document.getElementById('xpChart');
  if(xc&&xd.length>0)new Chart(xc,{type:'line',data:{labels:xd.map(x=>'D'+x.day),datasets:[{data:xd.map(x=>x.xp),borderColor:'#f59e0b',backgroundColor:'rgba(245,158,11,.08)',fill:true,tension:.4,borderWidth:2.5,pointRadius:3}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,grid:{color:gc}},x:{grid:{display:false},ticks:{maxTicksLimit:8}}}}});
  const cd=JSON.parse(completionDataJson||'[]');
  const cc=document.getElementById('completionChart');
  if(cc&&cd.length>0)new Chart(cc,{type:'bar',data:{labels:cd.map(x=>'D'+x.day),datasets:[{data:cd.map(x=>x.percentage),backgroundColor:cd.map(x=>x.percentage===100?'rgba(16,185,129,.7)':x.percentage>=75?'rgba(59,130,246,.7)':x.percentage>=50?'rgba(245,158,11,.7)':'rgba(239,68,68,.7)'),borderRadius:6}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{min:0,max:100,grid:{color:gc},ticks:{callback:v=>v+'%'}},x:{grid:{display:false},ticks:{maxTicksLimit:10,font:{size:10}}}}}});
  // Score ring animation
  const ring=document.getElementById('scoreRing');
  if(ring){const c=2*Math.PI*42;setTimeout(()=>{ring.style.strokeDashoffset=(c*(1-ketoScore/100)).toString();},400);}
});
</script>
</body>
</html>