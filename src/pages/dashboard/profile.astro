---
import { 
  supabase, getProfile, isSubscriptionActive, getWeightLogs, 
  getUserJourney, getDailyTasks, getWaterIntake, getXPTransactions, 
  calculateBMI, calculateCalorieTarget,
  formatWeight, formatHeight, weightLabel,
  kgToLbs, getPlan,
  type UnitSystem
} from '../../lib/supabase';

const accessToken = Astro.cookies.get('sb-access-token')?.value;
if (!accessToken) return Astro.redirect('/login');

const { data: { user } } = await supabase.auth.getUser(accessToken);
if (!user) return Astro.redirect('/login');

const profile = await getProfile(user.id);
if (!profile || !isSubscriptionActive(profile)) return Astro.redirect('/dashboard/upgrade');

// â”€â”€ Units & Plan â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const units: UnitSystem = (profile.preferred_units as UnitSystem) || 'imperial';
const wLabel = weightLabel(units);
const plan = getPlan(profile.subscription_tier);

// â”€â”€ Journey & Tasks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const journey = await getUserJourney(user.id);
const currentDay = journey?.current_day || 1;
const dailyTasks = await getDailyTasks(user.id, currentDay);
await getWaterIntake(user.id, currentDay);
const incompleteTasks = dailyTasks?.filter(
  t => t.task_type !== 'reflection' && t.task_type !== 'weight' && !t.completed
) || [];

const weightLogs = await getWeightLogs(user.id, 30);
const { data: allTasks } = await supabase
  .from('daily_tasks').select('*').eq('user_id', user.id)
  .order('day_number', { ascending: true });
const xpTransactions = await getXPTransactions(user.id, 30);

// â”€â”€ Charts data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const completionData: {day:number;percentage:number;completed:number;total:number}[] = [];
for (let day = 1; day <= Math.min(journey?.current_day || 1, 30); day++) {
  const dt = allTasks?.filter(t => t.day_number === day) || [];
  const dc = dt.filter(t => t.completed).length;
  completionData.push({ day, percentage: dt.length > 0 ? Math.round((dc / dt.length) * 100) : 0, completed: dc, total: dt.length });
}
const xpData: {day:number;xp:number}[] = [];
let cXP = 0;
for (let day = 1; day <= Math.min(journey?.current_day || 1, 30); day++) {
  cXP += xpTransactions?.filter(t => t.day_number === day).reduce((s,t) => s + (t.xp_amount||0), 0) || 0;
  xpData.push({ day, xp: cXP });
}

// â”€â”€ Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const totalDaysCompleted = journey?.current_day ? journey.current_day - 1 : 0;
const currentStreak  = journey?.streak_days    || 0;
const longestStreak  = journey?.longest_streak || 0;
const perfectDays    = journey?.perfect_days   || 0;
const totalXP        = journey?.total_xp       || 0;
const level          = journey?.level          || 1;

const currentWeight = profile.weight_kg || 0;
const startWeight   = weightLogs.length > 0 ? weightLogs[weightLogs.length - 1].weight_kg : currentWeight;
const weightChange  = startWeight - currentWeight;
const targetWeight  = profile.target_weight_kg || currentWeight - 5;
const weightToLose  = currentWeight - targetWeight;
const progressPercent = weightToLose > 0 ? ((startWeight - currentWeight) / (startWeight - targetWeight)) * 100 : 0;

const bmi = profile.weight_kg && profile.height_cm ? await calculateBMI(profile.weight_kg, profile.height_cm) : null;
function getBMICategory(b: number | null) {
  if (!b)     return { label: 'Unknown',     color: 'gray'   };
  if (b < 18.5) return { label: 'Underweight', color: 'blue'   };
  if (b < 25)   return { label: 'Normal',      color: 'green'  };
  if (b < 30)   return { label: 'Overweight',  color: 'yellow' };
  return { label: 'Obese', color: 'red' };
}
const bmiCategory   = getBMICategory(bmi);
const calorieTarget = await calculateCalorieTarget(profile);
const fatGrams      = Math.round((calorieTarget * 0.70) / 9);
const proteinGrams  = Math.round((calorieTarget * 0.25) / 4);
const carbGrams     = Math.round((calorieTarget * 0.05) / 4);

const daysLeft = profile.subscription_end_date
  ? Math.max(0, Math.ceil((new Date(profile.subscription_end_date).getTime() - Date.now()) / 86400000)) : 0;
const subscriptionProgress = daysLeft > 0 ? ((30 - daysLeft) / 30) * 100 : 100;

const achievementsList = [
  { name:'First Step',       description:'Complete your first day',   icon:'ğŸ¯', unlocked: perfectDays  >= 1  },
  { name:'Week Warrior',     description:'Complete 7 days perfectly', icon:'ğŸ“…', unlocked: perfectDays  >= 7  },
  { name:'Two Weeks Strong', description:'Complete 14 days perfectly',icon:'ğŸ’ª', unlocked: perfectDays  >= 14 },
  { name:'On Fire',          description:'7 day streak',              icon:'ğŸ”¥', unlocked: currentStreak>= 7  },
  { name:'Level Master',     description:'Reach Level 5',             icon:'â­', unlocked: level        >= 5  },
  { name:'XP Hunter',        description:'Earn 500 XP',               icon:'ğŸ…', unlocked: totalXP      >= 500 },
  { name:'First Kilo',       description:'Lose 1 kg / 2.2 lbs',      icon:'âš–ï¸', unlocked: weightChange >= 1  },
  { name:'Five Down',        description:'Lose 5 kg / 11 lbs',       icon:'ğŸ†', unlocked: weightChange >= 5  },
  { name:'Halfway Hero',     description:'Reach Day 15',              icon:'ğŸŒŸ', unlocked: currentDay   >= 15 },
  { name:'Keto Champion',    description:'Complete 30 days',          icon:'ğŸ‘‘', unlocked: currentDay   >= 30 },
];
const unlockedAchievements = achievementsList.filter(a => a.unlocked);
const lockedAchievements   = achievementsList.filter(a => !a.unlocked);

// Weight chart converted to display units
const chartData = weightLogs.slice().reverse().map(log => ({
  date: new Date(log.date).toLocaleDateString('en-US', { month:'short', day:'numeric' }),
  weight: units === 'imperial' ? kgToLbs(log.weight_kg) : log.weight_kg,
}));
const weightChartLabel = units === 'imperial' ? 'lbs' : 'kg';

const totalTasksCompleted = allTasks?.filter(t => t.completed).length || 0;
const totalMealsCompleted = allTasks?.filter(t => t.completed && ['breakfast','lunch','dinner','snack'].includes(t.task_type)).length || 0;
const { data: waterData } = await supabase.from('water_intake').select('glasses_count').eq('user_id', user.id);
const totalWaterGlasses = waterData?.reduce((s,w) => s + w.glasses_count, 0) || 0;

// Display helpers
const displayWeight       = formatWeight(currentWeight, units);
const displayTargetWeight = formatWeight(targetWeight,  units);
const displayHeight       = profile.height_cm
  ? (units === 'imperial'
      ? (() => { const ti = profile.height_cm! / 2.54; return `${Math.floor(ti/12)}'${Math.round(ti%12)}"`; })()
      : `${profile.height_cm} cm`)
  : 'â€”';

// Edit form input defaults
const weightInputVal = profile.weight_kg ? (units==='imperial' ? kgToLbs(profile.weight_kg) : profile.weight_kg) : '';
const targetInputVal = profile.target_weight_kg ? (units==='imperial' ? kgToLbs(profile.target_weight_kg) : profile.target_weight_kg) : '';
const heightFtVal = profile.height_cm && units==='imperial' ? Math.floor(profile.height_cm/2.54/12) : '';
const heightInVal = profile.height_cm && units==='imperial' ? Math.round((profile.height_cm/2.54)%12) : '';
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Profile â€“ Keto Journey</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root{--bg-primary:#fff;--bg-secondary:#f9fafb;--bg-card:#fff;--text-primary:#111827;--text-secondary:#6b7280;--border-color:#e5e7eb;--accent-primary:#10b981;--accent-secondary:#34d399;--shadow-sm:0 1px 3px rgba(0,0,0,.1);--shadow-md:0 4px 6px rgba(0,0,0,.1);--shadow-lg:0 10px 15px rgba(0,0,0,.1);--shadow-xl:0 20px 25px rgba(0,0,0,.15);}
    [data-theme="dark"]{--bg-primary:#1a1a2e;--bg-secondary:#16213e;--bg-card:#0f3460;--text-primary:#eaeaea;--text-secondary:#a0aec0;--border-color:#2d3748;--shadow-sm:0 1px 3px rgba(0,0,0,.3);--shadow-md:0 4px 6px rgba(0,0,0,.4);--shadow-lg:0 10px 15px rgba(0,0,0,.5);--shadow-xl:0 20px 25px rgba(0,0,0,.6);}
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg-secondary);color:var(--text-primary);transition:all .3s ease;}
    .container{max-width:1400px;margin:0 auto;padding:0 1.5rem;}
    nav{background:var(--bg-primary);border-bottom:1px solid var(--border-color);padding:1rem 0;position:sticky;top:0;z-index:50;box-shadow:var(--shadow-md);}
    nav a{color:var(--text-secondary);text-decoration:none;padding:.5rem 1rem;border-radius:.75rem;font-weight:500;transition:all .3s ease;}
    nav a:hover,nav a.active{color:var(--accent-primary);background:linear-gradient(135deg,rgba(16,185,129,.1),rgba(52,211,153,.1));transform:translateY(-2px);}
    .theme-toggle{position:relative;width:60px;height:30px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:9999px;cursor:pointer;box-shadow:inset 0 2px 4px rgba(0,0,0,.2),var(--shadow-md);transition:all .3s;}
    .theme-toggle-slider{position:absolute;top:3px;left:3px;width:24px;height:24px;background:white;border-radius:50%;transition:all .3s;box-shadow:0 2px 4px rgba(0,0,0,.3);display:flex;align-items:center;justify-content:center;font-size:.75rem;}
    [data-theme="dark"] .theme-toggle{background:linear-gradient(135deg,#2d3561,#1a1f3a);}
    [data-theme="dark"] .theme-toggle-slider{transform:translateX(30px);background:#1a1a2e;color:#fbbf24;}
    .notification-bell{position:relative;background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));border:none;width:2.5rem;height:2.5rem;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .3s;box-shadow:var(--shadow-md);}
    .notification-bell:hover{transform:translateY(-4px) scale(1.05);box-shadow:var(--shadow-xl);}
    .notification-badge{position:absolute;top:-4px;right:-4px;background:linear-gradient(135deg,#ef4444,#dc2626);color:white;width:20px;height:20px;border-radius:50%;font-size:.75rem;font-weight:700;display:flex;align-items:center;justify-content:center;animation:pulse 2s infinite;}
    @keyframes pulse{0%,100%{transform:scale(1);}50%{transform:scale(1.15);}}
    .notification-dropdown{position:absolute;top:calc(100% + .5rem);right:0;width:380px;max-height:500px;background:var(--bg-card);border-radius:1.5rem;box-shadow:var(--shadow-xl);border:1px solid var(--border-color);display:none;overflow:hidden;}
    .notification-dropdown.active{display:block;animation:slideDown .4s cubic-bezier(.68,-.55,.265,1.55);}
    @keyframes slideDown{from{opacity:0;transform:translateY(-20px) scale(.95);}to{opacity:1;transform:translateY(0) scale(1);}}
    .notification-item{padding:1rem 1.5rem;border-bottom:1px solid var(--border-color);display:flex;gap:1rem;align-items:center;transition:all .3s;cursor:pointer;}
    .notification-item:hover{background:linear-gradient(90deg,rgba(16,185,129,.05),transparent);transform:translateX(4px);}
    .notification-icon{width:3rem;height:3rem;background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));border-radius:1rem;display:flex;align-items:center;justify-content:center;font-size:1.5rem;flex-shrink:0;}
    .hero-profile{background:linear-gradient(135deg,#10b981,#059669,#047857);border-radius:2rem;padding:3rem;margin-bottom:2rem;box-shadow:var(--shadow-xl);position:relative;overflow:hidden;}
    .hero-profile::before{content:'';position:absolute;top:-50%;right:-50%;width:200%;height:200%;background:radial-gradient(circle,rgba(255,255,255,.1) 0%,transparent 70%);animation:rotate 20s linear infinite;}
    @keyframes rotate{from{transform:rotate(0deg);}to{transform:rotate(360deg);}}
    .avatar-3d{width:10rem;height:10rem;border-radius:50%;border:5px solid white;box-shadow:0 10px 30px rgba(0,0,0,.3);display:flex;align-items:center;justify-content:center;font-size:5rem;background:rgba(255,255,255,.2);backdrop-filter:blur(10px);position:relative;transition:all .4s;}
    .avatar-3d:hover{transform:scale(1.1) rotateY(10deg);}
    .avatar-edit-btn{position:absolute;bottom:.5rem;right:.5rem;background:white;color:var(--accent-primary);width:3rem;height:3rem;border-radius:50%;border:none;display:flex;align-items:center;justify-content:center;font-size:1.5rem;cursor:pointer;box-shadow:var(--shadow-lg);transition:all .3s;}
    .avatar-edit-btn:hover{transform:scale(1.15) rotate(15deg);}
    .stat-card-3d{background:var(--bg-card);border-radius:1.5rem;padding:2rem;border:1px solid var(--border-color);box-shadow:var(--shadow-lg);transition:all .4s cubic-bezier(.68,-.55,.265,1.55);position:relative;overflow:hidden;}
    .stat-card-3d::before{content:'';position:absolute;top:-50%;right:-50%;width:200%;height:200%;background:radial-gradient(circle,rgba(16,185,129,.05) 0%,transparent 70%);animation:rotate 15s linear infinite;}
    .stat-card-3d:hover{transform:translateY(-10px) scale(1.02);box-shadow:var(--shadow-xl);border-color:var(--accent-primary);}
    .stat-icon-3d{width:4rem;height:4rem;background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));border-radius:1.25rem;display:flex;align-items:center;justify-content:center;font-size:2rem;margin-bottom:1.5rem;box-shadow:var(--shadow-md);position:relative;z-index:1;}
    .card-3d{background:var(--bg-card);border-radius:1.5rem;padding:2rem;box-shadow:var(--shadow-lg);border:1px solid var(--border-color);transition:all .3s;}
    .card-3d:hover{box-shadow:var(--shadow-xl);transform:translateY(-4px);}
    .btn-3d{display:inline-flex;align-items:center;gap:.5rem;padding:.875rem 1.75rem;border-radius:1rem;font-weight:700;cursor:pointer;border:none;text-decoration:none;transition:all .3s cubic-bezier(.68,-.55,.265,1.55);position:relative;overflow:hidden;}
    .btn-3d::before{content:'';position:absolute;top:50%;left:50%;width:0;height:0;border-radius:50%;background:rgba(255,255,255,.3);transform:translate(-50%,-50%);transition:width .6s,height .6s;}
    .btn-3d:hover::before{width:300px;height:300px;}
    .btn-primary-3d{background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));color:white;box-shadow:var(--shadow-md);}
    .btn-primary-3d:hover{transform:translateY(-4px) scale(1.05);box-shadow:var(--shadow-xl);}
    .btn-secondary-3d{background:var(--bg-card);color:var(--text-primary);border:2px solid var(--border-color);}
    .btn-secondary-3d:hover{border-color:var(--accent-primary);transform:translateY(-2px);}
    .progress-3d{width:100%;height:1rem;background:var(--border-color);border-radius:9999px;overflow:hidden;box-shadow:inset 0 2px 4px rgba(0,0,0,.1);}
    .progress-fill-3d{height:100%;background:linear-gradient(90deg,var(--accent-primary),var(--accent-secondary),#3b82f6);border-radius:9999px;transition:width .6s cubic-bezier(.68,-.55,.265,1.55);position:relative;}
    .progress-fill-3d::after{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.3),transparent);animation:shimmer 2s infinite;}
    @keyframes shimmer{0%{transform:translateX(-100%);}100%{transform:translateX(100%);}}
    .achievement-badge{background:var(--bg-card);border-radius:1.25rem;padding:1.25rem;border:2px solid var(--border-color);transition:all .3s;display:flex;align-items:center;gap:1rem;}
    .achievement-badge.unlocked{background:linear-gradient(135deg,rgba(16,185,129,.1),rgba(52,211,153,.1));border-color:var(--accent-primary);}
    .achievement-badge:hover{transform:scale(1.05);box-shadow:var(--shadow-lg);}
    .units-toggle-wrap{display:inline-flex;background:rgba(0,0,0,.2);backdrop-filter:blur(10px);border-radius:1rem;padding:.375rem;gap:.375rem;}
    .units-btn{padding:.625rem 1.25rem;border-radius:.75rem;border:none;font-weight:700;font-size:.9375rem;cursor:pointer;transition:all .3s cubic-bezier(.68,-.55,.265,1.55);}
    .units-btn.active{background:white;color:#059669;}
    .units-btn.inactive{background:transparent;color:rgba(255,255,255,.7);}
    .units-btn.inactive:hover{color:white;}
    .form-input{width:100%;padding:1rem;border:2px solid var(--border-color);border-radius:1rem;background:var(--bg-secondary);color:var(--text-primary);font-size:1rem;transition:all .3s;}
    .form-input:focus{outline:none;border-color:var(--accent-primary);box-shadow:0 0 0 3px rgba(16,185,129,.1);}
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(8px);z-index:100;display:none;align-items:center;justify-content:center;padding:1rem;}
    .modal-overlay.active{display:flex;}
    .modal-content{background:var(--bg-primary);border-radius:2rem;box-shadow:var(--shadow-xl);max-width:600px;width:100%;max-height:90vh;overflow-y:auto;animation:modalSlideUp .4s cubic-bezier(.68,-.55,.265,1.55);}
    @keyframes modalSlideUp{from{opacity:0;transform:translateY(50px) scale(.9);}to{opacity:1;transform:translateY(0) scale(1);}}
    .modal-header{background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));padding:2rem;border-radius:2rem 2rem 0 0;color:white;}
    .grid{display:grid;gap:1.5rem;}
    .grid-2{grid-template-columns:repeat(auto-fit,minmax(300px,1fr));}
    .grid-3{grid-template-columns:repeat(auto-fit,minmax(250px,1fr));}
    .grid-4{grid-template-columns:repeat(auto-fit,minmax(220px,1fr));}
    .flex{display:flex;align-items:center;}
    .flex-between{display:flex;justify-content:space-between;align-items:center;}
    .gap-2{gap:1rem;}.gap-3{gap:1.5rem;}
    .mb-4{margin-bottom:2rem;}
    @media(max-width:768px){.grid-2,.grid-3,.grid-4{grid-template-columns:1fr;}.notification-dropdown{width:calc(100vw - 2rem);right:-1rem;}.hero-profile{padding:2rem;}.avatar-3d{width:8rem;height:8rem;font-size:4rem;}}
  </style>
</head>
<body>

<nav>
  <div class="container">
    <div class="flex-between">
      <div class="flex gap-2">
        <span style="font-size:2.5rem;">ğŸ¥‘</span>
        <div>
          <h1 style="font-size:1.375rem;font-weight:800;background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;">Keto Journey</h1>
          <p style="font-size:.8125rem;color:var(--text-secondary);font-weight:600;">{plan.name} Plan Â· {plan.durationDays} Days</p>
        </div>
      </div>
      <div class="flex gap-3">
        <a href="/dashboard/">Dashboard</a>
        <a href="/dashboard/shopping-list">Shopping</a>
        <a href="/dashboard/recipes">Recipes</a>
        <a href="/dashboard/profile" class="active">Profile</a>
        <a href="/dashboard/notifications">ğŸ”” Reminders</a>
        <div class="flex gap-2" style="padding-left:1rem;border-left:1px solid var(--border-color);position:relative;">
          <div class="theme-toggle" id="themeToggle"><div class="theme-toggle-slider"><span id="themeIcon">â˜€ï¸</span></div></div>
          {incompleteTasks.length > 0 && (
            <div style="position:relative;">
              <button class="notification-bell" id="notif-bell">
                <span style="color:white;">ğŸ””</span>
                <span class="notification-badge">{incompleteTasks.length}</span>
              </button>
              <div class="notification-dropdown" id="notificationDropdown">
                <div style="padding:1.5rem;border-bottom:1px solid var(--border-color);background:linear-gradient(135deg,rgba(16,185,129,.1),rgba(52,211,153,.1));">
                  <h3 style="font-size:1.125rem;font-weight:800;color:var(--accent-primary);display:flex;align-items:center;gap:.75rem;"><span>ğŸ””</span><span>{incompleteTasks.length} Pending</span></h3>
                </div>
                <div style="max-height:400px;overflow-y:auto;">
                  {incompleteTasks.map(task => (
                    <div class="notification-item">
                      <div class="notification-icon">{task.task_type==='breakfast'&&'ğŸ³'}{task.task_type==='lunch'&&'ğŸ¥—'}{task.task_type==='dinner'&&'ğŸ½ï¸'}{task.task_type==='snack'&&'ğŸ'}{task.task_type==='water'&&'ğŸ’§'}</div>
                      <div style="flex:1;"><div style="font-weight:700;color:var(--text-primary);">{task.task_title}</div><div style="font-size:.8125rem;color:var(--text-secondary);">+{task.xp_earned} XP</div></div>
                    </div>
                  ))}
                </div>
                <div style="padding:1.25rem;border-top:1px solid var(--border-color);text-align:center;">
                  <a href="/dashboard/" class="btn-3d btn-primary-3d" style="width:100%;justify-content:center;">View All Tasks â†’</a>
                </div>
              </div>
            </div>
          )}
          <a href="/dashboard/profile" style="width:2.5rem;height:2.5rem;background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:800;text-decoration:none;font-size:1.125rem;">
            {profile.full_name.charAt(0).toUpperCase()}
          </a>
        </div>
      </div>
    </div>
  </div>
</nav>

<div class="container" style="padding-top:2rem;padding-bottom:4rem;">

  <!-- Hero -->
  <div class="hero-profile">
    <div style="position:relative;z-index:10;display:flex;flex-direction:column;align-items:center;gap:2rem;">
      <div style="position:relative;">
        <div class="avatar-3d">
          {profile.avatar_url?.startsWith('emoji:') ? <span>{profile.avatar_url.replace('emoji:','')}</span>
          : profile.avatar_url ? <img src={profile.avatar_url} alt={profile.full_name} style="width:100%;height:100%;object-fit:cover;border-radius:50%;"/>
          : <span>ğŸ‘¤</span>}
        </div>
        <button class="avatar-edit-btn" id="open-avatar-modal">ğŸ“·</button>
      </div>
      <div style="text-align:center;color:white;">
        <div style="display:flex;align-items:center;gap:1rem;justify-content:center;margin-bottom:1rem;">
          <h1 style="font-size:3rem;font-weight:900;text-shadow:0 4px 8px rgba(0,0,0,.3);">{profile.full_name}</h1>
          <button id="open-edit-modal" style="background:rgba(255,255,255,.2);backdrop-filter:blur(10px);border:none;padding:.75rem;border-radius:1rem;cursor:pointer;font-size:1.5rem;transition:all .3s;">âœï¸</button>
        </div>
        <p style="font-size:1.125rem;opacity:.9;margin-bottom:1.5rem;">{profile.email}</p>
        <div style="display:flex;flex-wrap:wrap;gap:1rem;justify-content:center;margin-bottom:1.5rem;">
          <span style="display:inline-flex;align-items:center;gap:.5rem;padding:.75rem 1.5rem;background:rgba(255,255,255,.25);backdrop-filter:blur(10px);border-radius:9999px;font-weight:800;">
            <span style="font-size:1.5rem;">{plan.emoji}</span><span>{plan.name} Plan</span>
          </span>
          <span style="display:inline-flex;align-items:center;gap:.5rem;padding:.75rem 1.5rem;background:rgba(255,255,255,.2);backdrop-filter:blur(10px);border-radius:9999px;font-weight:700;">
            ğŸ”¥ {currentStreak} Day Streak
          </span>
          <span style="display:inline-flex;align-items:center;gap:.5rem;padding:.75rem 1.5rem;background:rgba(255,255,255,.2);backdrop-filter:blur(10px);border-radius:9999px;font-weight:700;">
            ğŸ† {unlockedAchievements.length}/{achievementsList.length} Badges
          </span>
        </div>
        <!-- Units Toggle -->
        <div class="units-toggle-wrap">
          <button onclick="setUnits('imperial')" class={`units-btn ${units==='imperial'?'active':'inactive'}`}>ğŸ‡ºğŸ‡¸ lbs / ft</button>
          <button onclick="setUnits('metric')"   class={`units-btn ${units==='metric'  ?'active':'inactive'}`}>ğŸŒ kg / cm</button>
        </div>
      </div>
      <div style="background:rgba(255,255,255,.2);backdrop-filter:blur(10px);border-radius:2rem;padding:2rem;text-align:center;box-shadow:var(--shadow-xl);">
        <div style="font-size:.875rem;opacity:.9;margin-bottom:.5rem;font-weight:600;">Days Completed</div>
        <div style="font-size:4rem;font-weight:900;text-shadow:0 4px 8px rgba(0,0,0,.3);">{totalDaysCompleted}</div>
        <div style="font-size:.875rem;opacity:.9;">out of {plan.durationDays} days</div>
      </div>
    </div>
  </div>

  <!-- Stats Grid -->
  <div class="grid grid-4 mb-4">
    <div class="stat-card-3d">
      <div class="stat-icon-3d">âš–ï¸</div>
      <div style="font-size:.875rem;color:var(--text-secondary);font-weight:700;text-transform:uppercase;letter-spacing:.05em;margin-bottom:.5rem;position:relative;z-index:1;">Current Weight</div>
      <div style="font-size:2rem;font-weight:900;background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;position:relative;z-index:1;">{displayWeight}</div>
      <div style="font-size:.875rem;color:var(--text-secondary);margin-top:.5rem;position:relative;z-index:1;">Target: {displayTargetWeight}</div>
      <div style="margin-top:1rem;position:relative;z-index:1;"><div class="progress-3d" style="height:6px;"><div class="progress-fill-3d" style={`width:${Math.min(100,progressPercent)}%`}></div></div></div>
    </div>
    <div class="stat-card-3d">
      <div class="stat-icon-3d">ğŸ“</div>
      <div style="font-size:.875rem;color:var(--text-secondary);font-weight:700;text-transform:uppercase;letter-spacing:.05em;margin-bottom:.5rem;position:relative;z-index:1;">Height / BMI</div>
      <div style="font-size:2rem;font-weight:900;background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;position:relative;z-index:1;">{displayHeight}</div>
      <div style="margin-top:1rem;position:relative;z-index:1;"><span style="padding:.375rem 1rem;border-radius:9999px;font-size:.8125rem;font-weight:700;background:linear-gradient(135deg,rgba(16,185,129,.15),rgba(52,211,153,.15));color:var(--accent-primary);border:2px solid var(--accent-primary);">BMI {bmi?bmi.toFixed(1):'N/A'} â€” {bmiCategory.label}</span></div>
    </div>
    <div class="stat-card-3d">
      <div class="stat-icon-3d">ğŸ”¥</div>
      <div style="font-size:.875rem;color:var(--text-secondary);font-weight:700;text-transform:uppercase;letter-spacing:.05em;margin-bottom:.5rem;position:relative;z-index:1;">Streak</div>
      <div style="font-size:2.5rem;font-weight:900;background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;position:relative;z-index:1;">{currentStreak} <span style="font-size:1.25rem;opacity:.7;">days</span></div>
      <div style="margin-top:1rem;font-size:.8125rem;color:var(--text-secondary);position:relative;z-index:1;">Longest: {longestStreak} days</div>
    </div>
    <div class="stat-card-3d">
      <div class="stat-icon-3d">ğŸ“…</div>
      <div style="font-size:.875rem;color:var(--text-secondary);font-weight:700;text-transform:uppercase;letter-spacing:.05em;margin-bottom:.5rem;position:relative;z-index:1;">Days Left</div>
      <div style="font-size:2.5rem;font-weight:900;background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;position:relative;z-index:1;">{daysLeft}</div>
      <div style="margin-top:1rem;position:relative;z-index:1;"><div class="progress-3d" style="height:6px;"><div class="progress-fill-3d" style={`width:${subscriptionProgress}%`}></div></div></div>
    </div>
  </div>

  <!-- Content Grid -->
  <div class="grid grid-2">
    <!-- Left -->
    <div style="display:flex;flex-direction:column;gap:2rem;">

      <!-- Weight Chart -->
      <div class="card-3d">
        <div class="flex-between mb-4">
          <div>
            <h2 style="font-size:1.5rem;font-weight:800;background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;display:flex;align-items:center;gap:.75rem;">ğŸ“ˆ Weight Progress</h2>
            <p style="font-size:.875rem;color:var(--text-secondary);margin-top:.25rem;">Showing in {units==='imperial'?'lbs':'kg'}</p>
          </div>
          <button id="open-weight-modal" class="btn-3d btn-primary-3d">â• Add Weight</button>
        </div>
        {chartData.length > 1 ? (
          <div style="position:relative;height:300px;"><canvas id="weightChart"></canvas></div>
        ) : (
          <div style="height:300px;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(135deg,rgba(16,185,129,.05),rgba(52,211,153,.05));border-radius:1rem;border:2px dashed var(--accent-primary);">
            <span style="font-size:5rem;margin-bottom:1rem;">ğŸ“Š</span>
            <h3 style="font-size:1.5rem;font-weight:700;margin-bottom:.75rem;">Start Tracking</h3>
            <p style="color:var(--text-secondary);margin-bottom:1.5rem;">Log your weight to see progress!</p>
            <button id="open-weight-modal-2" class="btn-3d btn-primary-3d">â• Add First Entry</button>
          </div>
        )}
      </div>

      <!-- XP Chart -->
      <div class="card-3d">
        <h2 style="font-size:1.5rem;font-weight:800;background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;display:flex;align-items:center;gap:.75rem;margin-bottom:1.5rem;">âš¡ XP Progress</h2>
        {xpData.length>0 ? <div style="position:relative;height:300px;"><canvas id="xpChart"></canvas></div>
        : <div style="height:300px;display:flex;align-items:center;justify-content:center;color:var(--text-secondary);text-align:center;"><div><span style="font-size:4rem;display:block;margin-bottom:1rem;">âš¡</span><p>Complete tasks to earn XP!</p></div></div>}
      </div>

      <!-- Completion Chart -->
      <div class="card-3d">
        <h2 style="font-size:1.5rem;font-weight:800;background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;display:flex;align-items:center;gap:.75rem;margin-bottom:1.5rem;">ğŸ“Š Daily Completion</h2>
        {completionData.length>0 ? <div style="position:relative;height:300px;"><canvas id="completionChart"></canvas></div>
        : <div style="height:300px;display:flex;align-items:center;justify-content:center;color:var(--text-secondary);text-align:center;"><div><span style="font-size:4rem;display:block;margin-bottom:1rem;">ğŸ“Š</span><p>Complete your first day!</p></div></div>}
      </div>

      <!-- Nutrition -->
      <div class="card-3d">
        <h2 style="font-size:1.5rem;font-weight:800;background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;display:flex;align-items:center;gap:.75rem;margin-bottom:1.5rem;">ğŸ¥‘ Daily Nutrition Targets</h2>
        <div class="grid grid-2" style="gap:1rem;">
          {[
            {icon:'ğŸ”¥',label:'Calories',value:`${calorieTarget} kcal`,color:'#ef4444',bg:'rgba(239,68,68,.1)'},
            {icon:'ğŸ¥©',label:'Protein', value:`${proteinGrams}g`,     color:'#dc2626',bg:'rgba(220,38,38,.1)'},
            {icon:'ğŸ¥“',label:'Fat',     value:`${fatGrams}g`,         color:'#10b981',bg:'rgba(16,185,129,.1)'},
            {icon:'ğŸŒ¾',label:'Net Carbs',value:`${carbGrams}g`,      color:'#f59e0b',bg:'rgba(245,158,11,.1)'},
          ].map(item=>(
            <div style={`padding:1.25rem;background:${item.bg};border-radius:1rem;border:2px solid ${item.color};`}>
              <div style="display:flex;align-items:center;gap:.75rem;">
                <span style="font-size:2.5rem;">{item.icon}</span>
                <div><div style="font-size:.8125rem;color:var(--text-secondary);font-weight:600;">{item.label}</div><div style={`font-size:1.75rem;font-weight:800;color:${item.color};`}>{item.value}</div></div>
              </div>
            </div>
          ))}
        </div>
        <div style="margin-top:1.5rem;padding:1.25rem;background:linear-gradient(135deg,rgba(59,130,246,.1),rgba(37,99,235,.1));border-radius:1rem;border:2px solid #3b82f6;text-align:center;">
          <p style="font-weight:700;color:#2563eb;">Keto Ratio: 70% Fat Â· 25% Protein Â· 5% Carbs</p>
        </div>
      </div>

      <!-- Activity -->
      <div class="card-3d">
        <h2 style="font-size:1.5rem;font-weight:800;background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;display:flex;align-items:center;gap:.75rem;margin-bottom:1.5rem;">ğŸ“Š Activity Summary</h2>
        <div class="grid grid-3">
          {[
            {icon:'ğŸ½ï¸',label:'Meals',  value:totalMealsCompleted, color:'#7c3aed',bg:'rgba(139,92,246,.1)',border:'#8b5cf6'},
            {icon:'ğŸ’§',label:'Glasses', value:totalWaterGlasses,   color:'#2563eb',bg:'rgba(59,130,246,.1)', border:'#3b82f6'},
            {icon:'âœ…',label:'Tasks',   value:totalTasksCompleted, color:'#d97706',bg:'rgba(245,158,11,.1)', border:'#f59e0b'},
          ].map(item=>(
            <div style={`text-align:center;padding:1.5rem;background:${item.bg};border-radius:1rem;border:2px solid ${item.border};`}>
              <span style="font-size:3rem;display:block;margin-bottom:.75rem;">{item.icon}</span>
              <div style={`font-size:2rem;font-weight:800;color:${item.color};margin-bottom:.5rem;`}>{item.value}</div>
              <div style="font-size:.875rem;color:var(--text-secondary);font-weight:600;">{item.label}</div>
            </div>
          ))}
        </div>
      </div>
    </div>

    <!-- Right -->
    <div style="display:flex;flex-direction:column;gap:2rem;">
      <!-- Achievements -->
      <div class="card-3d">
        <h2 style="font-size:1.5rem;font-weight:800;background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;display:flex;align-items:center;gap:.75rem;margin-bottom:1.5rem;">ğŸ† Achievements</h2>
        {unlockedAchievements.length>0&&(
          <div style="margin-bottom:2rem;">
            <h3 style="font-size:.875rem;font-weight:700;color:var(--accent-primary);text-transform:uppercase;margin-bottom:1rem;">âœ… Unlocked ({unlockedAchievements.length})</h3>
            <div style="display:flex;flex-direction:column;gap:.75rem;max-height:280px;overflow-y:auto;">
              {unlockedAchievements.map(a=>(
                <div class="achievement-badge unlocked">
                  <span style="font-size:2.5rem;">{a.icon}</span>
                  <div style="flex:1;"><h4 style="font-weight:700;color:var(--text-primary);">{a.name}</h4><p style="font-size:.8125rem;color:var(--text-secondary);">{a.description}</p></div>
                  <span style="color:var(--accent-primary);font-size:1.5rem;">âœ“</span>
                </div>
              ))}
            </div>
          </div>
        )}
        {lockedAchievements.length>0&&(
          <div>
            <h3 style="font-size:.875rem;font-weight:700;color:var(--text-secondary);text-transform:uppercase;margin-bottom:1rem;">ğŸ”’ Locked ({lockedAchievements.length})</h3>
            <div style="display:flex;flex-direction:column;gap:.75rem;">
              {lockedAchievements.slice(0,5).map(a=>(
                <div class="achievement-badge" style="opacity:.6;">
                  <span style="font-size:2.5rem;filter:grayscale(1);">{a.icon}</span>
                  <div style="flex:1;"><h4 style="font-weight:700;color:var(--text-secondary);">{a.name}</h4><p style="font-size:.8125rem;color:var(--text-secondary);">{a.description}</p></div>
                  <span style="color:var(--text-secondary);">ğŸ”’</span>
                </div>
              ))}
            </div>
          </div>
        )}
      </div>

      <!-- Quick Actions -->
      <div class="card-3d" style="background:linear-gradient(135deg,rgba(16,185,129,.05),rgba(52,211,153,.05));border:2px solid var(--accent-primary);">
        <h2 style="font-size:1.25rem;font-weight:800;margin-bottom:1.5rem;background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;display:flex;align-items:center;gap:.75rem;">âš¡ Quick Actions</h2>
        <div style="display:flex;flex-direction:column;gap:1rem;">
          <a href="/dashboard/" class="btn-3d btn-primary-3d" style="width:100%;justify-content:center;">ğŸ“Š Go to Dashboard</a>
          <a href="/dashboard/recipes" class="btn-3d btn-secondary-3d" style="width:100%;justify-content:center;">ğŸ½ï¸ View Recipes</a>
          <button id="open-edit-modal-2" class="btn-3d btn-secondary-3d" style="width:100%;justify-content:center;">âœï¸ Edit Profile</button>
          <form action="/api/auth/logout" method="POST">
            <button type="submit" class="btn-3d" style="width:100%;justify-content:center;background:linear-gradient(135deg,#ef4444,#dc2626);color:white;box-shadow:var(--shadow-md);">ğŸšª Logout</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Avatar Modal -->
<div class="modal-overlay" id="avatarModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="flex-between">
        <h2 style="font-size:1.75rem;font-weight:900;display:flex;align-items:center;gap:.75rem;"><span>ğŸ“·</span><span>Change Avatar</span></h2>
        <button id="close-avatar-modal" style="background:rgba(255,255,255,.2);border:none;width:2.5rem;height:2.5rem;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.5rem;cursor:pointer;">Ã—</button>
      </div>
    </div>
    <div style="padding:2rem;">
      <div style="display:flex;justify-content:center;margin-bottom:2rem;">
        <div id="avatar-preview" style="width:8rem;height:8rem;border-radius:50%;background:var(--bg-secondary);display:flex;align-items:center;justify-content:center;font-size:4rem;overflow:hidden;border:4px solid var(--border-color);">
          {profile.avatar_url?.startsWith('emoji:') ? <span>{profile.avatar_url.replace('emoji:','')}</span> : profile.avatar_url ? <img src={profile.avatar_url} alt="Avatar" style="width:100%;height:100%;object-fit:cover;"/> : <span>ğŸ‘¤</span>}
        </div>
      </div>
      <div style="margin-bottom:1.5rem;">
        <label style="display:block;font-size:.875rem;font-weight:700;margin-bottom:.5rem;">Upload Image</label>
        <input type="file" id="avatar-upload" accept="image/*" class="form-input"/>
        <p style="font-size:.8125rem;color:var(--text-secondary);margin-top:.5rem;">Max 2MB Â· JPG/PNG</p>
      </div>
      <div style="margin-bottom:1.5rem;">
        <label style="display:block;font-size:.875rem;font-weight:700;margin-bottom:.75rem;">Or Choose Emoji</label>
        <div style="display:grid;grid-template-columns:repeat(8,1fr);gap:.5rem;">
          {['ğŸ‘¤','ğŸ˜Š','ğŸ˜','ğŸ¤ ','ğŸ‘¨','ğŸ‘©','ğŸ§”','ğŸ‘±','ğŸ¦¸','ğŸ§™','ğŸ§','ğŸ§›','ğŸ§Ÿ','ğŸ¤–','ğŸ‘¾','ğŸ˜º'].map(emoji=>(
            <button type="button" data-emoji={emoji} class="emoji-btn" style="font-size:2rem;padding:.5rem;border:2px solid var(--border-color);background:var(--bg-secondary);border-radius:.75rem;cursor:pointer;transition:all .3s;">{emoji}</button>
          ))}
        </div>
      </div>
      <button id="save-avatar-btn" class="btn-3d btn-primary-3d" style="width:100%;justify-content:center;">ğŸ’¾ Save Avatar</button>
    </div>
  </div>
</div>

<!-- Edit Modal -->
<div class="modal-overlay" id="editModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="flex-between">
        <h2 style="font-size:1.75rem;font-weight:900;display:flex;align-items:center;gap:.75rem;"><span>âœï¸</span><span>Edit Profile</span></h2>
        <button id="close-edit-modal" style="background:rgba(255,255,255,.2);border:none;width:2.5rem;height:2.5rem;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.5rem;cursor:pointer;">Ã—</button>
      </div>
    </div>
    <form id="edit-form" style="padding:2rem;display:flex;flex-direction:column;gap:1.5rem;">
      <div>
        <label style="display:block;font-size:.875rem;font-weight:700;margin-bottom:.5rem;">Full Name</label>
        <input type="text" name="full_name" value={profile.full_name} class="form-input" required/>
      </div>
      <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;">
        <div>
          <label style="display:block;font-size:.875rem;font-weight:700;margin-bottom:.5rem;">Age</label>
          <input type="number" name="age" value={profile.age||''} class="form-input"/>
        </div>
        <div>
          <label style="display:block;font-size:.875rem;font-weight:700;margin-bottom:.5rem;">Gender</label>
          <select name="gender" class="form-input">
            <option value="">Selectâ€¦</option>
            <option value="male"   selected={profile.gender==='male'}>Male</option>
            <option value="female" selected={profile.gender==='female'}>Female</option>
            <option value="other"  selected={profile.gender==='other'}>Other</option>
          </select>
        </div>
      </div>
      <div>
        <label style="display:block;font-size:.875rem;font-weight:700;margin-bottom:.5rem;">Weight ({wLabel})</label>
        <input type="number" name="weight_display" value={weightInputVal} step="0.1" class="form-input" placeholder={`Enter weight in ${wLabel}`}/>
        <p style="font-size:.8125rem;color:var(--text-secondary);margin-top:.375rem;">Currently: {displayWeight}</p>
      </div>
      {units==='imperial' ? (
        <div>
          <label style="display:block;font-size:.875rem;font-weight:700;margin-bottom:.5rem;">Height (ft / in)</label>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:.75rem;">
            <input type="number" name="height_ft" value={heightFtVal} min="3" max="8" class="form-input" placeholder="feet"/>
            <input type="number" name="height_in" value={heightInVal} min="0" max="11" class="form-input" placeholder="inches"/>
          </div>
          <p style="font-size:.8125rem;color:var(--text-secondary);margin-top:.375rem;">Currently: {displayHeight}</p>
        </div>
      ) : (
        <div>
          <label style="display:block;font-size:.875rem;font-weight:700;margin-bottom:.5rem;">Height (cm)</label>
          <input type="number" name="height_cm" value={profile.height_cm||''} class="form-input" placeholder="Enter height in cm"/>
        </div>
      )}
      <div>
        <label style="display:block;font-size:.875rem;font-weight:700;margin-bottom:.5rem;">Target Weight ({wLabel})</label>
        <input type="number" name="target_weight_display" value={targetInputVal} step="0.1" class="form-input"/>
      </div>
      <div>
        <label style="display:block;font-size:.875rem;font-weight:700;margin-bottom:.5rem;">Goal</label>
        <select name="goal" class="form-input">
          <option value="">Selectâ€¦</option>
          <option value="lose_weight"  selected={profile.goal==='lose_weight'}>Lose Weight</option>
          <option value="maintain"     selected={profile.goal==='maintain'}>Maintain Weight</option>
          <option value="gain_muscle"  selected={profile.goal==='gain_muscle'}>Gain Muscle</option>
        </select>
      </div>
      <div>
        <label style="display:block;font-size:.875rem;font-weight:700;margin-bottom:.5rem;">Activity Level</label>
        <select name="activity_level" class="form-input">
          <option value="">Selectâ€¦</option>
          <option value="sedentary"   selected={profile.activity_level==='sedentary'}>Sedentary (no exercise)</option>
          <option value="light"       selected={profile.activity_level==='light'}>Light (1â€“3 days/week)</option>
          <option value="moderate"    selected={profile.activity_level==='moderate'}>Moderate (3â€“5 days/week)</option>
          <option value="active"      selected={profile.activity_level==='active'}>Active (6â€“7 days/week)</option>
          <option value="very_active" selected={profile.activity_level==='very_active'}>Very Active (2Ã—/day)</option>
        </select>
      </div>
      <div style="display:flex;gap:1rem;padding-top:.5rem;">
        <button type="submit" class="btn-3d btn-primary-3d" style="flex:1;justify-content:center;">ğŸ’¾ Save Changes</button>
        <button type="button" id="close-edit-modal-2" class="btn-3d btn-secondary-3d">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Weight Modal -->
<div class="modal-overlay" id="weightModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="flex-between">
        <h2 style="font-size:1.75rem;font-weight:900;display:flex;align-items:center;gap:.75rem;"><span>âš–ï¸</span><span>Add Weight Entry</span></h2>
        <button id="close-weight-modal" style="background:rgba(255,255,255,.2);border:none;width:2.5rem;height:2.5rem;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.5rem;cursor:pointer;">Ã—</button>
      </div>
    </div>
    <form id="weight-form" style="padding:2rem;display:flex;flex-direction:column;gap:1.5rem;">
      <div>
        <label style="display:block;font-size:.875rem;font-weight:700;margin-bottom:.5rem;">Weight ({wLabel})</label>
        <input type="number" name="weight_display" step="0.1" min="50" max="700" placeholder={`Enter in ${wLabel}`} class="form-input" style="font-size:1.25rem;font-weight:700;" required/>
        <p style="font-size:.8125rem;color:var(--text-secondary);margin-top:.375rem;">{units==='imperial'?'Will be converted to kg automatically':'Saved directly in kg'}</p>
      </div>
      <div>
        <label style="display:block;font-size:.875rem;font-weight:700;margin-bottom:.5rem;">Date</label>
        <input type="date" name="date" value={new Date().toISOString().split('T')[0]} max={new Date().toISOString().split('T')[0]} class="form-input" required/>
      </div>
      <div>
        <label style="display:block;font-size:.875rem;font-weight:700;margin-bottom:.5rem;">Notes (optional)</label>
        <textarea name="notes" rows="3" placeholder="How are you feeling?" class="form-input" style="resize:none;"></textarea>
      </div>
      <div style="display:flex;gap:1rem;">
        <button type="submit" class="btn-3d btn-primary-3d" style="flex:1;justify-content:center;">âœ… Add Entry</button>
        <button type="button" id="close-weight-modal-2" class="btn-3d btn-secondary-3d">Cancel</button>
      </div>
    </form>
  </div>
</div>

<script is:inline define:vars={{
  chartData: JSON.stringify(chartData),
  xpData: JSON.stringify(xpData),
  completionData: JSON.stringify(completionData),
  currentUnits: units,
  weightChartLabel
}}>
  // Dark Mode
  const html = document.documentElement;
  const themeIcon = document.getElementById('themeIcon');
  const saved = localStorage.getItem('theme') || 'light';
  html.setAttribute('data-theme', saved);
  if (themeIcon) themeIcon.textContent = saved==='dark'?'ğŸŒ™':'â˜€ï¸';
  document.getElementById('themeToggle')?.addEventListener('click', function() {
    const next = html.getAttribute('data-theme')==='dark'?'light':'dark';
    html.setAttribute('data-theme', next);
    if (themeIcon) themeIcon.textContent = next==='dark'?'ğŸŒ™':'â˜€ï¸';
    localStorage.setItem('theme', next);
  });

  // Notifications
  const bell = document.getElementById('notif-bell');
  const drop = document.getElementById('notificationDropdown');
  if (bell && drop) {
    bell.addEventListener('click', e => { e.stopPropagation(); drop.classList.toggle('active'); });
    document.addEventListener('click', e => { if (!drop.contains(e.target)&&!bell.contains(e.target)) drop.classList.remove('active'); });
  }

  // Modals
  [
    { m:'avatarModal',  o:['open-avatar-modal'],                          c:['close-avatar-modal'] },
    { m:'editModal',    o:['open-edit-modal','open-edit-modal-2'],         c:['close-edit-modal','close-edit-modal-2'] },
    { m:'weightModal',  o:['open-weight-modal','open-weight-modal-2'],     c:['close-weight-modal','close-weight-modal-2'] },
  ].forEach(({ m, o, c }) => {
    const el = document.getElementById(m);
    if (!el) return;
    o.forEach(id => document.getElementById(id)?.addEventListener('click', e => { e.preventDefault(); el.classList.add('active'); }));
    c.forEach(id => document.getElementById(id)?.addEventListener('click', () => el.classList.remove('active')));
    el.addEventListener('click', e => { if (e.target===el) el.classList.remove('active'); });
  });

  // Units Toggle
  async function setUnits(u) {
    const res = await fetch('/api/profile/update-units', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ units:u }) });
    if (res.ok) window.location.reload();
    else alert('Failed to update units');
  }
  window.setUnits = setUnits;

  // Avatar
  let avatarData = null;
  const upload = document.getElementById('avatar-upload');
  const preview = document.getElementById('avatar-preview');
  if (upload) {
    upload.addEventListener('change', function(e) {
      const f = e.target.files[0];
      if (!f) return;
      if (f.size > 2*1024*1024) { alert('âŒ Max 2MB'); return; }
      const r = new FileReader();
      r.onload = ev => { if (preview) { preview.innerHTML='<img src="'+ev.target.result+'" style="width:100%;height:100%;object-fit:cover;border-radius:50%;"/>'; avatarData=ev.target.result; } };
      r.readAsDataURL(f);
    });
  }
  document.querySelectorAll('.emoji-btn').forEach(b => b.addEventListener('click', function() {
    const e = this.getAttribute('data-emoji');
    if (preview) { preview.innerHTML='<span style="font-size:4rem;">'+e+'</span>'; avatarData='emoji:'+e; }
  }));
  document.getElementById('save-avatar-btn')?.addEventListener('click', async function() {
    if (!avatarData) { alert('âŒ Select an avatar first'); return; }
    const res = await fetch('/api/profile/update-avatar', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ avatar:avatarData }) });
    if (res.ok) window.location.reload();
    else alert('âŒ Failed to update avatar');
  });

  // Edit Form (with unit conversion)
  document.getElementById('edit-form')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    const d = Object.fromEntries(new FormData(this).entries());
    const w = parseFloat(d.weight_display), t = parseFloat(d.target_weight_display);
    if (currentUnits === 'imperial') {
      if (!isNaN(w)) d.weight_kg = (w/2.20462).toFixed(2);
      if (!isNaN(t)) d.target_weight_kg = (t/2.20462).toFixed(2);
      const ft = parseFloat(d.height_ft)||0, inch = parseFloat(d.height_in)||0;
      d.height_cm = Math.round((ft*12+inch)*2.54);
    } else {
      if (!isNaN(w)) d.weight_kg = w;
      if (!isNaN(t)) d.target_weight_kg = t;
    }
    delete d.weight_display; delete d.target_weight_display; delete d.height_ft; delete d.height_in;
    const res = await fetch('/api/profile/update', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(d) });
    if (res.ok) window.location.reload();
    else alert('âŒ Failed to update profile');
  });

  // Weight Form (with unit conversion)
  document.getElementById('weight-form')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    const d = Object.fromEntries(new FormData(this).entries());
    const v = parseFloat(d.weight_display);
    d.weight_kg = currentUnits==='imperial' ? (v/2.20462).toFixed(2) : v;
    delete d.weight_display;
    const res = await fetch('/api/profile/add-weight', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(d) });
    if (res.ok) window.location.reload();
    else { const err = await res.json(); alert('âŒ '+(err.error||'Failed')); }
  });

  // Charts
  window.addEventListener('load', function() {
    if (typeof Chart==='undefined') return;
    const isDark = html.getAttribute('data-theme')==='dark';
    const tc = isDark?'#eaeaea':'#374151', gc = isDark?'rgba(255,255,255,.1)':'rgba(0,0,0,.05)';

    const wCtx = document.getElementById('weightChart');
    if (wCtx) {
      const d = JSON.parse(chartData);
      if (d.length > 1) {
        const ws=d.map(x=>x.weight), mn=Math.min(...ws), mx=Math.max(...ws), rng=mx-mn;
        new Chart(wCtx, { type:'line', data:{ labels:d.map(x=>x.date), datasets:[{ data:ws, borderColor:'#10b981', backgroundColor:'rgba(16,185,129,.1)', fill:true, tension:.4, borderWidth:3, pointRadius:6 }] }, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false}, tooltip:{ callbacks:{ label:ctx=>ctx.parsed.y.toFixed(1)+' '+weightChartLabel } } }, scales:{ y:{ min:Math.floor(mn-rng*.2), max:Math.ceil(mx+rng*.2), grid:{color:gc}, ticks:{color:tc,callback:v=>v+' '+weightChartLabel} }, x:{grid:{display:false},ticks:{color:tc}} } } });
      }
    }
    const xpCtx = document.getElementById('xpChart');
    if (xpCtx) {
      const d = JSON.parse(xpData);
      if (d.length>0) new Chart(xpCtx, { type:'line', data:{ labels:d.map(x=>'Day '+x.day), datasets:[{ data:d.map(x=>x.xp), borderColor:'#eab308', backgroundColor:'rgba(234,179,8,.1)', fill:true, tension:.4, borderWidth:3 }] }, options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ y:{beginAtZero:true,grid:{color:gc},ticks:{color:tc}}, x:{grid:{display:false},ticks:{color:tc}} } } });
    }
    const cCtx = document.getElementById('completionChart');
    if (cCtx) {
      const d = JSON.parse(completionData);
      if (d.length>0) new Chart(cCtx, { type:'bar', data:{ labels:d.map(x=>'D'+x.day), datasets:[{ data:d.map(x=>x.percentage), backgroundColor:d.map(x=>x.percentage===100?'#10b981':x.percentage>=75?'#3b82f6':x.percentage>=50?'#f59e0b':'#ef4444'), borderRadius:8 }] }, options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ y:{min:0,max:100,grid:{color:gc},ticks:{color:tc,callback:v=>v+'%'}}, x:{grid:{display:false},ticks:{color:tc,font:{size:10}}} } } });
    }
  });

  console.log('âœ… Profile v4 â€” Units:', currentUnits);
</script>
</body>
</html>