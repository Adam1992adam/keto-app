---
import { supabase, getProfile, getPlan, getUserJourney, getDailyTasks } from '../../lib/supabase';

const accessToken = Astro.cookies.get('sb-access-token')?.value;
if (!accessToken) return Astro.redirect('/login');

const { data: { user } } = await supabase.auth.getUser(accessToken);
if (!user) return Astro.redirect('/login');

const profile = await getProfile(user.id);
const currentPlan = profile ? getPlan(profile.subscription_tier) : null;
const isSubscribed = profile?.subscription_status === 'active';

const journey = await getUserJourney(user.id);
const currentDay = journey?.current_day || 1;
const dailyTasks = await getDailyTasks(user.id, currentDay);
const incompleteTasks = dailyTasks?.filter((t: any) => t.task_type !== 'reflection' && t.task_type !== 'weight' && !t.completed) || [];

const LS_URL = "https://new-keto-plan.lemonsqueezy.com/checkout/buy/b975765f-a640-4cec-b3ef-44112acc9f75";

const plans = [
  {
    id: 'basic_30',
    name: 'Basic',
    emoji: 'ü•ë',
    tagline: 'Perfect Start',
    price: 29.99,
    duration: '30 Days',
    perMonth: null,
    gradient: 'linear-gradient(135deg,#10b981,#059669)',
    glow: 'rgba(16,185,129,.35)',
    border: 'rgba(16,185,129,.3)',
    accent: '#10b981',
    popular: false,
    features: [
      { text: '30-day meal plan', included: true },
      { text: '30 keto recipes', included: true },
      { text: '4 free eBooks', included: true },
      { text: 'Dashboard & tracking', included: true },
      { text: 'Water & macros tracker', included: true },
      { text: 'Basic analytics', included: true },
      { text: '87+ recipes library', included: false },
      { text: 'Advanced analytics', included: false },
      { text: 'Priority support', included: false },
      { text: 'AI Keto Coach', included: false },
    ]
  },
  {
    id: 'pro_6',
    name: 'Pro',
    emoji: '‚ö°',
    tagline: 'Most Popular',
    price: 99.99,
    duration: '6 Months',
    perMonth: 16.67,
    gradient: 'linear-gradient(135deg,#6366f1,#8b5cf6)',
    glow: 'rgba(99,102,241,.35)',
    border: 'rgba(99,102,241,.4)',
    accent: '#6366f1',
    popular: true,
    features: [
      { text: '6-month meal plan', included: true },
      { text: '87+ keto recipes', included: true },
      { text: '8 free eBooks', included: true },
      { text: 'Dashboard & tracking', included: true },
      { text: 'Water & macros tracker', included: true },
      { text: 'Advanced analytics', included: true },
      { text: 'Priority support', included: true },
      { text: 'Weekly progress reports', included: true },
      { text: 'Community access', included: false },
      { text: 'AI Keto Coach', included: false },
    ]
  },
  {
    id: 'elite_12',
    name: 'Elite',
    emoji: 'üëë',
    tagline: 'Best Value',
    price: 199.99,
    duration: '12 Months',
    perMonth: 16.67,
    gradient: 'linear-gradient(135deg,#f59e0b,#d97706)',
    glow: 'rgba(245,158,11,.35)',
    border: 'rgba(245,158,11,.35)',
    accent: '#f59e0b',
    popular: false,
    features: [
      { text: '12-month meal plan', included: true },
      { text: 'Unlimited recipes', included: true },
      { text: '12 free eBooks', included: true },
      { text: 'Dashboard & tracking', included: true },
      { text: 'Water & macros tracker', included: true },
      { text: 'Advanced analytics', included: true },
      { text: 'Priority 24/7 support', included: true },
      { text: 'Weekly progress reports', included: true },
      { text: 'Community access', included: true },
      { text: 'AI Keto Coach ü§ñ', included: true },
    ]
  }
];

const userName = profile?.full_name?.split(' ')[0] || 'Friend';
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Upgrade ‚Äî Keto Journey</title>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,700;0,9..144,900;1,9..144,700&family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600;9..40,700&display=swap" rel="stylesheet"/>

  <script is:inline>
    (function(){
      const t = localStorage.getItem('keto-theme') || 'dark';
      document.documentElement.setAttribute('data-theme', t);
    })();
  </script>

  <style>
    :root {
      --bg:      #0c1117;
      --surface: #131b24;
      --card:    #1a2535;
      --card2:   #1e2d42;
      --border:  rgba(255,255,255,.07);
      --border2: rgba(255,255,255,.12);
      --text:    #e8edf5;
      --muted:   #4a5a6e;
      --soft:    #8a9ab0;
      --green:   #10b981;
      --green2:  #34d399;
      --blue:    #3b82f6;
      --purple:  #8b5cf6;
      --gold:    #f59e0b;
      --red:     #ef4444;
      --cyan:    #06b6d4;
      --radius:  20px;
      --nav-h:   64px;
    }
    [data-theme="light"] {
      --bg:      #f0f4f8;
      --surface: #ffffff;
      --card:    #ffffff;
      --card2:   #f8fafc;
      --border:  rgba(0,0,0,.07);
      --border2: rgba(0,0,0,.12);
      --text:    #0f172a;
      --muted:   #94a3b8;
      --soft:    #64748b;
    }

    *,*::before,*::after { margin:0; padding:0; box-sizing:border-box; }
    html { scroll-behavior:smooth; }
    body {
      font-family:'DM Sans',sans-serif;
      background:var(--bg); color:var(--text);
      min-height:100vh; overflow-x:hidden;
      transition:background .3s,color .3s;
    }

    /* BG MESH */
    .bg-mesh { position:fixed; inset:0; pointer-events:none; z-index:0; overflow:hidden; }
    .orb { position:absolute; border-radius:50%; filter:blur(110px); animation:orbDrift ease-in-out infinite; }
    [data-theme="light"] .orb { opacity:.2; }
    .o1{width:700px;height:700px;background:rgba(16,185,129,.06);top:-200px;left:-200px;animation-duration:24s;opacity:.5;}
    .o2{width:600px;height:600px;background:rgba(99,102,241,.05);bottom:-150px;right:-150px;animation-duration:30s;animation-delay:-14s;opacity:.4;}
    .o3{width:400px;height:400px;background:rgba(245,158,11,.04);top:40%;left:40%;animation-duration:20s;animation-delay:-8s;opacity:.35;}
    @keyframes orbDrift{0%,100%{transform:translate(0,0) scale(1);}33%{transform:translate(50px,-60px) scale(1.07);}66%{transform:translate(-40px,50px) scale(.94);}}

    /* NAV */
    nav {
      position:sticky; top:0; z-index:100; height:var(--nav-h);
      background:rgba(12,17,23,.85); border-bottom:1px solid var(--border);
      backdrop-filter:blur(20px); display:flex; align-items:center;
      transition:background .3s;
    }
    [data-theme="light"] nav { background:rgba(255,255,255,.88); }
    .nav-inner { max-width:1280px; margin:0 auto; padding:0 1.5rem; width:100%; display:flex; align-items:center; gap:1.5rem; }
    .nav-brand { display:flex; align-items:center; gap:.6rem; text-decoration:none; font-family:'Fraunces',serif; font-weight:700; font-size:1.1rem; color:var(--text); flex-shrink:0; }
    .nav-links { display:flex; align-items:center; gap:.25rem; flex:1; overflow-x:auto; }
    .nav-links::-webkit-scrollbar{display:none;}
    .nav-link { display:flex; align-items:center; gap:.4rem; padding:.45rem .9rem; border-radius:10px; font-size:.82rem; font-weight:600; color:var(--soft); text-decoration:none; white-space:nowrap; transition:all .2s; }
    .nav-link:hover,.nav-link.active { background:rgba(16,185,129,.1); color:var(--green); }
    .nav-link.active { font-weight:700; }
    .nav-right { display:flex; align-items:center; gap:.75rem; flex-shrink:0; }
    .theme-btn { width:38px; height:38px; border-radius:10px; background:var(--card); border:1px solid var(--border); display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:1rem; transition:all .2s; }
    .theme-btn:hover { border-color:var(--green); }
    .notif-wrap { position:relative; }
    .notif-btn { width:38px; height:38px; border-radius:10px; background:var(--card); border:1px solid var(--border); display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:1rem; position:relative; transition:all .2s; }
    .notif-btn:hover { border-color:var(--green); }
    .notif-badge { position:absolute; top:-5px; right:-5px; background:var(--red); color:#fff; width:18px; height:18px; border-radius:50%; font-size:.65rem; font-weight:800; display:flex; align-items:center; justify-content:center; animation:pulseBadge 2s infinite; }
    @keyframes pulseBadge{0%,100%{transform:scale(1);}50%{transform:scale(1.2);}}
    .notif-dropdown { position:absolute; top:calc(100% + .5rem); right:0; width:340px; background:var(--card); border:1px solid var(--border); border-radius:var(--radius); overflow:hidden; box-shadow:0 20px 60px rgba(0,0,0,.4); display:none; z-index:200; }
    .notif-dropdown.open { display:block; animation:dropIn .25s ease; }
    @keyframes dropIn{from{opacity:0;transform:translateY(-8px);}to{opacity:1;transform:translateY(0);}}
    .notif-item { display:flex; align-items:center; gap:.875rem; padding:.875rem 1.25rem; border-bottom:1px solid var(--border); cursor:pointer; transition:background .2s; }
    .notif-item:hover { background:rgba(16,185,129,.06); }
    .nav-avatar { width:38px; height:38px; border-radius:10px; background:linear-gradient(135deg,var(--green),var(--blue)); display:flex; align-items:center; justify-content:center; color:#fff; font-weight:800; font-size:.95rem; text-decoration:none; transition:all .2s; }
    .nav-avatar:hover { transform:scale(1.05); }

    /* PAGE */
    .page { position:relative; z-index:1; max-width:1280px; margin:0 auto; padding:2rem 1.5rem 5rem; }

    /* HERO SECTION */
    .hero {
      text-align:center; margin-bottom:3rem;
      animation:fadeUp .5s ease both;
    }
    .hero-badge {
      display:inline-flex; align-items:center; gap:.5rem;
      background:rgba(16,185,129,.1); border:1px solid rgba(16,185,129,.25);
      border-radius:99px; padding:.4rem 1.1rem;
      font-size:.78rem; font-weight:700; color:var(--green);
      text-transform:uppercase; letter-spacing:.08em;
      margin-bottom:1.5rem;
    }
    .hero-title {
      font-family:'Fraunces',serif;
      font-size:clamp(2.2rem,5vw,3.5rem);
      font-weight:900; line-height:1.1; margin-bottom:1rem;
    }
    .hero-title .hl {
      font-style:italic;
      background:linear-gradient(135deg,var(--green),var(--green2),var(--cyan));
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
    }
    .hero-sub { font-size:1rem; color:var(--soft); max-width:500px; margin:0 auto 2rem; line-height:1.6; }

    /* TRUST BADGES */
    .trust-row {
      display:flex; justify-content:center; gap:2rem; flex-wrap:wrap;
      margin-bottom:3rem;
    }
    .trust-item {
      display:flex; align-items:center; gap:.5rem;
      font-size:.82rem; font-weight:700; color:var(--soft);
    }
    .trust-icon {
      width:32px; height:32px; border-radius:8px;
      background:var(--card); border:1px solid var(--border);
      display:flex; align-items:center; justify-content:center;
      font-size:.95rem;
    }

    /* CURRENT PLAN BANNER */
    .current-banner {
      background:linear-gradient(135deg,rgba(16,185,129,.08),rgba(52,211,153,.04));
      border:1px solid rgba(16,185,129,.2); border-radius:16px;
      padding:1.25rem 1.75rem;
      display:flex; align-items:center; justify-content:space-between;
      flex-wrap:wrap; gap:1rem; margin-bottom:2.5rem;
      animation:fadeUp .4s ease both;
    }
    .banner-left { display:flex; align-items:center; gap:1rem; }
    .banner-icon { font-size:1.75rem; }
    .banner-title { font-weight:800; font-size:.95rem; }
    .banner-sub { font-size:.78rem; color:var(--soft); margin-top:.2rem; }
    .badge-active {
      display:inline-flex; align-items:center; gap:.4rem;
      background:rgba(16,185,129,.12); border:1px solid rgba(16,185,129,.3);
      border-radius:99px; padding:.3rem .9rem;
      font-size:.75rem; font-weight:800; color:var(--green);
    }

    /* PLANS GRID */
    .plans-grid {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(300px,1fr));
      gap:1.5rem; align-items:start;
      margin-bottom:3rem;
    }

    /* PLAN CARD */
    .plan-card {
      background:var(--card); border:1px solid var(--border);
      border-radius:var(--radius); overflow:hidden;
      transition:all .35s cubic-bezier(.4,0,.2,1);
      position:relative;
      animation:fadeUp .5s ease both;
    }
    .plan-card:nth-child(1){animation-delay:.05s;}
    .plan-card:nth-child(2){animation-delay:.1s;}
    .plan-card:nth-child(3){animation-delay:.15s;}
    .plan-card:hover { transform:translateY(-8px); }
    .plan-card.popular {
      border-color:rgba(99,102,241,.4);
      box-shadow:0 0 0 1px rgba(99,102,241,.15), 0 20px 50px rgba(99,102,241,.15);
    }
    .plan-card.popular:hover {
      box-shadow:0 0 0 1px rgba(99,102,241,.3), 0 30px 60px rgba(99,102,241,.2);
    }

    /* POPULAR BADGE */
    .popular-badge {
      position:absolute; top:1.25rem; right:1.25rem;
      background:linear-gradient(135deg,#6366f1,#8b5cf6);
      color:#fff; font-size:.68rem; font-weight:800;
      padding:.3rem .8rem; border-radius:99px;
      text-transform:uppercase; letter-spacing:.06em;
      box-shadow:0 4px 12px rgba(99,102,241,.4);
    }

    /* PLAN HEADER */
    .plan-header {
      padding:2rem 2rem 1.5rem; position:relative; overflow:hidden;
    }
    .plan-header::before {
      content:''; position:absolute; top:-40px; right:-40px;
      width:160px; height:160px; border-radius:50%;
      filter:blur(50px); opacity:.15; pointer-events:none;
    }
    .plan-emoji-wrap {
      width:60px; height:60px; border-radius:16px;
      display:flex; align-items:center; justify-content:center;
      font-size:1.8rem; margin-bottom:1rem; flex-shrink:0;
      position:relative; z-index:1;
    }
    .plan-name {
      font-family:'Fraunces',serif; font-size:1.6rem; font-weight:900;
      margin-bottom:.2rem; position:relative; z-index:1;
    }
    .plan-tagline {
      font-size:.72rem; font-weight:700; text-transform:uppercase;
      letter-spacing:.08em; color:var(--soft); margin-bottom:1.25rem;
      position:relative; z-index:1;
    }

    .plan-price-block { position:relative; z-index:1; }
    .plan-price {
      font-family:'Fraunces',serif; font-size:3.5rem; font-weight:900;
      line-height:1; display:flex; align-items:flex-start; gap:.1rem;
    }
    .plan-price sup { font-size:1.4rem; margin-top:.4rem; font-family:'DM Sans',sans-serif; font-weight:700; }
    .plan-duration { font-size:.82rem; color:var(--soft); font-weight:600; margin-top:.3rem; }
    .plan-per-month {
      display:inline-flex; align-items:center; gap:.3rem;
      background:rgba(16,185,129,.08); border:1px solid rgba(16,185,129,.15);
      border-radius:99px; padding:.2rem .65rem;
      font-size:.72rem; font-weight:800; color:var(--green);
      margin-top:.5rem;
    }

    /* DIVIDER */
    .plan-divider { height:1px; background:var(--border); margin:0 2rem; }

    /* FEATURES */
    .plan-features { padding:1.5rem 2rem; }
    .feature-item {
      display:flex; align-items:center; gap:.75rem;
      padding:.55rem 0; border-bottom:1px solid rgba(255,255,255,.04);
      font-size:.85rem; transition:all .2s;
    }
    [data-theme="light"] .feature-item { border-bottom-color:rgba(0,0,0,.04); }
    .feature-item:last-child { border:none; }
    .feature-item.off { color:var(--muted); }
    .feature-item.off .feat-text { text-decoration:line-through; opacity:.6; }
    .feat-check {
      width:20px; height:20px; border-radius:6px; flex-shrink:0;
      display:flex; align-items:center; justify-content:center;
      font-size:.7rem; font-weight:900;
    }
    .feat-check.yes { background:rgba(16,185,129,.15); color:var(--green); }
    .feat-check.no  { background:rgba(255,255,255,.04); color:var(--muted); }
    [data-theme="light"] .feat-check.no { background:rgba(0,0,0,.04); }

    /* PLAN FOOTER */
    .plan-footer { padding:1.25rem 2rem 2rem; }
    .btn-upgrade {
      display:flex; align-items:center; justify-content:center; gap:.6rem;
      width:100%; padding:1rem 1.5rem; border-radius:13px;
      font-size:.9rem; font-weight:800; border:none; cursor:pointer;
      text-decoration:none; transition:all .3s cubic-bezier(.4,0,.2,1);
      position:relative; overflow:hidden;
    }
    .btn-upgrade::before {
      content:''; position:absolute; inset:0;
      background:linear-gradient(to right,transparent,rgba(255,255,255,.12),transparent);
      transform:translateX(-100%); transition:transform .5s;
    }
    .btn-upgrade:hover::before { transform:translateX(100%); }
    .btn-upgrade:hover { transform:translateY(-2px); }
    .btn-upgrade.green { background:linear-gradient(135deg,#10b981,#059669); color:#fff; box-shadow:0 4px 16px rgba(16,185,129,.35); }
    .btn-upgrade.green:hover { box-shadow:0 8px 24px rgba(16,185,129,.45); }
    .btn-upgrade.indigo { background:linear-gradient(135deg,#6366f1,#8b5cf6); color:#fff; box-shadow:0 4px 16px rgba(99,102,241,.35); }
    .btn-upgrade.indigo:hover { box-shadow:0 8px 24px rgba(99,102,241,.5); }
    .btn-upgrade.gold { background:linear-gradient(135deg,#f59e0b,#d97706); color:#fff; box-shadow:0 4px 16px rgba(245,158,11,.35); }
    .btn-upgrade.gold:hover { box-shadow:0 8px 24px rgba(245,158,11,.5); }
    .btn-current {
      display:flex; align-items:center; justify-content:center; gap:.5rem;
      width:100%; padding:.875rem; border-radius:13px;
      background:rgba(16,185,129,.08); border:1px solid rgba(16,185,129,.2);
      color:var(--green); font-weight:800; font-size:.875rem; cursor:default;
    }

    /* COMPARISON TABLE */
    .compare-section {
      background:var(--card); border:1px solid var(--border);
      border-radius:var(--radius); overflow:hidden;
      margin-bottom:3rem; animation:fadeUp .5s .2s ease both;
    }
    .compare-title {
      font-family:'Fraunces',serif; font-size:1.4rem; font-weight:700;
      padding:1.75rem 2rem 1.5rem;
      background:linear-gradient(135deg,var(--green),var(--green2));
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
    }
    .compare-row {
      display:grid; grid-template-columns:1fr repeat(3,100px);
      gap:0; border-top:1px solid var(--border); align-items:center;
    }
    .compare-row.header { background:var(--surface); }
    .compare-cell {
      padding:.875rem 1.25rem; font-size:.82rem;
      border-right:1px solid var(--border);
    }
    .compare-cell:last-child { border-right:none; }
    .compare-cell.center { text-align:center; }
    .compare-cell.header-cell { font-weight:800; font-size:.78rem; text-transform:uppercase; letter-spacing:.06em; color:var(--soft); }
    .compare-cell.feat-name { font-weight:600; color:var(--text); }
    .compare-row:hover { background:rgba(255,255,255,.02); }
    [data-theme="light"] .compare-row:hover { background:rgba(0,0,0,.02); }

    /* GUARANTEE */
    .guarantee {
      background:linear-gradient(135deg,rgba(16,185,129,.08),rgba(6,182,212,.05));
      border:1px solid rgba(16,185,129,.2); border-radius:var(--radius);
      padding:2rem; text-align:center; margin-bottom:2rem;
      animation:fadeUp .5s .3s ease both;
    }
    .guarantee-icon { font-size:2.5rem; margin-bottom:.75rem; }
    .guarantee-title { font-family:'Fraunces',serif; font-size:1.3rem; font-weight:700; margin-bottom:.5rem; }
    .guarantee-sub { font-size:.875rem; color:var(--soft); max-width:400px; margin:0 auto; line-height:1.6; }

    /* FAQ */
    .faq-section { margin-bottom:3rem; animation:fadeUp .5s .35s ease both; }
    .faq-title {
      font-family:'Fraunces',serif; font-size:1.5rem; font-weight:700;
      margin-bottom:1.25rem;
      background:linear-gradient(135deg,var(--green),var(--green2));
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
    }
    .faq-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:1rem; }
    .faq-item {
      background:var(--card); border:1px solid var(--border);
      border-radius:14px; padding:1.25rem; transition:all .25s;
    }
    .faq-item:hover { border-color:var(--border2); transform:translateY(-2px); }
    .faq-q { font-weight:800; font-size:.875rem; margin-bottom:.5rem; }
    .faq-a { font-size:.8rem; color:var(--soft); line-height:1.6; }

    /* MODAL */
    .modal-overlay {
      display:none; position:fixed; inset:0;
      background:rgba(0,0,0,.7); z-index:500;
      align-items:center; justify-content:center; padding:1.5rem;
      backdrop-filter:blur(8px);
    }
    .modal-overlay.show { display:flex; }
    .modal {
      background:var(--card); border:1px solid var(--border);
      border-radius:var(--radius); padding:2.5rem;
      max-width:440px; width:100%;
      box-shadow:0 40px 80px rgba(0,0,0,.5);
      animation:popIn .3s cubic-bezier(.4,0,.2,1);
      position:relative; overflow:hidden;
    }
    .modal::before {
      content:''; position:absolute; top:-60px; right:-60px;
      width:200px; height:200px; border-radius:50%;
      background:radial-gradient(circle,rgba(16,185,129,.1),transparent 70%);
      pointer-events:none;
    }
    @keyframes popIn{from{opacity:0;transform:scale(.9) translateY(20px);}to{opacity:1;transform:scale(1) translateY(0);}}
    .modal-title { font-family:'Fraunces',serif; font-size:1.5rem; font-weight:900; margin-bottom:.5rem; }
    .modal-sub { font-size:.875rem; color:var(--soft); line-height:1.6; margin-bottom:1.5rem; }
    .modal-plan-box {
      background:var(--surface); border:1px solid var(--border);
      border-radius:14px; padding:1.25rem; margin-bottom:1.5rem;
      display:flex; align-items:center; gap:1rem; position:relative; z-index:1;
    }
    .modal-plan-emoji { font-size:2.2rem; }
    .modal-plan-name { font-weight:800; font-size:1rem; }
    .modal-plan-price { font-size:.82rem; color:var(--soft); margin-top:.2rem; }
    .modal-actions { display:flex; flex-direction:column; gap:.75rem; position:relative; z-index:1; }
    .modal-confirm {
      padding:1rem; border-radius:12px; border:none; cursor:pointer;
      font-weight:800; font-size:.95rem;
      background:linear-gradient(135deg,var(--green),var(--green2)); color:#fff;
      box-shadow:0 4px 16px rgba(16,185,129,.35); transition:all .25s;
    }
    .modal-confirm:hover { transform:translateY(-2px); box-shadow:0 8px 24px rgba(16,185,129,.45); }
    .modal-cancel {
      padding:.875rem; border-radius:12px; border:1px solid var(--border);
      cursor:pointer; font-weight:700; font-size:.875rem;
      background:transparent; color:var(--soft); transition:all .2s;
    }
    .modal-cancel:hover { border-color:var(--green); color:var(--green); }
    .modal-close {
      position:absolute; top:1.25rem; right:1.25rem;
      background:var(--surface); border:none; width:32px; height:32px;
      border-radius:50%; cursor:pointer; color:var(--soft); font-size:1.1rem;
      display:flex; align-items:center; justify-content:center; z-index:2;
    }

    /* TOAST */
    .toast { position:fixed; top:5rem; right:1.5rem; z-index:9999; background:linear-gradient(135deg,var(--green),var(--green2)); color:#fff; padding:.875rem 1.5rem; border-radius:12px; font-weight:700; font-size:.875rem; box-shadow:0 10px 30px rgba(16,185,129,.4); transform:translateY(-20px); opacity:0; pointer-events:none; transition:all .35s cubic-bezier(.4,0,.2,1); }
    .toast.show { transform:translateY(0); opacity:1; }

    @keyframes fadeUp{from{opacity:0;transform:translateY(14px);}to{opacity:1;transform:translateY(0);}}

    @media(max-width:768px){
      .plans-grid { grid-template-columns:1fr; }
      .compare-row { grid-template-columns:1fr repeat(3,70px); }
      .compare-cell { padding:.75rem .6rem; font-size:.75rem; }
      .trust-row { gap:1rem; }
    }
  </style>
</head>
<body>

<div class="bg-mesh" aria-hidden="true">
  <div class="orb o1"></div><div class="orb o2"></div><div class="orb o3"></div>
</div>

<!-- NAV -->
<nav>
  <div class="nav-inner">
    <a href="/dashboard" class="nav-brand">ü•ë <span>Keto Journey</span></a>
    <div class="nav-links">
      <a href="/dashboard"               class="nav-link">üìä Dashboard</a>
      <a href="/dashboard/shopping-list" class="nav-link">üõí Shopping</a>
      <a href="/dashboard/recipes"       class="nav-link">üç≥ Recipes</a>
      <a href="/dashboard/profile"       class="nav-link">üë§ Profile</a>
      <a href="/dashboard/notifications" class="nav-link">üîî Reminders</a>
      <a href="/dashboard/upgrade"       class="nav-link active">‚ö° Upgrade</a>
    </div>
    <div class="nav-right">
      <button class="theme-btn" id="themeBtn" title="Toggle theme">‚òÄÔ∏è</button>

      {incompleteTasks.length > 0 && (
        <div class="notif-wrap">
          <button class="notif-btn" id="notifBtn">
            üîî <span class="notif-badge">{incompleteTasks.length}</span>
          </button>
          <div class="notif-dropdown" id="notifDropdown">
            <div style="padding:1rem 1.25rem;border-bottom:1px solid var(--border);font-weight:800;font-size:.9rem;color:var(--green);">
              üîî {incompleteTasks.length} Pending Task{incompleteTasks.length !== 1 ? 's' : ''}
            </div>
            <div style="max-height:320px;overflow-y:auto;">
              {incompleteTasks.map((t: any) => (
                <div class="notif-item">
                  <div style="width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--green),var(--green2));display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0;">
                    {t.task_type==='breakfast'?'üç≥':t.task_type==='lunch'?'ü•ó':t.task_type==='dinner'?'üçΩÔ∏è':t.task_type==='snack'?'üçé':'üíß'}
                  </div>
                  <div>
                    <div style="font-weight:700;font-size:.85rem;">{t.task_title}</div>
                    <div style="font-size:.75rem;color:var(--soft);">+{t.xp_earned} XP</div>
                  </div>
                </div>
              ))}
            </div>
            <div style="padding:.875rem 1.25rem;border-top:1px solid var(--border);">
              <a href="/dashboard" style="display:block;text-align:center;padding:.6rem;border-radius:10px;background:linear-gradient(135deg,var(--green),var(--green2));color:#fff;font-weight:700;font-size:.8rem;text-decoration:none;">View All Tasks ‚Üí</a>
            </div>
          </div>
        </div>
      )}

      {profile && (
        <a href="/dashboard/profile" class="nav-avatar">{profile.full_name.charAt(0).toUpperCase()}</a>
      )}
    </div>
  </div>
</nav>

<!-- PAGE -->
<div class="page">

  <!-- HERO -->
  <div class="hero">
    <div class="hero-badge">‚ö° Level Up Your Journey</div>
    <h1 class="hero-title">
      Choose Your<br/><span class="hl">Keto Plan</span>
    </h1>
    <p class="hero-sub">One-time payment. Lifetime access. Cancel-free ‚Äî results guaranteed or your money back.</p>
  </div>

  <!-- TRUST BADGES -->
  <div class="trust-row">
    <div class="trust-item">
      <div class="trust-icon">üõ°Ô∏è</div>
      <span>30-Day Guarantee</span>
    </div>
    <div class="trust-item">
      <div class="trust-icon">üîí</div>
      <span>Secure Checkout</span>
    </div>
    <div class="trust-item">
      <div class="trust-icon">‚ö°</div>
      <span>Instant Access</span>
    </div>
    <div class="trust-item">
      <div class="trust-icon">üåç</div>
      <span>10,000+ Users</span>
    </div>
  </div>

  <!-- CURRENT PLAN -->
  {isSubscribed && currentPlan && (
    <div class="current-banner">
      <div class="banner-left">
        <div class="banner-icon">{currentPlan.emoji}</div>
        <div>
          <div class="banner-title">You're on the <strong>{currentPlan.name} Plan</strong></div>
          <div class="banner-sub">Upgrade anytime to unlock more powerful features</div>
        </div>
      </div>
      <span class="badge-active">‚úì Active</span>
    </div>
  )}

  <!-- PLANS -->
  <div class="plans-grid">
    {plans.map(plan => (
      <div class={`plan-card ${plan.popular ? 'popular' : ''}`} style={plan.popular ? `box-shadow:0 0 0 1px ${plan.border},0 20px 50px ${plan.glow.replace('.35','.12')}` : ''}>

        {plan.popular && <div class="popular-badge">Most Popular</div>}

        <!-- Header -->
        <div class="plan-header" style={`background:linear-gradient(135deg,${plan.accent}08,transparent)`}>
          <div class="plan-header::before" style={`background:${plan.accent}`}></div>
          <div class="plan-emoji-wrap" style={`background:${plan.gradient};box-shadow:0 6px 20px ${plan.glow}`}>
            {plan.emoji}
          </div>
          <div class="plan-name">{plan.name}</div>
          <div class="plan-tagline">{plan.tagline}</div>
          <div class="plan-price-block">
            <div class="plan-price" style={`background:${plan.gradient};-webkit-background-clip:text;-webkit-text-fill-color:transparent;`}>
              <sup>$</sup>{plan.price}
            </div>
            <div class="plan-duration">for {plan.duration}</div>
            {plan.perMonth && (
              <div class="plan-per-month">
                <span>üí∞</span>
                <span>${plan.perMonth.toFixed(2)} / month</span>
              </div>
            )}
          </div>
        </div>

        <div class="plan-divider"></div>

        <!-- Features -->
        <div class="plan-features">
          {plan.features.map(f => (
            <div class={`feature-item ${!f.included ? 'off' : ''}`}>
              <div class={`feat-check ${f.included ? 'yes' : 'no'}`}
                   style={f.included ? `background:${plan.accent}20;color:${plan.accent}` : ''}>
                {f.included ? '‚úì' : '‚úï'}
              </div>
              <span class="feat-text">{f.text}</span>
            </div>
          ))}
        </div>

        <!-- CTA -->
        <div class="plan-footer">
          {currentPlan?.id === plan.id ? (
            <div class="btn-current">‚úì Current Plan</div>
          ) : (
            <button
              class={`btn-upgrade ${plan.id === 'basic_30' ? 'green' : plan.id === 'pro_6' ? 'indigo' : 'gold'}`}
              data-plan-id={plan.id}
              data-plan-name={plan.name}
              data-plan-price={plan.price}
              data-plan-emoji={plan.emoji}
              data-plan-duration={plan.duration}
              onclick="openModal(this)"
            >
              <span>üöÄ</span>
              <span>Get {plan.name} ‚Äî ${plan.price}</span>
            </button>
          )}
        </div>
      </div>
    ))}
  </div>

  <!-- COMPARISON TABLE -->
  <div class="compare-section">
    <div class="compare-title">Full Comparison</div>
    <div class="compare-row header">
      <div class="compare-cell header-cell">Feature</div>
      <div class="compare-cell header-cell center">ü•ë Basic</div>
      <div class="compare-cell header-cell center">‚ö° Pro</div>
      <div class="compare-cell header-cell center">üëë Elite</div>
    </div>
    {[
      ['Meal Plan', '30 days', '6 months', '12 months'],
      ['Recipes', '30', '87+', 'Unlimited'],
      ['Free eBooks', '4', '8', '12'],
      ['Dashboard & Tracking', '‚úì', '‚úì', '‚úì'],
      ['Macros Tracker', '‚úì', '‚úì', '‚úì'],
      ['Advanced Analytics', '‚Äî', '‚úì', '‚úì'],
      ['Priority Support', '‚Äî', '‚úì', '‚úì'],
      ['Community Access', '‚Äî', '‚Äî', '‚úì'],
      ['AI Keto Coach ü§ñ', '‚Äî', '‚Äî', '‚úì'],
      ['Lifetime Updates', '‚Äî', '‚Äî', '‚úì'],
    ].map(row => (
      <div class="compare-row">
        <div class="compare-cell feat-name">{row[0]}</div>
        {[row[1], row[2], row[3]].map((val, i) => (
          <div class="compare-cell center" style={val === '‚úì' ? `color:${i===0?'#10b981':i===1?'#6366f1':'#f59e0b'}` : val === '‚Äî' ? 'color:var(--muted);opacity:.4' : `font-weight:700;color:${i===0?'#10b981':i===1?'#6366f1':'#f59e0b'}`}>
            {val}
          </div>
        ))}
      </div>
    ))}
  </div>

  <!-- FAQ -->
  <div class="faq-section">
    <div class="faq-title">Frequently Asked Questions</div>
    <div class="faq-grid">
      {[
        { q:'Is this a one-time payment?', a:'Yes! No subscriptions, no hidden fees. Pay once and keep access forever.' },
        { q:'Can I upgrade later?', a:'Absolutely. You can upgrade from Basic to Pro or Elite at any time from this page.' },
        { q:'What\'s the money-back guarantee?', a:'If you\'re not happy within 30 days, we\'ll give you a full refund. No questions asked.' },
        { q:'What is the AI Keto Coach?', a:'Elite members get access to our AI-powered coach that gives personalized keto advice, recipe ideas, and progress analysis.' },
        { q:'How do I access my plan?', a:'After payment, your account is instantly upgraded. Just log in to access all features.' },
        { q:'Is my payment secure?', a:'Yes. All payments are processed securely through LemonSqueezy with industry-standard encryption.' },
      ].map(faq => (
        <div class="faq-item">
          <div class="faq-q">‚ùì {faq.q}</div>
          <div class="faq-a">{faq.a}</div>
        </div>
      ))}
    </div>
  </div>

  <!-- GUARANTEE -->
  <div class="guarantee">
    <div class="guarantee-icon">üõ°Ô∏è</div>
    <div class="guarantee-title">30-Day Money-Back Guarantee</div>
    <p class="guarantee-sub">Not satisfied with your results? Contact us within 30 days for a full refund ‚Äî no questions asked. We stand behind every plan.</p>
  </div>

</div><!-- /page -->

<!-- MODAL -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <button class="modal-close" onclick="closeModal()">√ó</button>
    <div class="modal-title">Confirm Upgrade üöÄ</div>
    <p class="modal-sub">You'll be redirected to our secure checkout to complete your payment instantly.</p>
    <div class="modal-plan-box">
      <div class="modal-plan-emoji" id="modalEmoji"></div>
      <div>
        <div class="modal-plan-name" id="modalName"></div>
        <div class="modal-plan-price" id="modalPrice"></div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="modal-confirm" id="modalConfirm">Continue to Secure Checkout ‚Üí</button>
      <button class="modal-cancel" onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script is:inline define:vars={{ LS_URL }}>

// ‚îÄ‚îÄ THEME ‚îÄ‚îÄ
const html = document.documentElement;
const themeBtn = document.getElementById('themeBtn');
function applyTheme(t) {
  html.setAttribute('data-theme', t);
  localStorage.setItem('keto-theme', t);
  if (themeBtn) themeBtn.textContent = t === 'dark' ? '‚òÄÔ∏è' : 'üåô';
}
applyTheme(localStorage.getItem('keto-theme') || 'dark');
themeBtn?.addEventListener('click', () => {
  applyTheme(html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
});

// ‚îÄ‚îÄ NOTIFS ‚îÄ‚îÄ
const notifBtn  = document.getElementById('notifBtn');
const notifDrop = document.getElementById('notifDropdown');
notifBtn?.addEventListener('click', e => { e.stopPropagation(); notifDrop?.classList.toggle('open'); });
document.addEventListener('click', e => { if (notifDrop && !notifDrop.contains(e.target) && e.target !== notifBtn) notifDrop.classList.remove('open'); });

// ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ
let checkoutUrl = LS_URL;

function openModal(btn) {
  document.getElementById('modalEmoji').textContent = btn.dataset.planEmoji;
  document.getElementById('modalName').textContent  = `${btn.dataset.planName} Plan ‚Äî ${btn.dataset.planDuration}`;
  document.getElementById('modalPrice').textContent = `$${btn.dataset.planPrice} one-time payment`;
  checkoutUrl = LS_URL;
  document.getElementById('modalOverlay').classList.add('show');
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('show');
}

document.getElementById('modalOverlay').addEventListener('click', e => {
  if (e.target === document.getElementById('modalOverlay')) closeModal();
});

document.getElementById('modalConfirm').addEventListener('click', () => {
  closeModal();
  window.open(checkoutUrl, '_blank');
  showToast('üöÄ Redirecting to checkout...');
});

function showToast(msg) {
  const t = document.getElementById('toast');
  if (!t) return;
  t.textContent = msg;
  t.className = 'toast show';
  setTimeout(() => t.classList.remove('show'), 2800);
}

window.openModal  = openModal;
window.closeModal = closeModal;

</script>
</body>
</html>