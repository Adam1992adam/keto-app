---
import { supabase, getProfile, getPlan } from '../../lib/supabase';

const accessToken = Astro.cookies.get('sb-access-token')?.value;
if (!accessToken) return Astro.redirect('/login');

const { data: { user } } = await supabase.auth.getUser(accessToken);
if (!user) return Astro.redirect('/login');

const profile = await getProfile(user.id);
const currentPlan = profile ? getPlan(profile.subscription_tier) : null;
const isSubscribed = profile?.subscription_status === 'active';

const plans = [
  {
    id: 'basic_30',
    name: 'Basic',
    emoji: 'ü•â',
    tagline: 'Perfect Start',
    price: 29,
    duration: '30 Days',
    perMonth: 29,
    payhipLink: 'OEQk9',
    popular: false,
    features: [
      { text: '30-day meal plan', included: true },
      { text: '30 keto recipes', included: true },
      { text: '4 free eBooks', included: true },
      { text: 'Dashboard & tracking', included: true },
      { text: 'Water & macros tracker', included: true },
      { text: 'Basic analytics', included: true },
      { text: '87+ recipes library', included: false },
      { text: 'Advanced analytics', included: false },
      { text: 'Priority support', included: false },
      { text: 'Community access', included: false },
    ]
  },
  {
    id: 'pro_6',
    name: 'Pro',
    emoji: 'ü•à',
    tagline: 'Most Popular',
    price: 99,
    duration: '6 Months',
    perMonth: 16.5,
    payhipLink: 'OEQk9',
    popular: true,
    features: [
      { text: '6-month meal plan', included: true },
      { text: '87+ keto recipes', included: true },
      { text: '8 free eBooks', included: true },
      { text: 'Dashboard & tracking', included: true },
      { text: 'Water & macros tracker', included: true },
      { text: 'Advanced analytics', included: true },
      { text: 'Priority support', included: true },
      { text: 'Weekly progress reports', included: true },
      { text: 'Community access', included: false },
      { text: '24/7 support', included: false },
    ]
  },
  {
    id: 'elite_12',
    name: 'Elite',
    emoji: 'ü•á',
    tagline: 'Best Value',
    price: 149,
    duration: '12 Months',
    perMonth: 12.4,
    payhipLink: 'OEQk9',
    popular: false,
    features: [
      { text: '12-month meal plan', included: true },
      { text: 'Unlimited recipes', included: true },
      { text: '12 free eBooks', included: true },
      { text: 'Dashboard & tracking', included: true },
      { text: 'Water & macros tracker', included: true },
      { text: 'Advanced analytics', included: true },
      { text: 'Priority 24/7 support', included: true },
      { text: 'Weekly progress reports', included: true },
      { text: 'Community access', included: true },
      { text: 'Lifetime updates', included: true },
    ]
  }
];
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Upgrade ‚Äì Keto Journey</title>
  <style>
    :root{--bg-primary:#fff;--bg-secondary:#f9fafb;--bg-card:#fff;--text-primary:#111827;--text-secondary:#6b7280;--border-color:#e5e7eb;--accent-primary:#10b981;--shadow-md:0 4px 6px rgba(0,0,0,.1);--shadow-lg:0 10px 15px rgba(0,0,0,.1);--shadow-xl:0 20px 25px rgba(0,0,0,.15);}
    [data-theme="dark"]{--bg-primary:#1a1a2e;--bg-secondary:#16213e;--bg-card:#0f3460;--text-primary:#eaeaea;--text-secondary:#a0aec0;--border-color:#2d3748;}
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg-secondary);color:var(--text-primary);}
    .container{max-width:1400px;margin:0 auto;padding:0 1.5rem;}
    nav{background:var(--bg-primary);border-bottom:1px solid var(--border-color);padding:1rem 0;position:sticky;top:0;z-index:50;box-shadow:var(--shadow-md);}
    nav a{color:var(--text-secondary);text-decoration:none;padding:.5rem 1rem;border-radius:.75rem;font-weight:500;transition:all .3s;}
    nav a:hover,nav a.active{color:var(--accent-primary);}
    .theme-toggle{position:relative;width:60px;height:30px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:9999px;cursor:pointer;}
    .theme-toggle-slider{position:absolute;top:3px;left:3px;width:24px;height:24px;background:white;border-radius:50%;transition:all .3s;display:flex;align-items:center;justify-content:center;font-size:.75rem;}
    [data-theme="dark"] .theme-toggle{background:linear-gradient(135deg,#2d3561,#1a1f3a);}
    [data-theme="dark"] .theme-toggle-slider{transform:translateX(30px);background:#1a1a2e;color:#fbbf24;}
    .hero{text-align:center;padding:4rem 2rem;background:linear-gradient(135deg,#10b981,#059669);border-radius:2rem;margin:2rem 0;color:white;position:relative;overflow:hidden;}
    .hero::before{content:'';position:absolute;top:-50%;right:-50%;width:200%;height:200%;background:radial-gradient(circle,rgba(255,255,255,.1) 0%,transparent 70%);animation:rotate 20s linear infinite;}
    @keyframes rotate{from{transform:rotate(0deg);}to{transform:rotate(360deg);}}
    .hero h1{font-size:3.5rem;font-weight:900;position:relative;z-index:1;}
    .plans-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:2rem;margin:3rem 0;}
    .plan-card{background:var(--bg-card);border-radius:2rem;padding:2.5rem;border:3px solid var(--border-color);box-shadow:var(--shadow-lg);transition:all .4s;position:relative;overflow:hidden;}
    .plan-card:hover{transform:translateY(-15px) scale(1.02);box-shadow:var(--shadow-xl);border-color:var(--accent-primary);}
    .plan-card.popular{border-color:var(--accent-primary);border-width:4px;}
    .plan-card.popular::after{content:'‚≠ê MOST POPULAR';position:absolute;top:1.5rem;right:-2.5rem;background:linear-gradient(135deg,#10b981,#059669);color:white;padding:.5rem 3rem;font-weight:800;font-size:.75rem;transform:rotate(45deg);}
    .plan-emoji{font-size:4rem;margin-bottom:1rem;display:block;text-align:center;}
    .plan-name{font-size:2rem;font-weight:900;margin-bottom:.5rem;text-align:center;background:linear-gradient(135deg,var(--accent-primary),#34d399);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
    .plan-tagline{font-size:.875rem;color:var(--text-secondary);font-weight:600;text-transform:uppercase;text-align:center;margin-bottom:2rem;}
    .plan-price{text-align:center;margin:2rem 0;}
    .plan-price-amount{font-size:4rem;font-weight:900;background:linear-gradient(135deg,var(--accent-primary),#34d399);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
    .plan-price-duration{font-size:1rem;color:var(--text-secondary);font-weight:600;margin-top:.5rem;}
    .plan-price-monthly{font-size:.875rem;color:var(--text-secondary);margin-top:.25rem;}
    .feature-item{display:flex;align-items:center;gap:.75rem;padding:.875rem 0;border-bottom:1px solid var(--border-color);}
    .feature-item:last-child{border:none;}
    .feature-icon{font-size:1.25rem;}
    .feature-text{font-size:.9375rem;font-weight:500;}
    .feature-text.disabled{color:var(--text-secondary);opacity:.5;text-decoration:line-through;}
    .plan-btn{display:flex;align-items:center;justify-content:center;gap:.75rem;width:100%;padding:1.25rem 2rem;border-radius:1.25rem;font-weight:800;font-size:1.125rem;cursor:pointer;border:none;margin-top:2rem;}
    .plan-btn-primary{background:linear-gradient(135deg,var(--accent-primary),#34d399);color:white;}
    .plan-btn-primary:hover{transform:translateY(-2px) scale(1.05);}
    .plan-btn-secondary{background:var(--bg-secondary);color:var(--text-primary);border:2px solid var(--border-color);}
    .current-plan-badge{display:inline-flex;align-items:center;gap:.5rem;padding:.625rem 1.25rem;background:linear-gradient(135deg,rgba(16,185,129,.15),rgba(52,211,153,.15));border:2px solid var(--accent-primary);border-radius:9999px;font-weight:800;font-size:.875rem;color:var(--accent-primary);margin-top:2rem;}
    .flex{display:flex;align-items:center;}
    .flex-between{display:flex;justify-content:space-between;align-items:center;}
    .gap-2{gap:1rem;}
    @media(max-width:768px){.hero h1{font-size:2.5rem;}.plans-grid{grid-template-columns:1fr;}}
  </style>
</head>
<body>

<nav>
  <div class="container">
    <div class="flex-between">
      <div class="flex gap-2">
        <span style="font-size:2.5rem;">ü•ë</span>
        <div>
          <h1 style="font-size:1.375rem;font-weight:800;background:linear-gradient(135deg,var(--accent-primary),#34d399);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">Keto Journey</h1>
          <p style="font-size:.8125rem;color:var(--text-secondary);font-weight:600;">Choose Your Plan</p>
        </div>
      </div>
      <div class="flex gap-2">
        {isSubscribed && <a href="/dashboard/">Dashboard</a>}
        <a href="/dashboard/recipes">Recipes</a>
        {isSubscribed && <a href="/dashboard/profile">Profile</a>}
        <div class="flex gap-2" style="padding-left:1rem;border-left:1px solid var(--border-color);">
          <div class="theme-toggle" id="themeToggle"><div class="theme-toggle-slider"><span id="themeIcon">‚òÄÔ∏è</span></div></div>
          {isSubscribed && (
            <a href="/dashboard/profile" style="width:2.5rem;height:2.5rem;background:linear-gradient(135deg,var(--accent-primary),#34d399);border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:800;text-decoration:none;font-size:1.125rem;">
              {profile.full_name.charAt(0).toUpperCase()}
            </a>
          )}
        </div>
      </div>
    </div>
  </div>
</nav>

<div class="container" style="padding:2rem 1.5rem 4rem;">

  <div class="hero">
    <h1>üöÄ Choose Your Keto Journey</h1>
    <p style="font-size:1.125rem;opacity:.95;position:relative;z-index:1;margin-top:.5rem;">Transform your body with the plan that fits your goals</p>
  </div>

  {isSubscribed && currentPlan && (
    <div style="text-align:center;margin:2rem 0;padding:1.5rem;background:linear-gradient(135deg,rgba(16,185,129,.1),rgba(52,211,153,.1));border-radius:1.5rem;border:2px solid var(--accent-primary);">
      <p style="font-size:1.125rem;font-weight:700;">You're on <strong>{currentPlan.emoji} {currentPlan.name}</strong></p>
      <p style="font-size:.9375rem;color:var(--text-secondary);margin-top:.5rem;">Want more? Upgrade below!</p>
    </div>
  )}

  <div class="plans-grid">
    {plans.map(plan => (
      <div class={`plan-card ${plan.popular?'popular':''}`}>
        <span class="plan-emoji">{plan.emoji}</span>
        <h3 class="plan-name">{plan.name}</h3>
        <p class="plan-tagline">{plan.tagline}</p>
        <div class="plan-price">
          <div class="plan-price-amount">${plan.price}</div>
          <div class="plan-price-duration">{plan.duration}</div>
          {plan.perMonth !== plan.price && (
            <div class="plan-price-monthly">Only ${plan.perMonth.toFixed(1)}/month</div>
          )}
        </div>
        <div>
          {plan.features.map(f => (
            <div class="feature-item">
              <span class="feature-icon">{f.included?'‚úÖ':'‚ùå'}</span>
              <span class={`feature-text ${!f.included?'disabled':''}`}>{f.text}</span>
            </div>
          ))}
        </div>
        {currentPlan?.id === plan.id ? (
          <div style="text-align:center;"><span class="current-plan-badge"><span>‚úì</span><span>Current</span></span></div>
        ) : (
          <button class={`plan-btn ${plan.popular?'plan-btn-primary':'plan-btn-secondary'}`} onclick={`selectPlan('${plan.id}','${plan.name}',${plan.price},'${plan.payhipLink}')`}>
            <span>üõí</span><span>Buy {plan.name}</span>
          </button>
        )}
      </div>
    ))}
  </div>

</div>

<script is:inline>
  const html=document.documentElement;
  const themeIcon=document.getElementById('themeIcon');
  const saved=localStorage.getItem('theme')||'light';
  html.setAttribute('data-theme',saved);
  if(themeIcon)themeIcon.textContent=saved==='dark'?'üåô':'‚òÄÔ∏è';
  document.getElementById('themeToggle')?.addEventListener('click',function(){
    const next=html.getAttribute('data-theme')==='dark'?'light':'dark';
    html.setAttribute('data-theme',next);
    if(themeIcon)themeIcon.textContent=next==='dark'?'üåô':'‚òÄÔ∏è';
    localStorage.setItem('theme',next);
  });

  function selectPlan(planId, planName, price, payhipLink) {
    // Check if Payhip link is configured
    if (!payhipLink || payhipLink === 'YOUR_BASIC_LINK' || payhipLink === 'YOUR_PRO_LINK' || payhipLink === 'YOUR_ELITE_LINK') {
      alert('‚ö†Ô∏è Payhip link not configured yet!\n\nTo enable checkout:\n1. Add product link in upgrade.astro\n2. Replace ' + payhipLink + ' with your Payhip URL');
      return;
    }
    
    // Redirect to Payhip checkout (opens in new tab)
    window.open('https://payhip.com/b/' + payhipLink, '_blank');
  }
  window.selectPlan = selectPlan;
</script>
</body>
</html>