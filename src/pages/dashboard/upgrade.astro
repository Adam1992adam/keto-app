---
import { supabase, getProfile, getPlan } from '../../lib/supabase';

const accessToken = Astro.cookies.get('sb-access-token')?.value;
if (!accessToken) return Astro.redirect('/login');

const { data: { user } } = await supabase.auth.getUser(accessToken);
if (!user) return Astro.redirect('/login');

const profile = await getProfile(user.id);
const currentPlan = profile ? getPlan(profile.subscription_tier) : null;
const isSubscribed = profile?.subscription_status === 'active';

// ÿ±ÿßÿ®ÿ∑ LemonSqueezy ÿßŸÑŸàÿßÿ≠ÿØ ŸÑŸÑŸÉŸÑ
const LS_URL = "https://new-keto-plan.lemonsqueezy.com/checkout/buy/9ea69d7b-cd63-4769-a83a-5d28e1bb56b7";

const plans = [
  {
    id: 'basic_30',
    name: 'Basic',
    emoji: 'ü•ë',
    tagline: 'Perfect Start',
    price: 29.99,
    duration: '30 Days',
    perMonth: 29.99,
    popular: false,
    color: '#10b981',
    features: [
      { text: '30-day meal plan', included: true },
      { text: '30 keto recipes', included: true },
      { text: '4 free eBooks', included: true },
      { text: 'Dashboard & tracking', included: true },
      { text: 'Water & macros tracker', included: true },
      { text: 'Basic analytics', included: true },
      { text: '87+ recipes library', included: false },
      { text: 'Advanced analytics', included: false },
      { text: 'Priority support', included: false },
      { text: 'Community access', included: false },
    ]
  },
  {
    id: 'pro_6',
    name: 'Pro',
    emoji: '‚ö°',
    tagline: 'Most Popular',
    price: 99.99,
    duration: '6 Months',
    perMonth: 16.67,
    popular: true,
    color: '#6366f1',
    features: [
      { text: '6-month meal plan', included: true },
      { text: '87+ keto recipes', included: true },
      { text: '8 free eBooks', included: true },
      { text: 'Dashboard & tracking', included: true },
      { text: 'Water & macros tracker', included: true },
      { text: 'Advanced analytics', included: true },
      { text: 'Priority support', included: true },
      { text: 'Weekly progress reports', included: true },
      { text: 'Community access', included: false },
      { text: '24/7 support', included: false },
    ]
  },
  {
    id: 'elite_12',
    name: 'Elite',
    emoji: 'üëë',
    tagline: 'Best Value',
    price: 199.99,
    duration: '12 Months',
    perMonth: 16.67,
    popular: false,
    color: '#f59e0b',
    features: [
      { text: '12-month meal plan', included: true },
      { text: 'Unlimited recipes', included: true },
      { text: '12 free eBooks', included: true },
      { text: 'Dashboard & tracking', included: true },
      { text: 'Water & macros tracker', included: true },
      { text: 'Advanced analytics', included: true },
      { text: 'Priority 24/7 support', included: true },
      { text: 'Weekly progress reports', included: true },
      { text: 'Community access', included: true },
      { text: 'Lifetime updates', included: true },
    ]
  }
];
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Upgrade ‚Äì Keto Journey</title>
  <style>
    :root{
      --bg:#f8fafc; --card:#fff; --text:#0f172a; --muted:#64748b;
      --border:#e2e8f0; --accent:#10b981; --shadow:0 4px 24px rgba(0,0,0,.08);
    }
    [data-theme="dark"]{
      --bg:#0f172a; --card:#1e293b; --text:#f1f5f9; --muted:#94a3b8;
      --border:#334155; --shadow:0 4px 24px rgba(0,0,0,.4);
    }
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}

    /* NAV */
    nav{background:var(--card);border-bottom:1px solid var(--border);padding:.875rem 2rem;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:50;box-shadow:var(--shadow);}
    .logo{display:flex;align-items:center;gap:.75rem;}
    .logo-text{font-size:1.25rem;font-weight:800;background:linear-gradient(135deg,#10b981,#34d399);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
    .nav-links{display:flex;align-items:center;gap:.5rem;}
    .nav-links a{color:var(--muted);text-decoration:none;padding:.5rem .875rem;border-radius:.625rem;font-weight:500;font-size:.875rem;transition:all .2s;}
    .nav-links a:hover{color:var(--accent);background:rgba(16,185,129,.08);}
    .theme-btn{width:36px;height:36px;border-radius:50%;border:1px solid var(--border);background:var(--card);cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center;transition:all .2s;}
    .theme-btn:hover{border-color:var(--accent);}

    /* HERO */
    .hero{
      text-align:center;padding:4rem 2rem 3rem;
      background:linear-gradient(135deg,#10b981 0%,#059669 50%,#047857 100%);
      position:relative;overflow:hidden;
    }
    .hero::before{
      content:'';position:absolute;inset:0;
      background:url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    }
    .hero h1{font-size:clamp(2rem,5vw,3rem);font-weight:900;color:#fff;position:relative;margin-bottom:.75rem;}
    .hero p{color:rgba(255,255,255,.85);font-size:1.05rem;position:relative;}
    .hero-badge{
      display:inline-flex;align-items:center;gap:.5rem;
      background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.25);
      border-radius:99px;padding:.35rem 1rem;font-size:.8rem;color:#fff;
      font-weight:600;margin-bottom:1.25rem;position:relative;
    }

    /* CURRENT PLAN BANNER */
    .current-banner{
      max-width:700px;margin:2rem auto;
      background:linear-gradient(135deg,rgba(16,185,129,.1),rgba(52,211,153,.05));
      border:2px solid rgba(16,185,129,.3);border-radius:1.25rem;
      padding:1.25rem 2rem;display:flex;align-items:center;justify-content:space-between;
      flex-wrap:wrap;gap:1rem;
    }
    .current-banner-text{font-weight:700;font-size:1rem;}
    .current-banner-sub{font-size:.85rem;color:var(--muted);margin-top:.2rem;}
    .badge-active{display:inline-flex;align-items:center;gap:.4rem;background:rgba(16,185,129,.15);border:1px solid rgba(16,185,129,.3);border-radius:99px;padding:.3rem .8rem;font-size:.78rem;font-weight:700;color:#10b981;}

    /* PLANS GRID */
    .plans-wrap{max-width:1200px;margin:0 auto;padding:2rem;}
    .plans-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:1.5rem;align-items:start;}

    .plan-card{
      background:var(--card);border:2px solid var(--border);
      border-radius:1.5rem;overflow:hidden;transition:all .3s;
      box-shadow:var(--shadow);position:relative;
    }
    .plan-card:hover{transform:translateY(-6px);box-shadow:0 20px 40px rgba(0,0,0,.12);}
    .plan-card.popular{border-color:#6366f1;box-shadow:0 0 0 4px rgba(99,102,241,.1);}

    .popular-ribbon{
      position:absolute;top:1.25rem;right:-2.5rem;
      background:linear-gradient(135deg,#6366f1,#8b5cf6);
      color:#fff;font-size:.7rem;font-weight:800;
      padding:.3rem 3rem;transform:rotate(45deg);
      text-transform:uppercase;letter-spacing:.05em;
    }

    .plan-header{padding:2rem 2rem 1.5rem;}
    .plan-icon{font-size:2.5rem;margin-bottom:.75rem;display:block;}
    .plan-name{font-size:1.5rem;font-weight:900;margin-bottom:.25rem;}
    .plan-tagline{font-size:.8rem;font-weight:600;text-transform:uppercase;letter-spacing:.06em;color:var(--muted);}
    .plan-price-wrap{margin:1.25rem 0;}
    .plan-price{font-size:3rem;font-weight:900;line-height:1;}
    .plan-price sup{font-size:1.25rem;vertical-align:top;margin-top:.5rem;}
    .plan-duration{font-size:.875rem;color:var(--muted);margin-top:.25rem;}
    .plan-per-month{font-size:.8rem;color:var(--muted);}

    .plan-features{padding:0 2rem 1.5rem;border-top:1px solid var(--border);}
    .feature{display:flex;align-items:center;gap:.75rem;padding:.65rem 0;border-bottom:1px solid var(--border);font-size:.875rem;}
    .feature:last-child{border:none;}
    .feature.off{color:var(--muted);}
    .feature.off span:last-child{text-decoration:line-through;}
    .feat-icon{width:20px;text-align:center;flex-shrink:0;}

    .plan-footer{padding:1.25rem 2rem 2rem;}
    .btn-buy{
      display:flex;align-items:center;justify-content:center;gap:.6rem;
      width:100%;padding:1rem;border-radius:1rem;font-weight:700;font-size:.95rem;
      border:none;cursor:pointer;transition:all .25s;text-decoration:none;
    }
    .btn-buy.primary{background:linear-gradient(135deg,#6366f1,#8b5cf6);color:#fff;box-shadow:0 4px 16px rgba(99,102,241,.35);}
    .btn-buy.primary:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(99,102,241,.45);}
    .btn-buy.secondary{background:var(--bg);color:var(--text);border:2px solid var(--border);}
    .btn-buy.secondary:hover{border-color:var(--accent);color:var(--accent);}
    .btn-buy.gold{background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff;box-shadow:0 4px 16px rgba(245,158,11,.35);}
    .btn-buy.gold:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(245,158,11,.45);}
    .btn-current{
      display:flex;align-items:center;justify-content:center;gap:.5rem;
      width:100%;padding:.875rem;border-radius:1rem;
      background:rgba(16,185,129,.1);border:2px solid rgba(16,185,129,.3);
      color:#10b981;font-weight:700;font-size:.875rem;cursor:default;
    }

    /* MODAL */
    .modal-overlay{
      display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);
      z-index:100;align-items:center;justify-content:center;padding:1rem;
      backdrop-filter:blur(4px);
    }
    .modal-overlay.show{display:flex;}
    .modal{
      background:var(--card);border-radius:1.5rem;padding:2.5rem;
      max-width:460px;width:100%;box-shadow:0 40px 80px rgba(0,0,0,.3);
      animation:popIn .3s ease;
    }
    @keyframes popIn{from{opacity:0;transform:scale(.9);}to{opacity:1;transform:scale(1);}}
    .modal h3{font-size:1.4rem;font-weight:800;margin-bottom:.5rem;}
    .modal p{color:var(--muted);font-size:.9rem;line-height:1.6;margin-bottom:1.5rem;}
    .modal-plan-info{
      background:var(--bg);border:1px solid var(--border);
      border-radius:1rem;padding:1rem 1.25rem;margin-bottom:1.5rem;
      display:flex;align-items:center;gap:1rem;
    }
    .modal-plan-icon{font-size:2rem;}
    .modal-plan-name{font-weight:700;}
    .modal-plan-price{font-size:.85rem;color:var(--muted);}
    .modal-btns{display:flex;flex-direction:column;gap:.75rem;}
    .modal-btn-confirm{
      padding:1rem;border-radius:1rem;border:none;cursor:pointer;
      font-weight:700;font-size:1rem;
      background:linear-gradient(135deg,#10b981,#059669);color:#fff;
      box-shadow:0 4px 16px rgba(16,185,129,.3);transition:all .2s;
    }
    .modal-btn-confirm:hover{transform:translateY(-2px);}
    .modal-btn-cancel{
      padding:.875rem;border-radius:1rem;border:2px solid var(--border);
      cursor:pointer;font-weight:600;font-size:.9rem;
      background:transparent;color:var(--muted);transition:all .2s;
    }
    .modal-btn-cancel:hover{border-color:var(--accent);color:var(--accent);}

    /* GUARANTEE */
    .guarantee{
      max-width:700px;margin:2rem auto 3rem;text-align:center;
      padding:1.5rem;background:var(--card);border:1px solid var(--border);
      border-radius:1.25rem;
    }
    .guarantee h4{font-weight:700;margin-bottom:.4rem;}
    .guarantee p{font-size:.875rem;color:var(--muted);}

    @media(max-width:768px){
      .plans-wrap{padding:1rem;}
      nav{padding:.75rem 1rem;}
      .hero{padding:3rem 1rem 2rem;}
    }
  </style>
</head>
<body>

<!-- NAV -->
<nav>
  <div class="logo">
    <span style="font-size:2rem;">ü•ë</span>
    <span class="logo-text">Keto Journey</span>
  </div>
  <div class="nav-links">
    <a href="/dashboard/">Dashboard</a>
    <a href="/dashboard/recipes">Recipes</a>
    <a href="/dashboard/profile">Profile</a>
    <button class="theme-btn" id="themeBtn">‚òÄÔ∏è</button>
  </div>
</nav>

<!-- HERO -->
<div class="hero">
  <div class="hero-badge">üöÄ Level Up Your Journey</div>
  <h1>Choose Your Keto Plan</h1>
  <p>Upgrade anytime. One-time payment. Lifetime access.</p>
</div>

<!-- CURRENT PLAN BANNER -->
<div class="plans-wrap">
  {isSubscribed && currentPlan && (
    <div class="current-banner">
      <div>
        <div class="current-plan-text">You're currently on <strong>{currentPlan.emoji} {currentPlan.name} Plan</strong></div>
        <div class="current-banner-sub">Upgrade anytime to unlock more features</div>
      </div>
      <span class="badge-active">‚úì Active</span>
    </div>
  )}

  <!-- PLANS -->
  <div class="plans-grid">
    {plans.map(plan => (
      <div class={`plan-card ${plan.popular ? 'popular' : ''}`}>
        {plan.popular && <div class="popular-ribbon">Most Popular</div>}

        <div class="plan-header">
          <span class="plan-icon">{plan.emoji}</span>
          <div class="plan-name">{plan.name}</div>
          <div class="plan-tagline">{plan.tagline}</div>
          <div class="plan-price-wrap">
            <div class="plan-price"><sup>$</sup>{plan.price}</div>
            <div class="plan-duration">for {plan.duration}</div>
            {plan.id !== 'basic_30' && (
              <div class="plan-per-month">${plan.perMonth.toFixed(2)}/month</div>
            )}
          </div>
        </div>

        <div class="plan-features">
          {plan.features.map(f => (
            <div class={`feature ${!f.included ? 'off' : ''}`}>
              <span class="feat-icon">{f.included ? '‚úÖ' : '‚¨ú'}</span>
              <span>{f.text}</span>
            </div>
          ))}
        </div>

        <div class="plan-footer">
          {currentPlan?.id === plan.id ? (
            <div class="btn-current">
              <span>‚úì</span><span>Current Plan</span>
            </div>
          ) : (
            <button
              class={`btn-buy ${plan.popular ? 'primary' : plan.id === 'elite_12' ? 'gold' : 'secondary'}`}
              data-plan-id={plan.id}
              data-plan-name={plan.name}
              data-plan-price={plan.price}
              data-plan-emoji={plan.emoji}
              data-plan-duration={plan.duration}
            >
              <span>üõí</span>
              <span>Get {plan.name} ‚Äî ${plan.price}</span>
            </button>
          )}
        </div>
      </div>
    ))}
  </div>

  <!-- GUARANTEE -->
  <div class="guarantee">
    <h4>üõ°Ô∏è 30-Day Money-Back Guarantee</h4>
    <p>Not satisfied? Contact us within 30 days for a full refund ‚Äî no questions asked.</p>
  </div>
</div>

<!-- CONFIRM MODAL -->
<div class="modal-overlay" id="modal">
  <div class="modal">
    <h3>Confirm Upgrade</h3>
    <p>You're about to upgrade your plan. You'll be redirected to the secure checkout to complete your payment.</p>
    <div class="modal-plan-info">
      <div class="modal-plan-icon" id="modalEmoji"></div>
      <div>
        <div class="modal-plan-name" id="modalName"></div>
        <div class="modal-plan-price" id="modalPrice"></div>
      </div>
    </div>
    <div class="modal-btns">
      <button class="modal-btn-confirm" id="modalConfirm">Continue to Checkout ‚Üí</button>
      <button class="modal-btn-cancel" id="modalCancel">Cancel</button>
    </div>
  </div>
</div>

<script is:inline define:vars={{ LS_URL }}>
  // Theme
  const html = document.documentElement;
  const themeBtn = document.getElementById('themeBtn');
  const saved = localStorage.getItem('theme') || 'light';
  html.setAttribute('data-theme', saved);
  themeBtn.textContent = saved === 'dark' ? 'üåô' : '‚òÄÔ∏è';
  themeBtn.addEventListener('click', () => {
    const next = html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    html.setAttribute('data-theme', next);
    themeBtn.textContent = next === 'dark' ? 'üåô' : '‚òÄÔ∏è';
    localStorage.setItem('theme', next);
  });

  // Modal
  const modal = document.getElementById('modal');
  const modalEmoji = document.getElementById('modalEmoji');
  const modalName = document.getElementById('modalName');
  const modalPrice = document.getElementById('modalPrice');
  const modalConfirm = document.getElementById('modalConfirm');
  const modalCancel = document.getElementById('modalCancel');

  let checkoutUrl = LS_URL;

  // Plan buttons
  document.querySelectorAll('.btn-buy[data-plan-id]').forEach(btn => {
    btn.addEventListener('click', () => {
      const planId    = btn.dataset.planId;
      const planName  = btn.dataset.planName;
      const planPrice = btn.dataset.planPrice;
      const planEmoji = btn.dataset.planEmoji;
      const planDur   = btn.dataset.planDuration;

      modalEmoji.textContent = planEmoji;
      modalName.textContent  = `${planName} Plan ‚Äî ${planDur}`;
      modalPrice.textContent = `$${planPrice} one-time payment`;
      checkoutUrl = LS_URL;

      modal.classList.add('show');
    });
  });

  modalCancel.addEventListener('click', () => modal.classList.remove('show'));
  modal.addEventListener('click', e => { if (e.target === modal) modal.classList.remove('show'); });

  modalConfirm.addEventListener('click', () => {
    modal.classList.remove('show');
    window.open(checkoutUrl, '_blank');
  });
</script>

</body>
</html>