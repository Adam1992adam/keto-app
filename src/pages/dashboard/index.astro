---
import AiCoach from '../../components/AiCoach.astro';

import { supabase, getProfile, isSubscriptionActive, getUserJourney, initializeUserJourney, getDailyTasks, getWaterIntake } from '../../lib/supabase';

const accessToken = Astro.cookies.get('sb-access-token')?.value;
if (!accessToken) return Astro.redirect('/login');

const { data: { user }, error: authError } = await supabase.auth.getUser(accessToken);
if (authError || !user) return Astro.redirect('/login');

const profile = await getProfile(user.id);
if (!profile) return Astro.redirect('/login');

// ‚îÄ‚îÄ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÜÿ™Ÿáÿßÿ° ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ‚îÄ‚îÄ
const isExpired =
  profile?.subscription_status === 'expired' ||
  (profile?.subscription_end_date && new Date(profile.subscription_end_date) < new Date());

if (isExpired && profile?.subscription_status !== 'active') {
  await supabase.from('profiles').update({ subscription_status: 'expired' }).eq('id', user.id);
  return Astro.redirect('/dashboard/expired');
}

const hasAccess = isSubscriptionActive(profile);
if (!hasAccess) return Astro.redirect('/dashboard/upgrade');

let journey = await getUserJourney(user.id);
if (!journey) {
  journey = await initializeUserJourney(user.id);
  if (!journey) return Astro.redirect('/login?error=journey_init_failed');
}

const { data: updatedDay } = await supabase.rpc('update_current_day', { user_id_param: user.id });
journey = await getUserJourney(user.id);
if (!journey) return Astro.redirect('/login?error=journey_reload_failed');

const dayParam = Astro.url.searchParams.get('day');
const viewDay = dayParam ? Math.min(Math.max(parseInt(dayParam), 1), 30) : journey.current_day;
const currentDay = journey.current_day;
const planType = profile.subscription_tier === 'pro_6' ? 'pro_6' : profile.subscription_tier === 'elite_12' ? 'elite_12' : 'basic_30';

const dailyTasks = await getDailyTasks(user.id, viewDay);
const waterIntake = await getWaterIntake(user.id, viewDay);
const canInteract = viewDay === currentDay;

const filteredTasks = dailyTasks.filter(t => t.task_type !== 'reflection' && t.task_type !== 'weight');
const completedTasks = filteredTasks.filter(t => t.completed).length;
const totalTasks = filteredTasks.length;
const progressPercentage = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

const { data: mealPlans } = await supabase
  .from('meal_plans')
  .select('*, recipe:recipes(*)')
  .eq('plan_type', 'basic_30')
  .eq('day_number', viewDay)
  .order('order_index');

const todayMeals = mealPlans || [];
const incompleteTasks = filteredTasks.filter(t => !t.completed);

const { data: completedMealTasks } = await supabase
  .from('daily_tasks')
  .select('task_type')
  .eq('user_id', user.id)
  .eq('day_number', viewDay)
  .eq('completed', true)
  .in('task_type', ['breakfast', 'lunch', 'dinner', 'snack']);

let actualCalories = 0, actualProtein = 0, actualFat = 0, actualCarbs = 0;
if (completedMealTasks) {
  completedMealTasks.forEach(task => {
    const meal = todayMeals.find(m => m.meal_type === task.task_type);
    if (meal?.recipe) {
      actualCalories += meal.recipe.calories || 0;
      actualProtein  += meal.recipe.protein   || 0;
      actualFat      += meal.recipe.fat        || 0;
      actualCarbs    += meal.recipe.net_carbs  || 0;
    }
  });
}

const age    = profile.age         || 30;
const weight = profile.weight_kg   || 70;
const height = profile.height_cm   || 170;
const gender = profile.gender      || 'male';
let bmr = gender === 'male'
  ? 10 * weight + 6.25 * height - 5 * age + 5
  : 10 * weight + 6.25 * height - 5 * age - 161;
const actMult: Record<string,number> = { sedentary:1.2, light:1.375, moderate:1.55, active:1.725, very_active:1.9 };
const tdee = Math.round(bmr * (actMult[profile.activity_level||'moderate']||1.55));
const targetCalories = profile.goal === 'lose_weight' ? tdee - 500 : tdee;
const targetFat      = Math.round((targetCalories * 0.70) / 9);
const targetProtein  = Math.round((targetCalories * 0.25) / 4);
const targetCarbs    = Math.round((targetCalories * 0.05) / 4);
const caloriesPercent = targetCalories > 0 ? Math.round((actualCalories / targetCalories) * 100) : 0;
const proteinPercent  = targetProtein  > 0 ? Math.round((actualProtein  / targetProtein)  * 100) : 0;
const fatPercent      = targetFat      > 0 ? Math.round((actualFat      / targetFat)      * 100) : 0;
const carbsPercent    = targetCarbs    > 0 ? Math.round((actualCarbs    / targetCarbs)    * 100) : 0;

// ‚îÄ‚îÄ Weight history ‚îÄ‚îÄ
const { data: weightHistory } = await supabase
  .from('weight_logs')
  .select('weight_kg, logged_at')
  .eq('user_id', user.id)
  .order('logged_at', { ascending: true })
  .limit(14);

const isElite = profile.subscription_tier === 'elite_12';

// ‚îÄ‚îÄ Keto Flu tips ‚îÄ‚îÄ
const ketoFluTips: Record<number, any> = {
  1: { icon:'üöÄ', day:'Day 1', title:"Your Body is Starting to Change!", whatsHappening:"Your body is burning through its last glucose stores. You'll lose water weight fast ‚Äî this is REAL progress starting now!", tip:"Hydration is critical today. Your kidneys are flushing electrolytes rapidly with the water.", suggestion:"üßÇ Add a pinch of sea salt to your water + drink 3-4L today", action:"Drink a full glass of water right now! üíß", gradient:"linear-gradient(135deg,#3b82f6,#06b6d4)", severity:"info", progress:10 },
  2: { icon:'‚ö°', day:'Day 2', title:"Headaches? Your Body is Adapting!", whatsHappening:"Your brain is running low on glucose and signaling distress. Headaches and mild fatigue are completely normal!", tip:"Electrolytes are your best weapon. Salt, potassium, magnesium.", suggestion:"üßÇ Salt every meal + sip on coconut water or broth", action:"Add salt to your next meal right now! üßÇ", gradient:"linear-gradient(135deg,#f59e0b,#f97316)", severity:"warning", progress:20 },
  3: { icon:'üò§', day:'Day 3', title:"The Hardest Day ‚Äî But You WILL Win!", whatsHappening:"Peak keto flu! Maximum fatigue, brain fog, and sugar cravings hit today. Most people quit here. NOT you!", tip:"Eat MORE fat immediately. Avocado, olive oil, butter ‚Äî don't restrict.", suggestion:"ü•ë Avocado + olive oil + macadamia nuts = instant energy", action:"Eat a spoon of peanut butter or avocado RIGHT NOW! ü•ë", gradient:"linear-gradient(135deg,#ef4444,#dc2626)", severity:"danger", progress:30 },
  4: { icon:'üí™', day:'Day 4', title:"Muscle Cramps? Fix It in Minutes!", whatsHappening:"Your muscles are losing magnesium and potassium faster than normal. 100% fixable!", tip:"Focus on: Sodium (salt), Potassium (leafy greens), Magnesium (nuts).", suggestion:"üíä Magnesium glycinate 300mg tonight + eat spinach today", action:"Eat a handful of almonds or add spinach to your meal! ü•¨", gradient:"linear-gradient(135deg,#8b5cf6,#6d28d9)", severity:"warning", progress:40 },
  5: { icon:'üß†', day:'Day 5', title:"Brain Fog is Temporary ‚Äî Clarity is Coming!", whatsHappening:"Your brain is SWITCHING fuel sources from glucose to ketones. This fog means the transition is happening!", tip:"Your brain needs fat to make this switch. Don't skimp today.", suggestion:"üêü Fatty fish or Omega-3 supplement ‚Äî brain fuel during transition", action:"Take a 10-minute walk to boost mental energy! üö∂", gradient:"linear-gradient(135deg,#06b6d4,#0284c7)", severity:"warning", progress:50 },
  6: { icon:'üò¥', day:'Day 6', title:"Can't Sleep? Here's the Fix!", whatsHappening:"Low magnesium directly disrupts deep sleep during keto adaptation. Fixable tonight!", tip:"Magnesium before bed is a game changer for sleep quality during keto.", suggestion:"üåô Magnesium glycinate 400mg + chamomile tea 1 hour before bed", action:"Prepare your magnesium supplement for tonight! üíä", gradient:"linear-gradient(135deg,#6366f1,#8b5cf6)", severity:"info", progress:60 },
  7: { icon:'üéâ', day:'Day 7', title:"ONE FULL WEEK ‚Äî You're Crushing It!", whatsHappening:"Your body is beginning to produce ketones! Most people feel a noticeable energy shift today.", tip:"You've crossed the hardest threshold. Your metabolism is shifting into fat-burning mode.", suggestion:"‚öñÔ∏è Weigh yourself today ‚Äî you'll be amazed at the progress!", action:"Log your weight and celebrate this milestone! üèÜ", gradient:"linear-gradient(135deg,#10b981,#059669)", severity:"success", progress:70 },
  8: { icon:'üî•', day:'Day 8', title:"Sugar Cravings? Your Secret Weapon is FAT!", whatsHappening:"Your body is making one final attempt to get glucose. These cravings mean you're close to full ketosis!", tip:"When cravings hit ‚Äî eat fat immediately.", suggestion:"üßÄ Cheese + dark chocolate 90% + peanut butter = craving killer", action:"Prepare a keto emergency snack for craving attacks! üéØ", gradient:"linear-gradient(135deg,#f59e0b,#10b981)", severity:"info", progress:80 },
  9: { icon:'‚ú®', day:'Day 9', title:"Feel That Clean Energy? That's Ketosis!", whatsHappening:"You're in ketosis or extremely close! Clean, steady energy with no crashes.", tip:"Your body is now a fat-burning machine. Every day gets easier.", suggestion:"üèÉ Try light exercise today ‚Äî you'll feel surprisingly amazing!", action:"Notice how different and cleaner your energy feels today! ‚ú®", gradient:"linear-gradient(135deg,#10b981,#3b82f6)", severity:"success", progress:90 },
  10:{ icon:'üëë', day:'Day 10', title:"You BEAT Keto Flu ‚Äî You're a Champion!", whatsHappening:"You've completed the HARDEST phase! 80% of people quit during these 10 days. You're unstoppable!", tip:"From here, fat adaptation deepens every week.", suggestion:"üì∏ Take a progress photo right now ‚Äî you've truly earned it!", action:"Share your victory ‚Äî you beat what most people can't! üëë", gradient:"linear-gradient(135deg,#f59e0b,#ef4444)", severity:"success", progress:100 },
};
const currentTip = ketoFluTips[viewDay];
const showKetoFluTip = viewDay >= 1 && viewDay <= 10 && currentTip;

const userName = profile.full_name?.split(' ')[0] || 'Friend';
const weightHistoryJson = JSON.stringify(weightHistory || []);
const greeting = new Date().getHours() < 12 ? 'Good morning' : new Date().getHours() < 17 ? 'Good afternoon' : 'Good evening';
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard ‚Äî Keto Journey</title>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,700;0,9..144,900;1,9..144,700&family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600;9..40,700&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <script is:inline>
    (function(){
      const t = localStorage.getItem('keto-theme') || 'dark';
      document.documentElement.setAttribute('data-theme', t);
    })();
  </script>

  <style>
    :root {
      --bg:       #0c1117;
      --surface:  #131b24;
      --card:     #1a2535;
      --card2:    #1e2d42;
      --border:   rgba(255,255,255,.07);
      --border2:  rgba(255,255,255,.12);
      --text:     #e8edf5;
      --muted:    #4a5a6e;
      --soft:     #8a9ab0;
      --green:    #10b981;
      --green2:   #34d399;
      --blue:     #3b82f6;
      --purple:   #8b5cf6;
      --gold:     #f59e0b;
      --red:      #ef4444;
      --cyan:     #06b6d4;
      --radius:   20px;
      --nav-h:    64px;
    }
    [data-theme="light"] {
      --bg:      #f0f4f8;
      --surface: #ffffff;
      --card:    #ffffff;
      --card2:   #f8fafc;
      --border:  rgba(0,0,0,.07);
      --border2: rgba(0,0,0,.12);
      --text:    #0f172a;
      --muted:   #94a3b8;
      --soft:    #64748b;
    }

    *,*::before,*::after { margin:0; padding:0; box-sizing:border-box; }
    html { scroll-behavior:smooth; }
    body {
      font-family:'DM Sans',sans-serif;
      background:var(--bg); color:var(--text);
      min-height:100vh; overflow-x:hidden;
      transition: background .3s, color .3s;
    }

    .bg-mesh { position:fixed; inset:0; pointer-events:none; z-index:0; overflow:hidden; }
    .orb { position:absolute; border-radius:50%; filter:blur(100px); animation:orbDrift ease-in-out infinite; opacity:.6; }
    [data-theme="light"] .orb { opacity:.25; }
    .o1{width:700px;height:700px;background:rgba(16,185,129,.06);top:-200px;left:-200px;animation-duration:22s;}
    .o2{width:500px;height:500px;background:rgba(59,130,246,.05);bottom:-100px;right:-100px;animation-duration:28s;animation-delay:-12s;}
    .o3{width:400px;height:400px;background:rgba(139,92,246,.04);top:40%;left:45%;animation-duration:19s;animation-delay:-7s;}
    @keyframes orbDrift { 0%,100%{transform:translate(0,0) scale(1);} 33%{transform:translate(50px,-60px) scale(1.08);} 66%{transform:translate(-40px,50px) scale(.94);} }

    nav {
      position:sticky; top:0; z-index:100; height:var(--nav-h);
      background:rgba(12,17,23,.85); border-bottom:1px solid var(--border);
      backdrop-filter:blur(20px); display:flex; align-items:center;
      transition: background .3s;
    }
    [data-theme="light"] nav { background:rgba(255,255,255,.88); }
    .nav-inner { max-width:1280px; margin:0 auto; padding:0 1.5rem; width:100%; display:flex; align-items:center; gap:1.5rem; }
    .nav-brand { display:flex; align-items:center; gap:.6rem; text-decoration:none; font-family:'Fraunces',serif; font-weight:700; font-size:1.1rem; color:var(--text); flex-shrink:0; }
    .nav-links { display:flex; align-items:center; gap:.25rem; flex:1; overflow-x:auto; }
    .nav-links::-webkit-scrollbar { display:none; }
    .nav-link { display:flex; align-items:center; gap:.4rem; padding:.45rem .9rem; border-radius:10px; font-size:.82rem; font-weight:600; color:var(--soft); text-decoration:none; white-space:nowrap; transition:all .2s; }
    .nav-link:hover,.nav-link.active { background:rgba(16,185,129,.1); color:var(--green); }
    .nav-link.active { font-weight:700; }
    .nav-right { display:flex; align-items:center; gap:.75rem; flex-shrink:0; }

    .theme-btn { width:38px; height:38px; border-radius:10px; background:var(--card); border:1px solid var(--border); display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:1rem; transition:all .2s; }
    .theme-btn:hover { border-color:var(--green); }

    .notif-wrap { position:relative; }
    .notif-btn { width:38px; height:38px; border-radius:10px; background:var(--card); border:1px solid var(--border); display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:1rem; transition:all .2s; position:relative; }
    .notif-btn:hover { border-color:var(--green); }
    .notif-badge { position:absolute; top:-5px; right:-5px; background:var(--red); color:#fff; width:18px; height:18px; border-radius:50%; font-size:.65rem; font-weight:800; display:flex; align-items:center; justify-content:center; animation:pulseBadge 2s infinite; }
    @keyframes pulseBadge { 0%,100%{transform:scale(1);} 50%{transform:scale(1.2);} }
    .notif-dropdown { position:absolute; top:calc(100% + .5rem); right:0; width:340px; background:var(--card); border:1px solid var(--border); border-radius:var(--radius); overflow:hidden; box-shadow:0 20px 60px rgba(0,0,0,.4); display:none; z-index:200; animation:dropIn .25s ease; }
    .notif-dropdown.open { display:block; }
    @keyframes dropIn { from{opacity:0;transform:translateY(-8px);} to{opacity:1;transform:translateY(0);} }
    .notif-item { display:flex; align-items:center; gap:.875rem; padding:.875rem 1.25rem; border-bottom:1px solid var(--border); cursor:pointer; transition:background .2s; }
    .notif-item:hover { background:rgba(16,185,129,.06); }
    .notif-icon { width:38px; height:38px; border-radius:10px; flex-shrink:0; background:linear-gradient(135deg,var(--green),var(--green2)); display:flex; align-items:center; justify-content:center; font-size:1.1rem; }
    .nav-avatar { width:38px; height:38px; border-radius:10px; background:linear-gradient(135deg,var(--green),var(--blue)); display:flex; align-items:center; justify-content:center; color:#fff; font-weight:800; font-size:.95rem; text-decoration:none; flex-shrink:0; transition:all .2s; }
    .nav-avatar:hover { transform:scale(1.05); }

    .page { position:relative; z-index:1; max-width:1280px; margin:0 auto; padding:2rem 1.5rem 5rem; }

    .dash-header { display:flex; align-items:flex-start; justify-content:space-between; gap:1.5rem; margin-bottom:2rem; flex-wrap:wrap; }
    .dash-greeting { font-size:.78rem; font-weight:600; color:var(--muted); text-transform:uppercase; letter-spacing:.1em; margin-bottom:.5rem; }
    .dash-title { font-family:'Fraunces',serif; font-size:clamp(1.8rem,4vw,2.8rem); font-weight:900; line-height:1.15; margin-bottom:.5rem; }
    .dash-title .hl { font-style:italic; background:linear-gradient(135deg,var(--green),var(--green2)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
    .dash-sub { font-size:.9rem; color:var(--soft); }
    .dash-nav-btns { display:flex; gap:.5rem; }
    .btn-nav { padding:.5rem 1rem; border-radius:10px; font-size:.8rem; font-weight:700; background:var(--card); border:1px solid var(--border); color:var(--soft); text-decoration:none; cursor:pointer; transition:all .2s; display:inline-flex; align-items:center; gap:.3rem; }
    .btn-nav:hover:not([disabled]) { border-color:var(--green); color:var(--green); }

    .progress-wrap { margin-top:1.25rem; }
    .progress-info { display:flex; justify-content:space-between; align-items:center; margin-bottom:.5rem; }
    .progress-label { font-size:.78rem; font-weight:700; color:var(--soft); }
    .progress-val { font-size:.78rem; font-weight:800; color:var(--green); }
    .progress-bar { width:100%; height:8px; background:var(--surface); border-radius:99px; overflow:hidden; }
    .progress-fill { height:100%; border-radius:99px; background:linear-gradient(90deg,var(--green),var(--green2),var(--blue)); transition:width .8s cubic-bezier(.4,0,.2,1); position:relative; overflow:hidden; }
    .progress-fill::after { content:''; position:absolute; inset:0; background:linear-gradient(90deg,transparent,rgba(255,255,255,.3),transparent); animation:shimmer 2s infinite; }
    @keyframes shimmer { 0%{transform:translateX(-100%);} 100%{transform:translateX(100%);} }

    .stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:1rem; margin-bottom:1.5rem; }
    .stat-card { background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:1.5rem; position:relative; overflow:hidden; transition:all .3s cubic-bezier(.4,0,.2,1); animation:fadeUp .5s ease both; }
    .stat-card:nth-child(1){animation-delay:.05s;} .stat-card:nth-child(2){animation-delay:.1s;} .stat-card:nth-child(3){animation-delay:.15s;} .stat-card:nth-child(4){animation-delay:.2s;}
    .stat-card:hover { transform:translateY(-4px); border-color:var(--border2); }
    .stat-card .glow { position:absolute; top:-30px; right:-30px; width:120px; height:120px; border-radius:50%; filter:blur(40px); opacity:.2; transition:opacity .3s; }
    .stat-card:hover .glow { opacity:.4; }
    .stat-icon { width:44px; height:44px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:1.3rem; margin-bottom:1rem; position:relative; z-index:1; }
    .stat-label { font-size:.72rem; font-weight:700; color:var(--soft); text-transform:uppercase; letter-spacing:.08em; margin-bottom:.4rem; position:relative; z-index:1; }
    .stat-val { font-family:'Fraunces',serif; font-size:2.2rem; font-weight:900; line-height:1; position:relative; z-index:1; margin-bottom:.3rem; }
    .stat-sub { font-size:.78rem; color:var(--soft); position:relative; z-index:1; }

    .keto-banner { border-radius:var(--radius); padding:2rem; margin-bottom:1.5rem; position:relative; overflow:hidden; animation:fadeUp .5s .25s ease both; }
    .keto-banner::before { content:''; position:absolute; top:-50%; right:-50%; width:200%; height:200%; background:radial-gradient(circle,rgba(255,255,255,.1) 0%,transparent 70%); animation:spin 18s linear infinite; pointer-events:none; }
    @keyframes spin { to{transform:rotate(360deg);} }
    .keto-content { position:relative; z-index:1; color:#fff; }
    .keto-header { display:flex; align-items:flex-start; gap:1.25rem; margin-bottom:1.5rem; flex-wrap:wrap; }
    .keto-icon-wrap { width:56px; height:56px; flex-shrink:0; background:rgba(255,255,255,.2); backdrop-filter:blur(10px); border-radius:14px; display:flex; align-items:center; justify-content:center; font-size:1.8rem; }
    .keto-meta { flex:1; }
    .keto-badges { display:flex; gap:.5rem; flex-wrap:wrap; margin-bottom:.4rem; }
    .keto-badge { background:rgba(255,255,255,.22); padding:.2rem .7rem; border-radius:99px; font-size:.72rem; font-weight:800; }
    .keto-title { font-family:'Fraunces',serif; font-size:1.4rem; font-weight:900; line-height:1.2; }
    .keto-cards { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:.875rem; margin-bottom:1.5rem; }
    .keto-card { background:rgba(0,0,0,.18); backdrop-filter:blur(10px); border-radius:12px; padding:1.1rem; border:1px solid rgba(255,255,255,.18); }
    .keto-card-label { display:flex; align-items:center; gap:.4rem; font-size:.68rem; font-weight:800; text-transform:uppercase; letter-spacing:.08em; opacity:.8; margin-bottom:.5rem; }
    .keto-card-text { font-size:.875rem; line-height:1.6; font-weight:600; }
    .keto-prog-bar { width:100%; height:10px; background:rgba(0,0,0,.25); border-radius:99px; overflow:hidden; margin:.75rem 0 .35rem; }
    .keto-prog-fill { height:100%; background:rgba(255,255,255,.8); border-radius:99px; position:relative; overflow:hidden; }
    .keto-prog-fill::after { content:''; position:absolute; inset:0; background:linear-gradient(90deg,transparent,rgba(255,255,255,.5),transparent); animation:shimmer 2s infinite; }
    .keto-prog-labels { display:flex; justify-content:space-between; font-size:.65rem; opacity:.7; font-weight:700; }
    .keto-action-btn { background:#fff; color:#111; padding:.7rem 1.4rem; border-radius:10px; border:none; font-weight:800; font-size:.875rem; cursor:pointer; display:inline-flex; align-items:center; gap:.5rem; transition:all .25s; }
    .keto-action-btn:hover { transform:translateY(-2px); box-shadow:0 8px 20px rgba(0,0,0,.25); }
    .keto-close { position:absolute; top:1rem; right:1rem; background:rgba(255,255,255,.2); border:none; width:32px; height:32px; border-radius:50%; color:#fff; font-size:1.2rem; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all .25s; z-index:20; }
    .keto-close:hover { background:rgba(255,255,255,.35); transform:rotate(90deg); }

    .tabs-wrap { display:flex; gap:.25rem; margin-bottom:1.5rem; background:var(--surface); border-radius:14px; padding:.3rem; overflow-x:auto; border:1px solid var(--border); }
    .tab-btn { display:flex; align-items:center; gap:.45rem; padding:.6rem 1.1rem; border-radius:10px; border:none; font-size:.82rem; font-weight:700; cursor:pointer; color:var(--soft); background:transparent; transition:all .2s; white-space:nowrap; flex-shrink:0; }
    .tab-btn:hover { color:var(--text); }
    .tab-btn.active { background:var(--card); color:var(--green); box-shadow:0 2px 8px rgba(0,0,0,.15); }
    .tab-badge { background:var(--gold); color:#000; padding:.1rem .45rem; border-radius:99px; font-size:.65rem; font-weight:800; }
    .tab-content { display:none; animation:fadeUp .3s ease; }
    .tab-content.active { display:block; }
    @keyframes fadeUp { from{opacity:0;transform:translateY(12px);} to{opacity:1;transform:translateY(0);} }

    .card { background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:1.75rem; transition:all .25s; }
    .card:hover { border-color:var(--border2); }
    .card-title { font-family:'Fraunces',serif; font-size:1.25rem; font-weight:700; margin-bottom:1.5rem; background:linear-gradient(135deg,var(--green),var(--green2)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
    .grid2 { display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:1rem; }

    .task-item { display:flex; align-items:center; justify-content:space-between; padding:1rem 1.25rem; background:var(--surface); border:1px solid var(--border); border-radius:14px; margin-bottom:.75rem; transition:all .25s; position:relative; overflow:hidden; }
    .task-item::before { content:''; position:absolute; left:0; top:0; bottom:0; width:3px; background:linear-gradient(135deg,var(--green),var(--green2)); transform:scaleY(0); transition:transform .25s; }
    .task-item:hover { border-color:rgba(16,185,129,.3); transform:translateX(4px); }
    .task-item:hover::before { transform:scaleY(1); }
    .task-left { display:flex; align-items:center; gap:.875rem; }
    .task-circle { width:36px; height:36px; border-radius:10px; flex-shrink:0; display:flex; align-items:center; justify-content:center; font-size:1rem; background:rgba(16,185,129,.1); border:1.5px solid rgba(16,185,129,.25); }
    .task-circle.done { background:linear-gradient(135deg,var(--green),var(--green2)); border-color:transparent; color:#fff; }
    .task-name { font-weight:600; font-size:.9rem; }
    .task-name.done { color:var(--soft); text-decoration:line-through; }
    .task-time { font-size:.75rem; color:var(--muted); margin-top:.15rem; }
    .xp-badge { padding:.2rem .6rem; border-radius:99px; font-size:.72rem; font-weight:800; background:rgba(16,185,129,.1); color:var(--green); border:1px solid rgba(16,185,129,.2); }

    .water-section { margin-top:1.25rem; padding:1.5rem; background:rgba(6,182,212,.06); border:1px solid rgba(6,182,212,.2); border-radius:14px; }
    .water-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; }
    .water-title { font-weight:700; font-size:.95rem; }
    .water-count { font-family:'Fraunces',serif; font-size:1.75rem; font-weight:900; color:var(--cyan); }
    .water-btns { display:flex; gap:.4rem; }
    .water-btn { padding:.35rem .75rem; border-radius:8px; font-size:.8rem; font-weight:700; border:1px solid var(--border); background:var(--card); color:var(--text); cursor:pointer; transition:all .2s; }
    .water-btn:hover { border-color:var(--cyan); color:var(--cyan); }
    .water-grid { display:grid; grid-template-columns:repeat(8,1fr); gap:.5rem; }
    .water-glass { aspect-ratio:1; border-radius:10px; border:1.5px solid var(--border); background:var(--surface); display:flex; align-items:center; justify-content:center; font-size:1.2rem; cursor:pointer; transition:all .3s; }
    .water-glass.filled { background:linear-gradient(135deg,var(--cyan),#0ea5e9); border-color:var(--cyan); transform:scale(1.08); box-shadow:0 0 14px rgba(6,182,212,.4); }
    .water-glass:hover { transform:scale(1.12) rotate(5deg); }

    .macros-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:1rem; margin-bottom:1.25rem; }
    .macro-card { border-radius:16px; padding:1.5rem; position:relative; overflow:hidden; color:#fff; transition:all .3s; }
    .macro-card:hover { transform:translateY(-6px); }
    .macro-card::before { content:''; position:absolute; top:-50%; right:-50%; width:200%; height:200%; background:radial-gradient(circle,rgba(255,255,255,.12) 0%,transparent 70%); animation:spin 14s linear infinite; pointer-events:none; }
    .macro-card.cal { background:linear-gradient(135deg,#f093fb,#f5576c); }
    .macro-card.pro { background:linear-gradient(135deg,#4facfe,#00f2fe); }
    .macro-card.fat { background:linear-gradient(135deg,#ffecd2,#fcb69f); }
    .macro-card.carb{ background:linear-gradient(135deg,#a8edea,#fed6e3); }
    .macro-pct { position:absolute; top:1rem; right:1rem; background:rgba(0,0,0,.22); padding:.2rem .6rem; border-radius:99px; font-size:.8rem; font-weight:800; color:#fff; z-index:1; }
    .macro-lbl { font-size:.72rem; font-weight:700; text-transform:uppercase; letter-spacing:.1em; opacity:.9; margin-bottom:.35rem; position:relative; z-index:1; }
    .macro-val { font-family:'Fraunces',serif; font-size:2.5rem; font-weight:900; position:relative; z-index:1; text-shadow:0 3px 8px rgba(0,0,0,.3); }
    .macro-target { font-size:.82rem; opacity:.85; position:relative; z-index:1; margin-bottom:.75rem; }
    .macro-prog { height:8px; background:rgba(255,255,255,.25); border-radius:99px; overflow:hidden; position:relative; z-index:1; }
    .macro-prog-fill { height:100%; background:rgba(255,255,255,.85); border-radius:99px; transition:width 1s ease; }

    .manual-form { background:linear-gradient(135deg,#667eea,#764ba2); border-radius:var(--radius); padding:2rem; color:#fff; position:relative; overflow:hidden; margin-top:1.25rem; }
    .manual-form::before { content:''; position:absolute; top:-50%; right:-50%; width:200%; height:200%; background:radial-gradient(circle,rgba(255,255,255,.08) 0%,transparent 70%); animation:spin 22s linear infinite; pointer-events:none; }
    .manual-form h4 { font-family:'Fraunces',serif; font-size:1.15rem; font-weight:700; margin-bottom:.4rem; position:relative; z-index:1; }
    .manual-form p { font-size:.85rem; opacity:.85; margin-bottom:1.25rem; position:relative; z-index:1; }
    .form-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(130px,1fr)); gap:.875rem; position:relative; z-index:1; }
    .form-group label { font-size:.72rem; font-weight:700; text-transform:uppercase; letter-spacing:.06em; display:block; margin-bottom:.4rem; }
    .form-group input { width:100%; padding:.65rem .875rem; border-radius:10px; border:1.5px solid rgba(255,255,255,.3); background:rgba(255,255,255,.12); color:#fff; font-size:.9rem; font-weight:700; outline:none; transition:all .2s; }
    .form-group input:focus { border-color:#fff; background:rgba(255,255,255,.22); }
    .btn-submit { margin-top:1.25rem; width:100%; padding:.875rem; border-radius:12px; border:none; background:#fff; color:#667eea; font-weight:800; font-size:.9rem; cursor:pointer; transition:all .25s; position:relative; z-index:1; }
    .btn-submit:hover { transform:translateY(-2px); box-shadow:0 8px 20px rgba(0,0,0,.2); }

    .chart-wrap { position:relative; height:200px; margin-top:1rem; }

    .cal-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:.5rem; }
    .cal-day { aspect-ratio:1; display:flex; align-items:center; justify-content:center; border-radius:10px; font-weight:700; font-size:.9rem; text-decoration:none; color:var(--soft); background:var(--surface); border:1.5px solid var(--border); transition:all .25s; }
    .cal-day:hover { transform:scale(1.1) translateY(-2px); border-color:var(--border2); }
    .cal-day.done { background:rgba(16,185,129,.12); color:var(--green); border-color:rgba(16,185,129,.3); }
    .cal-day.today { background:linear-gradient(135deg,var(--green),var(--green2)); color:#fff; border-color:transparent; transform:scale(1.15); box-shadow:0 6px 18px rgba(16,185,129,.4); z-index:5; }

    .meal-card { background:var(--card); border:1px solid var(--border); border-radius:var(--radius); overflow:hidden; transition:all .25s; }
    .meal-card:hover { border-color:var(--border2); transform:translateY(-3px); }
    .meal-img { width:100%; height:200px; object-fit:cover; display:block; }
    .meal-body { padding:1.25rem; }
    .meal-type { font-size:.72rem; font-weight:700; color:var(--soft); text-transform:uppercase; letter-spacing:.08em; margin-bottom:.4rem; }
    .meal-name { font-weight:700; font-size:.95rem; margin-bottom:1rem; color:var(--text); }
    .btn-recipe { display:flex; align-items:center; justify-content:center; gap:.4rem; width:100%; padding:.7rem; border-radius:10px; background:linear-gradient(135deg,var(--green),var(--green2)); color:#fff; font-weight:700; font-size:.82rem; text-decoration:none; transition:all .2s; }
    .btn-recipe:hover { transform:translateY(-2px); box-shadow:0 6px 16px rgba(16,185,129,.35); }

    .toast { position:fixed; top:5rem; right:1.5rem; z-index:9999; background:linear-gradient(135deg,var(--green),var(--green2)); color:#fff; padding:.875rem 1.5rem; border-radius:12px; font-weight:700; font-size:.875rem; box-shadow:0 10px 30px rgba(16,185,129,.4); transform:translateY(-20px); opacity:0; pointer-events:none; transition:all .35s cubic-bezier(.4,0,.2,1); }
    .toast.show { transform:translateY(0); opacity:1; }

    @media(max-width:768px){
      .stats-grid{ grid-template-columns:repeat(2,1fr); }
      .macros-grid{ grid-template-columns:repeat(2,1fr); }
      .water-grid{ grid-template-columns:repeat(4,1fr); }
      .cal-grid{ grid-template-columns:repeat(5,1fr); }
      .nav-links .nav-link span.nav-label { display:none; }
    }
    @media(max-width:480px){
      .stats-grid{ grid-template-columns:1fr 1fr; }
      .macros-grid{ grid-template-columns:1fr 1fr; }
    }
  </style>
</head>
<body>

<div class="bg-mesh" aria-hidden="true">
  <div class="orb o1"></div>
  <div class="orb o2"></div>
  <div class="orb o3"></div>
</div>

<nav>
  <div class="nav-inner">
    <a href="/dashboard" class="nav-brand">ü•ë <span>Keto Journey</span></a>
    <div class="nav-links">
      <a href="/dashboard"               class="nav-link active">üìä <span class="nav-label">Dashboard</span></a>
      <a href="/dashboard/shopping-list" class="nav-link">üõí <span class="nav-label">Shopping</span></a>
      <a href="/dashboard/recipes"       class="nav-link">üç≥ <span class="nav-label">Recipes</span></a>
      <a href="/dashboard/profile"       class="nav-link">üë§ <span class="nav-label">Profile</span></a>
      <a href="/dashboard/notifications" class="nav-link">üîî <span class="nav-label">Reminders</span></a>
      <a href="/dashboard/upgrade"       class="nav-link">‚ö° <span class="nav-label">Upgrade</span></a>
    </div>
    <div class="nav-right">
      <button class="theme-btn" id="themeBtn" title="Toggle theme">‚òÄÔ∏è</button>

      {incompleteTasks.length > 0 && (
        <div class="notif-wrap">
          <button class="notif-btn" id="notifBtn">
            üîî <span class="notif-badge">{incompleteTasks.length}</span>
          </button>
          <div class="notif-dropdown" id="notifDropdown">
            <div style="padding:1rem 1.25rem;border-bottom:1px solid var(--border);font-weight:800;font-size:.9rem;color:var(--green);">
              üîî {incompleteTasks.length} Pending Task{incompleteTasks.length !== 1 ? 's' : ''}
            </div>
            <div style="max-height:320px;overflow-y:auto;">
              {incompleteTasks.map(t => (
                <div class="notif-item" data-task={t.task_type}>
                  <div class="notif-icon">
                    {t.task_type==='breakfast'?'üç≥':t.task_type==='lunch'?'ü•ó':t.task_type==='dinner'?'üçΩÔ∏è':t.task_type==='snack'?'üçé':'üíß'}
                  </div>
                  <div>
                    <div style="font-weight:700;font-size:.85rem;">{t.task_title}</div>
                    <div style="font-size:.75rem;color:var(--soft);">+{t.xp_earned} XP</div>
                  </div>
                </div>
              ))}
            </div>
            <div style="padding:.875rem 1.25rem;border-top:1px solid var(--border);">
              <button id="seeAllTasks" style="width:100%;padding:.6rem;border-radius:10px;background:linear-gradient(135deg,var(--green),var(--green2));border:none;color:#fff;font-weight:700;font-size:.8rem;cursor:pointer;">View All Tasks ‚Üí</button>
            </div>
          </div>
        </div>
      )}

      <a href="/dashboard/profile" class="nav-avatar">{profile.full_name.charAt(0).toUpperCase()}</a>
    </div>
  </div>
</nav>

<div class="page">

  <div class="dash-header">
    <div>
      <div class="dash-greeting">{greeting}, {userName} üëã</div>
      <h1 class="dash-title">Day <span class="hl">{viewDay}</span> of 30</h1>
      <p class="dash-sub">
        {viewDay === currentDay
          ? `You're ${Math.round((currentDay/30)*100)}% through your transformation`
          : `Viewing Day ${viewDay} ‚Ä¢ Currently on Day ${currentDay}`}
      </p>
      <div class="progress-wrap">
        <div class="progress-info">
          <span class="progress-label">Journey Progress</span>
          <span class="progress-val">{Math.round((currentDay/30)*100)}%</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" style={`width:${(currentDay/30)*100}%`}></div>
        </div>
      </div>
    </div>
    <div class="dash-nav-btns">
      <a href={viewDay > 1 ? `/dashboard/?day=${viewDay - 1}` : '#'} class="btn-nav" style={viewDay <= 1 ? 'opacity:.4;pointer-events:none;' : ''}>‚Üê Prev</a>
      <a href={viewDay < 30 ? `/dashboard/?day=${viewDay + 1}` : '#'} class="btn-nav" style={viewDay >= 30 ? 'opacity:.4;pointer-events:none;' : ''}>Next ‚Üí</a>
    </div>
  </div>

  <div class="stats-grid">
    <div class="stat-card">
      <div class="glow" style="background:var(--green);"></div>
      <div class="stat-icon" style="background:rgba(16,185,129,.1);">üìÖ</div>
      <div class="stat-label">Current Day</div>
      <div class="stat-val" style="background:linear-gradient(135deg,var(--green),var(--green2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;">{currentDay}</div>
      <div class="stat-sub">of 30 days</div>
    </div>
    <div class="stat-card">
      <div class="glow" style="background:var(--blue);"></div>
      <div class="stat-icon" style="background:rgba(59,130,246,.1);">‚úÖ</div>
      <div class="stat-label">Tasks Done</div>
      <div class="stat-val" style="background:linear-gradient(135deg,var(--blue),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent;">{completedTasks}<span style="font-size:1.2rem;opacity:.5;">/{totalTasks}</span></div>
      <div class="progress-bar" style="margin-top:.6rem;"><div class="progress-fill" style={`width:${progressPercentage}%`}></div></div>
    </div>
    <div class="stat-card">
      <div class="glow" style="background:var(--gold);"></div>
      <div class="stat-icon" style="background:rgba(245,158,11,.1);">‚ö°</div>
      <div class="stat-label">Total XP</div>
      <div class="stat-val" style="background:linear-gradient(135deg,var(--gold),#fbbf24);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">{journey.total_xp}</div>
      <div class="stat-sub">Level {journey.level}</div>
    </div>
    <div class="stat-card">
      <div class="glow" style="background:var(--red);"></div>
      <div class="stat-icon" style="background:rgba(239,68,68,.1);">üî•</div>
      <div class="stat-label">Streak</div>
      <div class="stat-val" style="background:linear-gradient(135deg,var(--red),var(--gold));-webkit-background-clip:text;-webkit-text-fill-color:transparent;">{journey.streak_days}</div>
      <div class="stat-sub">days in a row</div>
    </div>
  </div>

  {showKetoFluTip && (
    <div class="keto-banner" id="keto-banner" style={`background:${currentTip.gradient};`}>
      <button class="keto-close" id="ketoClose">√ó</button>
      <div class="keto-content">
        <div class="keto-header">
          <div class="keto-icon-wrap">{currentTip.icon}</div>
          <div class="keto-meta">
            <div class="keto-badges">
              <span class="keto-badge">{currentTip.day} of 10</span>
              <span class="keto-badge">üõ°Ô∏è Keto Flu Guide</span>
              {currentTip.severity === 'danger' && <span class="keto-badge" style="background:rgba(255,255,255,.35);">‚ö†Ô∏è Hardest Day</span>}
              {currentTip.severity === 'success' && <span class="keto-badge" style="background:rgba(255,255,255,.35);">üéâ Victory!</span>}
            </div>
            <div class="keto-title">{currentTip.title}</div>
          </div>
        </div>
        <div class="keto-cards">
          <div class="keto-card">
            <div class="keto-card-label"><span>üî¨</span> What's Happening</div>
            <p class="keto-card-text">{currentTip.whatsHappening}</p>
          </div>
          <div class="keto-card">
            <div class="keto-card-label"><span>üí°</span> Pro Tip</div>
            <p class="keto-card-text">{currentTip.tip}</p>
          </div>
          <div class="keto-card">
            <div class="keto-card-label"><span>üõí</span> Today's Recommendation</div>
            <p class="keto-card-text">{currentTip.suggestion}</p>
          </div>
        </div>
        <div>
          <div style="display:flex;justify-content:space-between;font-size:.78rem;font-weight:700;opacity:.85;margin-bottom:.4rem;">
            <span>Keto Flu Progress</span><span>{currentTip.progress}% Complete</span>
          </div>
          <div class="keto-prog-bar">
            <div class="keto-prog-fill" style={`width:${currentTip.progress}%`}></div>
          </div>
          <div class="keto-prog-labels">
            <span>Day 1</span><span>Day 5 Halfway</span><span>Day 10 üëë</span>
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:1rem;flex-wrap:wrap;margin-top:1.25rem;">
          <button class="keto-action-btn">‚ö° {currentTip.action}</button>
          <span style="font-size:.82rem;opacity:.85;font-weight:600;">
            üèÜ {10-viewDay>0 ? `${10-viewDay} days left until you beat keto flu!` : `You beat keto flu! üéâ`}
          </span>
        </div>
      </div>
    </div>
  )}

  <div class="tabs-wrap">
    <button class="tab-btn active" data-tab="tasks">
      ‚úÖ Tasks
      {incompleteTasks.length > 0 && <span class="tab-badge">{incompleteTasks.length}</span>}
    </button>
    <button class="tab-btn" data-tab="meals">üçΩÔ∏è Meals</button>
    <button class="tab-btn" data-tab="nutrition">üìä Nutrition</button>
    <button class="tab-btn" data-tab="calendar">üìÜ Calendar</button>
    <button class="tab-btn" data-tab="progress">üìà Progress</button>
  </div>

  <!-- TAB: Tasks -->
  <div id="tab-tasks" class="tab-content active">
    <div class="card">
      <div class="card-title">Today's Tasks</div>
      {filteredTasks.map(task => (
        <div class="task-item">
          <div class="task-left">
            <div class={`task-circle ${task.completed ? 'done' : ''}`}>
              {task.completed ? '‚úì' : task.task_type==='breakfast'?'üç≥':task.task_type==='lunch'?'ü•ó':task.task_type==='dinner'?'üçΩÔ∏è':task.task_type==='snack'?'üçé':'üíß'}
            </div>
            <div>
              <div class={`task-name ${task.completed ? 'done' : ''}`}>{task.task_title}</div>
              {task.completed && task.completed_at && (
                <div class="task-time">‚úì Completed at {new Date(task.completed_at).toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'})}</div>
              )}
            </div>
          </div>
          <span class="xp-badge">+{task.xp_earned} XP</span>
        </div>
      ))}

      {waterIntake && (
        <div class="water-section">
          <div class="water-header">
            <div>
              <div class="water-title">üíß Water Intake</div>
              <div style="font-size:.82rem;color:var(--soft);margin-top:.2rem;">
                <span class="water-count" id="waterCount">{waterIntake.glasses_count}</span>
                <span style="color:var(--muted);"> / {waterIntake.target_glasses} glasses</span>
              </div>
            </div>
            {canInteract && (
              <div class="water-btns">
                <button class="water-btn" data-w="minus">‚àí</button>
                <button class="water-btn" data-w="plus">+ Add</button>
              </div>
            )}
          </div>
          <div class="water-grid">
            {Array.from({length: waterIntake.target_glasses}, (_, i) => (
              <div class={`water-glass ${i < waterIntake.glasses_count ? 'filled' : ''}`} data-gi={i}>üíß</div>
            ))}
          </div>
        </div>
      )}
    </div>
  </div>

  <!-- TAB: Meals -->
  <div id="tab-meals" class="tab-content">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;flex-wrap:wrap;gap:.75rem;">
      <span class="card-title" style="margin:0;">Today's Meals</span>
      <a href="/dashboard/shopping-list" style="display:inline-flex;align-items:center;gap:.4rem;padding:.6rem 1.1rem;border-radius:10px;background:linear-gradient(135deg,var(--green),var(--green2));color:#fff;font-weight:700;font-size:.82rem;text-decoration:none;">üõí Shopping List</a>
    </div>
    <div class="grid2">
      {todayMeals.map(meal => (
        <div class="meal-card">
          {meal.recipe?.image_url && (
            <div style="position:relative;">
              <img src={meal.recipe.image_url} alt={meal.recipe.title} class="meal-img"/>
              <div style="position:absolute;bottom:0;left:0;right:0;padding:1rem;background:linear-gradient(to top,rgba(0,0,0,.7),transparent);">
                <span style="color:#fff;font-weight:700;font-size:.82rem;">
                  {meal.meal_type==='breakfast'?'‚òÄÔ∏è Breakfast':meal.meal_type==='lunch'?'üåû Lunch':meal.meal_type==='dinner'?'üåô Dinner':'üçé Snack'}
                </span>
              </div>
            </div>
          )}
          <div class="meal-body">
            {!meal.recipe?.image_url && <div class="meal-type">{meal.meal_type}</div>}
            <div class="meal-name">{meal.recipe?.title}</div>
            <a href={`/dashboard/recipe/${meal.recipe?.id}`} class="btn-recipe">View Recipe ‚Üí</a>
          </div>
        </div>
      ))}
      {todayMeals.length === 0 && (
        <div class="card" style="grid-column:1/-1;text-align:center;color:var(--soft);padding:3rem;">
          <div style="font-size:3rem;margin-bottom:1rem;">üçΩÔ∏è</div>
          <p>No meals planned for this day yet.</p>
        </div>
      )}
    </div>
  </div>

  <!-- TAB: Nutrition -->
  <div id="tab-nutrition" class="tab-content">
    <div class="card-title" style="margin-bottom:1.25rem;">üìä Smart Macros Tracker</div>
    <div class="macros-grid">
      <div class="macro-card cal">
        <div class="macro-pct">{caloriesPercent}%</div>
        <div class="macro-lbl">Calories</div>
        <div class="macro-val" data-mt="calories">{actualCalories}</div>
        <div class="macro-target">Target: {targetCalories} kcal</div>
        <div class="macro-prog"><div class="macro-prog-fill" data-mp="calories" style={`width:${Math.min(caloriesPercent,100)}%`}></div></div>
      </div>
      <div class="macro-card pro">
        <div class="macro-pct">{proteinPercent}%</div>
        <div class="macro-lbl">Protein</div>
        <div class="macro-val" data-mt="protein">{actualProtein}g</div>
        <div class="macro-target">Target: {targetProtein}g</div>
        <div class="macro-prog"><div class="macro-prog-fill" data-mp="protein" style={`width:${Math.min(proteinPercent,100)}%`}></div></div>
      </div>
      <div class="macro-card fat">
        <div class="macro-pct">{fatPercent}%</div>
        <div class="macro-lbl">Fat</div>
        <div class="macro-val" data-mt="fat">{actualFat}g</div>
        <div class="macro-target">Target: {targetFat}g</div>
        <div class="macro-prog"><div class="macro-prog-fill" data-mp="fat" style={`width:${Math.min(fatPercent,100)}%`}></div></div>
      </div>
      <div class="macro-card carb">
        <div class="macro-pct">{carbsPercent}%</div>
        <div class="macro-lbl">Net Carbs</div>
        <div class="macro-val" data-mt="carbs">{actualCarbs}g</div>
        <div class="macro-target">Target: {targetCarbs}g</div>
        <div class="macro-prog"><div class="macro-prog-fill" data-mp="carbs" style={`width:${Math.min(carbsPercent,100)}%`}></div></div>
      </div>
    </div>

    {actualCalories > 0 && (
      <div class="grid2" style="margin-bottom:1.25rem;">
        <div class="card">
          <div class="card-title">ü•ß Calorie Distribution</div>
          <div class="chart-wrap"><canvas id="pieChart"></canvas></div>
        </div>
        <div class="card">
          <div class="card-title">üìä Target vs Actual</div>
          <div class="chart-wrap"><canvas id="barChart"></canvas></div>
        </div>
      </div>
    )}

    <div class="manual-form">
      <h4>‚ûï Add Custom Food</h4>
      <p>Track additional meals or snacks that aren't in your plan</p>
      <form id="macroForm">
        <div class="form-grid">
          <div class="form-group"><label>Calories</label><input type="number" id="mCal" placeholder="0" min="0"/></div>
          <div class="form-group"><label>Protein (g)</label><input type="number" id="mPro" placeholder="0" min="0" step=".1"/></div>
          <div class="form-group"><label>Fat (g)</label><input type="number" id="mFat" placeholder="0" min="0" step=".1"/></div>
          <div class="form-group"><label>Net Carbs (g)</label><input type="number" id="mCarb" placeholder="0" min="0" step=".1"/></div>
        </div>
        <button type="submit" class="btn-submit">‚ú® Add to Today's Macros</button>
      </form>
    </div>
  </div>

  <!-- TAB: Calendar -->
  <div id="tab-calendar" class="tab-content">
    <div class="card">
      <div class="card-title">üìÜ 30-Day Journey</div>
      <div class="cal-grid">
        {Array.from({length:30},(_,i)=>i+1).map(day=>(
          <a href={`/dashboard?day=${day}`}
             class={`cal-day ${day < currentDay ? 'done' : ''} ${day === currentDay ? 'today' : ''}`}>
            {day}
          </a>
        ))}
      </div>
    </div>
  </div>

  <!-- TAB: Progress -->
  <div id="tab-progress" class="tab-content">
    <div class="grid2">
      <div class="card">
        <div class="card-title">‚öñÔ∏è Weight Progress</div>
        {(weightHistory && weightHistory.length > 1) ? (
          <div class="chart-wrap" style="height:240px;"><canvas id="weightChart"></canvas></div>
        ) : (
          <div style="text-align:center;padding:2rem;color:var(--soft);">
            <div style="font-size:2.5rem;margin-bottom:.75rem;">‚öñÔ∏è</div>
            <p>Log your weight in Profile to see your progress chart here!</p>
          </div>
        )}
      </div>
      <div class="card">
        <div class="card-title">üèÜ Achievements</div>
        <div style="display:flex;flex-direction:column;gap:.75rem;">
          {[
            { icon:'üî•', label:'Streak Warrior', desc:`${journey.streak_days} days streak`, done: journey.streak_days >= 3 },
            { icon:'‚ö°', label:'XP Collector', desc:`${journey.total_xp} XP earned`, done: journey.total_xp >= 100 },
            { icon:'üíß', label:'Hydration Hero', desc:'Hit 8 glasses today', done: (waterIntake?.glasses_count||0) >= 8 },
            { icon:'‚úÖ', label:'Task Master', desc:'Complete all tasks today', done: completedTasks === totalTasks && totalTasks > 0 },
            { icon:'üìÖ', label:'Week Warrior', desc:'Reach Day 7', done: currentDay >= 7 },
            { icon:'üëë', label:'Keto Champion', desc:'Beat keto flu (Day 10)', done: currentDay >= 10 },
          ].map(a => (
            <div style={`display:flex;align-items:center;gap:.875rem;padding:.875rem;border-radius:12px;background:${a.done?'rgba(16,185,129,.08)':'var(--surface)'};border:1px solid ${a.done?'rgba(16,185,129,.25)':'var(--border)'};`}>
              <div style={`width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.25rem;background:${a.done?'rgba(16,185,129,.15)':'rgba(255,255,255,.04)'};filter:${a.done?'none':'grayscale(1) opacity(.4)'}`}>{a.icon}</div>
              <div style="flex:1;">
                <div style={`font-weight:700;font-size:.875rem;color:${a.done?'var(--green)':'var(--soft)'}`}>{a.label}</div>
                <div style="font-size:.75rem;color:var(--muted);">{a.desc}</div>
              </div>
              {a.done && <span style="font-size:.7rem;font-weight:800;color:var(--green);background:rgba(16,185,129,.12);border:1px solid rgba(16,185,129,.25);padding:.15rem .5rem;border-radius:99px;">‚úì Earned</span>}
            </div>
          ))}
        </div>
      </div>
    </div>
  </div>

</div><!-- /page -->

<!-- Toast -->
<div class="toast" id="toast"></div>

<script is:inline define:vars={{
  actualCalories, actualProtein, actualFat, actualCarbs,
  targetCalories, targetProtein, targetFat, targetCarbs,
  weightHistoryJson,
  currentDay, viewDay,
}}>

// ‚îÄ‚îÄ THEME ‚îÄ‚îÄ
const html     = document.documentElement;
const themeBtn = document.getElementById('themeBtn');
function applyTheme(t) {
  html.setAttribute('data-theme', t);
  localStorage.setItem('keto-theme', t);
  if (themeBtn) themeBtn.textContent = t === 'dark' ? '‚òÄÔ∏è' : 'üåô';
}
applyTheme(localStorage.getItem('keto-theme') || 'dark');
themeBtn?.addEventListener('click', () => {
  applyTheme(html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
});

// ‚îÄ‚îÄ NOTIFS ‚îÄ‚îÄ
const notifBtn  = document.getElementById('notifBtn');
const notifDrop = document.getElementById('notifDropdown');
notifBtn?.addEventListener('click', e => { e.stopPropagation(); notifDrop?.classList.toggle('open'); });
document.addEventListener('click', e => { if (!notifDrop?.contains(e.target) && e.target !== notifBtn) notifDrop?.classList.remove('open'); });
document.getElementById('seeAllTasks')?.addEventListener('click', () => { notifDrop?.classList.remove('open'); switchTab('tasks'); });
document.querySelectorAll('.notif-item').forEach(n => n.addEventListener('click', () => { notifDrop?.classList.remove('open'); switchTab('tasks'); }));

// ‚îÄ‚îÄ TABS ‚îÄ‚îÄ
function switchTab(name) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + name)?.classList.add('active');
  document.querySelector(`[data-tab="${name}"]`)?.classList.add('active');
}
document.querySelectorAll('.tab-btn').forEach(b => {
  b.addEventListener('click', () => { const t = b.getAttribute('data-tab'); if(t) switchTab(t); });
});

// ‚îÄ‚îÄ KETO BANNER ‚îÄ‚îÄ
const banner    = document.getElementById('keto-banner');
const ketoClose = document.getElementById('ketoClose');
if (banner && ketoClose) {
  const key = 'keto_flu_' + window.location.search;
  if (localStorage.getItem(key) === new Date().toDateString()) banner.style.display = 'none';
  ketoClose.addEventListener('click', () => {
    banner.style.opacity = '0'; banner.style.transform = 'translateY(-10px) scale(.97)';
    localStorage.setItem(key, new Date().toDateString());
    setTimeout(() => banner.style.display = 'none', 300);
  });
}

// ‚îÄ‚îÄ WATER ‚îÄ‚îÄ
let currentWater = parseInt(document.getElementById('waterCount')?.textContent || '0');
document.querySelectorAll('[data-w]').forEach(btn => {
  btn.addEventListener('click', async () => {
    const newCount = Math.max(0, Math.min(8, currentWater + (btn.getAttribute('data-w') === 'plus' ? 1 : -1)));
    if (newCount === currentWater) return;
    try {
      const r = await fetch('/api/water/update', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ glasses: newCount }) });
      if (r.ok) {
        currentWater = newCount;
        const el = document.getElementById('waterCount');
        if (el) el.textContent = newCount;
        document.querySelectorAll('[data-gi]').forEach((g, i) => g.classList.toggle('filled', i < newCount));
        showToast(`üíß ${newCount} / 8 glasses logged!`);
      }
    } catch(e) {}
  });
});

// ‚îÄ‚îÄ MANUAL MACROS ‚îÄ‚îÄ
let mCal = actualCalories, mPro = actualProtein, mFat = actualFat, mCarb = actualCarbs;
document.getElementById('macroForm')?.addEventListener('submit', e => {
  e.preventDefault();
  mCal  += parseFloat(document.getElementById('mCal')?.value)  || 0;
  mPro  += parseFloat(document.getElementById('mPro')?.value)  || 0;
  mFat  += parseFloat(document.getElementById('mFat')?.value)  || 0;
  mCarb += parseFloat(document.getElementById('mCarb')?.value) || 0;
  updateMacro('calories', mCal,  targetCalories);
  updateMacro('protein',  mPro,  targetProtein);
  updateMacro('fat',      mFat,  targetFat);
  updateMacro('carbs',    mCarb, targetCarbs);
  e.target.reset();
  showToast('‚úÖ Macros added!');
});
function updateMacro(type, val, tgt) {
  const pct = Math.round((val/tgt)*100);
  const el  = document.querySelector(`[data-mt="${type}"]`);
  if (el) el.textContent = type==='calories' ? Math.round(val) : Math.round(val)+'g';
  const card = el?.closest('.macro-card');
  if (card) {
    const pEl = card.querySelector('.macro-pct');
    if (pEl) pEl.textContent = pct+'%';
    const bar = card.querySelector(`[data-mp="${type}"]`);
    if (bar) bar.style.width = Math.min(pct,100)+'%';
  }
}

// ‚îÄ‚îÄ CHARTS ‚îÄ‚îÄ
window.addEventListener('load', () => {
  if (typeof Chart === 'undefined') return;
  const dark = html.getAttribute('data-theme') === 'dark';
  const tCol = dark ? '#e8edf5' : '#0f172a';
  const gCol = dark ? 'rgba(255,255,255,.06)' : 'rgba(0,0,0,.05)';
  Chart.defaults.color = tCol;

  if (actualCalories > 0) {
    const pie = document.getElementById('pieChart');
    if (pie) new Chart(pie, {
      type:'doughnut',
      data:{ labels:['Protein','Fat','Net Carbs'], datasets:[{ data:[mPro*4,mFat*9,mCarb*4], backgroundColor:['#4facfe','#fcb69f','#fed6e3'], borderWidth:0, hoverOffset:8 }] },
      options:{ responsive:true, maintainAspectRatio:false, cutout:'65%', plugins:{ legend:{ position:'bottom', labels:{ padding:16, font:{size:13,weight:'bold'} } } } }
    });
    const bar = document.getElementById('barChart');
    if (bar) new Chart(bar, {
      type:'bar',
      data:{
        labels:['Protein (g)','Fat (g)','Carbs (g)'],
        datasets:[
          { label:'Target', data:[targetProtein,targetFat,targetCarbs], backgroundColor:'rgba(148,163,184,.25)', borderColor:'rgba(148,163,184,.5)', borderWidth:2, borderRadius:8 },
          { label:'Actual', data:[mPro,mFat,mCarb], backgroundColor:['rgba(79,172,254,.7)','rgba(252,182,159,.7)','rgba(254,214,227,.7)'], borderColor:['#4facfe','#fcb69f','#fed6e3'], borderWidth:2, borderRadius:8 }
        ]
      },
      options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{beginAtZero:true,grid:{color:gCol}}, x:{grid:{display:false}} }, plugins:{ legend:{ position:'top' } } }
    });
  }

  const wh = JSON.parse(weightHistoryJson || '[]');
  if (wh.length > 1) {
    const wc = document.getElementById('weightChart');
    if (wc) new Chart(wc, {
      type:'line',
      data:{
        labels: wh.map(w => new Date(w.logged_at).toLocaleDateString('en-US',{month:'short',day:'numeric'})),
        datasets:[{
          label:'Weight (kg)', data: wh.map(w => w.weight_kg),
          borderColor:'#10b981', backgroundColor:'rgba(16,185,129,.1)',
          borderWidth:2.5, pointBackgroundColor:'#10b981', pointRadius:4,
          tension:.4, fill:true,
        }]
      },
      options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{grid:{color:gCol}}, x:{grid:{display:false}} }, plugins:{ legend:{display:false} } }
    });
  }
});

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ
function showToast(msg) {
  const t = document.getElementById('toast');
  if (!t) return;
  t.textContent = msg;
  t.className = 'toast show';
  setTimeout(() => t.classList.remove('show'), 2800);
}

</script>

<!-- ‚úÖ AI Coach ÿßŸÑÿµÿ≠Ÿäÿ≠ ÿßŸÑŸàÿ≠ŸäÿØ ‚Äî Ÿäÿ≥ÿ™ÿØÿπŸä /api/chat/gemini ŸÖŸÜ ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ± -->
{isElite && (
  <AiCoach
    userName={userName}
    currentDay={currentDay}
    streak={journey.streak_days}
    totalXp={journey.total_xp}
    level={journey.level}
  />
)}

</body>
</html>