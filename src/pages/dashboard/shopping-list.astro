---
import { supabase, getProfile, isSubscriptionActive, getUserJourney, getDailyTasks } from '../../lib/supabase';

const accessToken = Astro.cookies.get('sb-access-token')?.value;
if (!accessToken) return Astro.redirect('/login');

const { data: { user } } = await supabase.auth.getUser(accessToken);
if (!user) return Astro.redirect('/login');

const profile = await getProfile(user.id);
if (!profile || !isSubscriptionActive(profile)) {
  return Astro.redirect('/dashboard/upgrade');
}

const journey = await getUserJourney(user.id);
const currentDay = journey?.current_day || 1;

const dailyTasks = await getDailyTasks(user.id, currentDay);
const incompleteTasks = dailyTasks?.filter(t => t.task_type !== 'reflection' && t.task_type !== 'weight' && !t.completed) || [];

const weekParam = Astro.url.searchParams.get('week') || '1';
const weekNumber = parseInt(weekParam);
const startDay = (weekNumber - 1) * 7 + 1;
const endDay = Math.min(startDay + 6, 30);

if (weekNumber < 1 || weekNumber > 5) {
  return Astro.redirect('/dashboard/shopping-list?week=1');
}

const { data: mealPlans } = await supabase
  .from('meal_plans')
  .select('*, recipe:recipes(*)')
  .eq('plan_type', 'basic_30')
  .gte('day_number', startDay)
  .lte('day_number', endDay)
  .order('day_number');

const ingredientMap = new Map();
mealPlans?.forEach(meal => {
  if (meal.recipe?.ingredients) {
    meal.recipe.ingredients.forEach((ing: any) => {
      const key = ing.item.toLowerCase().trim();
      if (ingredientMap.has(key)) {
        const existing = ingredientMap.get(key);
        const newAmount = parseFloat(existing.amount || 0) + parseFloat(ing.amount || 0);
        ingredientMap.set(key, { item: ing.item, amount: Math.ceil(newAmount * 10) / 10, unit: existing.unit || ing.unit, count: existing.count + 1 });
      } else {
        ingredientMap.set(key, { ...ing, count: 1 });
      }
    });
  }
});

const shoppingList = Array.from(ingredientMap.values()).sort((a, b) => a.item.localeCompare(b.item));

const categories: any = {
  'Proteins & Meat': { keywords: ['eggs', 'chicken', 'beef', 'pork', 'salmon', 'shrimp', 'tuna', 'bacon', 'sausage', 'ham', 'steak', 'ribeye', 'pepperoni'], icon: 'ü•©', gradient: 'linear-gradient(135deg,#ef4444,#dc2626)', glow: 'rgba(239,68,68,.25)', tip: 'Buy in bulk and freeze portions' },
  'Dairy & Cheese':  { keywords: ['cheese', 'butter', 'cream', 'yogurt', 'feta', 'parmesan', 'mozzarella', 'cheddar', 'ricotta'], icon: 'üßÄ', gradient: 'linear-gradient(135deg,#f59e0b,#d97706)', glow: 'rgba(245,158,11,.25)', tip: 'Check expiry dates carefully' },
  'Fresh Vegetables':{ keywords: ['avocado', 'spinach', 'lettuce', 'broccoli', 'asparagus', 'cauliflower', 'zucchini', 'tomato', 'cucumber', 'pepper', 'mushroom', 'onion', 'celery', 'green beans'], icon: 'ü•¨', gradient: 'linear-gradient(135deg,#10b981,#059669)', glow: 'rgba(16,185,129,.25)', tip: 'Buy fresh, store in cool place' },
  'Nuts & Seeds':    { keywords: ['almonds', 'macadamia', 'pine nuts', 'chia', 'peanut', 'walnut', 'pecan'], icon: 'ü•ú', gradient: 'linear-gradient(135deg,#8b5cf6,#7c3aed)', glow: 'rgba(139,92,246,.25)', tip: 'Store in airtight containers' },
  'Pantry Staples':  { keywords: ['olive oil', 'coconut', 'almond flour', 'soy sauce', 'mustard', 'mayo', 'vanilla', 'baking powder', 'protein powder', 'cocoa'], icon: 'üè∫', gradient: 'linear-gradient(135deg,#6b7280,#4b5563)', glow: 'rgba(107,114,128,.25)', tip: 'Stock up ‚Äî they last months' },
  'Herbs & Spices':  { keywords: ['salt', 'pepper', 'garlic', 'paprika', 'thyme', 'basil', 'ginger', 'chives', 'dill', 'rosemary', 'cinnamon'], icon: 'üåø', gradient: 'linear-gradient(135deg,#06b6d4,#0891b2)', glow: 'rgba(6,182,212,.25)', tip: 'Fresh herbs add amazing flavor' },
};

const categorizedList: any = {};
Object.keys(categories).forEach(cat => { categorizedList[cat] = []; });
categorizedList['Other'] = [];

shoppingList.forEach(item => {
  let categorized = false;
  for (const [category, data] of Object.entries(categories)) {
    if ((data as any).keywords.some((kw: string) => item.item.toLowerCase().includes(kw))) {
      categorizedList[category].push(item);
      categorized = true;
      break;
    }
  }
  if (!categorized) categorizedList['Other'].push(item);
});

const totalItems = shoppingList.length;
const checkedCategories = Object.entries(categorizedList).filter(([,items]: any) => items.length > 0).length;
const userName = profile.full_name?.split(' ')[0] || 'Friend';
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Shopping List ‚Äî Keto Journey</title>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,700;0,9..144,900;1,9..144,700&family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600;9..40,700&display=swap" rel="stylesheet"/>

  <script is:inline>
    (function(){
      const t = localStorage.getItem('keto-theme') || 'dark';
      document.documentElement.setAttribute('data-theme', t);
    })();
  </script>

  <style>
    :root {
      --bg:      #0c1117;
      --surface: #131b24;
      --card:    #1a2535;
      --card2:   #1e2d42;
      --border:  rgba(255,255,255,.07);
      --border2: rgba(255,255,255,.12);
      --text:    #e8edf5;
      --muted:   #4a5a6e;
      --soft:    #8a9ab0;
      --green:   #10b981;
      --green2:  #34d399;
      --blue:    #3b82f6;
      --purple:  #8b5cf6;
      --gold:    #f59e0b;
      --red:     #ef4444;
      --cyan:    #06b6d4;
      --radius:  20px;
      --nav-h:   64px;
    }
    [data-theme="light"] {
      --bg:      #f0f4f8;
      --surface: #ffffff;
      --card:    #ffffff;
      --card2:   #f8fafc;
      --border:  rgba(0,0,0,.07);
      --border2: rgba(0,0,0,.12);
      --text:    #0f172a;
      --muted:   #94a3b8;
      --soft:    #64748b;
    }

    *,*::before,*::after { margin:0; padding:0; box-sizing:border-box; }
    html { scroll-behavior:smooth; }
    body {
      font-family:'DM Sans',sans-serif;
      background:var(--bg); color:var(--text);
      min-height:100vh; overflow-x:hidden;
      transition:background .3s,color .3s;
    }

    /* BG */
    .bg-mesh { position:fixed; inset:0; pointer-events:none; z-index:0; overflow:hidden; }
    .orb { position:absolute; border-radius:50%; filter:blur(100px); animation:orbDrift ease-in-out infinite; opacity:.5; }
    [data-theme="light"] .orb { opacity:.2; }
    .o1{width:600px;height:600px;background:rgba(16,185,129,.07);top:-150px;left:-150px;animation-duration:24s;}
    .o2{width:500px;height:500px;background:rgba(59,130,246,.05);bottom:-100px;right:-100px;animation-duration:30s;animation-delay:-14s;}
    .o3{width:350px;height:350px;background:rgba(139,92,246,.04);top:50%;left:50%;animation-duration:20s;animation-delay:-8s;}
    @keyframes orbDrift{0%,100%{transform:translate(0,0) scale(1);}33%{transform:translate(40px,-50px) scale(1.06);}66%{transform:translate(-30px,40px) scale(.95);}}

    /* NAV */
    nav {
      position:sticky; top:0; z-index:100; height:var(--nav-h);
      background:rgba(12,17,23,.85); border-bottom:1px solid var(--border);
      backdrop-filter:blur(20px); display:flex; align-items:center;
      transition:background .3s;
    }
    [data-theme="light"] nav { background:rgba(255,255,255,.88); }
    .nav-inner { max-width:1280px; margin:0 auto; padding:0 1.5rem; width:100%; display:flex; align-items:center; gap:1.5rem; }
    .nav-brand { display:flex; align-items:center; gap:.6rem; text-decoration:none; font-family:'Fraunces',serif; font-weight:700; font-size:1.1rem; color:var(--text); flex-shrink:0; }
    .nav-links { display:flex; align-items:center; gap:.25rem; flex:1; overflow-x:auto; }
    .nav-links::-webkit-scrollbar{display:none;}
    .nav-link { display:flex; align-items:center; gap:.4rem; padding:.45rem .9rem; border-radius:10px; font-size:.82rem; font-weight:600; color:var(--soft); text-decoration:none; white-space:nowrap; transition:all .2s; }
    .nav-link:hover,.nav-link.active { background:rgba(16,185,129,.1); color:var(--green); }
    .nav-link.active { font-weight:700; }
    .nav-right { display:flex; align-items:center; gap:.75rem; flex-shrink:0; }
    .theme-btn { width:38px; height:38px; border-radius:10px; background:var(--card); border:1px solid var(--border); display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:1rem; transition:all .2s; }
    .theme-btn:hover { border-color:var(--green); }
    .notif-wrap { position:relative; }
    .notif-btn { width:38px; height:38px; border-radius:10px; background:var(--card); border:1px solid var(--border); display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:1rem; position:relative; transition:all .2s; }
    .notif-btn:hover { border-color:var(--green); }
    .notif-badge { position:absolute; top:-5px; right:-5px; background:var(--red); color:#fff; width:18px; height:18px; border-radius:50%; font-size:.65rem; font-weight:800; display:flex; align-items:center; justify-content:center; animation:pulseBadge 2s infinite; }
    @keyframes pulseBadge{0%,100%{transform:scale(1);}50%{transform:scale(1.2);}}
    .notif-dropdown { position:absolute; top:calc(100% + .5rem); right:0; width:340px; background:var(--card); border:1px solid var(--border); border-radius:var(--radius); overflow:hidden; box-shadow:0 20px 60px rgba(0,0,0,.4); display:none; z-index:200; }
    .notif-dropdown.open { display:block; animation:dropIn .25s ease; }
    @keyframes dropIn{from{opacity:0;transform:translateY(-8px);}to{opacity:1;transform:translateY(0);}}
    .notif-item { display:flex; align-items:center; gap:.875rem; padding:.875rem 1.25rem; border-bottom:1px solid var(--border); cursor:pointer; transition:background .2s; }
    .notif-item:hover { background:rgba(16,185,129,.06); }
    .nav-avatar { width:38px; height:38px; border-radius:10px; background:linear-gradient(135deg,var(--green),var(--blue)); display:flex; align-items:center; justify-content:center; color:#fff; font-weight:800; font-size:.95rem; text-decoration:none; transition:all .2s; }
    .nav-avatar:hover { transform:scale(1.05); }

    /* PAGE */
    .page { position:relative; z-index:1; max-width:1280px; margin:0 auto; padding:2rem 1.5rem 5rem; }

    /* HERO */
    .hero {
      border-radius:var(--radius); padding:2.5rem;
      background:linear-gradient(135deg,rgba(16,185,129,.12),rgba(59,130,246,.08));
      border:1px solid rgba(16,185,129,.2);
      margin-bottom:2rem; position:relative; overflow:hidden;
      animation:fadeUp .5s ease both;
    }
    .hero::before {
      content:''; position:absolute; top:-80px; right:-80px;
      width:300px; height:300px; border-radius:50%;
      background:radial-gradient(circle,rgba(16,185,129,.15),transparent 70%);
      animation:heroGlow 6s ease-in-out infinite;
    }
    @keyframes heroGlow{0%,100%{transform:scale(1);}50%{transform:scale(1.2);}}
    .hero-content { position:relative; z-index:1; }
    .hero-title { font-family:'Fraunces',serif; font-size:clamp(2rem,4vw,3rem); font-weight:900; line-height:1.1; margin-bottom:.5rem; }
    .hero-title .hl { font-style:italic; background:linear-gradient(135deg,var(--green),var(--green2)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
    .hero-sub { font-size:.95rem; color:var(--soft); margin-bottom:1.5rem; }

    /* WEEK PILLS */
    .week-nav { display:flex; gap:.5rem; flex-wrap:wrap; margin-bottom:1.5rem; }
    .week-pill {
      padding:.45rem 1.1rem; border-radius:99px; font-size:.8rem; font-weight:700;
      background:var(--card); border:1.5px solid var(--border);
      color:var(--soft); text-decoration:none; transition:all .2s;
    }
    .week-pill:hover { border-color:var(--green); color:var(--green); }
    .week-pill.active {
      background:linear-gradient(135deg,var(--green),var(--green2));
      border-color:transparent; color:#fff;
      box-shadow:0 4px 14px rgba(16,185,129,.4);
    }

    /* STATS ROW */
    .stats-row { display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:1rem; margin-bottom:2rem; }
    .stat-pill {
      background:var(--card); border:1px solid var(--border); border-radius:16px;
      padding:1.25rem 1.5rem; display:flex; align-items:center; gap:1rem;
      transition:all .3s; animation:fadeUp .5s ease both;
    }
    .stat-pill:nth-child(1){animation-delay:.05s;}
    .stat-pill:nth-child(2){animation-delay:.1s;}
    .stat-pill:nth-child(3){animation-delay:.15s;}
    .stat-pill:hover { transform:translateY(-3px); border-color:var(--border2); }
    .stat-icon { width:42px; height:42px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:1.2rem; flex-shrink:0; }
    .stat-val { font-family:'Fraunces',serif; font-size:1.75rem; font-weight:900; line-height:1; }
    .stat-lbl { font-size:.72rem; font-weight:700; color:var(--soft); text-transform:uppercase; letter-spacing:.06em; margin-top:.2rem; }

    /* ACTION BTNS */
    .action-row { display:flex; gap:.75rem; margin-bottom:2rem; flex-wrap:wrap; }
    .btn {
      display:inline-flex; align-items:center; gap:.5rem;
      padding:.65rem 1.25rem; border-radius:12px; font-size:.82rem; font-weight:700;
      cursor:pointer; border:none; text-decoration:none; transition:all .25s;
    }
    .btn-primary { background:linear-gradient(135deg,var(--green),var(--green2)); color:#fff; box-shadow:0 4px 14px rgba(16,185,129,.35); }
    .btn-primary:hover { transform:translateY(-2px); box-shadow:0 8px 20px rgba(16,185,129,.45); }
    .btn-secondary { background:var(--card); border:1px solid var(--border); color:var(--soft); }
    .btn-secondary:hover { border-color:var(--green); color:var(--green); }

    /* PROGRESS BAR */
    .progress-wrap { margin-bottom:2rem; }
    .progress-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:.5rem; }
    .progress-label { font-size:.78rem; font-weight:700; color:var(--soft); }
    .progress-val { font-size:.78rem; font-weight:800; color:var(--green); }
    .progress-track { height:8px; background:var(--surface); border-radius:99px; overflow:hidden; }
    .progress-fill { height:100%; border-radius:99px; background:linear-gradient(90deg,var(--green),var(--green2),var(--blue)); transition:width .8s cubic-bezier(.4,0,.2,1); position:relative; overflow:hidden; }
    .progress-fill::after { content:''; position:absolute; inset:0; background:linear-gradient(90deg,transparent,rgba(255,255,255,.35),transparent); animation:shimmer 2s infinite; }
    @keyframes shimmer{0%{transform:translateX(-100%);}100%{transform:translateX(100%);}}

    /* CATEGORY SECTION */
    .cat-section {
      background:var(--card); border:1px solid var(--border);
      border-radius:var(--radius); overflow:hidden;
      margin-bottom:1.25rem; transition:all .25s;
      animation:fadeUp .4s ease both;
    }
    .cat-section:hover { border-color:var(--border2); }

    .cat-header {
      display:flex; align-items:center; gap:1rem;
      padding:1.25rem 1.5rem; cursor:pointer;
      transition:background .2s; user-select:none;
      border-bottom:1px solid var(--border);
    }
    .cat-header:hover { background:rgba(255,255,255,.02); }

    .cat-icon-wrap {
      width:46px; height:46px; border-radius:13px;
      display:flex; align-items:center; justify-content:center;
      font-size:1.4rem; flex-shrink:0;
    }
    .cat-name { font-family:'Fraunces',serif; font-size:1.1rem; font-weight:700; flex:1; }
    .cat-count {
      padding:.2rem .65rem; border-radius:99px; font-size:.72rem; font-weight:800;
      background:rgba(16,185,129,.1); color:var(--green); border:1px solid rgba(16,185,129,.2);
    }
    .cat-chevron { color:var(--muted); transition:transform .3s; font-size:.9rem; }
    .cat-section.collapsed .cat-chevron { transform:rotate(-90deg); }
    .cat-section.collapsed .cat-body { display:none; }

    .cat-tip {
      margin:1rem 1.5rem 0; padding:.875rem 1rem;
      background:rgba(16,185,129,.06); border:1px solid rgba(16,185,129,.15);
      border-radius:12px; font-size:.8rem; color:var(--soft); font-weight:600;
    }

    .cat-body { padding:1rem 1.5rem 1.5rem; }
    .items-grid { display:flex; flex-direction:column; gap:.6rem; margin-top:.75rem; }

    /* ITEM ROW */
    .item-row {
      display:flex; align-items:center; gap:.875rem;
      padding:.875rem 1rem; border-radius:13px;
      background:var(--surface); border:1.5px solid transparent;
      transition:all .25s; position:relative; overflow:hidden;
    }
    .item-row::before {
      content:''; position:absolute; left:0; top:0; bottom:0; width:3px;
      border-radius:3px 0 0 3px; transition:opacity .25s; opacity:0;
    }
    .item-row:hover { border-color:rgba(16,185,129,.25); transform:translateX(4px); }
    .item-row:hover::before { opacity:1; background:linear-gradient(to bottom,var(--green),var(--green2)); }
    .item-row.checked { opacity:.45; }
    .item-row.checked .item-name { text-decoration:line-through; }

    .item-check {
      width:22px; height:22px; border-radius:7px; flex-shrink:0;
      border:2px solid rgba(16,185,129,.4); background:transparent;
      cursor:pointer; appearance:none; transition:all .25s; position:relative;
    }
    .item-check:checked {
      background:linear-gradient(135deg,var(--green),var(--green2));
      border-color:transparent;
    }
    .item-check:checked::after {
      content:'‚úì'; position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      color:#fff; font-size:.75rem; font-weight:900;
    }
    .item-check:hover { border-color:var(--green); transform:scale(1.1); }

    .item-info { flex:1; min-width:0; }
    .item-name { font-weight:700; font-size:.9rem; color:var(--text); }
    .item-amount { font-size:.78rem; color:var(--soft); font-weight:600; margin-top:.1rem; }

    .item-badge {
      padding:.15rem .55rem; border-radius:99px; font-size:.68rem; font-weight:800;
      background:rgba(99,102,241,.1); color:#818cf8; border:1px solid rgba(99,102,241,.2);
      flex-shrink:0; white-space:nowrap;
    }

    /* SUMMARY CARD */
    .summary-card {
      background:var(--card); border:1px solid var(--border);
      border-radius:var(--radius); padding:2rem; margin-top:1.5rem;
      text-align:center; animation:fadeUp .4s ease both;
    }
    .summary-title { font-family:'Fraunces',serif; font-size:1.4rem; font-weight:700; margin-bottom:1.5rem; background:linear-gradient(135deg,var(--green),var(--green2)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
    .summary-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:1rem; }
    .summary-item {
      padding:1.25rem; border-radius:14px; border:1px solid var(--border);
      background:var(--surface); transition:all .25s;
    }
    .summary-item:hover { border-color:var(--border2); transform:translateY(-2px); }
    .summary-num { font-family:'Fraunces',serif; font-size:2rem; font-weight:900; margin-bottom:.3rem; }
    .summary-lbl { font-size:.72rem; font-weight:700; color:var(--soft); text-transform:uppercase; letter-spacing:.06em; }
    .summary-footer { font-size:.75rem; color:var(--muted); margin-top:1.5rem; }

    /* EMPTY */
    .empty-state { text-align:center; padding:4rem 2rem; }
    .empty-state .empty-icon { font-size:4rem; margin-bottom:1rem; opacity:.5; }
    .empty-state p { color:var(--soft); font-size:.95rem; }

    /* TOAST */
    .toast { position:fixed; top:5rem; right:1.5rem; z-index:9999; background:linear-gradient(135deg,var(--green),var(--green2)); color:#fff; padding:.875rem 1.5rem; border-radius:12px; font-weight:700; font-size:.875rem; box-shadow:0 10px 30px rgba(16,185,129,.4); transform:translateY(-20px); opacity:0; pointer-events:none; transition:all .35s cubic-bezier(.4,0,.2,1); }
    .toast.show { transform:translateY(0); opacity:1; }

    @keyframes fadeUp{from{opacity:0;transform:translateY(12px);}to{opacity:1;transform:translateY(0);}}

    @media(max-width:768px){
      .stats-row { grid-template-columns:repeat(2,1fr); }
      .hero-title { font-size:1.8rem; }
    }
    @media print {
      nav,.action-row,.week-nav,.no-print,.item-check { display:none !important; }
      body { background:#fff !important; color:#000 !important; }
      .cat-section { border:1px solid #ddd !important; box-shadow:none !important; }
      .cat-section.collapsed .cat-body { display:block !important; }
    }
  </style>
</head>
<body>

<div class="bg-mesh" aria-hidden="true">
  <div class="orb o1"></div><div class="orb o2"></div><div class="orb o3"></div>
</div>

<!-- NAV -->
<nav>
  <div class="nav-inner">
    <a href="/dashboard" class="nav-brand">ü•ë <span>Keto Journey</span></a>
    <div class="nav-links">
      <a href="/dashboard"               class="nav-link">üìä <span>Dashboard</span></a>
      <a href="/dashboard/shopping-list" class="nav-link active">üõí <span>Shopping</span></a>
      <a href="/dashboard/recipes"       class="nav-link">üç≥ <span>Recipes</span></a>
      <a href="/dashboard/profile"       class="nav-link">üë§ <span>Profile</span></a>
      <a href="/dashboard/notifications" class="nav-link">üîî <span>Reminders</span></a>
      <a href="/dashboard/upgrade"       class="nav-link">‚ö° <span>Upgrade</span></a>
    </div>
    <div class="nav-right">
      <button class="theme-btn" id="themeBtn" title="Toggle theme">‚òÄÔ∏è</button>

      {incompleteTasks.length > 0 && (
        <div class="notif-wrap">
          <button class="notif-btn" id="notifBtn">
            üîî <span class="notif-badge">{incompleteTasks.length}</span>
          </button>
          <div class="notif-dropdown" id="notifDropdown">
            <div style="padding:1rem 1.25rem;border-bottom:1px solid var(--border);font-weight:800;font-size:.9rem;color:var(--green);">
              üîî {incompleteTasks.length} Pending Task{incompleteTasks.length !== 1 ? 's' : ''}
            </div>
            <div style="max-height:320px;overflow-y:auto;">
              {incompleteTasks.map(t => (
                <div class="notif-item">
                  <div style="width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--green),var(--green2));display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0;">
                    {t.task_type==='breakfast'?'üç≥':t.task_type==='lunch'?'ü•ó':t.task_type==='dinner'?'üçΩÔ∏è':t.task_type==='snack'?'üçé':'üíß'}
                  </div>
                  <div>
                    <div style="font-weight:700;font-size:.85rem;">{t.task_title}</div>
                    <div style="font-size:.75rem;color:var(--soft);">+{t.xp_earned} XP</div>
                  </div>
                </div>
              ))}
            </div>
            <div style="padding:.875rem 1.25rem;border-top:1px solid var(--border);">
              <a href="/dashboard" style="display:block;text-align:center;padding:.6rem;border-radius:10px;background:linear-gradient(135deg,var(--green),var(--green2));color:#fff;font-weight:700;font-size:.8rem;text-decoration:none;">View All Tasks ‚Üí</a>
            </div>
          </div>
        </div>
      )}

      <a href="/dashboard/profile" class="nav-avatar">{profile.full_name.charAt(0).toUpperCase()}</a>
    </div>
  </div>
</nav>

<!-- PAGE -->
<div class="page">

  <!-- HERO -->
  <div class="hero">
    <div class="hero-content">
      <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:1.5rem;flex-wrap:wrap;">
        <div>
          <div style="font-size:.78rem;font-weight:700;color:rgba(16,185,129,.8);text-transform:uppercase;letter-spacing:.1em;margin-bottom:.5rem;">
            Hey {userName} üëã
          </div>
          <h1 class="hero-title">
            Week <span class="hl">{weekNumber}</span> Shopping
          </h1>
          <p class="hero-sub">Days {startDay}‚Äì{endDay} ‚Ä¢ {totalItems} ingredients auto-calculated from your meal plan</p>

          <!-- Week Pills -->
          <div class="week-nav no-print">
            {[1,2,3,4,5].map(w => (
              <a href={`/dashboard/shopping-list?week=${w}`} class={`week-pill ${w === weekNumber ? 'active' : ''}`}>
                Week {w}
              </a>
            ))}
          </div>
        </div>

        <!-- Mini stats -->
        <div style="display:flex;gap:.75rem;flex-wrap:wrap;">
          <div style="background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:14px;padding:1rem 1.25rem;text-align:center;min-width:90px;">
            <div style="font-family:'Fraunces',serif;font-size:2rem;font-weight:900;color:var(--green);line-height:1;">{totalItems}</div>
            <div style="font-size:.72rem;font-weight:700;color:var(--soft);margin-top:.2rem;text-transform:uppercase;letter-spacing:.05em;">Items</div>
          </div>
          <div style="background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:14px;padding:1rem 1.25rem;text-align:center;min-width:90px;">
            <div style="font-family:'Fraunces',serif;font-size:2rem;font-weight:900;color:var(--cyan);line-height:1;">{checkedCategories}</div>
            <div style="font-size:.72rem;font-weight:700;color:var(--soft);margin-top:.2rem;text-transform:uppercase;letter-spacing:.05em;">Categories</div>
          </div>
          <div style="background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:14px;padding:1rem 1.25rem;text-align:center;min-width:90px;">
            <div style="font-family:'Fraunces',serif;font-size:2rem;font-weight:900;color:var(--gold);line-height:1;">{endDay - startDay + 1}</div>
            <div style="font-size:.72rem;font-weight:700;color:var(--soft);margin-top:.2rem;text-transform:uppercase;letter-spacing:.05em;">Days</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- PROGRESS -->
  <div class="progress-wrap no-print">
    <div class="progress-header">
      <span class="progress-label">Shopping Progress</span>
      <span class="progress-val" id="progressLabel">0 / {totalItems} checked</span>
    </div>
    <div class="progress-track">
      <div class="progress-fill" id="progressFill" style="width:0%"></div>
    </div>
  </div>

  <!-- ACTION BTNS -->
  <div class="action-row no-print">
    <button onclick="window.print()" class="btn btn-primary">üñ®Ô∏è Print List</button>
    <button onclick="copyList()" class="btn btn-secondary">üìã Copy to Clipboard</button>
    <button onclick="uncheckAll()" class="btn btn-secondary">‚Ü∫ Reset All</button>
  </div>

  <!-- SHOPPING LIST -->
  {Object.entries(categorizedList).map(([category, items]: [string, any], catIdx) => (
    items.length > 0 && (
      <div class="cat-section" id={`cat-${catIdx}`} style={`animation-delay:${catIdx * 0.05}s`}>
        <div class="cat-header" onclick={`toggleCat('cat-${catIdx}')`}>
          <div class="cat-icon-wrap" style={`background:${(categories as any)[category]?.gradient || 'linear-gradient(135deg,#6b7280,#4b5563)'};box-shadow:0 4px 12px ${(categories as any)[category]?.glow || 'rgba(107,114,128,.2)'}`}>
            {(categories as any)[category]?.icon || 'üì¶'}
          </div>
          <div class="cat-name">{category}</div>
          <span class="cat-count">{items.length}</span>
          <span class="cat-chevron">‚ñæ</span>
        </div>

        <div class="cat-body">
          {(categories as any)[category]?.tip && (
            <div class="cat-tip no-print">
              üí° {(categories as any)[category].tip}
            </div>
          )}
          <div class="items-grid">
            {items.map((item: any, idx: number) => (
              <div class="item-row" id={`item-${catIdx}-${idx}`}>
                <input
                  type="checkbox"
                  class="item-check no-print"
                  onchange={`toggleItem(this,'item-${catIdx}-${idx}')`}
                />
                <div class="item-info">
                  <div class="item-name">{item.item}</div>
                  <div class="item-amount">{item.amount} {item.unit}</div>
                </div>
                {item.count > 1 && (
                  <span class="item-badge">√ó{item.count} recipes</span>
                )}
              </div>
            ))}
          </div>
        </div>
      </div>
    )
  ))}

  {totalItems === 0 && (
    <div class="empty-state">
      <div class="empty-icon">üõí</div>
      <p>No ingredients found for this week.<br/>Make sure your meal plan is set up.</p>
    </div>
  )}

  <!-- SUMMARY -->
  {totalItems > 0 && (
    <div class="summary-card no-print">
      <div class="summary-title">Shopping Summary ‚Äî Week {weekNumber}</div>
      <div class="summary-grid">
        <div class="summary-item">
          <div class="summary-num" style="color:var(--blue);">{totalItems}</div>
          <div class="summary-lbl">Total Items</div>
        </div>
        <div class="summary-item">
          <div class="summary-num" style="color:var(--green);">{checkedCategories}</div>
          <div class="summary-lbl">Categories</div>
        </div>
        <div class="summary-item">
          <div class="summary-num" style="color:var(--gold);">W{weekNumber}</div>
          <div class="summary-lbl">Meal Plan</div>
        </div>
        <div class="summary-item">
          <div class="summary-num" style="color:var(--purple);">{endDay - startDay + 1}</div>
          <div class="summary-lbl">Days Covered</div>
        </div>
      </div>
      <div class="summary-footer">
        Generated {new Date().toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'})} ¬∑ Keto Journey
      </div>
    </div>
  )}

  <!-- PREV/NEXT NAV -->
  <div class="no-print" style="display:flex;justify-content:center;gap:.75rem;margin-top:2rem;flex-wrap:wrap;">
    {weekNumber > 1 && (
      <a href={`/dashboard/shopping-list?week=${weekNumber - 1}`} class="btn btn-secondary">‚Üê Week {weekNumber - 1}</a>
    )}
    {weekNumber < 5 && (
      <a href={`/dashboard/shopping-list?week=${weekNumber + 1}`} class="btn btn-primary">Week {weekNumber + 1} ‚Üí</a>
    )}
  </div>

</div><!-- /page -->

<div class="toast" id="toast"></div>

<script is:inline define:vars={{ totalItems }}>

// ‚îÄ‚îÄ THEME ‚îÄ‚îÄ
const html     = document.documentElement;
const themeBtn = document.getElementById('themeBtn');
function applyTheme(t) {
  html.setAttribute('data-theme', t);
  localStorage.setItem('keto-theme', t);
  if (themeBtn) themeBtn.textContent = t === 'dark' ? '‚òÄÔ∏è' : 'üåô';
}
applyTheme(localStorage.getItem('keto-theme') || 'dark');
themeBtn?.addEventListener('click', () => {
  applyTheme(html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
});

// ‚îÄ‚îÄ NOTIFS ‚îÄ‚îÄ
const notifBtn  = document.getElementById('notifBtn');
const notifDrop = document.getElementById('notifDropdown');
notifBtn?.addEventListener('click', e => { e.stopPropagation(); notifDrop?.classList.toggle('open'); });
document.addEventListener('click', e => { if (notifDrop && !notifDrop.contains(e.target) && e.target !== notifBtn) notifDrop.classList.remove('open'); });

// ‚îÄ‚îÄ PROGRESS ‚îÄ‚îÄ
let checkedCount = 0;
function updateProgress() {
  const pct = totalItems > 0 ? Math.round((checkedCount / totalItems) * 100) : 0;
  const fill = document.getElementById('progressFill');
  const label = document.getElementById('progressLabel');
  if (fill)  fill.style.width = pct + '%';
  if (label) label.textContent = `${checkedCount} / ${totalItems} checked`;
}

// ‚îÄ‚îÄ TOGGLE ITEM ‚îÄ‚îÄ
function toggleItem(checkbox, id) {
  const row = document.getElementById(id);
  if (!row) return;
  if (checkbox.checked) {
    row.classList.add('checked');
    checkedCount++;
    if (checkedCount === totalItems) showToast('üéâ All items checked! You\'re ready to shop!');
  } else {
    row.classList.remove('checked');
    checkedCount--;
  }
  updateProgress();
}

// ‚îÄ‚îÄ TOGGLE CATEGORY ‚îÄ‚îÄ
function toggleCat(id) {
  const el = document.getElementById(id);
  if (el) el.classList.toggle('collapsed');
}

// ‚îÄ‚îÄ UNCHECK ALL ‚îÄ‚îÄ
function uncheckAll() {
  document.querySelectorAll('.item-check').forEach(cb => {
    cb.checked = false;
  });
  document.querySelectorAll('.item-row').forEach(row => row.classList.remove('checked'));
  checkedCount = 0;
  updateProgress();
  showToast('‚Ü∫ All items reset');
}

// ‚îÄ‚îÄ COPY LIST ‚îÄ‚îÄ
function copyList() {
  const lines = ['üõí Keto Shopping List\n'];
  document.querySelectorAll('.cat-section').forEach(section => {
    const name = section.querySelector('.cat-name')?.textContent?.trim();
    const items = [];
    section.querySelectorAll('.item-row:not(.checked)').forEach(row => {
      const n = row.querySelector('.item-name')?.textContent?.trim();
      const a = row.querySelector('.item-amount')?.textContent?.trim();
      if (n) items.push(`  ‚òê ${n} ‚Äî ${a}`);
    });
    if (items.length > 0) {
      lines.push(`\n${name}`);
      lines.push(...items);
    }
  });
  navigator.clipboard.writeText(lines.join('\n'))
    .then(() => showToast('üìã Copied to clipboard!'))
    .catch(() => showToast('‚ùå Failed to copy'));
}

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ
function showToast(msg) {
  const t = document.getElementById('toast');
  if (!t) return;
  t.textContent = msg;
  t.className = 'toast show';
  setTimeout(() => t.classList.remove('show'), 2800);
}

window.toggleItem  = toggleItem;
window.toggleCat   = toggleCat;
window.uncheckAll  = uncheckAll;
window.copyList    = copyList;

</script>
</body>
</html>