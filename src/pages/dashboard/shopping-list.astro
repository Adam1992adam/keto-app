---
import { supabase, getProfile, isSubscriptionActive, getUserJourney, getDailyTasks } from '../../lib/supabase';

const accessToken = Astro.cookies.get('sb-access-token')?.value;
if (!accessToken) return Astro.redirect('/login');

const { data: { user } } = await supabase.auth.getUser(accessToken);
if (!user) return Astro.redirect('/login');

const profile = await getProfile(user.id);
if (!profile || !isSubscriptionActive(profile)) {
  return Astro.redirect('/dashboard/upgrade');
}

const journey = await getUserJourney(user.id);
const currentDay = journey?.current_day || 1;

const dailyTasks = await getDailyTasks(user.id, currentDay);
const incompleteTasks = dailyTasks?.filter(t => t.task_type !== 'reflection' && t.task_type !== 'weight' && !t.completed) || [];

const weekParam = Astro.url.searchParams.get('week') || '1';
const weekNumber = parseInt(weekParam);
const startDay = (weekNumber - 1) * 7 + 1;
const endDay = startDay + 6;

if (weekNumber < 1 || weekNumber > 5) {
  return Astro.redirect('/dashboard/shopping-list?week=1');
}

const { data: mealPlans } = await supabase
  .from('meal_plans')
  .select('*, recipe:recipes(*)')
  .eq('plan_type', 'basic_30')
  .gte('day_number', startDay)
  .lte('day_number', endDay)
  .order('day_number');

const ingredientMap = new Map();

mealPlans?.forEach(meal => {
  if (meal.recipe?.ingredients) {
    meal.recipe.ingredients.forEach((ing: any) => {
      const key = ing.item.toLowerCase().trim();
      if (ingredientMap.has(key)) {
        const existing = ingredientMap.get(key);
        const newAmount = parseFloat(existing.amount || 0) + parseFloat(ing.amount || 0);
        ingredientMap.set(key, {
          item: ing.item,
          amount: Math.ceil(newAmount * 10) / 10,
          unit: existing.unit || ing.unit,
          count: existing.count + 1
        });
      } else {
        ingredientMap.set(key, { ...ing, count: 1 });
      }
    });
  }
});

const shoppingList = Array.from(ingredientMap.values()).sort((a, b) => 
  a.item.localeCompare(b.item)
);

const categories: any = {
  'Proteins & Meat': {
    keywords: ['eggs', 'chicken', 'beef', 'pork', 'salmon', 'shrimp', 'tuna', 'bacon', 'sausage', 'ham', 'steak', 'ribeye', 'pepperoni'],
    icon: 'ü•©',
    color: '#ef4444',
    tip: 'Buy in bulk and freeze portions for savings'
  },
  'Dairy & Cheese': {
    keywords: ['cheese', 'butter', 'cream', 'yogurt', 'feta', 'parmesan', 'mozzarella', 'cheddar', 'ricotta', 'blue cheese'],
    icon: 'üßÄ',
    color: '#f59e0b',
    tip: 'Check expiry dates - buy what you\'ll use this week'
  },
  'Fresh Vegetables': {
    keywords: ['avocado', 'spinach', 'lettuce', 'broccoli', 'asparagus', 'cauliflower', 'zucchini', 'tomato', 'cucumber', 'pepper', 'mushroom', 'onion', 'celery', 'green beans'],
    icon: 'ü•¨',
    color: '#10b981',
    tip: 'Buy fresh and store properly to last the week'
  },
  'Nuts & Seeds': {
    keywords: ['almonds', 'macadamia', 'pine nuts', 'chia', 'peanut'],
    icon: 'ü•ú',
    color: '#8b5cf6',
    tip: 'Buy in bulk and store in airtight containers'
  },
  'Pantry Staples': {
    keywords: ['olive oil', 'coconut', 'almond flour', 'soy sauce', 'mustard', 'mayo', 'vanilla', 'baking powder', 'protein powder', 'cocoa'],
    icon: 'üè∫',
    color: '#6b7280',
    tip: 'Stock up on these - they last months'
  },
  'Herbs & Spices': {
    keywords: ['salt', 'pepper', 'garlic', 'paprika', 'thyme', 'basil', 'ginger', 'chives', 'dill', 'rosemary', 'cinnamon'],
    icon: 'üåø',
    color: '#059669',
    tip: 'Fresh herbs add amazing flavor - grow your own!'
  }
};

const categorizedList: any = {};
Object.keys(categories).forEach(cat => {
  categorizedList[cat] = [];
});
categorizedList['Other'] = [];

shoppingList.forEach(item => {
  let categorized = false;
  for (const [category, data] of Object.entries(categories)) {
    if ((data as any).keywords.some((kw: string) => item.item.toLowerCase().includes(kw))) {
      categorizedList[category].push(item);
      categorized = true;
      break;
    }
  }
  if (!categorized) {
    categorizedList['Other'].push(item);
  }
});

const totalItems = shoppingList.length;
const estimatedCost = shoppingList.reduce((sum, item) => {
  const basePrices: any = {
    'eggs': 0.3, 'chicken': 3, 'beef': 5, 'cheese': 4, 'butter': 0.5,
    'avocado': 1.5, 'broccoli': 2, 'almonds': 1
  };
  const key = Object.keys(basePrices).find(k => item.item.toLowerCase().includes(k));
  return sum + (key ? basePrices[key] * item.count : 2);
}, 0);
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shopping List - Keto Journey</title>
  
  <style>
    :root {
      --bg-primary: #ffffff;
      --bg-secondary: #f9fafb;
      --bg-card: #ffffff;
      --text-primary: #111827;
      --text-secondary: #6b7280;
      --border-color: #e5e7eb;
      --accent-primary: #10b981;
      --accent-secondary: #34d399;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
      --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
      --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
      --shadow-xl: 0 20px 25px rgba(0,0,0,0.15);
    }

    [data-theme="dark"] {
      --bg-primary: #1a1a2e;
      --bg-secondary: #16213e;
      --bg-card: #0f3460;
      --text-primary: #eaeaea;
      --text-secondary: #a0aec0;
      --border-color: #2d3748;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.3);
      --shadow-md: 0 4px 6px rgba(0,0,0,0.4);
      --shadow-lg: 0 10px 15px rgba(0,0,0,0.5);
      --shadow-xl: 0 20px 25px rgba(0,0,0,0.6);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-secondary);
      color: var(--text-primary);
      transition: all 0.3s ease;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1.5rem;
    }

    /* Navigation 3D */
    nav {
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border-color);
      padding: 1rem 0;
      position: sticky;
      top: 0;
      z-index: 50;
      box-shadow: var(--shadow-md);
      backdrop-filter: blur(10px);
    }

    nav .flex {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    nav a {
      color: var(--text-secondary);
      text-decoration: none;
      padding: 0.5rem 1rem;
      border-radius: 0.75rem;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    nav a:hover, nav a.active {
      color: var(--accent-primary);
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(52, 211, 153, 0.1));
      transform: translateY(-2px);
    }

    /* Dark Mode Toggle */
    .theme-toggle {
      position: relative;
      width: 60px;
      height: 30px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 9999px;
      cursor: pointer;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.2), var(--shadow-md);
      transition: all 0.3s ease;
    }

    .theme-toggle:hover {
      transform: scale(1.05);
    }

    .theme-toggle-slider {
      position: absolute;
      top: 3px;
      left: 3px;
      width: 24px;
      height: 24px;
      background: white;
      border-radius: 50%;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
    }

    [data-theme="dark"] .theme-toggle {
      background: linear-gradient(135deg, #2d3561 0%, #1a1f3a 100%);
    }

    [data-theme="dark"] .theme-toggle-slider {
      transform: translateX(30px);
      background: #1a1a2e;
      color: #fbbf24;
    }

    /* Notification Bell */
    .notification-bell {
      position: relative;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      border: none;
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: var(--shadow-md);
    }

    .notification-bell:hover {
      transform: translateY(-4px) scale(1.05);
      box-shadow: var(--shadow-xl);
    }

    .notification-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      font-size: 0.75rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.15); }
    }

    /* Notification Dropdown */
    .notification-dropdown {
      position: absolute;
      top: calc(100% + 0.5rem);
      right: 0;
      width: 380px;
      max-height: 500px;
      background: var(--bg-card);
      border-radius: 1.5rem;
      box-shadow: var(--shadow-xl);
      border: 1px solid var(--border-color);
      display: none;
      overflow: hidden;
      animation: slideDown 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    .notification-dropdown.active {
      display: block;
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-20px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    .notification-item {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      gap: 1rem;
      align-items: center;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .notification-item:hover {
      background: linear-gradient(90deg, rgba(16, 185, 129, 0.05), transparent);
      transform: translateX(4px);
    }

    .notification-icon {
      width: 3rem;
      height: 3rem;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      border-radius: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      flex-shrink: 0;
      box-shadow: var(--shadow-md);
    }

    /* Hero */
    .hero {
      background: linear-gradient(135deg, #10b981, #059669, #047857);
      border-radius: 2rem;
      padding: 3rem;
      margin-bottom: 2rem;
      box-shadow: var(--shadow-xl);
      position: relative;
      overflow: hidden;
    }

    .hero::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      animation: rotate 20s linear infinite;
    }

    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .hero-content {
      position: relative;
      z-index: 10;
      color: white;
    }

    /* Card 3D */
    .card-3d {
      background: var(--bg-card);
      border-radius: 1.5rem;
      padding: 2rem;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border-color);
      transition: all 0.3s ease;
    }

    .card-3d:hover {
      box-shadow: var(--shadow-xl);
      transform: translateY(-4px);
    }

    /* Category Card */
    .category-card {
      background: var(--bg-card);
      border-radius: 1.5rem;
      padding: 2rem;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border-color);
      margin-bottom: 2rem;
      transition: all 0.3s ease;
    }

    .category-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-xl);
    }

    .category-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 3px solid var(--accent-primary);
    }

    /* Shopping Item */
    .shopping-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      background: var(--bg-secondary);
      border-radius: 1rem;
      margin-bottom: 0.75rem;
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }

    .shopping-item:hover {
      border-color: var(--accent-primary);
      transform: translateX(8px);
      box-shadow: var(--shadow-md);
    }

    .shopping-item.checked {
      opacity: 0.5;
      text-decoration: line-through;
    }

    .checkbox-3d {
      width: 1.5rem;
      height: 1.5rem;
      border-radius: 0.5rem;
      border: 2px solid var(--accent-primary);
      cursor: pointer;
      transition: all 0.3s ease;
      appearance: none;
      background: var(--bg-card);
    }

    .checkbox-3d:checked {
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      transform: scale(1.1);
    }

    .checkbox-3d:checked::after {
      content: '‚úì';
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      font-weight: 700;
    }

    /* Button 3D */
    .btn-3d {
      display: inline-flex;
      align-items: center;
      gap: 0.75rem;
      padding: 1rem 2rem;
      border-radius: 1rem;
      font-weight: 700;
      cursor: pointer;
      border: none;
      text-decoration: none;
      transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      box-shadow: var(--shadow-md);
    }

    .btn-primary-3d {
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      color: white;
    }

    .btn-primary-3d:hover {
      transform: translateY(-4px) scale(1.05);
      box-shadow: var(--shadow-xl);
    }

    .btn-secondary-3d {
      background: var(--bg-card);
      color: var(--text-primary);
      border: 2px solid var(--border-color);
    }

    .btn-secondary-3d:hover {
      border-color: var(--accent-primary);
      transform: translateY(-2px);
    }

    /* Stats Card */
    .stats-card {
      background: rgba(255,255,255,0.2);
      backdrop-filter: blur(10px);
      border-radius: 1.5rem;
      padding: 2rem;
      border: 2px solid rgba(255,255,255,0.3);
      box-shadow: var(--shadow-lg);
    }

    /* Tip Card */
    .tip-card {
      background: var(--bg-card);
      border-radius: 1rem;
      padding: 1.25rem;
      border-left: 4px solid;
      box-shadow: var(--shadow-sm);
      transition: all 0.3s ease;
    }

    .tip-card:hover {
      transform: translateX(4px);
      box-shadow: var(--shadow-md);
    }

    /* Grid */
    .grid { display: grid; gap: 1.5rem; }
    .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
    .grid-3 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }

    /* Utilities */
    .flex { display: flex; align-items: center; }
    .flex-between { display: flex; justify-content: space-between; align-items: center; }
    .gap-1 { gap: 0.5rem; }
    .gap-2 { gap: 1rem; }
    .gap-3 { gap: 1.5rem; }

    @media print {
      nav, .no-print, button, .notification-bell {
        display: none !important;
      }
      
      body {
        background: white !important;
      }
      
      .card-3d, .category-card {
        box-shadow: none !important;
        border: 1px solid #ddd;
        page-break-inside: avoid;
      }
    }

    @media (max-width: 768px) {
      .grid-2, .grid-3 {
        grid-template-columns: 1fr;
      }
      
      .notification-dropdown {
        width: calc(100vw - 2rem);
        right: -1rem;
      }

      .hero {
        padding: 2rem;
      }
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav>
    <div class="container">
      <div class="flex-between">
        <div class="flex gap-2">
          <span style="font-size: 2.5rem;">ü•ë</span>
          <div>
            <h1 style="font-size: 1.375rem; font-weight: 800; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Keto Journey</h1>
            <p style="font-size: 0.8125rem; color: var(--text-secondary); font-weight: 600;">30-Day Transformation</p>
          </div>
        </div>
        
        <div class="flex gap-3">
          <a href="/dashboard">Dashboard</a>
          <a href="/dashboard/shopping-list" class="active">Shopping</a>
          <a href="/dashboard/recipes">Recipes</a>
          <a href="/dashboard/profile">Profile</a>
          <a href="/dashboard/notifications">üîî Reminders</a>
          
          <div class="flex gap-2" style="padding-left: 1rem; border-left: 1px solid var(--border-color); position: relative;">
            <!-- Dark Mode Toggle -->
            <div class="theme-toggle" id="themeToggle">
              <div class="theme-toggle-slider">
                <span id="themeIcon">‚òÄÔ∏è</span>
              </div>
            </div>

            <!-- Notification Bell -->
            {incompleteTasks.length > 0 && (
              <div style="position: relative;">
                <button class="notification-bell" id="notif-bell">
                  <span style="color: white;">üîî</span>
                  <span class="notification-badge">{incompleteTasks.length}</span>
                </button>
                
                <div class="notification-dropdown" id="notificationDropdown">
                  <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color); background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(52, 211, 153, 0.1));">
                    <h3 style="font-size: 1.125rem; font-weight: 800; color: var(--accent-primary); display: flex; align-items: center; gap: 0.75rem;">
                      <span style="font-size: 1.5rem;">üîî</span>
                      <span>{incompleteTasks.length} Pending Task{incompleteTasks.length !== 1 ? 's' : ''}</span>
                    </h3>
                  </div>
                  <div style="max-height: 400px; overflow-y: auto;">
                    {incompleteTasks.map(task => (
                      <div class="notification-item">
                        <div class="notification-icon">
                          {task.task_type === 'breakfast' && 'üç≥'}
                          {task.task_type === 'lunch' && 'ü•ó'}
                          {task.task_type === 'dinner' && 'üçΩÔ∏è'}
                          {task.task_type === 'snack' && 'üçé'}
                          {task.task_type === 'water' && 'üíß'}
                        </div>
                        <div style="flex: 1;">
                          <div style="font-weight: 700; font-size: 0.9375rem; color: var(--text-primary); margin-bottom: 0.25rem;">{task.task_title}</div>
                          <div style="font-size: 0.8125rem; color: var(--text-secondary); font-weight: 600;">+{task.xp_earned} XP ‚Ä¢ Day {currentDay}</div>
                        </div>
                      </div>
                    ))}
                  </div>
                  <div style="padding: 1.25rem; border-top: 1px solid var(--border-color); text-align: center;">
                    <a href="/dashboard" class="btn-primary-3d" style="width: 100%; justify-content: center;">
                      View All Tasks ‚Üí
                    </a>
                  </div>
                </div>
              </div>
            )}
            
            <!-- Profile Avatar -->
            <a href="/dashboard/profile" style="width: 2.5rem; height: 2.5rem; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 800; text-decoration: none; box-shadow: var(--shadow-md); transition: all 0.3s ease; font-size: 1.125rem;">
              {profile.full_name.charAt(0).toUpperCase()}
            </a>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container" style="padding-top: 2rem; padding-bottom: 4rem;">
    
    <!-- Hero -->
    <div class="hero">
      <div class="hero-content">
        <div class="flex-between" style="flex-wrap: wrap; gap: 2rem;">
          <div>
            <h1 style="font-size: 3.5rem; font-weight: 900; margin-bottom: 1rem; text-shadow: 0 4px 8px rgba(0,0,0,0.3);">üõí Smart Shopping List</h1>
            <p style="font-size: 1.25rem; opacity: 0.95; margin-bottom: 0.5rem;">Week {weekNumber} ‚Ä¢ Days {startDay}-{endDay}</p>
            <p style="font-size: 1rem; opacity: 0.85;">Automatically calculated from your meal plan</p>
          </div>
          
          <div class="stats-card" style="text-align: center;">
            <p style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem; font-weight: 600;">Estimated Total</p>
            <p style="font-size: 4rem; font-weight: 900; text-shadow: 0 4px 8px rgba(0,0,0,0.3);">${Math.round(estimatedCost)}</p>
            <p style="font-size: 0.875rem; opacity: 0.85;">{totalItems} items</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Smart Tips -->
    <div class="grid grid-3" style="margin-bottom: 2rem;">
      <div class="tip-card" style="border-color: #3b82f6;">
        <div class="flex gap-3" style="align-items: flex-start;">
          <span style="font-size: 2.5rem;">üí°</span>
          <div>
            <h3 style="font-weight: 700; margin-bottom: 0.5rem; color: var(--text-primary);">Smart Tip</h3>
            <p style="font-size: 0.875rem; color: var(--text-secondary); line-height: 1.5;">Shop once a week to save time and reduce impulse buys</p>
          </div>
        </div>
      </div>
      
      <div class="tip-card" style="border-color: #10b981;">
        <div class="flex gap-3" style="align-items: flex-start;">
          <span style="font-size: 2.5rem;">üí∞</span>
          <div>
            <h3 style="font-weight: 700; margin-bottom: 0.5rem; color: var(--text-primary);">Save Money</h3>
            <p style="font-size: 0.875rem; color: var(--text-secondary); line-height: 1.5;">Buy proteins in bulk and freeze for later use</p>
          </div>
        </div>
      </div>
      
      <div class="tip-card" style="border-color: #8b5cf6;">
        <div class="flex gap-3" style="align-items: flex-start;">
          <span style="font-size: 2.5rem;">üì±</span>
          <div>
            <h3 style="font-weight: 700; margin-bottom: 0.5rem; color: var(--text-primary);">Pro Tip</h3>
            <p style="font-size: 0.875rem; color: var(--text-secondary); line-height: 1.5;">Print or screenshot this list before heading to the store</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex gap-2 no-print" style="margin-bottom: 2rem; flex-wrap: wrap;">
      <button onclick="window.print()" class="btn-primary-3d">
        <span style="font-size: 1.25rem;">üñ®Ô∏è</span>
        <span>Print List</span>
      </button>
      
      <button onclick="copyToClipboard()" class="btn-secondary-3d">
        <span style="font-size: 1.25rem;">üìã</span>
        <span>Copy List</span>
      </button>
    </div>

    <!-- Shopping List by Category -->
    <div id="shopping-list-content">
      {Object.entries(categorizedList).map(([category, items]: [string, any]) => (
        items.length > 0 && (
          <div class="category-card">
            <div class="category-header">
              <span style="font-size: 3rem;">{categories[category]?.icon || 'üì¶'}</span>
              <div style="flex: 1;">
                <h3 style="font-size: 1.75rem; font-weight: 800; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">{category}</h3>
                <p style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.25rem;">{items.length} item{items.length !== 1 ? 's' : ''}</p>
              </div>
            </div>
            
            {categories[category]?.tip && (
              <div class="no-print" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(52, 211, 153, 0.1)); border-left: 4px solid var(--accent-primary); padding: 1rem; border-radius: 0.75rem; margin-bottom: 1.5rem;">
                <p style="font-size: 0.875rem; color: var(--text-primary); font-weight: 600;">
                  üí° <strong>Tip:</strong> {categories[category].tip}
                </p>
              </div>
            )}
            
            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
              {items.map((item: any, idx: number) => (
                <div class="shopping-item" data-item-id={category + '-' + idx}>
                  <input 
                    type="checkbox" 
                    class="checkbox-3d no-print"
                    onchange="toggleItem(this)"
                  />
                  <div style="flex: 1;">
                    <div class="flex gap-2" style="align-items: baseline; flex-wrap: wrap;">
                      <span style="font-weight: 800; font-size: 1.125rem; color: var(--text-primary);">
                        {item.amount} {item.unit}
                      </span>
                      <span style="font-weight: 600; font-size: 1rem; color: var(--text-primary);">{item.item}</span>
                      {item.count > 1 && (
                        <span style="padding: 0.25rem 0.75rem; background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(52, 211, 153, 0.15)); color: var(--accent-primary); border-radius: 9999px; font-size: 0.75rem; font-weight: 700; border: 2px solid var(--accent-primary);">
                          {item.count} recipes
                        </span>
                      )}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )
      ))}

      <!-- Summary -->
      <div class="card-3d" style="text-align: center; margin-top: 2rem;">
        <h3 style="font-size: 1.5rem; font-weight: 800; margin-bottom: 1.5rem; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Shopping Summary</h3>
        
        <div class="grid grid-3">
          <div style="padding: 1.5rem; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(37, 99, 235, 0.1)); border-radius: 1rem; border: 2px solid #3b82f6;">
            <p style="font-size: 3rem; font-weight: 800; color: #3b82f6; margin-bottom: 0.5rem;">{totalItems}</p>
            <p style="font-size: 0.875rem; color: var(--text-secondary); font-weight: 600;">Total Items</p>
          </div>
          
          <div style="padding: 1.5rem; background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1)); border-radius: 1rem; border: 2px solid var(--accent-primary);">
            <p style="font-size: 3rem; font-weight: 800; color: var(--accent-primary); margin-bottom: 0.5rem;">${Math.round(estimatedCost)}</p>
            <p style="font-size: 0.875rem; color: var(--text-secondary); font-weight: 600;">Est. Cost</p>
          </div>
          
          <div style="padding: 1.5rem; background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(124, 58, 237, 0.1)); border-radius: 1rem; border: 2px solid #8b5cf6;">
            <p style="font-size: 3rem; font-weight: 800; color: #8b5cf6; margin-bottom: 0.5rem;">Week {weekNumber}</p>
            <p style="font-size: 0.875rem; color: var(--text-secondary); font-weight: 600;">Meal Plan</p>
          </div>
        </div>

        <p style="font-size: 0.8125rem; color: var(--text-secondary); margin-top: 1.5rem;">Generated on {new Date().toLocaleDateString()} ‚Ä¢ Keto Journey</p>
      </div>
    </div>

    <!-- Week Navigation -->
    <div class="flex gap-2 no-print" style="justify-content: center; margin-top: 2rem; flex-wrap: wrap;">
      {weekNumber > 1 && (
        <a href={'/dashboard/shopping-list?week=' + (weekNumber - 1)} class="btn-secondary-3d">
          ‚Üê Week {weekNumber - 1}
        </a>
      )}
      {weekNumber < 5 && (
        <a href={'/dashboard/shopping-list?week=' + (weekNumber + 1)} class="btn-primary-3d">
          Week {weekNumber + 1} ‚Üí
        </a>
      )}
    </div>
  </div>

  <script is:inline>
    // Dark Mode Toggle
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    const html = document.documentElement;

    const savedTheme = localStorage.getItem('theme') || 'light';
    html.setAttribute('data-theme', savedTheme);
    themeIcon.textContent = savedTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';

    if (themeToggle) {
      themeToggle.addEventListener('click', function() {
        const currentTheme = html.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        
        html.setAttribute('data-theme', newTheme);
        themeIcon.textContent = newTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
        localStorage.setItem('theme', newTheme);
      });
    }

    // Notification Toggle
    const notifBell = document.getElementById('notif-bell');
    const notifDropdown = document.getElementById('notificationDropdown');
    
    if (notifBell && notifDropdown) {
      notifBell.addEventListener('click', function(e) {
        e.stopPropagation();
        notifDropdown.classList.toggle('active');
      });

      document.addEventListener('click', function(e) {
        if (!notifDropdown.contains(e.target) && !notifBell.contains(e.target)) {
          notifDropdown.classList.remove('active');
        }
      });
    }

    // Toggle Item
    function toggleItem(checkbox) {
      const item = checkbox.closest('.shopping-item');
      if (checkbox.checked) {
        item.classList.add('checked');
      } else {
        item.classList.remove('checked');
      }
    }

    // Copy to Clipboard
    function copyToClipboard() {
      const items = [];
      document.querySelectorAll('.shopping-item').forEach(item => {
        if (!item.classList.contains('checked')) {
          const text = item.textContent.trim().replace(/\s+/g, ' ').replace(/recipes?/i, '').trim();
          items.push('‚òê ' + text);
        }
      });
      
      navigator.clipboard.writeText(items.join('\n')).then(() => {
        alert('‚úÖ Shopping list copied to clipboard!');
      }).catch(() => {
        alert('‚ùå Failed to copy. Please try again.');
      });
    }

    window.toggleItem = toggleItem;
    window.copyToClipboard = copyToClipboard;

    console.log('‚úÖ Shopping List loaded successfully!');
  </script>
</body>
</html>