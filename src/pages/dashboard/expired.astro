---
// src/pages/dashboard/expired.astro
import { supabase, getProfile, getPlan } from '../../lib/supabase';

const accessToken = Astro.cookies.get('sb-access-token')?.value;
if (!accessToken) return Astro.redirect('/login');

const { data: { user } } = await supabase.auth.getUser(accessToken);
if (!user) return Astro.redirect('/login');

const profile = await getProfile(user.id);
if (!profile) return Astro.redirect('/login');

if (profile.subscription_status === 'active' && profile.subscription_end_date && new Date(profile.subscription_end_date) > new Date()) {
  return Astro.redirect('/dashboard/');
}

const currentTier = profile.subscription_tier as string;
const userName = profile.full_name?.split(' ')[0] || 'Friend';
const endDate = profile.subscription_end_date
  ? new Date(profile.subscription_end_date).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })
  : 'recently';

const LS_URL = "https://new-keto-plan.lemonsqueezy.com/checkout/buy/b975765f-a640-4cec-b3ef-44112acc9f75";

const allPlans = [
  {
    id: 'basic_30',
    name: 'Basic',
    emoji: 'ü•ë',
    price: '29.99',
    period: '30 days',
    color: '#10b981',
    gradient: 'linear-gradient(135deg,#10b981,#34d399)',
    perks: ['30-day meal plan', '30 keto recipes', '4 eBooks', 'Basic tracking'],
    popular: false,
  },
  {
    id: 'pro_6',
    name: 'Pro',
    emoji: '‚ö°',
    price: '99.99',
    period: '6 months',
    color: '#6366f1',
    gradient: 'linear-gradient(135deg,#6366f1,#8b5cf6)',
    perks: ['6-month meal plan', '87+ recipes', '8 eBooks', 'Advanced analytics', 'Priority support'],
    popular: true,
  },
  {
    id: 'elite_12',
    name: 'Elite',
    emoji: 'üëë',
    price: '199.99',
    period: '12 months',
    color: '#f59e0b',
    gradient: 'linear-gradient(135deg,#f59e0b,#fbbf24)',
    perks: ['12-month meal plan', 'Unlimited recipes', '12 eBooks', 'AI Keto Coach', '24/7 support', 'Community access'],
    popular: false,
  },
];

const suggestedPlans = currentTier === 'basic_30'
  ? allPlans.filter(p => p.id !== 'basic_30')
  : currentTier === 'pro_6'
  ? allPlans.filter(p => p.id === 'elite_12')
  : allPlans;

const tierMeta = {
  basic_30: {
    badge: '30 Days ‚úì',
    badgeColor: '#10b981',
    badgeBg: 'rgba(16,185,129,0.1)',
    icon: 'üèÖ',
    iconBg: 'rgba(16,185,129,0.1)',
    title: `You completed your 30-Day Keto Foundation!`,
    sub: `Your body has adapted to ketosis. Now it's time to go deeper.`,
    headline: `Your 30 Days Are Up ‚Äî But Your Journey Isn't, ${userName}`,
    body: `You took the first step and proved you can do it. Your body is already adapting to keto. Now is the perfect time to lock in your results with a longer plan.`,
    sectionLabel: '‚¨ÜÔ∏è Keep the momentum going',
  },
  pro_6: {
    badge: '6 Months ‚úì',
    badgeColor: '#818cf8',
    badgeBg: 'rgba(99,102,241,0.1)',
    icon: 'ü•à',
    iconBg: 'rgba(99,102,241,0.1)',
    title: `6 months of consistent keto ‚Äî incredible!`,
    sub: `You're in the top 5% of people who actually stick with it.`,
    headline: `6 Months Strong, ${userName} ‚Äî Ready for the Next Level?`,
    body: `You've proven you can sustain keto for months. Imagine what a full year with unlimited recipes, an AI Keto Coach, and a community behind you could do.`,
    sectionLabel: 'üëë Unlock the full experience',
  },
  elite_12: {
    badge: '12 Months ‚úì',
    badgeColor: '#fbbf24',
    badgeBg: 'rgba(245,158,11,0.1)',
    icon: 'üëë',
    iconBg: 'rgba(245,158,11,0.1)',
    title: `A full year of Elite Keto ‚Äî you're a legend!`,
    sub: `Your commitment has been extraordinary. Ready for year two?`,
    headline: `One Year Done, ${userName}. Your Story Continues.`,
    body: `Your dedication over the past year has been remarkable. Your progress, your recipes, your community ‚Äî all waiting for you. Let's keep writing this story together.`,
    sectionLabel: 'üîÑ Renew your elite access',
  },
};

const meta = tierMeta[currentTier as keyof typeof tierMeta] || tierMeta.basic_30;
const plansJson = JSON.stringify(suggestedPlans);
const defaultSelected = suggestedPlans.find(p => p.popular)?.id || suggestedPlans[suggestedPlans.length - 1]?.id || '';
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Continue Your Journey ‚Äî Keto Journey</title>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,wght@0,700;0,900;1,700&family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600;9..40,700&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --bg:#0c1117; --surface:#141b24; --card:#1a2332;
      --border:rgba(255,255,255,.07); --text:#e8edf5;
      --muted:#4a5a6e; --soft:#8a9ab0;
    }
    *,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
    html{scroll-behavior:smooth;}
    body{
      font-family:'DM Sans',sans-serif;
      background:var(--bg);color:var(--text);
      min-height:100vh;overflow-x:hidden;
    }

    /* BG */
    .bg-mesh{
      position:fixed;inset:0;pointer-events:none;z-index:0;overflow:hidden;
    }
    .orb{
      position:absolute;border-radius:50%;filter:blur(90px);
      animation:orbDrift ease-in-out infinite;
    }
    .o1{width:600px;height:600px;background:rgba(99,102,241,.07);top:-150px;left:-150px;animation-duration:20s;}
    .o2{width:500px;height:500px;background:rgba(16,185,129,.05);bottom:-100px;right:-100px;animation-duration:25s;animation-delay:-10s;}
    .o3{width:350px;height:350px;background:rgba(245,158,11,.04);top:50%;left:50%;animation-duration:17s;animation-delay:-6s;}
    @keyframes orbDrift{
      0%,100%{transform:translate(0,0) scale(1);}
      33%{transform:translate(40px,-50px) scale(1.08);}
      66%{transform:translate(-30px,40px) scale(.93);}
    }

    /* LAYOUT */
    .page{position:relative;z-index:1;max-width:800px;margin:0 auto;padding:2.5rem 1.5rem 5rem;}

    /* NAV */
    .topbar{
      display:flex;align-items:center;justify-content:space-between;
      margin-bottom:3.5rem;
    }
    .logo{font-family:'Fraunces',serif;font-size:1.15rem;font-weight:700;display:flex;align-items:center;gap:.5rem;}
    .tag-exp{
      display:flex;align-items:center;gap:.4rem;
      padding:.3rem .85rem;border-radius:99px;
      background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.2);
      font-size:.72rem;font-weight:700;color:#f87171;text-transform:uppercase;letter-spacing:.06em;
    }

    /* HERO */
    .hero{margin-bottom:3rem;animation:up .6s ease both;}
    .hero-meta{font-size:.75rem;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.1em;margin-bottom:1rem;}
    .hero h1{
      font-family:'Fraunces',serif;
      font-size:clamp(1.8rem,5vw,3rem);
      font-weight:900;line-height:1.18;margin-bottom:1rem;
    }
    .hero h1 .hl{
      font-style:italic;
      background:linear-gradient(135deg,#10b981,#34d399);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;
    }
    .hero p{font-size:1rem;color:var(--soft);line-height:1.75;max-width:560px;}

    /* ACHIEVEMENT */
    .achiev{
      display:flex;align-items:center;gap:1.25rem;
      background:var(--surface);border:1px solid var(--border);
      border-radius:18px;padding:1.25rem 1.5rem;
      margin-bottom:3.5rem;
      animation:up .6s .15s ease both;
    }
    .achiev-icon{
      width:54px;height:54px;border-radius:14px;flex-shrink:0;
      display:flex;align-items:center;justify-content:center;font-size:1.6rem;
    }
    .achiev-text h3{font-weight:700;font-size:.95rem;margin-bottom:.2rem;}
    .achiev-text p{font-size:.82rem;color:var(--soft);}
    .achiev-badge{
      margin-left:auto;flex-shrink:0;
      padding:.3rem .85rem;border-radius:99px;
      font-size:.72rem;font-weight:700;white-space:nowrap;
    }

    /* SECTION LABEL */
    .slabel{
      font-size:.7rem;font-weight:700;text-transform:uppercase;
      letter-spacing:.12em;color:var(--muted);margin-bottom:1.25rem;
    }

    /* PLANS */
    .plans{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:1rem;margin-bottom:2rem;
    }
    .pcard{
      background:var(--card);border:2px solid var(--border);
      border-radius:22px;padding:1.6rem;cursor:pointer;
      transition:all .3s ease;position:relative;overflow:hidden;
      animation:up .6s ease both;
    }
    .pcard:nth-child(1){animation-delay:.1s;}
    .pcard:nth-child(2){animation-delay:.2s;}
    .pcard:hover{transform:translateY(-5px);border-color:rgba(255,255,255,.15);}
    .pcard.sel{border-color:var(--pc);}
    .pglow{
      position:absolute;top:-50px;right:-50px;
      width:160px;height:160px;border-radius:50%;
      filter:blur(60px);opacity:.12;transition:opacity .3s;
    }
    .pcard:hover .pglow,.pcard.sel .pglow{opacity:.25;}
    .pop-tag{
      position:absolute;top:.9rem;right:.9rem;
      font-size:.65rem;font-weight:800;text-transform:uppercase;letter-spacing:.07em;
      padding:.2rem .65rem;border-radius:99px;
    }
    .pemoji{font-size:2rem;margin-bottom:.9rem;display:block;}
    .pname{
      font-family:'Fraunces',serif;
      font-size:1.4rem;font-weight:700;margin-bottom:.15rem;
    }
    .pperiod{font-size:.8rem;color:var(--soft);margin-bottom:1.1rem;}
    .pprice{
      font-size:2rem;font-weight:800;line-height:1;margin-bottom:1.4rem;
    }
    .pprice small{font-size:.8rem;font-weight:500;color:var(--soft);}
    .pperks{list-style:none;}
    .pperks li{
      display:flex;align-items:center;gap:.55rem;
      font-size:.82rem;color:var(--soft);
      padding:.35rem 0;border-bottom:1px solid var(--border);
    }
    .pperks li:last-child{border:none;}
    .pperks li .ck{font-weight:800;flex-shrink:0;}
    .psel-btn{
      display:flex;align-items:center;justify-content:center;gap:.4rem;
      width:100%;padding:.8rem;border-radius:12px;
      border:2px solid var(--border);background:transparent;
      color:var(--soft);font-size:.85rem;font-weight:700;
      cursor:pointer;transition:all .25s;margin-top:1.4rem;
    }
    .pcard.sel .psel-btn{color:#fff;border-color:transparent;}

    /* CTA */
    .cta{animation:up .6s .35s ease both;}
    .btn-go{
      display:flex;align-items:center;justify-content:center;gap:.7rem;
      width:100%;padding:1.15rem 2rem;border-radius:16px;border:none;
      font-size:1rem;font-weight:700;cursor:pointer;color:#fff;
      background:linear-gradient(135deg,#6366f1,#8b5cf6);
      box-shadow:0 10px 36px rgba(99,102,241,.35);
      transition:all .3s;margin-bottom:.875rem;
      position:relative;overflow:hidden;
    }
    .btn-go::after{
      content:'';position:absolute;inset:0;
      background:linear-gradient(135deg,rgba(255,255,255,.12),transparent);
      opacity:0;transition:opacity .3s;
    }
    .btn-go:hover{transform:translateY(-3px);box-shadow:0 18px 48px rgba(99,102,241,.45);}
    .btn-go:hover::after{opacity:1;}
    .btn-back{
      display:block;width:100%;padding:.875rem;border-radius:14px;
      border:1px solid var(--border);background:transparent;
      color:var(--soft);font-size:.875rem;font-weight:600;
      cursor:pointer;transition:all .2s;text-decoration:none;text-align:center;
    }
    .btn-back:hover{border-color:var(--soft);color:var(--text);}

    /* GUARANTEE */
    .guarantee{
      display:flex;align-items:center;gap:1rem;
      margin-top:1.75rem;padding:1.1rem 1.4rem;
      background:var(--surface);border:1px solid var(--border);border-radius:14px;
    }
    .guarantee-ico{font-size:1.75rem;flex-shrink:0;}
    .guarantee-txt h4{font-weight:700;font-size:.875rem;margin-bottom:.15rem;}
    .guarantee-txt p{font-size:.78rem;color:var(--soft);}

    @keyframes up{
      from{opacity:0;transform:translateY(22px);}
      to{opacity:1;transform:translateY(0);}
    }
    @media(max-width:540px){
      .plans{grid-template-columns:1fr;}
      .achiev{flex-wrap:wrap;}
      .achiev-badge{margin-left:0;}
    }
  </style>
</head>
<body>

<div class="bg-mesh">
  <div class="orb o1"></div>
  <div class="orb o2"></div>
  <div class="orb o3"></div>
</div>

<div class="page">

  <!-- Top Bar -->
  <nav class="topbar">
    <div class="logo">ü•ë Keto Journey</div>
    <div class="tag-exp">‚è∞ Plan Expired</div>
  </nav>

  <!-- Hero -->
  <div class="hero">
    <p class="hero-meta">Expired on {endDate}</p>
    <h1>
      {meta.headline.replace(userName, '___SPLIT___').split('___SPLIT___').map((part: string, i: number) => (
        i === 0 ? part : null
      ))}
      <span class="hl">{userName}</span>
      {meta.headline.replace(userName, '___SPLIT___').split('___SPLIT___')[1]}
    </h1>
    <p>{meta.body}</p>
  </div>

  <!-- Achievement -->
  <div class="achiev">
    <div class="achiev-icon" style={`background:${meta.iconBg};`}>{meta.icon}</div>
    <div class="achiev-text">
      <h3>{meta.title}</h3>
      <p>{meta.sub}</p>
    </div>
    <div class="achiev-badge" style={`background:${meta.badgeBg};color:${meta.badgeColor};`}>{meta.badge}</div>
  </div>

  <!-- Plans -->
  <p class="slabel">{meta.sectionLabel}</p>

  <div class="plans">
    {suggestedPlans.map((plan) => (
      <div
        class={`pcard ${plan.id === defaultSelected ? 'sel' : ''}`}
        id={`pc-${plan.id}`}
        onclick={`pick('${plan.id}')`}
        style={`--pc:${plan.color};`}
      >
        <div class="pglow" style={`background:${plan.color};`}></div>

        {plan.popular && suggestedPlans.length > 1 && (
          <div class="pop-tag" style="background:rgba(99,102,241,.15);color:#818cf8;border:1px solid rgba(99,102,241,.25);">
            Most Popular
          </div>
        )}

        <span class="pemoji">{plan.emoji}</span>
        <div class="pname" style={`color:${plan.color};`}>{plan.name}</div>
        <div class="pperiod">{plan.period}</div>
        <div class="pprice" style={`background:${plan.gradient};-webkit-background-clip:text;-webkit-text-fill-color:transparent;`}>
          ${plan.price} <small>one-time</small>
        </div>

        <ul class="pperks">
          {plan.perks.map((perk: string) => (
            <li><span class="ck" style={`color:${plan.color};`}>‚úì</span> {perk}</li>
          ))}
        </ul>

        <button
          class="psel-btn"
          style={plan.id === defaultSelected ? `background:${plan.gradient};border-color:transparent;` : ''}
        >
          {plan.id === defaultSelected ? '‚úì Selected' : 'Select'}
        </button>
      </div>
    ))}
  </div>

  <!-- CTA -->
  <div class="cta">
    <button class="btn-go" id="btnGo">
      <span>üöÄ</span>
      <span id="ctaText">{meta.sectionLabel.split(' ').slice(1).join(' ')}</span>
      <span style="margin-left:auto;opacity:.7;font-size:.85rem;">‚Üí</span>
    </button>
    <a href="/login" class="btn-back">‚Üê Back to login</a>

    <div class="guarantee">
      <div class="guarantee-ico">üõ°Ô∏è</div>
      <div class="guarantee-txt">
        <h4>30-Day Money-Back Guarantee</h4>
        <p>Not happy? Full refund within 30 days ‚Äî no questions, no hassle.</p>
      </div>
    </div>
  </div>

</div>

<script is:inline define:vars={{ LS_URL, plansJson, defaultSelected }}>
  const plans = JSON.parse(plansJson);
  let sel = defaultSelected;

  const ctaLabels = {
    basic_30: 'Continue with Basic ‚Äî 30 Days',
    pro_6:    'Unlock Pro ‚Äî 6 Months',
    elite_12: 'Go Elite ‚Äî Full Year',
  };

  function pick(id) {
    sel = id;
    const plan = plans.find(p => p.id === id);

    plans.forEach(p => {
      const card = document.getElementById('pc-' + p.id);
      if (!card) return;
      card.classList.remove('sel');
      const btn = card.querySelector('.psel-btn');
      btn.textContent = 'Select';
      btn.style = '';
    });

    const card = document.getElementById('pc-' + id);
    if (card) {
      card.classList.add('sel');
      const btn = card.querySelector('.psel-btn');
      btn.textContent = '‚úì Selected';
      btn.style = `background:${plan.gradient};border-color:transparent;`;
    }

    document.getElementById('ctaText').textContent = ctaLabels[id] || 'Continue Your Journey';
  }
  window.pick = pick;

  document.getElementById('btnGo').addEventListener('click', () => {
    window.location.href = LS_URL;
  });

  // Init
  if (sel) pick(sel);
</script>
</body>
</html>