---
import { supabase, getProfile, getUserJourney, getDailyTasks } from '../../../lib/supabase';

const { id } = Astro.params;
const accessToken = Astro.cookies.get('sb-access-token')?.value;

if (!accessToken) return Astro.redirect('/login');

const { data: { user } } = await supabase.auth.getUser(accessToken);
if (!user) return Astro.redirect('/login');

const profile = await getProfile(user.id);
const journey = await getUserJourney(user.id);

if (!profile || !journey) return Astro.redirect('/login');

const currentDay = journey?.current_day || 1;
const dailyTasks = await getDailyTasks(user.id, currentDay);
const incompleteTasks = dailyTasks?.filter(t => t.task_type !== 'reflection' && t.task_type !== 'weight' && !t.completed) || [];

// Get recipe
const { data: recipe } = await supabase
  .from('recipes')
  .select('*')
  .eq('id', id)
  .single();

if (!recipe) return Astro.redirect('/dashboard');

// Find which meal plan this recipe belongs to
const { data: mealPlan } = await supabase
  .from('meal_plans')
  .select('*')
  .eq('recipe_id', id)
  .eq('day_number', journey.current_day)
  .single();

const task = mealPlan ? dailyTasks.find(t => t.task_type === mealPlan.meal_type) : null;
const isCompleted = task?.completed || false;
const canComplete = mealPlan && !isCompleted;

// Parse JSON fields
const ingredients = recipe.ingredients || [];
const instructions = recipe.instructions || [];
const tips = recipe.tips || [];
const tags = recipe.tags || [];

// Category info
const categories = {
  breakfast: { name: 'Breakfast', icon: 'üç≥', color: '#f59e0b' },
  lunch: { name: 'Lunch', icon: 'ü•ó', color: '#10b981' },
  dinner: { name: 'Dinner', icon: 'üçΩÔ∏è', color: '#3b82f6' },
  snack: { name: 'Snacks', icon: 'üçé', color: '#8b5cf6' },
  other: { name: 'Other', icon: 'ü•ë', color: '#6b7280' }
};

const categoryInfo = categories[recipe.category] || categories.other;
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{recipe.title} - Keto Journey</title>
  
  <style>
    :root {
      --bg-primary: #ffffff;
      --bg-secondary: #f9fafb;
      --bg-card: #ffffff;
      --text-primary: #111827;
      --text-secondary: #6b7280;
      --border-color: #e5e7eb;
      --accent-primary: #10b981;
      --accent-secondary: #34d399;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
      --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
      --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
      --shadow-xl: 0 20px 25px rgba(0,0,0,0.15);
    }

    [data-theme="dark"] {
      --bg-primary: #1a1a2e;
      --bg-secondary: #16213e;
      --bg-card: #0f3460;
      --text-primary: #eaeaea;
      --text-secondary: #a0aec0;
      --border-color: #2d3748;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.3);
      --shadow-md: 0 4px 6px rgba(0,0,0,0.4);
      --shadow-lg: 0 10px 15px rgba(0,0,0,0.5);
      --shadow-xl: 0 20px 25px rgba(0,0,0,0.6);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-secondary);
      color: var(--text-primary);
      transition: all 0.3s ease;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 1.5rem;
    }

    /* Navigation 3D */
    nav {
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border-color);
      padding: 1rem 0;
      position: sticky;
      top: 0;
      z-index: 50;
      box-shadow: var(--shadow-md);
      backdrop-filter: blur(10px);
    }

    nav .flex {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    nav a {
      color: var(--text-secondary);
      text-decoration: none;
      padding: 0.5rem 1rem;
      border-radius: 0.75rem;
      font-weight: 500;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    nav a:hover {
      color: var(--accent-primary);
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(52, 211, 153, 0.1));
      transform: translateY(-2px);
    }

    /* Dark Mode Toggle */
    .theme-toggle {
      position: relative;
      width: 60px;
      height: 30px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 9999px;
      cursor: pointer;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.2), var(--shadow-md);
      transition: all 0.3s ease;
    }

    .theme-toggle:hover {
      transform: scale(1.05);
    }

    .theme-toggle-slider {
      position: absolute;
      top: 3px;
      left: 3px;
      width: 24px;
      height: 24px;
      background: white;
      border-radius: 50%;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
    }

    [data-theme="dark"] .theme-toggle {
      background: linear-gradient(135deg, #2d3561 0%, #1a1f3a 100%);
    }

    [data-theme="dark"] .theme-toggle-slider {
      transform: translateX(30px);
      background: #1a1a2e;
      color: #fbbf24;
    }

    /* Notification Bell */
    .notification-bell {
      position: relative;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      border: none;
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: var(--shadow-md);
    }

    .notification-bell:hover {
      transform: translateY(-4px) scale(1.05);
      box-shadow: var(--shadow-xl);
    }

    .notification-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      font-size: 0.75rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.15); }
    }

    /* Notification Dropdown */
    .notification-dropdown {
      position: absolute;
      top: calc(100% + 0.5rem);
      right: 0;
      width: 380px;
      max-height: 500px;
      background: var(--bg-card);
      border-radius: 1.5rem;
      box-shadow: var(--shadow-xl);
      border: 1px solid var(--border-color);
      display: none;
      overflow: hidden;
      animation: slideDown 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    .notification-dropdown.active {
      display: block;
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-20px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    .notification-item {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      gap: 1rem;
      align-items: center;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .notification-item:hover {
      background: linear-gradient(90deg, rgba(16, 185, 129, 0.05), transparent);
      transform: translateX(4px);
    }

    .notification-icon {
      width: 3rem;
      height: 3rem;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      border-radius: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      flex-shrink: 0;
      box-shadow: var(--shadow-md);
    }

    /* Hero Image */
    .hero-image {
      position: relative;
      height: 500px;
      border-radius: 2rem;
      overflow: hidden;
      margin-bottom: 2rem;
      box-shadow: var(--shadow-xl);
    }

    .hero-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .hero-overlay {
      position: absolute;
      inset: 0;
      background: linear-gradient(to top, rgba(0,0,0,0.9), rgba(0,0,0,0.3), transparent);
    }

    .hero-content {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 3rem;
      color: white;
    }

    .hero-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .hero-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(10px);
      border-radius: 9999px;
      font-weight: 700;
      font-size: 0.9375rem;
      box-shadow: var(--shadow-md);
    }

    .hero-title {
      font-size: 3.5rem;
      font-weight: 900;
      margin-bottom: 1rem;
      text-shadow: 0 4px 8px rgba(0,0,0,0.5);
    }

    .hero-description {
      font-size: 1.25rem;
      opacity: 0.95;
      max-width: 800px;
      line-height: 1.6;
    }

    /* Card 3D */
    .card-3d {
      background: var(--bg-card);
      border-radius: 1.5rem;
      padding: 2rem;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border-color);
      transition: all 0.3s ease;
      margin-bottom: 2rem;
    }

    .card-3d:hover {
      box-shadow: var(--shadow-xl);
      transform: translateY(-4px);
    }

    .card-title {
      font-size: 1.75rem;
      font-weight: 800;
      margin-bottom: 1.5rem;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    /* Macros Grid */
    .macros-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 1rem;
    }

    .macro-card {
      text-align: center;
      padding: 1.5rem;
      border-radius: 1.25rem;
      border: 2px solid;
      transition: all 0.3s ease;
    }

    .macro-card:hover {
      transform: translateY(-4px) scale(1.05);
      box-shadow: var(--shadow-lg);
    }

    .macro-value {
      font-size: 2.5rem;
      font-weight: 900;
      display: block;
      margin-bottom: 0.5rem;
    }

    .macro-label {
      font-size: 0.875rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* Ingredient Item */
    .ingredient-item {
      display: flex;
      align-items: start;
      gap: 1rem;
      padding: 1.25rem;
      background: var(--bg-secondary);
      border-radius: 1rem;
      border: 1px solid var(--border-color);
      transition: all 0.3s ease;
      margin-bottom: 1rem;
    }

    .ingredient-item:hover {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(52, 211, 153, 0.05));
      transform: translateX(8px);
      box-shadow: var(--shadow-md);
    }

    .ingredient-number {
      width: 2.5rem;
      height: 2.5rem;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 800;
      font-size: 1rem;
      flex-shrink: 0;
      box-shadow: var(--shadow-md);
    }

    /* Instruction Step */
    .instruction-step {
      display: flex;
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .step-number {
      width: 3rem;
      height: 3rem;
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      border-radius: 1.25rem;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 900;
      font-size: 1.25rem;
      flex-shrink: 0;
      box-shadow: var(--shadow-lg);
    }

    .step-text {
      font-size: 1.125rem;
      line-height: 1.7;
      color: var(--text-primary);
    }

    /* Button 3D */
    .btn-3d {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      padding: 1rem 2rem;
      border-radius: 1rem;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      border: none;
      text-decoration: none;
      transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      position: relative;
      overflow: hidden;
      width: 100%;
    }

    .btn-3d::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    .btn-3d:hover::before {
      width: 300px;
      height: 300px;
    }

    .btn-primary-3d {
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      color: white;
      box-shadow: var(--shadow-md);
    }

    .btn-primary-3d:hover {
      transform: translateY(-4px) scale(1.02);
      box-shadow: var(--shadow-xl);
    }

    .btn-secondary-3d {
      background: var(--bg-card);
      color: var(--text-primary);
      border: 2px solid var(--border-color);
    }

    .btn-secondary-3d:hover {
      border-color: var(--accent-primary);
      transform: translateY(-2px);
    }

    /* Sidebar */
    .sidebar {
      position: sticky;
      top: 6rem;
    }

    .info-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem;
      border-radius: 0.75rem;
      margin-bottom: 0.75rem;
    }

    /* Grid */
    .grid-2 {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 2rem;
    }

    /* Utilities */
    .flex { display: flex; align-items: center; }
    .flex-between { display: flex; justify-content: space-between; align-items: center; }
    .gap-1 { gap: 0.5rem; }
    .gap-2 { gap: 1rem; }
    .gap-3 { gap: 1.5rem; }

    @media (max-width: 1024px) {
      .grid-2 {
        grid-template-columns: 1fr;
      }

      .sidebar {
        position: relative;
        top: 0;
      }

      .hero-title {
        font-size: 2.5rem;
      }

      .notification-dropdown {
        width: calc(100vw - 2rem);
        right: -1rem;
      }
    }

    @media print {
      nav, .sidebar, .btn-3d {
        display: none !important;
      }
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav>
    <div class="container">
      <div class="flex-between">
        <div class="flex gap-2">
          <span style="font-size: 2.5rem;">ü•ë</span>
          <div>
            <h1 style="font-size: 1.375rem; font-weight: 800; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Keto Journey</h1>
            <p style="font-size: 0.8125rem; color: var(--text-secondary); font-weight: 600;">30-Day Transformation</p>
          </div>
        </div>
        
        <div class="flex gap-3">
          <a href="/dashboard">
            <svg style="width: 1rem; height: 1rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
            Back to Dashboard
          </a>
          
          <div class="flex gap-2" style="padding-left: 1rem; border-left: 1px solid var(--border-color); position: relative;">
            <!-- Dark Mode Toggle -->
            <div class="theme-toggle" id="themeToggle">
              <div class="theme-toggle-slider">
                <span id="themeIcon">‚òÄÔ∏è</span>
              </div>
            </div>

            <!-- Notification Bell -->
            {incompleteTasks.length > 0 && (
              <div style="position: relative;">
                <button class="notification-bell" id="notif-bell">
                  <span style="color: white;">üîî</span>
                  <span class="notification-badge">{incompleteTasks.length}</span>
                </button>
                
                <div class="notification-dropdown" id="notificationDropdown">
                  <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color); background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(52, 211, 153, 0.1));">
                    <h3 style="font-size: 1.125rem; font-weight: 800; color: var(--accent-primary); display: flex; align-items: center; gap: 0.75rem;">
                      <span style="font-size: 1.5rem;">üîî</span>
                      <span>{incompleteTasks.length} Pending Task{incompleteTasks.length !== 1 ? 's' : ''}</span>
                    </h3>
                  </div>
                  <div style="max-height: 400px; overflow-y: auto;">
                    {incompleteTasks.map(task => (
                      <div class="notification-item">
                        <div class="notification-icon">
                          {task.task_type === 'breakfast' && 'üç≥'}
                          {task.task_type === 'lunch' && 'ü•ó'}
                          {task.task_type === 'dinner' && 'üçΩÔ∏è'}
                          {task.task_type === 'snack' && 'üçé'}
                          {task.task_type === 'water' && 'üíß'}
                        </div>
                        <div style="flex: 1;">
                          <div style="font-weight: 700; font-size: 0.9375rem; color: var(--text-primary); margin-bottom: 0.25rem;">{task.task_title}</div>
                          <div style="font-size: 0.8125rem; color: var(--text-secondary); font-weight: 600;">+{task.xp_earned} XP ‚Ä¢ Day {currentDay}</div>
                        </div>
                      </div>
                    ))}
                  </div>
                  <div style="padding: 1.25rem; border-top: 1px solid var(--border-color); text-align: center;">
                    <a href="/dashboard" style="display: inline-block; padding: 0.875rem 1.75rem; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color: white; border-radius: 1rem; font-weight: 700; text-decoration: none; transition: all 0.3s; box-shadow: var(--shadow-md);">
                      View All Tasks ‚Üí
                    </a>
                  </div>
                </div>
              </div>
            )}
            
            <!-- Profile Avatar -->
            <a href="/dashboard/profile" style="width: 2.5rem; height: 2.5rem; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 800; text-decoration: none; box-shadow: var(--shadow-md); transition: all 0.3s ease; font-size: 1.125rem;">
              {profile.full_name.charAt(0).toUpperCase()}
            </a>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container" style="padding-top: 2rem; padding-bottom: 4rem;">
    
    <!-- Hero Image -->
    {recipe.image_url && (
      <div class="hero-image">
        <img src={recipe.image_url} alt={recipe.title} />
        <div class="hero-overlay"></div>
        <div class="hero-content">
          <div class="hero-badges">
            <span class="hero-badge" style={`color: ${categoryInfo.color}; border: 2px solid ${categoryInfo.color};`}>
              <span style="font-size: 1.25rem;">{categoryInfo.icon}</span>
              <span>{categoryInfo.name}</span>
            </span>
            <span class="hero-badge" style="color: #3b82f6; border: 2px solid #3b82f6;">
              <span>‚è±Ô∏è</span>
              <span>{recipe.prep_time + recipe.cook_time} mins</span>
            </span>
            <span class="hero-badge" style="color: #8b5cf6; border: 2px solid #8b5cf6;">
              <span>üçΩÔ∏è</span>
              <span>{recipe.servings} serving{recipe.servings > 1 ? 's' : ''}</span>
            </span>
            {isCompleted && (
              <span class="hero-badge" style="color: #10b981; border: 2px solid #10b981; background: linear-gradient(135deg, rgba(16, 185, 129, 0.9), rgba(52, 211, 153, 0.9));">
                <span>‚úì</span>
                <span>Completed</span>
              </span>
            )}
          </div>
          <h1 class="hero-title">{recipe.title}</h1>
          <p class="hero-description">{recipe.description}</p>
        </div>
      </div>
    )}

    <!-- Content Grid -->
    <div class="grid-2">
      
      <!-- Main Content -->
      <div>
        
        <!-- Macros -->
        <div class="card-3d">
          <h2 class="card-title">
            <span style="font-size: 2rem;">üìä</span>
            <span>Nutrition Facts</span>
          </h2>
          <div class="macros-grid">
            <div class="macro-card" style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.1)); border-color: #ef4444; color: #dc2626;">
              <span class="macro-value">{recipe.calories}</span>
              <span class="macro-label">Calories</span>
            </div>
            <div class="macro-card" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(37, 99, 235, 0.1)); border-color: #3b82f6; color: #2563eb;">
              <span class="macro-value">{recipe.protein}g</span>
              <span class="macro-label">Protein</span>
            </div>
            <div class="macro-card" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(217, 119, 6, 0.1)); border-color: #f59e0b; color: #d97706;">
              <span class="macro-value">{recipe.fat}g</span>
              <span class="macro-label">Fat</span>
            </div>
            <div class="macro-card" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1)); border-color: #10b981; color: #059669;">
              <span class="macro-value">{recipe.net_carbs}g</span>
              <span class="macro-label">Carbs</span>
            </div>
            <div class="macro-card" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(124, 58, 237, 0.1)); border-color: #8b5cf6; color: #7c3aed;">
              <span class="macro-value">{recipe.fiber}g</span>
              <span class="macro-label">Fiber</span>
            </div>
          </div>
        </div>

        <!-- Ingredients -->
        <div class="card-3d">
          <h2 class="card-title">
            <span style="font-size: 2rem;">üõí</span>
            <span>Ingredients</span>
          </h2>
          <div>
            {ingredients.map((ingredient, index) => (
              <div class="ingredient-item">
                <div class="ingredient-number">{index + 1}</div>
                <div style="flex: 1;">
                  <p style="font-size: 1.125rem; font-weight: 700; color: var(--text-primary);">
                    {ingredient.amount} {ingredient.unit} {ingredient.item}
                  </p>
                </div>
              </div>
            ))}
          </div>
        </div>

        <!-- Instructions -->
        <div class="card-3d">
          <h2 class="card-title">
            <span style="font-size: 2rem;">üë®‚Äçüç≥</span>
            <span>Instructions</span>
          </h2>
          <div>
            {instructions.map((instruction, index) => (
              <div class="instruction-step">
                <div class="step-number">{index + 1}</div>
                <div class="step-text">{instruction}</div>
              </div>
            ))}
          </div>
        </div>

        <!-- Tips -->
        {tips.length > 0 && (
          <div class="card-3d" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.05), rgba(217, 119, 6, 0.05)); border-color: #f59e0b;">
            <h2 class="card-title">
              <span style="font-size: 2rem;">üí°</span>
              <span>Pro Tips</span>
            </h2>
            <div>
              {tips.map((tip, index) => (
                <div style="display: flex; align-items: start; gap: 1rem; margin-bottom: 1rem;">
                  <span style="font-size: 1.75rem;">‚ú®</span>
                  <p style="font-size: 1.0625rem; line-height: 1.7; color: var(--text-primary);">{tip}</p>
                </div>
              ))}
            </div>
          </div>
        )}
      </div>

      <!-- Sidebar -->
      <div class="sidebar">
        <div class="card-3d">
          
          <!-- Time Info -->
          <div style="margin-bottom: 2rem;">
            <h3 style="font-size: 0.875rem; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 1rem;">Time Required</h3>
            <div>
              <div class="info-row" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(37, 99, 235, 0.1)); border: 1px solid #3b82f6;">
                <span style="font-weight: 600; color: var(--text-primary);">Prep Time</span>
                <span style="font-weight: 800; color: #2563eb;">{recipe.prep_time} min</span>
              </div>
              <div class="info-row" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(217, 119, 6, 0.1)); border: 1px solid #f59e0b;">
                <span style="font-weight: 600; color: var(--text-primary);">Cook Time</span>
                <span style="font-weight: 800; color: #d97706;">{recipe.cook_time} min</span>
              </div>
              <div class="info-row" style="background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color: white;">
                <span style="font-weight: 700;">Total Time</span>
                <span style="font-weight: 900; font-size: 1.25rem;">{recipe.prep_time + recipe.cook_time} min</span>
              </div>
            </div>
          </div>

          <!-- Details -->
          <div style="margin-bottom: 2rem; padding-top: 2rem; border-top: 1px solid var(--border-color);">
            <h3 style="font-size: 0.875rem; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 1rem;">Details</h3>
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem;">
              <span style="color: var(--text-secondary); font-weight: 600;">Difficulty</span>
              <span style="padding: 0.375rem 1rem; background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(52, 211, 153, 0.15)); color: var(--accent-primary); border-radius: 9999px; font-weight: 700; font-size: 0.875rem; text-transform: capitalize;">
                {recipe.difficulty}
              </span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: var(--text-secondary); font-weight: 600;">Servings</span>
              <span style="font-weight: 800; color: var(--text-primary);">{recipe.servings}</span>
            </div>
          </div>

          <!-- Tags -->
          {tags.length > 0 && (
            <div style="margin-bottom: 2rem; padding-top: 2rem; border-top: 1px solid var(--border-color);">
              <h3 style="font-size: 0.875rem; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 1rem;">Tags</h3>
              <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                {tags.map(tag => (
                  <span style="padding: 0.5rem 1rem; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 9999px; font-size: 0.875rem; font-weight: 600; text-transform: capitalize;">
                    {tag}
                  </span>
                ))}
              </div>
            </div>
          )}

          <!-- Action Buttons -->
          <div style="padding-top: 2rem; border-top: 1px solid var(--border-color);">
            {canComplete && (
              <form id="complete-form" style="margin-bottom: 1rem;">
                <input type="hidden" name="taskType" value={mealPlan.meal_type} />
                <button type="submit" class="btn-3d btn-primary-3d">
                  <svg style="width: 1.25rem; height: 1.25rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                  </svg>
                  <span style="position: relative; z-index: 1;">Mark as Completed</span>
                </button>
              </form>
            )}

            {isCompleted && (
              <div style="padding: 2rem; background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(52, 211, 153, 0.1)); border: 2px solid var(--accent-primary); border-radius: 1.5rem; text-align: center; margin-bottom: 1rem;">
                <div style="font-size: 4rem; margin-bottom: 0.75rem;">‚úÖ</div>
                <p style="font-weight: 800; color: var(--accent-primary); font-size: 1.25rem; margin-bottom: 0.5rem;">Completed!</p>
                <p style="font-size: 0.9375rem; color: var(--text-secondary);">You earned +{task?.xp_earned || 25} XP</p>
              </div>
            )}

            <a href="/dashboard" class="btn-3d btn-secondary-3d" style="margin-bottom: 0.75rem;">
              <svg style="width: 1.25rem; height: 1.25rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
              </svg>
              <span style="position: relative; z-index: 1;">Back to Dashboard</span>
            </a>

            <button onclick="window.print()" class="btn-3d btn-secondary-3d">
              <svg style="width: 1.25rem; height: 1.25rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
              </svg>
              <span style="position: relative; z-index: 1;">Print Recipe</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script is:inline>
    // Dark Mode Toggle
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    const html = document.documentElement;

    const savedTheme = localStorage.getItem('theme') || 'light';
    html.setAttribute('data-theme', savedTheme);
    themeIcon.textContent = savedTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';

    if (themeToggle) {
      themeToggle.addEventListener('click', function() {
        const currentTheme = html.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        
        html.setAttribute('data-theme', newTheme);
        themeIcon.textContent = newTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
        localStorage.setItem('theme', newTheme);
      });
    }

    // Notification Toggle
    const notifBell = document.getElementById('notif-bell');
    const notifDropdown = document.getElementById('notificationDropdown');
    
    if (notifBell && notifDropdown) {
      notifBell.addEventListener('click', function(e) {
        e.stopPropagation();
        notifDropdown.classList.toggle('active');
      });

      document.addEventListener('click', function(e) {
        if (!notifDropdown.contains(e.target) && !notifBell.contains(e.target)) {
          notifDropdown.classList.remove('active');
        }
      });
    }

    // Complete Form
    const form = document.getElementById('complete-form');
    if (form) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData(form);
        const taskType = formData.get('taskType');

        try {
          const res = await fetch('/api/tasks/complete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ taskType })
          });

          if (res.ok) {
            const notification = document.createElement('div');
            notification.style.cssText = `
              position: fixed;
              top: 5rem;
              right: 1.5rem;
              background: linear-gradient(135deg, #10b981, #34d399);
              color: white;
              padding: 1.5rem 2rem;
              border-radius: 1.5rem;
              box-shadow: 0 10px 30px rgba(0,0,0,0.3);
              z-index: 9999;
              font-weight: 700;
              font-size: 1.125rem;
              display: flex;
              align-items: center;
              gap: 1rem;
              animation: slideDown 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            `;
            notification.innerHTML = `
              <span style="font-size: 2.5rem;">üéâ</span>
              <div>
                <p style="font-weight: 900; margin-bottom: 0.25rem;">Task Completed!</p>
                <p style="font-size: 0.9375rem; opacity: 0.95;">You earned XP points</p>
              </div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
              window.location.reload();
            }, 1500);
          }
        } catch (error) {
          console.error('Error:', error);
          alert('Failed to complete task. Please try again.');
        }
      });
    }

    console.log('‚úÖ Recipe page loaded successfully!');
  </script>
</body>
</html>
