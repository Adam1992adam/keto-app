---
import { supabase, getProfile, getUserJourney, getDailyTasks } from '../../../lib/supabase';

const { id } = Astro.params;
const accessToken = Astro.cookies.get('sb-access-token')?.value;

if (!accessToken) return Astro.redirect('/login');

const { data: { user } } = await supabase.auth.getUser(accessToken);
if (!user) return Astro.redirect('/login');

const profile = await getProfile(user.id);
const journey = await getUserJourney(user.id);
if (!profile || !journey) return Astro.redirect('/login');

const currentDay = journey?.current_day || 1;
const dailyTasks = await getDailyTasks(user.id, currentDay);
const incompleteTasks = dailyTasks?.filter((t: any) => t.task_type !== 'reflection' && t.task_type !== 'weight' && !t.completed) || [];

const { data: recipe } = await supabase.from('recipes').select('*').eq('id', id).single();
if (!recipe) return Astro.redirect('/dashboard');

const { data: mealPlan } = await supabase
  .from('meal_plans').select('*')
  .eq('recipe_id', id).eq('day_number', journey.current_day).single();

const task = mealPlan ? dailyTasks.find((t: any) => t.task_type === mealPlan.meal_type) : null;
const isCompleted = task?.completed || false;
const canComplete = mealPlan && !isCompleted;

const ingredients  = recipe.ingredients  || [];
const instructions = recipe.instructions || [];
const tips         = recipe.tips         || [];
const tags         = recipe.tags         || [];

const categories: any = {
  breakfast: { name:'Breakfast', icon:'üç≥', gradient:'linear-gradient(135deg,#f59e0b,#d97706)', glow:'rgba(245,158,11,.3)', accent:'#f59e0b' },
  lunch:     { name:'Lunch',     icon:'ü•ó', gradient:'linear-gradient(135deg,#10b981,#059669)', glow:'rgba(16,185,129,.3)',  accent:'#10b981' },
  dinner:    { name:'Dinner',    icon:'üçΩÔ∏è', gradient:'linear-gradient(135deg,#3b82f6,#2563eb)', glow:'rgba(59,130,246,.3)',  accent:'#3b82f6' },
  snack:     { name:'Snack',     icon:'üçé', gradient:'linear-gradient(135deg,#8b5cf6,#7c3aed)', glow:'rgba(139,92,246,.3)', accent:'#8b5cf6' },
  other:     { name:'Other',     icon:'ü•ë', gradient:'linear-gradient(135deg,#6b7280,#4b5563)', glow:'rgba(107,114,128,.3)', accent:'#6b7280' },
};
const cat = categories[recipe.category] || categories.other;
const totalTime = (recipe.prep_time || 0) + (recipe.cook_time || 0);
const difficultyColor = recipe.difficulty === 'Easy' ? '#10b981' : recipe.difficulty === 'Medium' ? '#f59e0b' : '#ef4444';
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{recipe.title} ‚Äî Keto Journey</title>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,700;0,9..144,900;1,9..144,700&family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600;9..40,700&display=swap" rel="stylesheet"/>
  <script is:inline>
    (function(){ const t=localStorage.getItem('keto-theme')||'dark'; document.documentElement.setAttribute('data-theme',t); })();
  </script>
  <style>
    :root {
      --bg:#0c1117; --surface:#131b24; --card:#1a2535; --card2:#1e2d42;
      --border:rgba(255,255,255,.07); --border2:rgba(255,255,255,.13);
      --text:#e8edf5; --muted:#4a5a6e; --soft:#8a9ab0;
      --green:#10b981; --green2:#34d399; --blue:#3b82f6;
      --purple:#8b5cf6; --gold:#f59e0b; --red:#ef4444; --cyan:#06b6d4;
      --radius:20px; --nav-h:64px;
    }
    [data-theme="light"] {
      --bg:#f0f4f8; --surface:#fff; --card:#fff; --card2:#f8fafc;
      --border:rgba(0,0,0,.07); --border2:rgba(0,0,0,.13);
      --text:#0f172a; --muted:#94a3b8; --soft:#64748b;
    }
    *,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
    html{scroll-behavior:smooth;}
    body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;transition:background .3s,color .3s;}

    /* BG */
    .bg-mesh{position:fixed;inset:0;pointer-events:none;z-index:0;overflow:hidden;}
    .orb{position:absolute;border-radius:50%;filter:blur(110px);animation:orbDrift ease-in-out infinite;}
    [data-theme="light"] .orb{opacity:.15;}
    .o1{width:600px;height:600px;background:rgba(16,185,129,.06);top:-150px;left:-150px;animation-duration:24s;opacity:.5;}
    .o2{width:500px;height:500px;background:rgba(59,130,246,.05);bottom:-100px;right:-100px;animation-duration:30s;animation-delay:-14s;opacity:.4;}
    .o3{width:350px;height:350px;background:rgba(245,158,11,.04);top:45%;left:45%;animation-duration:20s;animation-delay:-8s;opacity:.3;}
    @keyframes orbDrift{0%,100%{transform:translate(0,0) scale(1);}33%{transform:translate(40px,-50px) scale(1.07);}66%{transform:translate(-30px,40px) scale(.94);}}

    /* NAV */
    nav{position:sticky;top:0;z-index:100;height:var(--nav-h);background:rgba(12,17,23,.85);border-bottom:1px solid var(--border);backdrop-filter:blur(20px);display:flex;align-items:center;transition:background .3s;}
    [data-theme="light"] nav{background:rgba(255,255,255,.88);}
    .nav-inner{max-width:1280px;margin:0 auto;padding:0 1.5rem;width:100%;display:flex;align-items:center;gap:1rem;}
    .nav-brand{display:flex;align-items:center;gap:.6rem;text-decoration:none;font-family:'Fraunces',serif;font-weight:700;font-size:1.05rem;color:var(--text);flex-shrink:0;}
    .nav-back{display:flex;align-items:center;gap:.4rem;padding:.45rem .9rem;border-radius:10px;font-size:.82rem;font-weight:700;color:var(--soft);text-decoration:none;background:var(--card);border:1px solid var(--border);transition:all .2s;white-space:nowrap;}
    .nav-back:hover{border-color:var(--green);color:var(--green);}
    .nav-spacer{flex:1;}
    .nav-right{display:flex;align-items:center;gap:.75rem;flex-shrink:0;}
    .theme-btn{width:38px;height:38px;border-radius:10px;background:var(--card);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1rem;transition:all .2s;}
    .theme-btn:hover{border-color:var(--green);}
    .notif-wrap{position:relative;}
    .notif-btn{width:38px;height:38px;border-radius:10px;background:var(--card);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1rem;position:relative;transition:all .2s;}
    .notif-btn:hover{border-color:var(--green);}
    .notif-badge{position:absolute;top:-5px;right:-5px;background:var(--red);color:#fff;width:18px;height:18px;border-radius:50%;font-size:.65rem;font-weight:800;display:flex;align-items:center;justify-content:center;animation:pulseBadge 2s infinite;}
    @keyframes pulseBadge{0%,100%{transform:scale(1);}50%{transform:scale(1.2);}}
    .notif-dropdown{position:absolute;top:calc(100% + .5rem);right:0;width:340px;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.4);display:none;z-index:200;}
    .notif-dropdown.open{display:block;animation:dropIn .25s ease;}
    @keyframes dropIn{from{opacity:0;transform:translateY(-8px);}to{opacity:1;transform:translateY(0);}}
    .notif-item{display:flex;align-items:center;gap:.875rem;padding:.875rem 1.25rem;border-bottom:1px solid var(--border);cursor:pointer;transition:background .2s;}
    .notif-item:hover{background:rgba(16,185,129,.06);}
    .nav-avatar{width:38px;height:38px;border-radius:10px;background:linear-gradient(135deg,var(--green),var(--blue));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:.95rem;text-decoration:none;transition:all .2s;}
    .nav-avatar:hover{transform:scale(1.05);}

    /* PAGE */
    .page{position:relative;z-index:1;max-width:1280px;margin:0 auto;padding:2rem 1.5rem 5rem;}

    /* HERO */
    .recipe-hero{
      border-radius:var(--radius); overflow:hidden;
      margin-bottom:2rem; position:relative; min-height:420px;
      background:var(--card); border:1px solid var(--border);
      animation:fadeUp .5s ease both;
    }
    .recipe-hero-img{width:100%;height:420px;object-fit:cover;display:block;}
    .recipe-hero-placeholder{
      height:420px; display:flex; align-items:center; justify-content:center;
      font-size:8rem;
      background:linear-gradient(135deg,var(--surface),var(--card2));
    }
    .hero-overlay{
      position:absolute;inset:0;
      background:linear-gradient(to top,rgba(12,17,23,.95) 0%,rgba(12,17,23,.5) 50%,transparent 100%);
    }
    [data-theme="light"] .hero-overlay{background:linear-gradient(to top,rgba(15,23,42,.9) 0%,rgba(15,23,42,.4) 55%,transparent 100%);}
    .hero-content{position:absolute;bottom:0;left:0;right:0;padding:2.5rem;}
    .hero-meta{display:flex;flex-wrap:wrap;gap:.6rem;margin-bottom:1rem;}
    .hero-pill{
      display:inline-flex;align-items:center;gap:.35rem;
      padding:.35rem .875rem;border-radius:99px;
      font-size:.75rem;font-weight:800;backdrop-filter:blur(12px);
      background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);
      color:#fff;
    }
    .recipe-title{
      font-family:'Fraunces',serif;
      font-size:clamp(1.8rem,4vw,2.8rem);
      font-weight:900;color:#fff;line-height:1.1;
      margin-bottom:.75rem;
      text-shadow:0 4px 16px rgba(0,0,0,.5);
    }
    .recipe-desc{
      font-size:.95rem;color:rgba(255,255,255,.8);
      max-width:700px;line-height:1.65;
    }
    .completed-ribbon{
      position:absolute;top:1.5rem;right:1.5rem;
      display:flex;align-items:center;gap:.4rem;
      padding:.45rem 1rem;border-radius:99px;
      background:rgba(16,185,129,.9);border:1px solid rgba(16,185,129,.5);
      backdrop-filter:blur(8px);
      color:#fff;font-size:.8rem;font-weight:800;
      box-shadow:0 4px 14px rgba(16,185,129,.4);
    }

    /* LAYOUT */
    .recipe-layout{display:grid;grid-template-columns:1fr 340px;gap:1.75rem;align-items:start;}
    @media(max-width:1024px){.recipe-layout{grid-template-columns:1fr;}}

    /* SECTION CARD */
    .section-card{
      background:var(--card);border:1px solid var(--border);
      border-radius:var(--radius);overflow:hidden;
      margin-bottom:1.5rem;transition:border-color .25s;
      animation:fadeUp .4s ease both;
    }
    .section-card:hover{border-color:var(--border2);}
    .section-head{
      display:flex;align-items:center;gap:.875rem;
      padding:1.5rem 1.75rem;border-bottom:1px solid var(--border);
    }
    .section-icon{
      width:44px;height:44px;border-radius:12px;
      display:flex;align-items:center;justify-content:center;
      font-size:1.2rem;flex-shrink:0;
    }
    .section-title{font-family:'Fraunces',serif;font-size:1.15rem;font-weight:700;}
    .section-body{padding:1.5rem 1.75rem;}

    /* MACROS */
    .macros-row{display:grid;grid-template-columns:repeat(5,1fr);gap:.875rem;}
    @media(max-width:640px){.macros-row{grid-template-columns:repeat(3,1fr);}}
    .macro-card{
      text-align:center;padding:1.25rem .875rem;border-radius:14px;
      border:1.5px solid;transition:all .25s;
    }
    .macro-card:hover{transform:translateY(-4px);}
    .macro-val{font-family:'Fraunces',serif;font-size:2rem;font-weight:900;line-height:1;display:block;margin-bottom:.3rem;}
    .macro-lbl{font-size:.68rem;font-weight:800;text-transform:uppercase;letter-spacing:.07em;}
    .macro-unit{font-size:.72rem;opacity:.7;}

    /* INGREDIENTS */
    .ingredient-list{display:flex;flex-direction:column;gap:.6rem;}
    .ingredient-row{
      display:flex;align-items:center;gap:.875rem;
      padding:.875rem 1rem;border-radius:12px;
      background:var(--surface);border:1.5px solid transparent;
      transition:all .25s;cursor:pointer;
    }
    .ingredient-row:hover{border-color:rgba(16,185,129,.25);transform:translateX(5px);}
    .ingredient-row.checked{opacity:.45;}
    .ingredient-row.checked .ing-name{text-decoration:line-through;}
    .ing-num{
      width:28px;height:28px;border-radius:8px;flex-shrink:0;
      display:flex;align-items:center;justify-content:center;
      font-size:.75rem;font-weight:800;color:#fff;
    }
    .ing-amount{font-weight:800;font-size:.9rem;color:var(--text);min-width:80px;flex-shrink:0;}
    .ing-name{font-size:.9rem;font-weight:600;color:var(--text);flex:1;}
    .ing-check{
      width:20px;height:20px;border-radius:6px;flex-shrink:0;
      border:2px solid rgba(16,185,129,.3);background:transparent;
      cursor:pointer;appearance:none;transition:all .2s;position:relative;
    }
    .ing-check:checked{background:linear-gradient(135deg,var(--green),var(--green2));border-color:transparent;}
    .ing-check:checked::after{content:'‚úì';position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#fff;font-size:.65rem;font-weight:900;}

    /* INSTRUCTIONS */
    .steps-list{display:flex;flex-direction:column;gap:1.25rem;}
    .step-row{
      display:flex;gap:1.25rem;padding:1.25rem;
      border-radius:14px;background:var(--surface);
      border:1.5px solid transparent;transition:all .25s;
    }
    .step-row:hover{border-color:rgba(59,130,246,.2);transform:translateX(4px);}
    .step-num{
      width:36px;height:36px;border-radius:10px;flex-shrink:0;
      display:flex;align-items:center;justify-content:center;
      font-size:.9rem;font-weight:900;color:#fff;
      background:linear-gradient(135deg,var(--blue),#2563eb);
      box-shadow:0 4px 12px rgba(59,130,246,.3);
    }
    .step-text{font-size:.9rem;line-height:1.7;padding-top:.15rem;}

    /* TIPS */
    .tips-list{display:flex;flex-direction:column;gap:.875rem;}
    .tip-row{
      display:flex;gap:.875rem;align-items:flex-start;
      padding:1rem 1.25rem;border-radius:12px;
      background:rgba(245,158,11,.06);
      border:1px solid rgba(245,158,11,.15);transition:all .2s;
    }
    .tip-row:hover{background:rgba(245,158,11,.1);}
    .tip-icon{font-size:1.2rem;flex-shrink:0;margin-top:.1rem;}
    .tip-text{font-size:.875rem;line-height:1.65;color:var(--soft);}

    /* SIDEBAR */
    .sidebar{position:sticky;top:calc(var(--nav-h) + 1rem);}
    .side-card{
      background:var(--card);border:1px solid var(--border);
      border-radius:var(--radius);overflow:hidden;margin-bottom:1.25rem;
      animation:fadeUp .4s .1s ease both;
    }
    .side-head{padding:1.25rem 1.5rem;border-bottom:1px solid var(--border);font-weight:800;font-size:.8rem;text-transform:uppercase;letter-spacing:.08em;color:var(--soft);}
    .side-body{padding:1.25rem 1.5rem;}

    /* TIME BLOCKS */
    .time-blocks{display:grid;grid-template-columns:1fr 1fr;gap:.6rem;margin-bottom:.6rem;}
    .time-block{text-align:center;padding:1rem;border-radius:12px;background:var(--surface);border:1px solid var(--border);}
    .time-val{font-family:'Fraunces',serif;font-size:1.5rem;font-weight:900;line-height:1;margin-bottom:.25rem;}
    .time-lbl{font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--soft);}
    .time-total{
      display:flex;align-items:center;justify-content:space-between;
      padding:.875rem 1.25rem;border-radius:12px;
      font-weight:800;font-size:.9rem;color:#fff;
    }

    /* DETAILS LIST */
    .detail-row{display:flex;align-items:center;justify-content:space-between;padding:.75rem 0;border-bottom:1px solid var(--border);}
    .detail-row:last-child{border:none;}
    .detail-lbl{font-size:.82rem;color:var(--soft);font-weight:600;}
    .detail-val{font-size:.82rem;font-weight:800;}
    .diff-pill{padding:.25rem .75rem;border-radius:99px;font-size:.72rem;font-weight:800;border:1px solid;}

    /* TAGS */
    .tags-wrap{display:flex;flex-wrap:wrap;gap:.5rem;}
    .tag-pill{padding:.3rem .75rem;border-radius:99px;font-size:.72rem;font-weight:700;background:var(--surface);border:1px solid var(--border);color:var(--soft);transition:all .2s;}
    .tag-pill:hover{border-color:var(--green);color:var(--green);}

    /* BUTTONS */
    .btn{
      display:flex;align-items:center;justify-content:center;gap:.5rem;
      width:100%;padding:.875rem;border-radius:13px;
      font-size:.875rem;font-weight:800;border:none;cursor:pointer;
      text-decoration:none;transition:all .25s;position:relative;overflow:hidden;
    }
    .btn::before{content:'';position:absolute;inset:0;background:linear-gradient(to right,transparent,rgba(255,255,255,.1),transparent);transform:translateX(-100%);transition:transform .4s;}
    .btn:hover::before{transform:translateX(100%);}
    .btn:hover{transform:translateY(-2px);}
    .btn-complete{background:linear-gradient(135deg,var(--green),var(--green2));color:#fff;box-shadow:0 4px 16px rgba(16,185,129,.35);margin-bottom:.75rem;}
    .btn-complete:hover{box-shadow:0 8px 24px rgba(16,185,129,.45);}
    .btn-outline{background:transparent;border:1px solid var(--border);color:var(--soft);margin-bottom:.6rem;}
    .btn-outline:hover{border-color:var(--green);color:var(--green);}

    /* COMPLETED STATE */
    .completed-box{
      background:linear-gradient(135deg,rgba(16,185,129,.08),rgba(52,211,153,.04));
      border:1px solid rgba(16,185,129,.25);border-radius:14px;
      padding:1.5rem;text-align:center;margin-bottom:.75rem;
    }
    .completed-box-icon{font-size:2.5rem;margin-bottom:.5rem;}
    .completed-box-title{font-family:'Fraunces',serif;font-size:1.1rem;font-weight:700;color:var(--green);margin-bottom:.25rem;}
    .completed-box-xp{font-size:.82rem;color:var(--soft);}

    /* PROGRESS BAR */
    .ing-progress{margin-top:1.25rem;padding-top:1.25rem;border-top:1px solid var(--border);}
    .ip-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem;}
    .ip-label{font-size:.75rem;font-weight:700;color:var(--soft);}
    .ip-val{font-size:.75rem;font-weight:800;color:var(--green);}
    .ip-track{height:6px;background:var(--surface);border-radius:99px;overflow:hidden;}
    .ip-fill{height:100%;border-radius:99px;background:linear-gradient(90deg,var(--green),var(--green2));transition:width .5s ease;}

    /* TOAST */
    .toast{position:fixed;top:5rem;right:1.5rem;z-index:9999;background:linear-gradient(135deg,var(--green),var(--green2));color:#fff;padding:.875rem 1.5rem;border-radius:12px;font-weight:700;font-size:.875rem;box-shadow:0 10px 30px rgba(16,185,129,.4);transform:translateY(-20px);opacity:0;pointer-events:none;transition:all .35s cubic-bezier(.4,0,.2,1);}
    .toast.show{transform:translateY(0);opacity:1;}

    @keyframes fadeUp{from{opacity:0;transform:translateY(12px);}to{opacity:1;transform:translateY(0);}}

    @media print{nav,.sidebar,.btn{display:none!important;}body{background:#fff!important;color:#000!important;}.section-card{box-shadow:none!important;border:1px solid #ddd!important;}}
  </style>
</head>
<body>

<div class="bg-mesh" aria-hidden="true">
  <div class="orb o1"></div><div class="orb o2"></div><div class="orb o3"></div>
</div>

<!-- NAV -->
<nav>
  <div class="nav-inner">
    <a href="/dashboard" class="nav-brand">ü•ë <span>Keto Journey</span></a>
    <a href="/dashboard/recipes" class="nav-back">‚Üê Recipes</a>
    <div class="nav-spacer"></div>
    <div class="nav-right">
      <button class="theme-btn" id="themeBtn">‚òÄÔ∏è</button>

      {incompleteTasks.length > 0 && (
        <div class="notif-wrap">
          <button class="notif-btn" id="notifBtn">
            üîî<span class="notif-badge">{incompleteTasks.length}</span>
          </button>
          <div class="notif-dropdown" id="notifDropdown">
            <div style="padding:1rem 1.25rem;border-bottom:1px solid var(--border);font-weight:800;font-size:.9rem;color:var(--green);">
              üîî {incompleteTasks.length} Pending Task{incompleteTasks.length !== 1 ? 's' : ''}
            </div>
            <div style="max-height:320px;overflow-y:auto;">
              {incompleteTasks.map((t: any) => (
                <div class="notif-item">
                  <div style="width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--green),var(--green2));display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0;">
                    {t.task_type==='breakfast'?'üç≥':t.task_type==='lunch'?'ü•ó':t.task_type==='dinner'?'üçΩÔ∏è':t.task_type==='snack'?'üçé':'üíß'}
                  </div>
                  <div>
                    <div style="font-weight:700;font-size:.85rem;">{t.task_title}</div>
                    <div style="font-size:.75rem;color:var(--soft);">+{t.xp_earned} XP</div>
                  </div>
                </div>
              ))}
            </div>
            <div style="padding:.875rem 1.25rem;border-top:1px solid var(--border);">
              <a href="/dashboard" style="display:block;text-align:center;padding:.6rem;border-radius:10px;background:linear-gradient(135deg,var(--green),var(--green2));color:#fff;font-weight:700;font-size:.8rem;text-decoration:none;">View All Tasks ‚Üí</a>
            </div>
          </div>
        </div>
      )}

      <a href="/dashboard/profile" class="nav-avatar">{profile.full_name.charAt(0).toUpperCase()}</a>
    </div>
  </div>
</nav>

<!-- PAGE -->
<div class="page">

  <!-- HERO -->
  <div class="recipe-hero">
    {recipe.image_url
      ? <img src={recipe.image_url} alt={recipe.title} class="recipe-hero-img"/>
      : <div class="recipe-hero-placeholder">{cat.icon}</div>
    }
    <div class="hero-overlay"></div>

    {isCompleted && (
      <div class="completed-ribbon">‚úì Completed Today</div>
    )}

    <div class="hero-content">
      <div class="hero-meta">
        <span class="hero-pill" style={`background:${cat.accent}25;border-color:${cat.accent}50;`}>
          <span>{cat.icon}</span><span>{cat.name}</span>
        </span>
        <span class="hero-pill">‚è±Ô∏è {totalTime} min</span>
        <span class="hero-pill">üçΩÔ∏è {recipe.servings} serving{recipe.servings > 1 ? 's' : ''}</span>
        <span class="hero-pill" style={`background:${difficultyColor}20;border-color:${difficultyColor}50;color:${difficultyColor};`}>
          {recipe.difficulty === 'Easy' ? '‚≠ê' : recipe.difficulty === 'Medium' ? '‚≠ê‚≠ê' : '‚≠ê‚≠ê‚≠ê'} {recipe.difficulty}
        </span>
        {recipe.net_carbs && (
          <span class="hero-pill" style="background:rgba(16,185,129,.2);border-color:rgba(16,185,129,.4);color:#34d399;">
            ü•ó {recipe.net_carbs}g carbs
          </span>
        )}
      </div>
      <h1 class="recipe-title">{recipe.title}</h1>
      {recipe.description && <p class="recipe-desc">{recipe.description}</p>}
    </div>
  </div>

  <!-- LAYOUT -->
  <div class="recipe-layout">

    <!-- MAIN -->
    <div>

      <!-- MACROS -->
      <div class="section-card" style="animation-delay:.05s;">
        <div class="section-head">
          <div class="section-icon" style="background:linear-gradient(135deg,#ef4444,#dc2626);box-shadow:0 4px 12px rgba(239,68,68,.3);">üìä</div>
          <div>
            <div class="section-title">Nutrition Facts</div>
            <div style="font-size:.75rem;color:var(--soft);margin-top:.1rem;">Per serving</div>
          </div>
        </div>
        <div class="section-body">
          <div class="macros-row">
            {[
              { val: recipe.calories,  lbl: 'Calories', unit: '',  color: '#ef4444', bg: 'rgba(239,68,68,.1)',  border: '#ef4444' },
              { val: recipe.protein,   lbl: 'Protein',  unit: 'g', color: '#3b82f6', bg: 'rgba(59,130,246,.1)', border: '#3b82f6' },
              { val: recipe.fat,       lbl: 'Fat',      unit: 'g', color: '#f59e0b', bg: 'rgba(245,158,11,.1)', border: '#f59e0b' },
              { val: recipe.net_carbs, lbl: 'Net Carbs',unit: 'g', color: '#10b981', bg: 'rgba(16,185,129,.1)', border: '#10b981' },
              { val: recipe.fiber,     lbl: 'Fiber',    unit: 'g', color: '#8b5cf6', bg: 'rgba(139,92,246,.1)', border: '#8b5cf6' },
            ].map(m => (
              <div class="macro-card" style={`background:${m.bg};border-color:${m.border};color:${m.color};`}>
                <span class="macro-val">{m.val}{m.unit}</span>
                <span class="macro-lbl">{m.lbl}</span>
              </div>
            ))}
          </div>
        </div>
      </div>

      <!-- INGREDIENTS -->
      <div class="section-card" style="animation-delay:.1s;">
        <div class="section-head">
          <div class="section-icon" style="background:linear-gradient(135deg,var(--green),var(--green2));box-shadow:0 4px 12px rgba(16,185,129,.3);">üõí</div>
          <div style="flex:1;">
            <div class="section-title">Ingredients</div>
            <div style="font-size:.75rem;color:var(--soft);margin-top:.1rem;">{ingredients.length} items ‚Ä¢ tap to check off</div>
          </div>
          <span style="font-size:.72rem;font-weight:700;padding:.25rem .65rem;border-radius:99px;background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.2);color:var(--green);" id="ingCount">0 / {ingredients.length}</span>
        </div>
        <div class="section-body">
          <div class="ingredient-list" id="ingList">
            {ingredients.map((ing: any, i: number) => (
              <div class="ingredient-row" onclick={`toggleIng(${i})`} id={`ing-${i}`}>
                <div class="ing-num" style={`background:${cat.gradient};box-shadow:0 3px 8px ${cat.glow};`}>{i + 1}</div>
                <span class="ing-amount">{ing.amount} {ing.unit}</span>
                <span class="ing-name">{ing.item}</span>
                <input type="checkbox" class="ing-check" id={`ingc-${i}`} onclick="event.stopPropagation();" onchange={`syncIng(${i})`}/>
              </div>
            ))}
          </div>
          <div class="ing-progress">
            <div class="ip-header">
              <span class="ip-label">Ingredients prepared</span>
              <span class="ip-val" id="ingPct">0%</span>
            </div>
            <div class="ip-track"><div class="ip-fill" id="ingBar" style="width:0%"></div></div>
          </div>
        </div>
      </div>

      <!-- INSTRUCTIONS -->
      <div class="section-card" style="animation-delay:.15s;">
        <div class="section-head">
          <div class="section-icon" style="background:linear-gradient(135deg,var(--blue),#2563eb);box-shadow:0 4px 12px rgba(59,130,246,.3);">üë®‚Äçüç≥</div>
          <div>
            <div class="section-title">Instructions</div>
            <div style="font-size:.75rem;color:var(--soft);margin-top:.1rem;">{instructions.length} steps</div>
          </div>
        </div>
        <div class="section-body">
          <div class="steps-list">
            {instructions.map((step: string, i: number) => (
              <div class="step-row">
                <div class="step-num">{i + 1}</div>
                <div class="step-text">{step}</div>
              </div>
            ))}
          </div>
        </div>
      </div>

      <!-- TIPS -->
      {tips.length > 0 && (
        <div class="section-card" style="animation-delay:.2s;">
          <div class="section-head">
            <div class="section-icon" style="background:linear-gradient(135deg,var(--gold),#d97706);box-shadow:0 4px 12px rgba(245,158,11,.3);">üí°</div>
            <div>
              <div class="section-title">Pro Tips</div>
              <div style="font-size:.75rem;color:var(--soft);margin-top:.1rem;">{tips.length} chef secrets</div>
            </div>
          </div>
          <div class="section-body">
            <div class="tips-list">
              {tips.map((tip: string) => (
                <div class="tip-row">
                  <span class="tip-icon">‚ú®</span>
                  <p class="tip-text">{tip}</p>
                </div>
              ))}
            </div>
          </div>
        </div>
      )}

    </div><!-- /main -->

    <!-- SIDEBAR -->
    <div class="sidebar">

      <!-- COMPLETE / COMPLETED -->
      {canComplete && (
        <div class="side-card">
          <div class="side-head">Today's Task</div>
          <div class="side-body">
            <p style="font-size:.82rem;color:var(--soft);margin-bottom:1rem;line-height:1.5;">
              This is your <strong style="color:var(--text);">{mealPlan.meal_type}</strong> for today ‚Äî Day {currentDay}.
              Mark it done to earn XP!
            </p>
            <button class="btn btn-complete" id="completeBtn">
              <span>‚úì</span>
              <span>Mark as Completed</span>
            </button>
          </div>
        </div>
      )}

      {isCompleted && (
        <div class="side-card">
          <div class="side-body">
            <div class="completed-box">
              <div class="completed-box-icon">üéâ</div>
              <div class="completed-box-title">Completed!</div>
              <div class="completed-box-xp">You earned +{task?.xp_earned || 25} XP today</div>
            </div>
          </div>
        </div>
      )}

      <!-- TIME -->
      <div class="side-card">
        <div class="side-head">Time Required</div>
        <div class="side-body">
          <div class="time-blocks">
            <div class="time-block">
              <div class="time-val" style="color:var(--blue);">{recipe.prep_time}</div>
              <div class="time-lbl">Prep</div>
              <div class="time-lbl" style="margin-top:.1rem;">min</div>
            </div>
            <div class="time-block">
              <div class="time-val" style="color:var(--gold);">{recipe.cook_time}</div>
              <div class="time-lbl">Cook</div>
              <div class="time-lbl" style="margin-top:.1rem;">min</div>
            </div>
          </div>
          <div class="time-total" style={`background:${cat.gradient};box-shadow:0 4px 14px ${cat.glow};`}>
            <span>‚è±Ô∏è Total Time</span>
            <span style="font-family:'Fraunces',serif;font-size:1.2rem;">{totalTime} min</span>
          </div>
        </div>
      </div>

      <!-- DETAILS -->
      <div class="side-card">
        <div class="side-head">Recipe Details</div>
        <div class="side-body">
          <div class="detail-row">
            <span class="detail-lbl">Category</span>
            <span class="detail-val">{cat.icon} {cat.name}</span>
          </div>
          <div class="detail-row">
            <span class="detail-lbl">Difficulty</span>
            <span class="diff-pill" style={`background:${difficultyColor}15;border-color:${difficultyColor}40;color:${difficultyColor};`}>{recipe.difficulty}</span>
          </div>
          <div class="detail-row">
            <span class="detail-lbl">Servings</span>
            <span class="detail-val">{recipe.servings} person{recipe.servings > 1 ? 's' : ''}</span>
          </div>
          {recipe.calories && (
            <div class="detail-row">
              <span class="detail-lbl">Calories</span>
              <span class="detail-val" style="color:var(--red);">{recipe.calories} kcal</span>
            </div>
          )}
          {recipe.net_carbs !== undefined && (
            <div class="detail-row">
              <span class="detail-lbl">Net Carbs</span>
              <span class="detail-val" style="color:var(--green);">{recipe.net_carbs}g</span>
            </div>
          )}
        </div>
      </div>

      <!-- TAGS -->
      {tags.length > 0 && (
        <div class="side-card">
          <div class="side-head">Tags</div>
          <div class="side-body">
            <div class="tags-wrap">
              {tags.map((tag: string) => (
                <span class="tag-pill"># {tag}</span>
              ))}
            </div>
          </div>
        </div>
      )}

      <!-- ACTIONS -->
      <div class="side-card">
        <div class="side-head">Actions</div>
        <div class="side-body">
          <a href="/dashboard" class="btn btn-outline">üè† Back to Dashboard</a>
          <a href="/dashboard/recipes" class="btn btn-outline">üìö All Recipes</a>
          <button onclick="window.print()" class="btn btn-outline" style="margin-bottom:0;">üñ®Ô∏è Print Recipe</button>
        </div>
      </div>

    </div><!-- /sidebar -->

  </div><!-- /layout -->

</div><!-- /page -->

<div class="toast" id="toast"></div>

<script is:inline define:vars={{ mealPlanType: mealPlan?.meal_type || null, xpEarned: task?.xp_earned || 25, totalIngredients: ingredients.length }}>

// ‚îÄ‚îÄ THEME ‚îÄ‚îÄ
const html = document.documentElement;
const themeBtn = document.getElementById('themeBtn');
function applyTheme(t) {
  html.setAttribute('data-theme', t);
  localStorage.setItem('keto-theme', t);
  if (themeBtn) themeBtn.textContent = t === 'dark' ? '‚òÄÔ∏è' : 'üåô';
}
applyTheme(localStorage.getItem('keto-theme') || 'dark');
themeBtn?.addEventListener('click', () => applyTheme(html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'));

// ‚îÄ‚îÄ NOTIFS ‚îÄ‚îÄ
const notifBtn  = document.getElementById('notifBtn');
const notifDrop = document.getElementById('notifDropdown');
notifBtn?.addEventListener('click', e => { e.stopPropagation(); notifDrop?.classList.toggle('open'); });
document.addEventListener('click', e => { if (notifDrop && !notifDrop.contains(e.target) && e.target !== notifBtn) notifDrop.classList.remove('open'); });

// ‚îÄ‚îÄ INGREDIENT CHECK ‚îÄ‚îÄ
let checkedCount = 0;
function updateIngProgress() {
  const pct = totalIngredients > 0 ? Math.round((checkedCount / totalIngredients) * 100) : 0;
  const bar   = document.getElementById('ingBar');
  const pctEl = document.getElementById('ingPct');
  const count = document.getElementById('ingCount');
  if (bar)   bar.style.width   = pct + '%';
  if (pctEl) pctEl.textContent = pct + '%';
  if (count) count.textContent = `${checkedCount} / ${totalIngredients}`;
}

function toggleIng(i) {
  const row = document.getElementById(`ing-${i}`);
  const cb  = document.getElementById(`ingc-${i}`);
  if (!row || !cb) return;
  cb.checked = !cb.checked;
  if (cb.checked) { row.classList.add('checked'); checkedCount++; }
  else            { row.classList.remove('checked'); checkedCount--; }
  updateIngProgress();
  if (checkedCount === totalIngredients && totalIngredients > 0)
    showToast('üéâ All ingredients prepared! Time to cook!');
}

function syncIng(i) {
  const row = document.getElementById(`ing-${i}`);
  const cb  = document.getElementById(`ingc-${i}`);
  if (!row || !cb) return;
  if (cb.checked) { row.classList.add('checked'); checkedCount++; }
  else            { row.classList.remove('checked'); checkedCount--; }
  updateIngProgress();
}

window.toggleIng = toggleIng;
window.syncIng   = syncIng;

// ‚îÄ‚îÄ COMPLETE TASK ‚îÄ‚îÄ
const completeBtn = document.getElementById('completeBtn');
if (completeBtn && mealPlanType) {
  completeBtn.addEventListener('click', async () => {
    completeBtn.disabled = true;
    completeBtn.textContent = '‚è≥ Saving...';
    try {
      const res = await fetch('/api/tasks/complete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ taskType: mealPlanType })
      });
      if (res.ok) {
        showToast(`üéâ Completed! +${xpEarned} XP earned!`);
        setTimeout(() => window.location.reload(), 1500);
      } else {
        completeBtn.disabled = false;
        completeBtn.textContent = '‚úì Mark as Completed';
        showToast('‚ùå Something went wrong. Try again.');
      }
    } catch {
      completeBtn.disabled = false;
      completeBtn.textContent = '‚úì Mark as Completed';
      showToast('‚ùå Connection error. Try again.');
    }
  });
}

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ
function showToast(msg) {
  const t = document.getElementById('toast');
  if (!t) return;
  t.textContent = msg;
  t.className = 'toast show';
  setTimeout(() => t.classList.remove('show'), 3000);
}

</script>
</body>
</html>