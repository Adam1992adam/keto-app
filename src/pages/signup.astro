---
// signup.astro ‚Äî ŸäŸÇÿ®ŸÑ email ŸÖŸÜ URL ÿ£Ÿà Ÿäÿ∑ŸÑÿ®Ÿá ŸÖŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
const emailParam = Astro.url.searchParams.get('email');
const allowedEmail = emailParam ? emailParam.toLowerCase().trim() : '';
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Complete Registration ‚Äì Keto Journey</title>
  <style>
    :root{--bg:#fff;--text:#111;--accent:#10b981;--border:#e5e7eb;}
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:1rem;}
    .card{background:var(--bg);border-radius:2rem;padding:3rem;max-width:500px;width:100%;box-shadow:0 25px 50px rgba(0,0,0,0.3);}
    .icon{font-size:4rem;text-align:center;margin-bottom:1.5rem;}
    h1{font-size:2rem;font-weight:900;text-align:center;margin-bottom:.5rem;background:linear-gradient(135deg,var(--accent),#34d399);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
    .subtitle{text-align:center;color:#6b7280;margin-bottom:2rem;}
    .plan-badge{text-align:center;padding:1rem;background:linear-gradient(135deg,rgba(16,185,129,.1),rgba(52,211,153,.1));border-radius:1rem;border:2px solid var(--accent);margin-bottom:2rem;display:none;}
    .plan-badge.show{display:block;}
    .plan-badge strong{color:var(--accent);font-size:1.125rem;}
    .form-group{margin-bottom:1.5rem;}
    label{display:block;font-weight:600;margin-bottom:.5rem;color:var(--text);}
    input{width:100%;padding:1rem;border:2px solid var(--border);border-radius:1rem;font-size:1rem;transition:all .3s;}
    input:focus{outline:none;border-color:var(--accent);}
    input[readonly]{background:#f9fafb;cursor:not-allowed;}
    button{width:100%;padding:1.25rem;background:linear-gradient(135deg,var(--accent),#34d399);color:white;border:none;border-radius:1rem;font-weight:800;font-size:1.125rem;cursor:pointer;transition:all .3s;}
    button:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 10px 25px rgba(16,185,129,0.3);}
    button:disabled{opacity:.5;cursor:not-allowed;}
    .error-msg{color:#ef4444;font-size:.875rem;margin-top:.5rem;display:none;}
    .error-msg.show{display:block;}
    .success{background:#10b981;color:white;padding:1rem;border-radius:1rem;text-align:center;margin-bottom:1.5rem;display:none;}
    .success.show{display:block;}
    .loading{text-align:center;padding:1rem;display:none;}
    .loading.show{display:block;}
    .loader{border:4px solid #f3f3f3;border-top:4px solid var(--accent);border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:0 auto 1rem;}
    @keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
    .no-purchase{text-align:center;padding:1rem;display:none;}
    .no-purchase.show{display:block;}
    .no-purchase h2{color:#ef4444;margin-bottom:1rem;}
    .no-purchase p{color:#6b7280;margin-bottom:.5rem;}
    .btn-outline{display:inline-block;margin-top:1rem;padding:1rem 2rem;background:var(--accent);color:white;text-decoration:none;border-radius:1rem;font-weight:800;}
  </style>
</head>
<body>
<div class="card">
  <div class="icon">üéâ</div>
  <h1>Complete Registration</h1>
  <p class="subtitle" id="subtitle">Enter your purchase email to get started</p>

  <!-- ‚îÄ‚îÄ Step 1: ÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿ•ŸäŸÖŸäŸÑ (ÿ•ÿ∞ÿß ŸÑŸÖ Ÿäÿ£ÿ™Ÿê ŸÖŸÜ URL) ‚îÄ‚îÄ -->
  <div id="emailStep">
    <div class="form-group">
      <label>Purchase Email</label>
      <input type="email" id="emailInput" placeholder="Enter the email you used to purchase"/>
      <div class="error-msg" id="emailError">Please enter a valid email</div>
    </div>
    <button id="verifyBtn" onclick="startVerification()">Verify Purchase üîç</button>
  </div>

  <!-- ‚îÄ‚îÄ Loading ‚îÄ‚îÄ -->
  <div class="loading" id="loadingDiv">
    <div class="loader"></div>
    <p>Checking your purchase...</p>
  </div>

  <!-- ‚îÄ‚îÄ No Purchase ‚îÄ‚îÄ -->
  <div class="no-purchase" id="noPurchaseDiv">
    <h2>‚ö†Ô∏è No Purchase Found</h2>
    <p>We couldn't find a purchase for this email.</p>
    <p>Please make sure you used the same email when purchasing.</p>
    <a href="https://payhip.com/b/OEQk9" class="btn-outline">Purchase Now</a>
    <br/><br/>
    <button onclick="resetForm()" style="background:#6b7280;">Try Another Email</button>
  </div>

  <!-- ‚îÄ‚îÄ Plan Badge ‚îÄ‚îÄ -->
  <div class="plan-badge" id="planBadge">
    <div style="font-size:.875rem;color:#6b7280;margin-bottom:.25rem;">Your Plan:</div>
    <strong id="planName">Loading...</strong>
  </div>

  <!-- ‚îÄ‚îÄ Success ‚îÄ‚îÄ -->
  <div class="success" id="successDiv">
    <strong>‚úì Account created!</strong><br/>Redirecting to dashboard...
  </div>

  <!-- ‚îÄ‚îÄ Signup Form ‚îÄ‚îÄ -->
  <form id="signupForm" style="display:none;" onsubmit="handleSignup(event)">
    <div class="form-group">
      <label>Email Address</label>
      <input type="email" id="emailDisplay" readonly/>
    </div>
    <div class="form-group">
      <label>Full Name</label>
      <input type="text" id="fullName" placeholder="Enter your full name" required/>
      <div class="error-msg" id="nameError">Please enter your name</div>
    </div>
    <div class="form-group">
      <label>Password</label>
      <input type="password" id="password" placeholder="Choose a strong password" required/>
      <div class="error-msg" id="passwordError">Password must be at least 6 characters</div>
    </div>
    <div class="form-group">
      <label>Confirm Password</label>
      <input type="password" id="confirmPassword" placeholder="Confirm your password" required/>
      <div class="error-msg" id="confirmError">Passwords don't match</div>
    </div>
    <button type="submit" id="submitBtn">Create My Account üöÄ</button>
    <div class="error-msg" id="formError" style="margin-top:1rem;text-align:center;"></div>
  </form>
</div>

<script is:inline define:vars={{allowedEmail}}>
  let purchaseData = null;
  let verifiedEmail = '';

  // ÿ•ÿ∞ÿß ÿ¨ÿßÿ° ÿßŸÑÿ•ŸäŸÖŸäŸÑ ŸÖŸÜ URL ‚Äî ŸÜÿ®ÿØÿ£ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã
  window.addEventListener('DOMContentLoaded', () => {
    if (allowedEmail) {
      document.getElementById('emailInput').value = allowedEmail;
      startVerification();
    }
  });

  async function startVerification() {
    const emailInput = document.getElementById('emailInput');
    const email = emailInput.value.trim().toLowerCase();

    if (!email || !email.includes('@')) {
      document.getElementById('emailError').classList.add('show');
      return;
    }

    document.getElementById('emailError').classList.remove('show');
    document.getElementById('emailStep').style.display = 'none';
    document.getElementById('loadingDiv').classList.add('show');
    document.getElementById('noPurchaseDiv').classList.remove('show');
    document.getElementById('planBadge').classList.remove('show');
    document.getElementById('signupForm').style.display = 'none';

    try {
      const response = await fetch('/api/payhip/verify-purchase', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ email })
      });

      const result = await response.json();
      document.getElementById('loadingDiv').classList.remove('show');

      if (result.reason === 'already_registered') {
        document.getElementById('subtitle').textContent = 'This email is already registered.';
        document.getElementById('noPurchaseDiv').innerHTML = `
          <h2 style="color:#f59e0b;">‚ö†Ô∏è Already Registered</h2>
          <p>This email already has an account.</p>
          <a href="/login" class="btn-outline">Login Instead</a>
        `;
        document.getElementById('noPurchaseDiv').classList.add('show');
        return;
      }

      if (!result.success || !result.canSignup) {
        document.getElementById('noPurchaseDiv').classList.add('show');
        return;
      }

      // ‚úÖ ÿ¥ÿ±ÿßÿ° ŸÖŸàÿ¨ŸàÿØ
      purchaseData = result.purchase;
      verifiedEmail = email;

      const planNames = {
        'basic_30': 'ü•ë Basic ‚Äî 30 Days ($29.99)',
        'pro_6':    '‚ö° Pro ‚Äî 6 Months ($99.99)',
        'elite_12': 'üëë Elite ‚Äî 12 Months ($199.99)'
      };

      document.getElementById('planName').textContent = planNames[purchaseData.tier] || purchaseData.tier;
      document.getElementById('planBadge').classList.add('show');
      document.getElementById('emailDisplay').value = email;
      document.getElementById('subtitle').textContent = 'Complete your account details below';
      document.getElementById('signupForm').style.display = 'block';

    } catch (err) {
      document.getElementById('loadingDiv').classList.remove('show');
      document.getElementById('noPurchaseDiv').classList.add('show');
    }
  }

  function resetForm() {
    document.getElementById('noPurchaseDiv').classList.remove('show');
    document.getElementById('emailStep').style.display = 'block';
    document.getElementById('emailInput').value = '';
  }

  async function handleSignup(e) {
    e.preventDefault();
    if (!purchaseData) return;

    // Clear errors
    document.querySelectorAll('.error-msg').forEach(el => el.classList.remove('show'));

    const fullName        = document.getElementById('fullName').value.trim();
    const password        = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirmPassword').value;

    let hasError = false;
    if (!fullName) { document.getElementById('nameError').classList.add('show'); hasError = true; }
    if (password.length < 6) { document.getElementById('passwordError').classList.add('show'); hasError = true; }
    if (password !== confirmPassword) { document.getElementById('confirmError').classList.add('show'); hasError = true; }
    if (hasError) return;

    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Creating account...';

    try {
      const response = await fetch('/api/auth/signup-payhip', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          email:     verifiedEmail,
          password,
          fullName,
          tier:      purchaseData.tier,
          startDate: purchaseData.start_date,
          endDate:   purchaseData.end_date,
          saleId:    purchaseData.sale_id
        })
      });

      const result = await response.json();

      if (!response.ok) throw new Error(result.error || 'Signup failed');

      document.getElementById('successDiv').classList.add('show');
      document.getElementById('signupForm').style.display = 'none';
      document.getElementById('planBadge').classList.remove('show');

      setTimeout(() => { window.location.href = '/dashboard'; }, 2000);

    } catch (err) {
      document.getElementById('formError').textContent = err.message;
      document.getElementById('formError').classList.add('show');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Create My Account üöÄ';
    }
  }
</script>
</body>
</html>