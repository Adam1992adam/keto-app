---
// signup.astro
const emailParam = Astro.url.searchParams.get('email');
const allowedEmail = emailParam ? emailParam.toLowerCase().trim() : '';
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Create Account ‚Äî Keto Journey</title>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,700;0,9..144,900;1,9..144,700&family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600;9..40,700;9..40,800&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --dark:#0a0f0a; --dark2:#0f1710; --card:#141f14;
      --border:rgba(16,185,129,.14); --border2:rgba(16,185,129,.3);
      --text:#e8f0e8; --soft:#6a8a6a; --muted:#3a4e3a;
      --green:#10b981; --green2:#34d399; --red:#ef4444;
      --gold:#f59e0b; --blue:#3b82f6; --indigo:#6366f1;
    }
    *,*::before,*::after { margin:0; padding:0; box-sizing:border-box; }
    html,body { height:100%; }
    body {
      font-family:'DM Sans',sans-serif;
      background:var(--dark); color:var(--text);
      display:grid; grid-template-columns:1fr 1fr;
      min-height:100vh;
    }

    /* ‚îÄ‚îÄ LEFT PANEL ‚îÄ‚îÄ */
    .panel-img { position:relative; overflow:hidden; }
    .panel-img-bg {
      position:absolute; inset:0;
      background:url('https://images.unsplash.com/photo-1490645935967-10de6ba17061?w=1000&q=85') center/cover no-repeat;
      transition:transform 8s ease;
    }
    .panel-img:hover .panel-img-bg { transform:scale(1.04); }
    .panel-img-overlay {
      position:absolute; inset:0;
      background:linear-gradient(160deg,rgba(10,15,10,.85) 0%,rgba(10,15,10,.35) 55%,rgba(16,185,129,.12) 100%);
    }
    .panel-content {
      position:relative; z-index:1; height:100%;
      display:flex; flex-direction:column; justify-content:space-between;
      padding:3rem;
    }
    .panel-logo {
      display:flex; align-items:center; gap:.6rem;
      font-family:'Fraunces',serif; font-weight:700; font-size:1.15rem;
      color:#fff; text-decoration:none;
    }
    .panel-logo span { color:var(--green); }
    .panel-middle {}
    .panel-eyebrow {
      display:inline-flex; align-items:center; gap:.4rem;
      background:rgba(16,185,129,.14); border:1px solid rgba(16,185,129,.3);
      border-radius:99px; padding:.3rem .85rem;
      font-size:.7rem; font-weight:800; color:var(--green);
      text-transform:uppercase; letter-spacing:.09em; margin-bottom:1rem;
    }
    .panel-title {
      font-family:'Fraunces',serif; font-size:2.8rem; font-weight:900;
      line-height:1.08; color:#fff; margin-bottom:1rem;
    }
    .panel-title em { font-style:italic; color:var(--green); }
    .panel-perks { display:flex; flex-direction:column; gap:.7rem; margin-top:1.5rem; }
    .perk {
      display:flex; align-items:center; gap:.875rem;
      background:rgba(255,255,255,.07); backdrop-filter:blur(12px);
      border:1px solid rgba(255,255,255,.1); border-radius:12px;
      padding:.875rem 1.1rem;
    }
    .perk-icon {
      width:36px; height:36px; border-radius:10px; flex-shrink:0;
      display:flex; align-items:center; justify-content:center; font-size:1rem;
    }
    .perk-text { font-size:.82rem; font-weight:600; color:rgba(255,255,255,.85); }
    .perk-sub { font-size:.7rem; color:rgba(255,255,255,.45); margin-top:.1rem; }
    .panel-bottom-img {
      border-radius:16px; overflow:hidden; height:140px; margin-top:1.5rem;
    }
    .panel-bottom-img img {
      width:100%; height:100%; object-fit:cover;
    }

    /* ‚îÄ‚îÄ RIGHT PANEL ‚îÄ‚îÄ */
    .panel-form {
      display:flex; flex-direction:column; justify-content:center;
      padding:3rem 4rem; background:var(--dark2); overflow-y:auto;
    }
    .form-top { margin-bottom:2rem; animation:fadeUp .5s ease both; }
    .form-back {
      display:inline-flex; align-items:center; gap:.4rem;
      font-size:.75rem; font-weight:700; color:var(--soft);
      text-decoration:none; margin-bottom:1.5rem;
      transition:color .2s;
    }
    .form-back:hover { color:var(--text); }
    .form-tag {
      display:inline-flex; align-items:center; gap:.4rem;
      background:rgba(16,185,129,.08); border:1px solid var(--border);
      border-radius:99px; padding:.28rem .8rem;
      font-size:.68rem; font-weight:800; color:var(--green);
      text-transform:uppercase; letter-spacing:.08em; margin-bottom:.875rem;
    }
    .form-title {
      font-family:'Fraunces',serif; font-size:2rem; font-weight:900;
      line-height:1.1; margin-bottom:.4rem;
    }
    .form-title em {
      font-style:italic;
      background:linear-gradient(135deg,var(--green),var(--green2));
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
    }
    .form-sub { font-size:.82rem; color:var(--soft); }

    /* ‚îÄ‚îÄ STEP INDICATOR ‚îÄ‚îÄ */
    .steps {
      display:flex; align-items:center; gap:.5rem; margin-bottom:2rem;
      animation:fadeUp .4s .05s ease both;
    }
    .step-dot {
      width:32px; height:32px; border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      font-size:.72rem; font-weight:800;
      border:2px solid var(--border); color:var(--muted);
      transition:all .3s;
    }
    .step-dot.active { background:var(--green); border-color:var(--green); color:#fff; }
    .step-dot.done { background:rgba(16,185,129,.15); border-color:var(--green); color:var(--green); }
    .step-line { flex:1; height:2px; background:var(--border); border-radius:2px; transition:all .3s; }
    .step-line.done { background:var(--green); }
    .step-label { font-size:.68rem; color:var(--soft); white-space:nowrap; }

    /* ‚îÄ‚îÄ STEP PANELS ‚îÄ‚îÄ */
    .step-panel { display:none; }
    .step-panel.active { display:block; animation:fadeUp .35s ease both; }

    /* ‚îÄ‚îÄ FIELDS ‚îÄ‚îÄ */
    .field { margin-bottom:1.1rem; }
    .field-label {
      display:block; font-size:.75rem; font-weight:800;
      color:var(--soft); text-transform:uppercase; letter-spacing:.07em;
      margin-bottom:.45rem;
    }
    .field-wrap { position:relative; }
    .field-icon {
      position:absolute; left:.95rem; top:50%; transform:translateY(-50%);
      font-size:.9rem; pointer-events:none;
    }
    .field-input {
      width:100%; padding:.825rem 1rem .825rem 2.6rem;
      background:var(--card); border:1.5px solid var(--border);
      border-radius:12px; color:var(--text);
      font-family:'DM Sans',sans-serif; font-size:.875rem; font-weight:500;
      transition:all .22s; outline:none;
    }
    .field-input::placeholder { color:var(--muted); }
    .field-input:focus {
      border-color:var(--green); background:rgba(16,185,129,.04);
      box-shadow:0 0 0 4px rgba(16,185,129,.1);
    }
    .field-input.error { border-color:var(--red); box-shadow:0 0 0 3px rgba(239,68,68,.1); }
    .field-input.success { border-color:var(--green); }
    .field-msg {
      font-size:.72rem; margin-top:.4rem;
      display:flex; align-items:center; gap:.35rem;
    }
    .field-msg.error { color:#fca5a5; }
    .field-msg.success { color:var(--green2); }
    .field-pw-toggle {
      position:absolute; right:.875rem; top:50%; transform:translateY(-50%);
      background:none; border:none; cursor:pointer;
      color:var(--soft); font-size:.95rem; transition:color .2s; padding:.25rem;
    }
    .field-pw-toggle:hover { color:var(--text); }

    /* ‚îÄ‚îÄ PASSWORD STRENGTH ‚îÄ‚îÄ */
    .pw-strength { margin-top:.6rem; }
    .pw-bars { display:flex; gap:.3rem; margin-bottom:.3rem; }
    .pw-bar {
      flex:1; height:4px; border-radius:2px;
      background:var(--muted); transition:background .3s;
    }
    .pw-bar.w { background:var(--red); }
    .pw-bar.m { background:var(--gold); }
    .pw-bar.s { background:var(--green); }
    .pw-label { font-size:.68rem; color:var(--soft); }

    /* ‚îÄ‚îÄ PLAN BADGE ‚îÄ‚îÄ */
    .plan-box {
      background:linear-gradient(135deg,rgba(16,185,129,.08),rgba(52,211,153,.04));
      border:1.5px solid var(--border2); border-radius:16px;
      padding:1.25rem 1.5rem; margin-bottom:1.5rem;
      display:flex; align-items:center; gap:1rem;
    }
    .pb-emoji { font-size:2.2rem; flex-shrink:0; }
    .pb-title { font-weight:800; font-size:.95rem; margin-bottom:.15rem; }
    .pb-meta { font-size:.73rem; color:var(--soft); }
    .pb-badge {
      margin-left:auto; padding:.25rem .75rem; border-radius:99px;
      background:rgba(16,185,129,.12); border:1px solid var(--border2);
      font-size:.68rem; font-weight:800; color:var(--green); flex-shrink:0;
    }

    /* ‚îÄ‚îÄ LOADING STATE ‚îÄ‚îÄ */
    .loading-state {
      text-align:center; padding:2.5rem 1rem;
    }
    .spinner-lg {
      width:52px; height:52px; border-radius:50%;
      border:3px solid var(--border); border-top-color:var(--green);
      animation:spin .8s linear infinite; margin:0 auto 1.25rem;
    }
    .loading-title { font-family:'Fraunces',serif; font-size:1.2rem; font-weight:700; margin-bottom:.4rem; }
    .loading-sub { font-size:.82rem; color:var(--soft); }
    @keyframes spin { to{transform:rotate(360deg);} }

    /* ‚îÄ‚îÄ NO PURCHASE STATE ‚îÄ‚îÄ */
    .empty-state {
      text-align:center; padding:2rem;
      background:rgba(239,68,68,.05); border:1px solid rgba(239,68,68,.15);
      border-radius:16px; margin-bottom:1.5rem;
    }
    .empty-icon { font-size:2.5rem; margin-bottom:.875rem; }
    .empty-title { font-family:'Fraunces',serif; font-size:1.2rem; font-weight:700; color:#fca5a5; margin-bottom:.5rem; }
    .empty-sub { font-size:.82rem; color:var(--soft); line-height:1.6; margin-bottom:1.25rem; }

    /* ‚îÄ‚îÄ SUCCESS STATE ‚îÄ‚îÄ */
    .success-state {
      text-align:center; padding:2rem;
    }
    .success-icon { font-size:4rem; margin-bottom:1rem; }
    .success-title { font-family:'Fraunces',serif; font-size:1.6rem; font-weight:900; color:var(--green); margin-bottom:.5rem; }
    .success-sub { font-size:.875rem; color:var(--soft); line-height:1.6; }
    .progress-bar {
      height:4px; background:var(--muted); border-radius:2px; margin-top:1.5rem; overflow:hidden;
    }
    .progress-fill {
      height:100%; background:linear-gradient(90deg,var(--green),var(--green2));
      border-radius:2px; animation:progressGrow 2s ease forwards;
    }
    @keyframes progressGrow { from{width:0%;}to{width:100%;} }

    /* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
    .btn-submit {
      width:100%; padding:.925rem;
      background:linear-gradient(135deg,var(--green),var(--green2));
      border:none; border-radius:12px; color:#fff;
      font-family:'DM Sans',sans-serif; font-weight:800; font-size:.9rem;
      cursor:pointer; transition:all .25s;
      display:flex; align-items:center; justify-content:center; gap:.5rem;
      position:relative; overflow:hidden;
    }
    .btn-submit::before {
      content:''; position:absolute; inset:0;
      background:linear-gradient(90deg,transparent,rgba(255,255,255,.1),transparent);
      transform:translateX(-100%); transition:transform .5s;
    }
    .btn-submit:hover::before { transform:translateX(100%); }
    .btn-submit:hover { transform:translateY(-2px); box-shadow:0 8px 24px rgba(16,185,129,.38); }
    .btn-submit:disabled { opacity:.5; cursor:not-allowed; transform:none; }
    .btn-outline {
      width:100%; padding:.875rem;
      background:transparent; border:1.5px solid var(--border);
      border-radius:12px; color:var(--soft);
      font-family:'DM Sans',sans-serif; font-weight:700; font-size:.875rem;
      cursor:pointer; transition:all .22s; margin-top:.75rem;
    }
    .btn-outline:hover { border-color:var(--green); color:var(--green); }
    .btn-purchase {
      display:block; padding:.875rem;
      background:linear-gradient(135deg,#6366f1,#8b5cf6);
      border-radius:12px; color:#fff; text-align:center;
      font-weight:800; font-size:.875rem; text-decoration:none;
      box-shadow:0 4px 16px rgba(99,102,241,.3); transition:all .22s;
    }
    .btn-purchase:hover { transform:translateY(-2px); box-shadow:0 8px 24px rgba(99,102,241,.4); }

    /* ‚îÄ‚îÄ INLINE SPINNER ‚îÄ‚îÄ */
    .btn-spin {
      display:none; width:16px; height:16px; border-radius:50%;
      border:2px solid rgba(255,255,255,.3); border-top-color:#fff;
      animation:spin .7s linear infinite;
    }

    /* ‚îÄ‚îÄ DIVIDER ‚îÄ‚îÄ */
    .divider { display:flex; align-items:center; gap:.875rem; margin:1.25rem 0 1rem; }
    .div-line { flex:1; height:1px; background:var(--border); }
    .div-text { font-size:.7rem; font-weight:700; color:var(--muted); white-space:nowrap; }

    /* ‚îÄ‚îÄ LOGIN LINK ‚îÄ‚îÄ */
    .login-prompt {
      text-align:center; font-size:.8rem; color:var(--soft);
    }
    .login-prompt a { color:var(--green); font-weight:800; text-decoration:none; }
    .login-prompt a:hover { text-decoration:underline; }

    @keyframes fadeUp { from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);} }

    @media(max-width:768px) {
      body { grid-template-columns:1fr; }
      .panel-img { display:none; }
      .panel-form { padding:2.5rem 1.75rem; }
    }
  </style>
</head>
<body>

<!-- LEFT PANEL -->
<div class="panel-img">
  <div class="panel-img-bg"></div>
  <div class="panel-img-overlay"></div>
  <div class="panel-content">
    <a href="/" class="panel-logo">ü•ë Keto<span>Journey</span></a>

    <div class="panel-middle">
      <div class="panel-eyebrow">üöÄ Start today</div>
      <h2 class="panel-title">Your body<br/>can do <em>more</em><br/>than you think</h2>
      <div class="panel-perks">
        {[
          { icon:'üìÖ', g:'linear-gradient(135deg,#10b981,#059669)', g2:'rgba(16,185,129,.2)', title:'30-day structured plan', sub:'Every meal planned for you' },
          { icon:'üçΩÔ∏è', g:'linear-gradient(135deg,#f59e0b,#d97706)', g2:'rgba(245,158,11,.2)', title:'87 delicious recipes', sub:'All under 20g net carbs' },
          { icon:'ü§ñ', g:'linear-gradient(135deg,#6366f1,#4f46e5)', g2:'rgba(99,102,241,.2)', title:'AI Keto Coach (Elite)', sub:'Personal nutrition guidance' },
          { icon:'üõ°Ô∏è', g:'linear-gradient(135deg,#3b82f6,#2563eb)', g2:'rgba(59,130,246,.2)', title:'30-day money-back guarantee', sub:'Zero risk, full results' },
        ].map(p => (
          <div class="perk">
            <div class="perk-icon" style={`background:${p.g};box-shadow:0 4px 10px ${p.g2};`}>{p.icon}</div>
            <div>
              <div class="perk-text">{p.title}</div>
              <div class="perk-sub">{p.sub}</div>
            </div>
          </div>
        ))}
      </div>
    </div>

    <div class="panel-bottom-img">
      <img src="https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=800&q=80" alt="Keto food"/>
    </div>
  </div>
</div>

<!-- RIGHT PANEL -->
<div class="panel-form">
  <div class="form-top">
    <a href="/login" class="form-back">‚Üê Back to login</a>
    <div class="form-tag">üéâ Create Account</div>
    <h1 class="form-title">Start your<br/><em>transformation</em></h1>
    <p class="form-sub">Verify your purchase, then set up your account</p>
  </div>

  <!-- STEP INDICATOR -->
  <div class="steps">
    <div class="step-dot active" id="stepDot1">1</div>
    <div class="step-line" id="stepLine1"></div>
    <div class="step-dot" id="stepDot2">2</div>
    <div class="step-line" id="stepLine2"></div>
    <div class="step-dot" id="stepDot3">3</div>
  </div>

  <!-- ‚îÄ‚îÄ STEP 1: VERIFY EMAIL ‚îÄ‚îÄ -->
  <div class="step-panel active" id="panel1">
    <div class="field">
      <label class="field-label">Purchase Email</label>
      <div class="field-wrap">
        <span class="field-icon">‚úâÔ∏è</span>
        <input type="email" id="emailInput" class="field-input"
          placeholder="Email you used when purchasing"/>
      </div>
      <div class="field-msg error" id="emailError" style="display:none;">
        ‚ö†Ô∏è Please enter a valid email address
      </div>
    </div>
    <button type="button" class="btn-submit" id="verifyBtn">
      <div class="btn-spin" id="verifySpin"></div>
      <span id="verifyTxt">Verify Purchase üîç</span>
    </button>
    <div class="divider">
      <div class="div-line"></div>
      <div class="div-text">Already have an account?</div>
      <div class="div-line"></div>
    </div>
    <div class="login-prompt">
      <a href="/login">Log in instead ‚Üí</a>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ -->
  <div class="step-panel" id="panelLoading">
    <div class="loading-state">
      <div class="spinner-lg"></div>
      <div class="loading-title">Verifying your purchase‚Ä¶</div>
      <div class="loading-sub">Checking your order ‚Äî this takes just a second</div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ NO PURCHASE ‚îÄ‚îÄ -->
  <div class="step-panel" id="panelNoPurchase">
    <div class="empty-state">
      <div class="empty-icon">üòï</div>
      <div class="empty-title">No purchase found</div>
      <div class="empty-sub">
        We couldn't find an order for this email.<br/>
        Make sure you used the same email when purchasing.
      </div>
      <a href="https://payhip.com/b/OEQk9" class="btn-purchase">Purchase Keto Journey ‚Üí</a>
    </div>
    <button type="button" class="btn-outline" onclick="resetToStep1()">
      ‚Üê Try a different email
    </button>
  </div>

  <!-- ‚îÄ‚îÄ ALREADY REGISTERED ‚îÄ‚îÄ -->
  <div class="step-panel" id="panelAlready">
    <div class="empty-state" style="background:rgba(245,158,11,.05);border-color:rgba(245,158,11,.2);">
      <div class="empty-icon">‚ö†Ô∏è</div>
      <div class="empty-title" style="color:#fde68a;">Already Registered</div>
      <div class="empty-sub">This email already has an account. Log in instead.</div>
      <a href="/login" class="btn-purchase" style="background:linear-gradient(135deg,#f59e0b,#d97706);box-shadow:0 4px 16px rgba(245,158,11,.3);">Log In ‚Üí</a>
    </div>
    <button type="button" class="btn-outline" onclick="resetToStep1()">‚Üê Try a different email</button>
  </div>

  <!-- ‚îÄ‚îÄ STEP 2: PLAN CONFIRMED ‚îÄ‚îÄ -->
  <div class="step-panel" id="panel2">
    <div class="plan-box" id="planBox">
      <div class="pb-emoji" id="planEmoji">ü•ë</div>
      <div>
        <div class="pb-title" id="planTitle">Loading plan‚Ä¶</div>
        <div class="pb-meta" id="planMeta">Verifying‚Ä¶</div>
      </div>
      <div class="pb-badge">‚úì Verified</div>
    </div>

    <div class="field">
      <label class="field-label">Full Name</label>
      <div class="field-wrap">
        <span class="field-icon">üë§</span>
        <input type="text" id="fullName" class="field-input" placeholder="Enter your full name"/>
      </div>
      <div class="field-msg error" id="nameError" style="display:none;">‚ö†Ô∏è Please enter your name</div>
    </div>

    <div class="field">
      <label class="field-label">Password</label>
      <div class="field-wrap">
        <span class="field-icon">üîí</span>
        <input type="password" id="password" class="field-input" placeholder="Choose a strong password"/>
        <button type="button" class="field-pw-toggle" id="pw1Toggle">üëÅÔ∏è</button>
      </div>
      <div class="pw-strength" id="pwStrength">
        <div class="pw-bars">
          <div class="pw-bar" id="bar1"></div>
          <div class="pw-bar" id="bar2"></div>
          <div class="pw-bar" id="bar3"></div>
          <div class="pw-bar" id="bar4"></div>
        </div>
        <div class="pw-label" id="pwLabel">Enter a password</div>
      </div>
      <div class="field-msg error" id="passwordError" style="display:none;">‚ö†Ô∏è Password must be at least 6 characters</div>
    </div>

    <div class="field" style="margin-bottom:1.5rem;">
      <label class="field-label">Confirm Password</label>
      <div class="field-wrap">
        <span class="field-icon">üîí</span>
        <input type="password" id="confirmPassword" class="field-input" placeholder="Confirm your password"/>
        <button type="button" class="field-pw-toggle" id="pw2Toggle">üëÅÔ∏è</button>
      </div>
      <div class="field-msg error" id="confirmError" style="display:none;">‚ö†Ô∏è Passwords don't match</div>
    </div>

    <button type="button" class="btn-submit" id="createBtn">
      <div class="btn-spin" id="createSpin"></div>
      <span id="createTxt">Create My Account üöÄ</span>
    </button>
    <div class="field-msg error" id="formError" style="display:none;margin-top:.75rem;justify-content:center;"></div>
  </div>

  <!-- ‚îÄ‚îÄ STEP 3: SUCCESS ‚îÄ‚îÄ -->
  <div class="step-panel" id="panel3">
    <div class="success-state">
      <div class="success-icon">üéâ</div>
      <div class="success-title">Welcome to Keto Journey!</div>
      <div class="success-sub">
        Your account is ready. Redirecting you to your personal dashboard‚Ä¶
      </div>
      <div class="progress-bar">
        <div class="progress-fill"></div>
      </div>
    </div>
  </div>

</div><!-- /panel-form -->

<script is:inline define:vars={{ allowedEmail }}>
  let purchaseData = null;
  let verifiedEmail = '';

  // Step management
  function goToPanel(id) {
    document.querySelectorAll('.step-panel').forEach(p => p.classList.remove('active'));
    document.getElementById(id)?.classList.add('active');
  }

  function updateStepUI(step) {
    for (let i = 1; i <= 3; i++) {
      const dot = document.getElementById(`stepDot${i}`);
      dot.classList.remove('active','done');
      if (i < step) dot.classList.add('done');
      else if (i === step) dot.classList.add('active');
    }
    for (let i = 1; i <= 2; i++) {
      const line = document.getElementById(`stepLine${i}`);
      if (i < step) line.classList.add('done');
      else line.classList.remove('done');
    }
  }

  function resetToStep1() {
    updateStepUI(1);
    goToPanel('panel1');
    document.getElementById('emailInput').value = '';
    purchaseData = null;
    verifiedEmail = '';
  }

  // Password strength
  const pwField = document.getElementById('password');
  pwField?.addEventListener('input', () => {
    const val = pwField.value;
    const strength = getStrength(val);
    const bars = [document.getElementById('bar1'), document.getElementById('bar2'), document.getElementById('bar3'), document.getElementById('bar4')];
    const label = document.getElementById('pwLabel');
    const cls = strength <= 1 ? 'w' : strength <= 2 ? 'm' : 's';
    bars.forEach((b, i) => { b.className = 'pw-bar'; if (i < strength) b.classList.add(cls); });
    const labels = ['','Too weak','Fair','Good','Strong üí™'];
    if (label) label.textContent = val ? (labels[strength] || 'Strong üí™') : 'Enter a password';
  });
  function getStrength(pw) {
    let s = 0;
    if (pw.length >= 6) s++;
    if (pw.length >= 10) s++;
    if (/[A-Z]/.test(pw) || /[0-9]/.test(pw)) s++;
    if (/[!@#$%^&*]/.test(pw)) s++;
    return Math.min(s, 4);
  }

  // Password toggles
  [['password','pw1Toggle'],['confirmPassword','pw2Toggle']].forEach(([fid, bid]) => {
    const f = document.getElementById(fid);
    const b = document.getElementById(bid);
    if (f && b) {
      b.addEventListener('click', () => {
        const isText = f.type === 'text';
        f.type = isText ? 'password' : 'text';
        b.textContent = isText ? 'üëÅÔ∏è' : 'üôà';
      });
    }
  });

  // VERIFY
  async function startVerification() {
    const email = document.getElementById('emailInput').value.trim().toLowerCase();
    const emailErr = document.getElementById('emailError');

    if (!email || !email.includes('@')) {
      emailErr.style.display = 'flex'; return;
    }
    emailErr.style.display = 'none';

    const btn = document.getElementById('verifyBtn');
    const spin = document.getElementById('verifySpin');
    const txt = document.getElementById('verifyTxt');
    btn.disabled = true;
    spin.style.display = 'block';
    txt.textContent = 'Verifying‚Ä¶';

    goToPanel('panelLoading');

    try {
      const res = await fetch('/api/payhip/verify-purchase', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ email })
      });
      const result = await res.json();

      if (result.reason === 'already_registered') {
        goToPanel('panelAlready'); return;
      }

      if (!result.success || !result.canSignup) {
        goToPanel('panelNoPurchase'); return;
      }

      // Success ‚Äî fill plan details
      purchaseData  = result.purchase;
      verifiedEmail = email;

      const plans = {
        'basic_30':  { emoji:'ü•ë', name:'Basic Plan', meta:'30-day access ‚Äî $29.99' },
        'pro_6':     { emoji:'‚ö°', name:'Pro Plan',   meta:'6-month access ‚Äî $99.99' },
        'elite_12':  { emoji:'üëë', name:'Elite Plan', meta:'12-month access ‚Äî $199.99' },
      };
      const plan = plans[purchaseData.tier] || { emoji:'ü•ë', name:purchaseData.tier, meta:'' };
      document.getElementById('planEmoji').textContent = plan.emoji;
      document.getElementById('planTitle').textContent = plan.name;
      document.getElementById('planMeta').textContent  = plan.meta;

      updateStepUI(2);
      goToPanel('panel2');

    } catch {
      goToPanel('panelNoPurchase');
    } finally {
      btn.disabled = false; spin.style.display = 'none'; txt.textContent = 'Verify Purchase üîç';
    }
  }

  // CREATE ACCOUNT
  async function handleCreate() {
    if (!purchaseData) return;

    // Clear errors
    ['nameError','passwordError','confirmError','formError'].forEach(id => {
      document.getElementById(id).style.display = 'none';
    });

    const fullName  = document.getElementById('fullName').value.trim();
    const password  = document.getElementById('password').value;
    const confirm   = document.getElementById('confirmPassword').value;
    let err = false;

    if (!fullName) { document.getElementById('nameError').style.display = 'flex'; err = true; }
    if (password.length < 6) { document.getElementById('passwordError').style.display = 'flex'; err = true; }
    if (password !== confirm) { document.getElementById('confirmError').style.display = 'flex'; err = true; }
    if (err) return;

    const btn = document.getElementById('createBtn');
    const spin = document.getElementById('createSpin');
    const txt = document.getElementById('createTxt');
    btn.disabled = true;
    spin.style.display = 'block';
    txt.textContent = 'Creating account‚Ä¶';

    try {
      const res = await fetch('/api/auth/signup-payhip', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          email:     verifiedEmail,
          password,  fullName,
          tier:      purchaseData.tier,
          startDate: purchaseData.start_date,
          endDate:   purchaseData.end_date,
          saleId:    purchaseData.sale_id,
        })
      });
      const result = await res.json();
      if (!res.ok) throw new Error(result.error || 'Signup failed');

      updateStepUI(3);
      goToPanel('panel3');
      setTimeout(() => { window.location.href = '/dashboard'; }, 2200);

    } catch (e) {
      const errEl = document.getElementById('formError');
      errEl.textContent = '‚ö†Ô∏è ' + e.message;
      errEl.style.display = 'flex';
      btn.disabled = false; spin.style.display = 'none'; txt.textContent = 'Create My Account üöÄ';
    }
  }

  // Wire events
  window.addEventListener('DOMContentLoaded', () => {
    document.getElementById('verifyBtn').addEventListener('click', startVerification);
    document.getElementById('emailInput').addEventListener('keydown', e => { if (e.key === 'Enter') startVerification(); });
    document.getElementById('createBtn').addEventListener('click', handleCreate);

    // Auto-fill from URL
    if (allowedEmail) {
      document.getElementById('emailInput').value = allowedEmail;
      startVerification();
    }
  });

  window.resetToStep1 = resetToStep1;
</script>
</body>
</html>