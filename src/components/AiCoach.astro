---
// src/components/AiCoach.astro
// ÙŠÙØ¶Ø§Ù ÙÙŠ Ù†Ù‡Ø§ÙŠØ© dashboard/index.astro Ù„Ø£ØµØ­Ø§Ø¨ Elite ÙÙ‚Ø·

const { userName, currentDay, streak, totalXp, level } = Astro.props;
---

<!-- â”€â”€ AI FAB â”€â”€ -->
<button class="ai-fab" id="aiFab" title="Keto AI Coach">
  <span class="ai-fab-icon">ğŸ¤–</span>
  <span class="ai-fab-pulse"></span>
</button>

<!-- â”€â”€ AI PANEL â”€â”€ -->
<div class="ai-panel" id="aiPanel">

  <!-- Header -->
  <div class="ai-header">
    <div class="ai-header-left">
      <div class="ai-avatar-wrap">
        <div class="ai-avatar">ğŸ¤–</div>
        <div class="ai-online-dot"></div>
      </div>
      <div>
        <div class="ai-name">Keto AI Coach</div>
        <div class="ai-status">â— Online â€¢ Elite exclusive</div>
      </div>
    </div>
    <div class="ai-header-right">
      <button class="ai-history-btn" id="aiHistoryBtn" title="Chat history">ğŸ•</button>
      <button class="ai-close-btn" id="aiClose">Ã—</button>
    </div>
  </div>

  <!-- Suggestions (shown when empty) -->
  <div class="ai-suggestions" id="aiSuggestions">
    <div class="ai-sug-title">Quick questions</div>
    <div class="ai-sug-grid">
      <button class="ai-sug" data-msg="What's a quick keto recipe for today?">ğŸ³ Quick recipe</button>
      <button class="ai-sug" data-msg="How is my keto journey going?">ğŸ“Š My progress</button>
      <button class="ai-sug" data-msg="I have a keto headache, what should I do?">ğŸ’Š Keto headache</button>
      <button class="ai-sug" data-msg="What should I eat to hit my protein goal?">ğŸ’ª Protein goal</button>
      <button class="ai-sug" data-msg="Give me a tip for today">âœ¨ Today's tip</button>
      <button class="ai-sug" data-msg="What keto snacks can I have?">ğŸ¥œ Keto snacks</button>
    </div>
  </div>

  <!-- Messages -->
  <div class="ai-messages" id="aiMessages">
    <div class="ai-msg bot ai-welcome">
      <div class="ai-msg-avatar">ğŸ¤–</div>
      <div class="ai-msg-bubble">
        ğŸ‘‹ Hey <strong>{userName}</strong>! I'm your personal Keto Coach.<br/>
        You're on Day <strong>{currentDay}</strong> with a <strong>{streak}</strong>-day streak and <strong>{totalXp}</strong> XP ğŸ”¥<br/>
        <span style="font-size:.75rem;opacity:.7;margin-top:.3rem;display:block;">You can send a food photo or fridge ingredients for instant analysis!</span>
      </div>
    </div>
  </div>

  <!-- Image Preview -->
  <div class="ai-img-preview" id="aiImgPreview" style="display:none;">
    <img id="aiImgThumb" src="" alt=""/>
    <button class="ai-img-remove" id="aiImgRemove">Ã—</button>
  </div>

  <!-- Input -->
  <div class="ai-input-wrap">
    <label class="ai-img-btn" for="aiImgInput" title="Send image">
      ğŸ“¸
      <input type="file" id="aiImgInput" accept="image/*" style="display:none;"/>
    </label>
    <input
      class="ai-input"
      id="aiInput"
      placeholder="Ask me anything about keto, or send a photo..."
      autocomplete="off"
    />
    <button class="ai-send-btn" id="aiSend">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
        <line x1="22" y1="2" x2="11" y2="13"></line>
        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
      </svg>
    </button>
  </div>

</div>

<style>
  /* â”€â”€ FAB â”€â”€ */
  .ai-fab {
    position: fixed; bottom: 2rem; right: 2rem; z-index: 500;
    width: 58px; height: 58px; border-radius: 50%;
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    border: none; cursor: pointer;
    box-shadow: 0 8px 28px rgba(99,102,241,.5);
    display: flex; align-items: center; justify-content: center;
    transition: all .3s; animation: fabIn .5s 1s ease both;
    overflow: visible;
  }
  .ai-fab:hover { transform: scale(1.1) translateY(-3px); box-shadow: 0 14px 36px rgba(99,102,241,.65); }
  .ai-fab-icon { font-size: 1.5rem; position: relative; z-index: 1; }
  .ai-fab-pulse {
    position: absolute; inset: -4px; border-radius: 50%;
    border: 2px solid rgba(99,102,241,.4);
    animation: fabPulse 2s ease infinite;
  }
  @keyframes fabIn  { from{opacity:0;transform:scale(0) rotate(-180deg);} to{opacity:1;transform:scale(1) rotate(0);} }
  @keyframes fabPulse { 0%,100%{transform:scale(1);opacity:.6;} 50%{transform:scale(1.3);opacity:0;} }

  /* â”€â”€ PANEL â”€â”€ */
  .ai-panel {
    position: fixed; bottom: 6.5rem; right: 2rem; z-index: 499;
    width: 380px; max-height: 560px;
    background: var(--card, #1a2535);
    border: 1px solid rgba(255,255,255,.08);
    border-radius: 24px;
    box-shadow: 0 24px 64px rgba(0,0,0,.5);
    display: none; flex-direction: column; overflow: hidden;
  }
  .ai-panel.open { display: flex; animation: panelUp .3s cubic-bezier(.4,0,.2,1); }
  @keyframes panelUp { from{opacity:0;transform:translateY(16px) scale(.97);} to{opacity:1;transform:translateY(0) scale(1);} }

  /* Header */
  .ai-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: .875rem 1rem; flex-shrink: 0;
    background: linear-gradient(135deg, rgba(99,102,241,.12), rgba(139,92,246,.06));
    border-bottom: 1px solid rgba(255,255,255,.06);
  }
  .ai-header-left { display: flex; align-items: center; gap: .75rem; }
  .ai-avatar-wrap { position: relative; }
  .ai-avatar {
    width: 38px; height: 38px; border-radius: 11px;
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    display: flex; align-items: center; justify-content: center; font-size: 1.1rem;
  }
  .ai-online-dot {
    position: absolute; bottom: -2px; right: -2px;
    width: 10px; height: 10px; border-radius: 50%;
    background: #10b981; border: 2px solid var(--card, #1a2535);
  }
  .ai-name { font-weight: 800; font-size: .875rem; color: var(--text, #e8edf5); }
  .ai-status { font-size: .68rem; color: #10b981; font-weight: 600; }
  .ai-header-right { display: flex; align-items: center; gap: .35rem; }
  .ai-history-btn, .ai-close-btn {
    width: 30px; height: 30px; border-radius: 8px;
    background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.08);
    color: var(--soft, #8a9ab0); font-size: .9rem; cursor: pointer; transition: all .2s;
    display: flex; align-items: center; justify-content: center;
  }
  .ai-history-btn:hover { border-color: #6366f1; color: #818cf8; }
  .ai-close-btn:hover { border-color: #ef4444; color: #f87171; }

  /* Suggestions */
  .ai-suggestions {
    padding: .75rem 1rem; border-bottom: 1px solid rgba(255,255,255,.05); flex-shrink: 0;
  }
  .ai-sug-title { font-size: .65rem; font-weight: 700; text-transform: uppercase; letter-spacing: .08em; color: var(--muted, #4a5a6e); margin-bottom: .5rem; }
  .ai-sug-grid { display: flex; flex-wrap: wrap; gap: .35rem; }
  .ai-sug {
    font-size: .72rem; font-weight: 600;
    color: #818cf8; background: rgba(99,102,241,.1);
    border: 1px solid rgba(99,102,241,.2); border-radius: 99px;
    padding: .25rem .65rem; cursor: pointer; transition: all .2s;
  }
  .ai-sug:hover { background: rgba(99,102,241,.22); border-color: rgba(99,102,241,.45); }

  /* Messages */
  .ai-messages {
    flex: 1; overflow-y: auto; padding: .875rem 1rem;
    display: flex; flex-direction: column; gap: .75rem;
    scroll-behavior: smooth;
  }
  .ai-messages::-webkit-scrollbar { width: 4px; }
  .ai-messages::-webkit-scrollbar-track { background: transparent; }
  .ai-messages::-webkit-scrollbar-thumb { background: rgba(255,255,255,.1); border-radius: 99px; }

  .ai-msg { display: flex; gap: .5rem; align-items: flex-end; }
  .ai-msg.user { flex-direction: row-reverse; }
  .ai-msg-avatar {
    width: 28px; height: 28px; border-radius: 8px; flex-shrink: 0;
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    display: flex; align-items: center; justify-content: center; font-size: .85rem;
  }
  .ai-msg.user .ai-msg-avatar {
    background: linear-gradient(135deg, #10b981, #34d399);
  }
  .ai-msg-bubble {
    max-width: 82%; padding: .65rem .875rem;
    border-radius: 16px; font-size: .82rem; line-height: 1.6; font-weight: 500;
    word-break: break-word;
  }
  .ai-msg.bot  .ai-msg-bubble { background: rgba(255,255,255,.07); color: var(--text, #e8edf5); border-radius: 4px 16px 16px 16px; }
  .ai-msg.user .ai-msg-bubble { background: linear-gradient(135deg, #6366f1, #8b5cf6); color: #fff; border-radius: 16px 4px 16px 16px; }
  .ai-msg-bubble img { max-width: 100%; border-radius: 10px; margin-top: .4rem; display: block; }

  /* Welcome */
  .ai-welcome .ai-msg-bubble { background: rgba(99,102,241,.1); border: 1px solid rgba(99,102,241,.2); }

  /* Typing */
  .ai-typing-dots { display: flex; gap: 4px; align-items: center; padding: .2rem 0; }
  .ai-typing-dots span {
    width: 6px; height: 6px; border-radius: 50%;
    background: var(--soft, #8a9ab0); animation: dot 1s infinite;
  }
  .ai-typing-dots span:nth-child(2) { animation-delay: .15s; }
  .ai-typing-dots span:nth-child(3) { animation-delay: .3s; }
  @keyframes dot { 0%,60%,100%{transform:translateY(0);opacity:.5;} 30%{transform:translateY(-6px);opacity:1;} }

  /* Image preview */
  .ai-img-preview {
    margin: 0 1rem .5rem; position: relative; display: inline-block;
  }
  .ai-img-preview img { width: 72px; height: 72px; object-fit: cover; border-radius: 10px; border: 2px solid rgba(99,102,241,.4); display: block; }
  .ai-img-remove {
    position: absolute; top: -6px; right: -6px;
    width: 20px; height: 20px; border-radius: 50%;
    background: #ef4444; border: none; color: #fff;
    font-size: .8rem; cursor: pointer; display: flex; align-items: center; justify-content: center;
  }

  /* Input */
  .ai-input-wrap {
    padding: .75rem 1rem; border-top: 1px solid rgba(255,255,255,.06);
    display: flex; align-items: center; gap: .5rem; flex-shrink: 0;
  }
  .ai-img-btn {
    width: 34px; height: 34px; border-radius: 9px; flex-shrink: 0;
    background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.08);
    display: flex; align-items: center; justify-content: center;
    font-size: 1rem; cursor: pointer; transition: all .2s;
  }
  .ai-img-btn:hover { border-color: #6366f1; background: rgba(99,102,241,.1); }
  .ai-input {
    flex: 1; padding: .6rem .875rem; border-radius: 12px;
    background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.08);
    color: var(--text, #e8edf5); font-size: .82rem; font-family: inherit;
    outline: none; transition: border-color .2s;
  }
  .ai-input:focus { border-color: rgba(99,102,241,.5); }
  .ai-input::placeholder { color: var(--muted, #4a5a6e); }
  .ai-send-btn {
    width: 34px; height: 34px; border-radius: 9px; flex-shrink: 0;
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    border: none; color: #fff; cursor: pointer; transition: all .2s;
    display: flex; align-items: center; justify-content: center;
  }
  .ai-send-btn:hover { transform: scale(1.08); }
  .ai-send-btn:disabled { opacity: .5; cursor: not-allowed; transform: none; }

  @media(max-width: 480px) {
    .ai-panel { width: calc(100vw - 2rem); right: 1rem; bottom: 5.5rem; }
    .ai-fab   { bottom: 1.5rem; right: 1.5rem; }
  }
</style>

<script is:inline define:vars={{ userName }}>

const fab     = document.getElementById('aiFab');
const panel   = document.getElementById('aiPanel');
const closeBtn= document.getElementById('aiClose');
const input   = document.getElementById('aiInput');
const sendBtn = document.getElementById('aiSend');
const msgs    = document.getElementById('aiMessages');
const imgInput= document.getElementById('aiImgInput');
const imgPrev = document.getElementById('aiImgPreview');
const imgThumb= document.getElementById('aiImgThumb');
const imgRem  = document.getElementById('aiImgRemove');
const sugsEl  = document.getElementById('aiSuggestions');
const histBtn = document.getElementById('aiHistoryBtn');

let pendingImg     = null; // { base64, type }
let isLoading      = false;
let historyLoaded  = false;

// â”€â”€ Open / Close â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
fab?.addEventListener('click', () => {
  panel?.classList.toggle('open');
  if (panel?.classList.contains('open') && !historyLoaded) loadHistory();
});
closeBtn?.addEventListener('click', () => panel?.classList.remove('open'));

// â”€â”€ Load history from server â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadHistory() {
  historyLoaded = true;
  try {
    const res  = await fetch('/api/chat/history');
    if (!res.ok) return;
    const data = await res.json();
    if (!data.messages?.length) return;

    // Clear welcome & show history
    if (msgs) msgs.innerHTML = '';
    data.messages.forEach(m => addBubble(m.content, m.role === 'user' ? 'user' : 'bot', false));
    scrollBottom();
    if (sugsEl) sugsEl.style.display = 'none';
  } catch {}
}

// â”€â”€ History button: toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
histBtn?.addEventListener('click', async () => {
  if (!historyLoaded) {
    await loadHistory();
  } else {
    // Clear and reload
    if (msgs) msgs.innerHTML = '';
    historyLoaded = false;
    await loadHistory();
  }
});

// â”€â”€ Image handling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
imgInput?.addEventListener('change', function () {
  const file = this.files?.[0];
  if (!file) return;
  if (file.size > 4 * 1024 * 1024) { alert('âŒ Max image size: 4MB'); return; }

  const reader = new FileReader();
  reader.onload = ev => {
    const result = ev.target?.result;
    if (typeof result !== 'string') return;

    // strip "data:image/xxx;base64,"
    const base64 = result.split(',')[1];
    pendingImg = { base64, type: file.type };

    if (imgThumb)  imgThumb.src  = result;
    if (imgPrev)   imgPrev.style.display = 'block';
  };
  reader.readAsDataURL(file);
});

imgRem?.addEventListener('click', () => {
  pendingImg = null;
  if (imgInput)  imgInput.value = '';
  if (imgPrev)   imgPrev.style.display = 'none';
  if (imgThumb)  imgThumb.src = '';
});

// â”€â”€ Suggestions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.ai-sug').forEach(btn => {
  btn.addEventListener('click', () => {
    const msg = btn.getAttribute('data-msg');
    if (msg && input) { input.value = msg; sendMsg(); }
  });
});

// â”€â”€ Send â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
sendBtn?.addEventListener('click', sendMsg);
input?.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMsg(); }
});

async function sendMsg() {
  const text = input?.value?.trim();
  if ((!text && !pendingImg) || isLoading) return;

  isLoading = true;
  if (sendBtn) sendBtn.disabled = true;
  if (sugsEl)  sugsEl.style.display = 'none';

  // Show user message
  const userContent = text || 'ğŸ“¸ Sent an image';
  if (pendingImg) {
    addBubble(`${text ? text + '<br/>' : ''}<img src="data:${pendingImg.type};base64,${pendingImg.base64}" style="max-width:200px;border-radius:10px;margin-top:.4rem;"/>`, 'user');
  } else {
    addBubble(userContent, 'user');
  }

  if (input) input.value = '';

  // Typing indicator
  const typingEl = addTyping();

  try {
    const res = await fetch('/api/chat/gemini', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        message:     text || '',
        imageBase64: pendingImg?.base64 || null,
        imageType:   pendingImg?.type   || null,
      }),
    });

    typingEl?.remove();

    if (!res.ok) {
      const err = await res.json();
      addBubble(`âŒ ${err.error || 'Something went wrong. Please try again.'}`, 'bot');
    } else {
      const data = await res.json();
      addBubble(data.reply, 'bot');
    }
  } catch {
    typingEl?.remove();
    addBubble('âŒ Connection error. Please try again.', 'bot');
  }

  // Clear image
  pendingImg = null;
  if (imgInput)  imgInput.value = '';
  if (imgPrev)   imgPrev.style.display = 'none';
  if (imgThumb)  imgThumb.src = '';

  isLoading = false;
  if (sendBtn) sendBtn.disabled = false;
  input?.focus();
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addBubble(content, role, scroll = true) {
  if (!msgs) return;
  const wrap = document.createElement('div');
  wrap.className = `ai-msg ${role}`;

  const avatar = document.createElement('div');
  avatar.className = 'ai-msg-avatar';
  avatar.textContent = role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';

  const bubble = document.createElement('div');
  bubble.className = 'ai-msg-bubble';
  bubble.innerHTML = content.replace(/\n/g, '<br/>');

  wrap.appendChild(avatar);
  wrap.appendChild(bubble);
  msgs.appendChild(wrap);
  if (scroll) scrollBottom();
  return wrap;
}

function addTyping() {
  if (!msgs) return null;
  const wrap = document.createElement('div');
  wrap.className = 'ai-msg bot';
  wrap.innerHTML = `
    <div class="ai-msg-avatar">ğŸ¤–</div>
    <div class="ai-msg-bubble">
      <div class="ai-typing-dots"><span></span><span></span><span></span></div>
    </div>`;
  msgs.appendChild(wrap);
  scrollBottom();
  return wrap;
}

function scrollBottom() {
  if (msgs) msgs.scrollTop = msgs.scrollHeight;
}

</script>