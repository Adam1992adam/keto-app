---
import { supabase } from '../lib/supabase';

interface Props {
  userId: string;
  currentDay: number;
  viewDay: number;
  profile: any;
}

const { userId, currentDay, viewDay, profile } = Astro.props;

// ÿ¨ŸÑÿ® ÿßŸÑŸàÿ¨ÿ®ÿßÿ™ ÿßŸÑŸÖŸÉÿ™ŸÖŸÑÿ© ŸÑŸÑŸäŸàŸÖ ŸÖÿπ ÿßŸÑŸÄ recipes
const { data: completedTasks } = await supabase
  .from('daily_tasks')
  .select('*')
  .eq('user_id', userId)
  .eq('day_number', viewDay)
  .eq('completed', true)
  .in('task_type', ['breakfast', 'lunch', 'dinner', 'snack']);

// ÿ¨ŸÑÿ® meal plans ŸÑŸÑŸàÿ¨ÿ®ÿßÿ™ ÿßŸÑŸÖŸÉÿ™ŸÖŸÑÿ©
const { data: mealPlans } = await supabase
  .from('meal_plans')
  .select('*, recipe:recipes(*)')
  .eq('plan_type', 'basic_30')
  .eq('day_number', viewDay);

// ÿ≠ÿ≥ÿßÿ® Macros ÿßŸÑŸÅÿπŸÑŸäÿ©
let actualCalories = 0;
let actualProtein = 0;
let actualFat = 0;
let actualCarbs = 0;

if (completedTasks && mealPlans) {
  completedTasks.forEach(task => {
    const mealPlan = mealPlans.find(mp => mp.meal_type === task.task_type);
    if (mealPlan?.recipe) {
      const recipe = mealPlan.recipe;
      actualCalories += recipe.calories || 0;
      actualProtein += recipe.protein || 0;
      actualFat += recipe.fat || 0;
      actualCarbs += recipe.net_carbs || 0;
    }
  });
}

// ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ£ŸáÿØÿßŸÅ (Keto Calculator)
const age = profile.age || 30;
const weight = profile.weight_kg || 70;
const height = profile.height_cm || 170;
const gender = profile.gender || 'male';
const activityLevel = profile.activity_level || 'moderate';

// BMR Calculation
let bmr = 0;
if (gender === 'male') {
  bmr = 10 * weight + 6.25 * height - 5 * age + 5;
} else {
  bmr = 10 * weight + 6.25 * height - 5 * age - 161;
}

// Activity multiplier
const activityMultipliers = {
  sedentary: 1.2,
  light: 1.375,
  moderate: 1.55,
  active: 1.725,
  very_active: 1.9
};

const tdee = Math.round(bmr * (activityMultipliers[activityLevel] || 1.55));

// Keto deficit (lose weight)
const targetCalories = profile.goal === 'lose_weight' ? tdee - 500 : tdee;

// Keto Ratios: 70% Fat, 25% Protein, 5% Carbs
const targetFat = Math.round((targetCalories * 0.70) / 9);
const targetProtein = Math.round((targetCalories * 0.25) / 4);
const targetCarbs = Math.round((targetCalories * 0.05) / 4);

// ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÜÿ≥ÿ® ÿßŸÑŸÖÿ¶ŸàŸäÿ©
const caloriesPercent = targetCalories > 0 ? Math.round((actualCalories / targetCalories) * 100) : 0;
const proteinPercent = targetProtein > 0 ? Math.round((actualProtein / targetProtein) * 100) : 0;
const fatPercent = targetFat > 0 ? Math.round((actualFat / targetFat) * 100) : 0;
const carbsPercent = targetCarbs > 0 ? Math.round((actualCarbs / targetCarbs) * 100) : 0;

// AI Insights
const insights = [];

if (actualCalories === 0) {
  insights.push({
    type: 'info',
    icon: '‚ÑπÔ∏è',
    message: 'No meals completed yet today.',
    suggestion: 'Complete your meals to see macro tracking!'
  });
} else {
  if (proteinPercent < 70) {
    insights.push({
      type: 'warning',
      icon: '‚ö†Ô∏è',
      message: `Low protein! You need ${Math.round(targetProtein - actualProtein)}g more.`,
      suggestion: 'Try adding eggs, chicken, or protein shake.'
    });
  } else if (proteinPercent >= 90 && proteinPercent <= 110) {
    insights.push({
      type: 'success',
      icon: '‚úÖ',
      message: 'Perfect protein intake!',
      suggestion: 'Keep up the great work!'
    });
  }

  if (carbsPercent > 120) {
    insights.push({
      type: 'danger',
      icon: 'üö®',
      message: 'Carbs too high for keto!',
      suggestion: 'Watch your net carbs to stay in ketosis.'
    });
  } else if (carbsPercent <= 100) {
    insights.push({
      type: 'success',
      icon: 'üéØ',
      message: 'Carbs on track!',
      suggestion: 'Great job staying keto!'
    });
  }

  if (fatPercent < 70) {
    insights.push({
      type: 'info',
      icon: 'üí°',
      message: 'Need more healthy fats.',
      suggestion: 'Add avocado, olive oil, or nuts.'
    });
  } else if (fatPercent >= 90 && fatPercent <= 110) {
    insights.push({
      type: 'success',
      icon: 'üî•',
      message: 'Fat intake is optimal!',
      suggestion: 'Perfect for ketosis!'
    });
  }
}

if (insights.length === 0 && actualCalories > 0) {
  insights.push({
    type: 'success',
    icon: 'üåü',
    message: 'All macros looking good!',
    suggestion: 'Keep following your plan!'
  });
}
---

<!-- Macros Tracker Card -->
<div class="card-premium p-8 animate-slide-up-fade">
  <div class="flex items-center justify-between mb-6">
    <div>
      <h2 class="text-3xl font-bold text-gray-900 flex items-center gap-3">
        <span class="text-4xl">üìä</span>
        <span>Smart Macros Tracker</span>
      </h2>
      <p class="text-gray-600 mt-1">Your nutrition breakdown for Day {viewDay}</p>
    </div>
    {actualCalories === 0 && (
      <span class="badge-orange">No meals completed yet</span>
    )}
  </div>

  <!-- Main Macros Grid -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
    <!-- Calories -->
    <div class="relative overflow-hidden bg-gradient-to-br from-orange-50 to-red-50 rounded-2xl p-6 border-2 border-orange-200">
      <div class="absolute top-0 right-0 w-20 h-20 bg-orange-200/30 rounded-full -mr-10 -mt-10"></div>
      <div class="relative">
        <div class="flex items-center justify-between mb-4">
          <span class="text-3xl">üî•</span>
          <span class={`badge ${caloriesPercent >= 90 && caloriesPercent <= 110 ? 'badge-emerald' : caloriesPercent < 90 ? 'badge-blue' : 'badge-orange'}`}>
            {caloriesPercent}%
          </span>
        </div>
        <p class="text-xs font-bold text-gray-500 uppercase mb-2">Calories</p>
        <p class="text-4xl font-bold text-orange-600 mb-1">{actualCalories}</p>
        <p class="text-sm text-gray-600">of {targetCalories} kcal</p>
        <div class="mt-4 progress-container h-2">
          <div class="h-full bg-gradient-to-r from-orange-500 to-red-500 rounded-full transition-all" style={`width: ${Math.min(caloriesPercent, 100)}%`}></div>
        </div>
      </div>
    </div>

    <!-- Protein -->
    <div class="relative overflow-hidden bg-gradient-to-br from-blue-50 to-cyan-50 rounded-2xl p-6 border-2 border-blue-200">
      <div class="absolute top-0 right-0 w-20 h-20 bg-blue-200/30 rounded-full -mr-10 -mt-10"></div>
      <div class="relative">
        <div class="flex items-center justify-between mb-4">
          <span class="text-3xl">ü•©</span>
          <span class={`badge ${proteinPercent >= 90 && proteinPercent <= 110 ? 'badge-emerald' : 'badge-blue'}`}>
            {proteinPercent}%
          </span>
        </div>
        <p class="text-xs font-bold text-gray-500 uppercase mb-2">Protein</p>
        <p class="text-4xl font-bold text-blue-600 mb-1">{actualProtein}g</p>
        <p class="text-sm text-gray-600">of {targetProtein}g</p>
        <div class="mt-4 progress-container h-2">
          <div class="h-full bg-gradient-to-r from-blue-500 to-cyan-500 rounded-full transition-all" style={`width: ${Math.min(proteinPercent, 100)}%`}></div>
        </div>
      </div>
    </div>

    <!-- Fat -->
    <div class="relative overflow-hidden bg-gradient-to-br from-yellow-50 to-amber-50 rounded-2xl p-6 border-2 border-yellow-200">
      <div class="absolute top-0 right-0 w-20 h-20 bg-yellow-200/30 rounded-full -mr-10 -mt-10"></div>
      <div class="relative">
        <div class="flex items-center justify-between mb-4">
          <span class="text-3xl">ü•ì</span>
          <span class={`badge ${fatPercent >= 90 && fatPercent <= 110 ? 'badge-emerald' : 'badge-orange'}`}>
            {fatPercent}%
          </span>
        </div>
        <p class="text-xs font-bold text-gray-500 uppercase mb-2">Fat</p>
        <p class="text-4xl font-bold text-yellow-600 mb-1">{actualFat}g</p>
        <p class="text-sm text-gray-600">of {targetFat}g</p>
        <div class="mt-4 progress-container h-2">
          <div class="h-full bg-gradient-to-r from-yellow-500 to-amber-500 rounded-full transition-all" style={`width: ${Math.min(fatPercent, 100)}%`}></div>
        </div>
      </div>
    </div>

    <!-- Net Carbs -->
    <div class="relative overflow-hidden bg-gradient-to-br from-green-50 to-emerald-50 rounded-2xl p-6 border-2 border-green-200">
      <div class="absolute top-0 right-0 w-20 h-20 bg-green-200/30 rounded-full -mr-10 -mt-10"></div>
      <div class="relative">
        <div class="flex items-center justify-between mb-4">
          <span class="text-3xl">üåæ</span>
          <span class={`badge ${carbsPercent <= 100 ? 'badge-emerald' : carbsPercent <= 120 ? 'badge-orange' : 'bg-red-100 text-red-700'}`}>
            {carbsPercent}%
          </span>
        </div>
        <p class="text-xs font-bold text-gray-500 uppercase mb-2">Net Carbs</p>
        <p class="text-4xl font-bold text-green-600 mb-1">{actualCarbs}g</p>
        <p class="text-sm text-gray-600">of {targetCarbs}g</p>
        <div class="mt-4 progress-container h-2">
          <div class={`h-full rounded-full transition-all ${carbsPercent <= 100 ? 'bg-gradient-to-r from-green-500 to-emerald-500' : 'bg-gradient-to-r from-red-500 to-pink-500'}`} style={`width: ${Math.min(carbsPercent, 100)}%`}></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts Section -->
  {actualCalories > 0 && (
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
      <!-- Pie Chart -->
      <div class="bg-white rounded-2xl p-6 border-2 border-gray-100 shadow-sm">
        <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
          <span>ü•ß</span>
          <span>Today's Distribution</span>
        </h3>
        <div class="relative h-80">
          <canvas id="macrosPieChart"></canvas>
        </div>
      </div>

      <!-- Bar Chart -->
      <div class="bg-white rounded-2xl p-6 border-2 border-gray-100 shadow-sm">
        <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
          <span>üìä</span>
          <span>Target vs Actual</span>
        </h3>
        <div class="relative h-80">
          <canvas id="macrosBarChart"></canvas>
        </div>
      </div>
    </div>
  )}

  <!-- AI Insights -->
  <div class="space-y-4">
    <h3 class="text-xl font-bold text-gray-900 flex items-center gap-2">
      <span>ü§ñ</span>
      <span>AI Nutrition Insights</span>
    </h3>
    
    <div class="grid gap-4">
      {insights.map(insight => (
        <div class={`
          p-5 rounded-xl border-2 flex items-start gap-4
          ${insight.type === 'success' ? 'bg-green-50 border-green-200' : ''}
          ${insight.type === 'warning' ? 'bg-yellow-50 border-yellow-200' : ''}
          ${insight.type === 'danger' ? 'bg-red-50 border-red-200' : ''}
          ${insight.type === 'info' ? 'bg-blue-50 border-blue-200' : ''}
        `}>
          <span class="text-3xl">{insight.icon}</span>
          <div class="flex-1">
            <p class={`font-bold mb-1 ${
              insight.type === 'success' ? 'text-green-700' :
              insight.type === 'warning' ? 'text-yellow-700' :
              insight.type === 'danger' ? 'text-red-700' :
              'text-blue-700'
            }`}>
              {insight.message}
            </p>
            <p class="text-sm text-gray-600">{insight.suggestion}</p>
          </div>
        </div>
      ))}
    </div>
  </div>

  <!-- Keto Status -->
  {actualCalories > 0 && (
    <div class="mt-8 p-6 bg-gradient-to-r from-purple-50 via-pink-50 to-purple-50 rounded-2xl border-2 border-purple-200">
      <div class="flex items-center justify-between">
        <div>
          <h4 class="text-lg font-bold text-gray-900 mb-2 flex items-center gap-2">
            <span>üî¨</span>
            <span>Keto Status</span>
          </h4>
          <p class="text-gray-600">
            {carbsPercent <= 100 
              ? '‚úÖ You\'re in optimal ketosis range!'
              : carbsPercent <= 120
              ? '‚ö†Ô∏è Close to keto limits - watch your carbs!'
              : '‚ùå Too many carbs - adjust your meals!'
            }
          </p>
        </div>
        <div class="text-right">
          <p class="text-sm text-gray-500 mb-1">Macro Ratio</p>
          <p class="text-2xl font-bold text-purple-600">
            {actualCalories > 0 ? Math.round((actualFat * 9 / actualCalories) * 100) : 0}% / 
            {actualCalories > 0 ? Math.round((actualProtein * 4 / actualCalories) * 100) : 0}% / 
            {actualCalories > 0 ? Math.round((actualCarbs * 4 / actualCalories) * 100) : 0}%
          </p>
          <p class="text-xs text-gray-500 mt-1">Fat / Protein / Carbs</p>
        </div>
      </div>
    </div>
  )}
</div>

<!-- Chart.js Script -->
{actualCalories > 0 && (
  <script is:inline define:vars={{ actualProtein, actualFat, actualCarbs, targetProtein, targetFat, targetCarbs }}>
    window.addEventListener('load', function() {
      if (typeof Chart === 'undefined') return;

      // Pie Chart
      const pieCtx = document.getElementById('macrosPieChart');
      if (pieCtx) {
        new Chart(pieCtx, {
          type: 'doughnut',
          data: {
            labels: ['Protein', 'Fat', 'Net Carbs'],
            datasets: [{
              data: [
                actualProtein * 4,
                actualFat * 9,
                actualCarbs * 4
              ],
              backgroundColor: ['#3b82f6', '#eab308', '#10b981'],
              borderWidth: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
                labels: { padding: 20, font: { size: 14, weight: 'bold' } }
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const value = context.parsed;
                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                    const percentage = Math.round((value / total) * 100);
                    return context.label + ': ' + value + ' cal (' + percentage + '%)';
                  }
                }
              }
            }
          }
        });
      }

      // Bar Chart
      const barCtx = document.getElementById('macrosBarChart');
      if (barCtx) {
        new Chart(barCtx, {
          type: 'bar',
          data: {
            labels: ['Protein (g)', 'Fat (g)', 'Net Carbs (g)'],
            datasets: [
              {
                label: 'Target',
                data: [targetProtein, targetFat, targetCarbs],
                backgroundColor: 'rgba(156, 163, 175, 0.5)',
                borderColor: '#9ca3af',
                borderWidth: 2
              },
              {
                label: 'Actual',
                data: [actualProtein, actualFat, actualCarbs],
                backgroundColor: ['rgba(59, 130, 246, 0.7)', 'rgba(234, 179, 8, 0.7)', 'rgba(16, 185, 129, 0.7)'],
                borderColor: ['#3b82f6', '#eab308', '#10b981'],
                borderWidth: 2
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'top', labels: { padding: 15, font: { size: 13, weight: 'bold' } } }
            },
            scales: {
              y: { beginAtZero: true, grid: { color: 'rgba(0, 0, 0, 0.05)' } },
              x: { grid: { display: false } }
            }
          }
        });
      }
    });
  </script>
)}